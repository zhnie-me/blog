<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Sharding-jdbc</title>
    <url>/2022/12/09/Sharding-jdbc/</url>
    <content><![CDATA[<h1 id="Sharding-jdbc"><a href="#Sharding-jdbc" class="headerlink" title="Sharding-jdbc"></a>Sharding-jdbc</h1><h2 id="æ¦‚å¿µï¼š"><a href="#æ¦‚å¿µï¼š" class="headerlink" title="æ¦‚å¿µï¼š"></a>æ¦‚å¿µï¼š</h2><p>å‚ç›´åˆ†åº“ï¼šå¤šä¸ªåº“ï¼Œåˆ†åˆ«æŸ¥ä¸åŒè¡¨ï¼› ds0.t_orderï¼Œds1.t_user</p>
<p>æ°´å¹³åˆ†è¡¨ï¼šå¤šä¸ªåº“ï¼Œåˆ†åˆ«å­˜ç»“æ„ç±»ä¼¼çš„è¡¨ï¼›ds0:t_order_0 ï¼Œds1:t_order_1</p>
<p>æ°´å¹³åˆ†åº“ï¼šå¤šä¸ªåº“ï¼Œæ ¹æ®ç®—æ³•å¾—å‡ºä¸åŒåº“ï¼Œä¸åŒè¡¨ï¼›ï¼ˆæ¯”æ°´å¹³åˆ†è¡¨å¤šäº†ä¸€ä¸ªæ¡ä»¶ï¼‰</p>
<p> <code>ds$-&gt;&#123;status % 2&#125; ï¼Œt_order_$-&gt;&#123;oid % 2&#125;ï¼Œds$-&gt;&#123;0..1&#125;.t_order_$-&gt;&#123;0..1&#125;</code></p>
<h2 id="1-ä¾èµ–"><a href="#1-ä¾èµ–" class="headerlink" title="1.ä¾èµ–"></a>1.ä¾èµ–</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--  sharding-jdbc åœºæ™¯ä¾èµ–      --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-1-å‚ç›´åˆ†åº“"><a href="#2-1-å‚ç›´åˆ†åº“" class="headerlink" title="2.1 å‚ç›´åˆ†åº“"></a>2.1 å‚ç›´åˆ†åº“</h2><p>åœ¨ä¸åŒåº“ä¸­ï¼Œåˆ†åˆ«æŸ¥ä¸åŒçš„è¡¨</p>
<p>#select * from ds0.t_order</p>
<p># select * from ds1.t_user</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring</span>:<span class="string"></span></span><br><span class="line">  <span class="attr">shardingsphere</span>:<span class="string"></span></span><br><span class="line">    <span class="attr">datasource</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">names</span>: <span class="string">ds0,ds1</span></span><br><span class="line">      <span class="attr">ds0</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">type</span>: <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name</span>: <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">        <span class="attr">name</span>: <span class="string">defaultDataSource</span></span><br><span class="line">        <span class="attr">url</span>: <span class="string">jdbc:mysql://localhost:3306/test?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true</span></span><br><span class="line">        <span class="attr">username</span>: <span class="string">root</span></span><br><span class="line">        <span class="attr">password</span>: <span class="string">123456</span></span><br><span class="line">      <span class="attr">ds1</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">type</span>: <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">        <span class="attr">driver-class-name</span>: <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">        <span class="attr">name</span>: <span class="string">defaultDataSource</span></span><br><span class="line">        <span class="attr">url</span>: <span class="string">jdbc:mysql://121.41.123.74:3306/test?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true</span></span><br><span class="line">        <span class="attr">username</span>: <span class="string">root</span></span><br><span class="line">        <span class="attr">password</span>: <span class="string">123456</span></span><br><span class="line">    <span class="attr">sharding</span>:<span class="string"></span></span><br><span class="line">      <span class="attr">tables</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">t_order</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">actual-data-nodes</span>: <span class="string">ds0.t_order #è¡¨è·¯ç”±</span></span><br><span class="line">        <span class="attr">t_user</span>:<span class="string"></span></span><br><span class="line">          <span class="attr">actual-data-nodes</span>: <span class="string">ds1.t_user #è¡¨è·¯ç”±</span></span><br><span class="line">      <span class="attr">props</span>:<span class="string"></span></span><br><span class="line">        <span class="attr">sql.show</span>: <span class="string">true</span></span><br></pre></td></tr></table></figure>

<h2 id="2-2-å…±äº«è¡¨"><a href="#2-2-å…±äº«è¡¨" class="headerlink" title="2.2 å…±äº«è¡¨"></a>2.2 å…±äº«è¡¨</h2><p> a ,båº“é‡Œéƒ½æœ‰ç›¸åŒçš„è¡¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sharding:</span><br><span class="line">      tables:</span><br><span class="line">        t_order:</span><br><span class="line">          actual-data-nodes: ds0.t_order #è¡¨è·¯ç”±</span><br><span class="line">        t_user:</span><br><span class="line">          actual-data-nodes: ds1.t_user #è¡¨è·¯ç”±</span><br><span class="line">      broadcast-tables:</span><br><span class="line">          - basic_dic</span><br><span class="line">          - basic_dic_type</span><br></pre></td></tr></table></figure>

<h2 id="2-3-æ°´å¹³åˆ†è¡¨"><a href="#2-3-æ°´å¹³åˆ†è¡¨" class="headerlink" title="2.3 æ°´å¹³åˆ†è¡¨"></a>2.3 æ°´å¹³åˆ†è¡¨</h2><p>ä¸»é”®ä¸èƒ½å”¯ä¸€ï¼Œé‡‡ç”¨é›ªèŠ±ç®—æ³•</p>
<p>ds0:t_order_0</p>
<p>ds1:t_order_1</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sharding:</span><br><span class="line">      tables:</span><br><span class="line">        t_order: #logic table</span><br><span class="line">          key-generator: #åˆ†ç‰‡çš„è¡¨ä¸»é”®ä¸èƒ½è‡ªå¢é•¿</span><br><span class="line">            column: oid # é€æ¸id</span><br><span class="line">            type: SNOWFLAKE #é›ªèŠ±ç®—æ³•ï¼Œäº§ç”Ÿä¸é‡å¤çš„å®šé•¿çš„æ•°å­—</span><br><span class="line">          table-strategy: #è¡¨ç­–ç•¥ï¼Œè¡¨è·¯ç”±</span><br><span class="line">            inline:</span><br><span class="line">              sharding-column: oid #æ ¹æ®oidä¸»é”®æ¥åˆ†ç‰‡</span><br><span class="line">              algorithm-expression: t_order_$-&gt;&#123;oid % 2&#125;</span><br><span class="line">          actual-data-nodes: ds1.t_order_$-&gt;&#123;0..1&#125; #è¡¨è·¯ç”±</span><br><span class="line">        t_user:</span><br><span class="line">          actual-data-nodes: ds0.t_user #è¡¨è·¯ç”±</span><br><span class="line">      broadcast-tables:</span><br><span class="line">          - basic_dic</span><br><span class="line">          - basic_dic_type</span><br><span class="line">      props:</span><br><span class="line">        sql.show: true</span><br></pre></td></tr></table></figure>

<h2 id="2-4-æ°´å¹³åˆ†åº“"><a href="#2-4-æ°´å¹³åˆ†åº“" class="headerlink" title="2.4 æ°´å¹³åˆ†åº“"></a>2.4 æ°´å¹³åˆ†åº“</h2><p>æ ¹æ®ç®—æ³•å¾—å‡ºä¸åŒåº“ï¼Œä¸åŒè¡¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sharding:</span><br><span class="line">      tables:</span><br><span class="line">        t_order: #logic table</span><br><span class="line">          key-generator: #åˆ†ç‰‡çš„è¡¨ä¸»é”®ä¸èƒ½è‡ªå¢é•¿</span><br><span class="line">            column: oid</span><br><span class="line">            type: SNOWFLAKE #é›ªèŠ±ç®—æ³•ï¼Œäº§ç”Ÿä¸é‡å¤çš„å®šé•¿çš„æ•°å­—</span><br><span class="line">          database-strategy: #æ•°æ®åº“ç­–ç•¥ï¼Œæ•°æ®åº“è·¯ç”±</span><br><span class="line">            inline:</span><br><span class="line">              sharding-column: status # æ•°æ®åº“çš„å­—æ®µ</span><br><span class="line">              algorithm-expression: ds$-&gt;&#123;status % 2&#125;</span><br><span class="line">          table-strategy: #è¡¨ç­–ç•¥ï¼Œè¡¨è·¯ç”±</span><br><span class="line">            inline:</span><br><span class="line">              sharding-column: oid #æ ¹æ®oidä¸»é”®æ¥åˆ†ç‰‡</span><br><span class="line">              algorithm-expression: t_order_$-&gt;&#123;oid % 2&#125;</span><br><span class="line">          actual-data-nodes: ds$-&gt;&#123;0..1&#125;.t_order_$-&gt;&#123;0..1&#125; #è¡¨è·¯ç”±</span><br><span class="line">        t_user:</span><br><span class="line">          actual-data-nodes: ds0.t_user #è¡¨è·¯ç”±</span><br><span class="line">      props:</span><br><span class="line">        sql.show: true</span><br></pre></td></tr></table></figure>

<h2 id="2-5-è¯»å†™åˆ†ç¦»"><a href="#2-5-è¯»å†™åˆ†ç¦»" class="headerlink" title="2.5 è¯»å†™åˆ†ç¦»"></a>2.5 è¯»å†™åˆ†ç¦»</h2><p>1.<strong>é…ç½®ä¸»åº“</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server-id=1</span><br><span class="line">## å¼€å¯binlog</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line">## binlogç¼“å­˜</span><br><span class="line">binlog_cache_size=1M</span><br><span class="line">## binlogæ ¼å¼(mixedã€statementã€row,é»˜è®¤æ ¼å¼æ˜¯statement)</span><br><span class="line">binlog_format=mixed</span><br></pre></td></tr></table></figure>

<p>é‡å¯mysqlæœåŠ¡ systemctl restart mysqld</p>
<p><strong>æ·»åŠ å¤åˆ¶masteræ•°æ®çš„ç”¨æˆ·readerï¼Œä¾›ä»æœåŠ¡å™¨ä½¿ç”¨</strong></p>
<p>GRANT REPLICATION SLAVE ON <em>.</em> to â€˜readerâ€˜@â€™%â€™ identified by â€˜Admin123!â€™;</p>
<p>2.<strong>é…ç½®ä»åº“</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">## è®¾ç½®server_id,æ³¨æ„è¦å”¯ä¸€</span><br><span class="line">server-id=2</span><br><span class="line">## å¼€å¯binlog,ä»¥å¤‡Slaveä½œä¸ºå…¶å®ƒSlaveçš„Masteræ—¶ä½¿ç”¨</span><br><span class="line">log-bin=mysql-slave-bin</span><br><span class="line">## relay_logé…ç½®ä¸­ç»§æ—¥å¿—</span><br><span class="line">relay_log=edu-mysql-relay-bin</span><br><span class="line">## å¦‚æœéœ€è¦åŒæ­¥å‡½æ•°æˆ–è€…å­˜å‚¨è¿‡ç¨‹</span><br><span class="line">log_bin_trust_function_creators=true</span><br><span class="line">## binlogç¼“å­˜</span><br><span class="line">binlog_cache_size=1M</span><br><span class="line">## binlogæ ¼å¼(mixedã€statementã€row,é»˜è®¤æ ¼å¼æ˜¯statement)</span><br><span class="line">binlog_format=mixed</span><br><span class="line">## è·³è¿‡ä¸»ä»å¤åˆ¶ä¸­é‡åˆ°çš„æ‰€æœ‰é”™è¯¯æˆ–æŒ‡å®šç±»å‹çš„é”™è¯¯,é¿å…slaveç«¯å¤åˆ¶ä¸­æ–­</span><br><span class="line">## å¦‚:1062é”™è¯¯æ˜¯æŒ‡ä¸€äº›ä¸»é”®é‡å¤,1032é”™è¯¯æ˜¯å› ä¸ºä¸»ä»æ•°æ®åº“æ•°æ®ä¸ä¸€è‡´</span><br><span class="line">slave_skip_errors=1062</span><br></pre></td></tr></table></figure>

<p>é‡å¯mysqlæœåŠ¡ systemctl restart mysqld</p>
<p>3.<strong>åœ¨ä»æœåŠ¡å™¨ä¸Šé…ç½®è¿æ¥ä¸»æœåŠ¡å™¨çš„ä¿¡æ¯</strong></p>
<p>é¦–å…ˆä¸»æœåŠ¡å™¨ä¸ŠæŸ¥çœ‹master_log_fileã€master_log_posä¸¤ä¸ªå‚æ•°ï¼Œç„¶ååˆ‡æ¢åˆ°ä»æœåŠ¡å™¨ä¸Šè¿›è¡Œä¸»æœåŠ¡å™¨çš„è¿æ¥ä¿¡æ¯çš„è®¾ç½®ã€‚</p>
<p>show master status</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29125988/1666276642360-78d2b92f-36d0-416a-911d-6d73547fef9d.png" alt="img"></p>
<p>4.<strong>ä»æœåŠ¡å™¨æ‰§è¡Œä¸‹é¢sql</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql&gt; change master to master_host=&#x27;192.168.25.101&#x27;,master_user=&#x27;reader&#x27;,master_password=&#x27;Admin123!&#x27;,master_log_file=&#x27;mysql-bin.000002&#x27;,master_log_pos=154;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.02 sec)</span><br></pre></td></tr></table></figure>

<p>5.<strong>ä»æœåŠ¡å™¨å¯åŠ¨I&#x2F;O çº¿ç¨‹å’ŒSQLçº¿ç¨‹</strong></p>
<p>å¯åŠ¨slaveï¼ˆå¼€ioçº¿ç¨‹ï¼‰ å¯åŠ¨å‘½ä»¤ start slave</p>
<p>show slave status\G;</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/29125988/1666276758561-3685f898-8533-44ab-90ce-1b3df27a3bd4.png" alt="img"></p>
<p>å…³é—­slaveå‘½ä»¤</p>
<p> stop slave</p>
<p>(å¦‚æœservice_uuidå› ä¸ºè™šæ‹Ÿæœºå…‹éš†å¯¼è‡´çš„é”™è¯¯ï¼Œè¯·å‚è€ƒï¼š<a href="https://blog.csdn.net/cnds123321/article/details/117925881">https://blog.csdn.net/cnds123321/article/details/11792588</a>)</p>
<p>&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;auto.cnf</p>
<hr>
<p>**6.**æµ‹è¯•ï¼ˆæ’å…¥ä¸»è¡¨ï¼Œä»è¡¨ä¹Ÿæœ‰æ•°æ®ï¼‰</p>
<p>7.é…ç½®è¯»å†™åˆ†ç¦»ï¼ˆè¡¨æ²¡æœ‰åˆ†ç‰‡ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  shardingsphere:</span><br><span class="line">    masterslave:</span><br><span class="line">      name: ms #è‡ªå®šä¹‰</span><br><span class="line">      master-data-source-name: ds0 #æŒ‡å®šmasterèŠ‚ç‚¹</span><br><span class="line">      slave-data-source-names: ds1 #æŒ‡å®šä»èŠ‚ç‚¹</span><br><span class="line">      load-balance-algorithm-type: round_robin</span><br><span class="line">    datasource:</span><br><span class="line">      names: ds0,ds1</span><br><span class="line">      ds0: #é…ç½®æ•°æ®æºçš„è¿æ¥ä¿¡æ¯</span><br><span class="line">        type: com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">        driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">        url: jdbc:mysql://192.168.25.101:3306/ma?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false</span><br><span class="line">        username: root</span><br><span class="line">        password: Admin123!</span><br><span class="line">      ds1: #</span><br><span class="line">        type: com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">        driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">        url: jdbc:mysql://192.168.25.103:3306/ma?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false</span><br><span class="line">        username: root</span><br><span class="line">        password: Admin123!</span><br><span class="line">    props:</span><br><span class="line">      sql.show: true</span><br><span class="line"></span><br><span class="line">mybatis-plus:</span><br><span class="line">  configuration:</span><br><span class="line">    map-underscore-to-camel-case: true</span><br><span class="line">  type-aliases-package: com.aaaaaaaaaaaaaaaaaaaaaaaaa è·¯å¾„</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>é…ç½®</category>
      </categories>
      <tags>
        <tag>Sharding-jdbc</tag>
      </tags>
  </entry>
  <entry>
    <title>arthas</title>
    <url>/2022/12/09/arthas/</url>
    <content><![CDATA[<h1 id="arthas"><a href="#arthas" class="headerlink" title="arthas"></a>arthas</h1><p>1.è§£å‹ç¼©åŒ…</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">unzip  xxx.zip -d æ–‡ä»¶å¤¹å</span><br></pre></td></tr></table></figure>



<p>2.cpåˆ°å®¹å™¨å†…</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker cp æ–‡ä»¶å¤¹å å®¹å™¨å:ç›®å½• </span><br></pre></td></tr></table></figure>

<p>3.è¿›å…¥å®¹å™¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ‰§è¡Œ java -jar arthes-boot.jar  é€‰æ‹©å®¹å™¨ 1</span><br></pre></td></tr></table></figure>



<p>4.è¾“å…¥å‘½ä»¤</p>
<ol>
<li>åç¼–è¯‘å‘½ä»¤</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">æ‰§è¡Œå‘½ä»¤ jad åŠ ä¸ŠæŸ¥çœ‹ç±»çš„å…¨è·¯å¾„ </span><br><span class="line">jad  java.lang.Math   </span><br></pre></td></tr></table></figure>



<ol start="2">
<li></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">trace com.nrec.pcs9000.app.service.impl.AstSgassetServiceImpl getAssetTreeMaps --skipJDKMethod false æŸ¥çœ‹åŒ…å«jdkè°ƒç”¨</span><br><span class="line">trace com.nrec.pcs9000.app.service.impl.AstSgassetServiceImpl *getAssetTreeMaps* æŸ¥çœ‹æ–¹æ³•å†…éƒ¨çš„æ‰€æœ‰è°ƒç”¨è€—æ—¶åŒ…å«lambdaã€jdkè°ƒç”¨</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>å·¥å…·</category>
      </categories>
      <tags>
        <tag>arthas</tag>
      </tags>
  </entry>
  <entry>
    <title>canal</title>
    <url>/2022/12/20/canal/</url>
    <content><![CDATA[<h1 id="canal"><a href="#canal" class="headerlink" title="canal"></a>canal</h1><h2 id="1-canalçš„æ­å»º"><a href="#1-canalçš„æ­å»º" class="headerlink" title="1.canalçš„æ­å»º"></a>1.canalçš„æ­å»º</h2><h3 id="1-å¼€å¯binlogæ—¥å¿—"><a href="#1-å¼€å¯binlogæ—¥å¿—" class="headerlink" title="1.å¼€å¯binlogæ—¥å¿—"></a>1.å¼€å¯binlogæ—¥å¿—</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># æŸ¥çœ‹æ˜¯å¦å¼€å¯</span><br><span class="line">SHOW VARIABLES LIKE &#x27;log_bin&#x27;;</span><br><span class="line">show global variables like &quot;binlog%&quot;;</span><br><span class="line"></span><br><span class="line">#æ²¡å¼€å¯:</span><br><span class="line">#ç¬¬ä¸€ç§æ–¹å¼: åœ¨mysqldä¸‹æ·»åŠ ç¬¬ä¸€ç§æ–¹å¼</span><br><span class="line">#å¼€å¯binlogæ—¥å¿—</span><br><span class="line">log_bin=ON</span><br><span class="line">#binlogæ—¥å¿—çš„åŸºæœ¬æ–‡ä»¶å</span><br><span class="line">log_bin_basename=/var/lib/mysql/mysql-bin</span><br><span class="line">#binlogæ–‡ä»¶çš„ç´¢å¼•æ–‡ä»¶ï¼Œç®¡ç†æ‰€æœ‰binlogæ–‡ä»¶</span><br><span class="line">log_bin_index=/var/lib/mysql/mysql-bin.index</span><br><span class="line">#é…ç½®serverid</span><br><span class="line">server-id=1</span><br><span class="line"></span><br><span class="line">#ç¬¬äºŒç§æ–¹å¼: åœ¨mysqldä¸‹æ·»åŠ ç¬¬äºŒç§æ–¹å¼</span><br><span class="line">#æ­¤ä¸€è¡Œç­‰åŒäºä¸Šé¢log_binä¸‰è¡Œ,è¿™é‡Œå¯ä»¥å†™ç»å¯¹è·¯å¾„,ä¹Ÿå¯ä»¥ç›´æ¥å†™mysql-bin(åè€…é»˜è®¤å°±æ˜¯åœ¨/var/lib/mysqlç›®å½•ä¸‹)</span><br><span class="line">log-bin=/var/lib/mysql/mysql-bin</span><br><span class="line">#é…ç½®serverid</span><br><span class="line">server-id=1</span><br><span class="line"></span><br><span class="line">é…ç½®å®Œåé‡å¯MySQLï¼Œå†æ¬¡æŸ¥çœ‹æ˜¯å¦å¼€å¯binlog</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="2-åˆ›å»ºä¸€ä¸ªç”¨æˆ·"><a href="#2-åˆ›å»ºä¸€ä¸ªç”¨æˆ·" class="headerlink" title="2.åˆ›å»ºä¸€ä¸ªç”¨æˆ·"></a>2.åˆ›å»ºä¸€ä¸ªç”¨æˆ·</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-- åˆ›å»ºç”¨æˆ· ç”¨æˆ·åï¼šcanal å¯†ç ï¼šcanal</span><br><span class="line">create user &#x27;canal&#x27;@&#x27;%&#x27; identified by &#x27;canal&#x27;;</span><br><span class="line">-- æˆæƒ *.*è¡¨ç¤ºæ‰€æœ‰åº“</span><br><span class="line">grant SELECT, REPLICATION SLAVE, REPLICATION CLIENT on *.* to &#x27;canal&#x27;@&#x27;%&#x27; with grant option;</span><br><span class="line">-- åˆ·æ–°</span><br><span class="line">flush privileges; </span><br><span class="line"></span><br><span class="line">-- æŸ¥çœ‹ç”¨æˆ·åŠæƒé™</span><br><span class="line">SELECT DISTINCT CONCAT(&#x27;User: &#x27;&#x27;&#x27;,user,&#x27;&#x27;&#x27;@&#x27;&#x27;&#x27;,host,&#x27;&#x27;&#x27;;&#x27;) AS query FROM mysql.user;</span><br></pre></td></tr></table></figure>



<h3 id="3-canalä¸‹è½½"><a href="#3-canalä¸‹è½½" class="headerlink" title="3.canalä¸‹è½½"></a>3.canalä¸‹è½½</h3><blockquote>
<p> Linux ä¸­  <a href="https://github.com/alibaba/canal/releases">https://github.com/alibaba/canal/releases</a></p>
</blockquote>
<p>3.1 å®‰è£…jdk</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tar -xvf jdk-8u60-linux-x64.tar.gz -C /usr/lib/jvm</span><br><span class="line"></span><br><span class="line">cd /etc/</span><br><span class="line">cp profile profile.bak</span><br><span class="line">vim  profile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">åœ¨ç»“å°¾æ·»åŠ </span></span><br><span class="line">export JAVA_HOME=/usr/lib/jvm/jdk1.8.0_60</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æˆ–è€…</span></span><br><span class="line">JAVA_HOME=/usr/lib/jvm/jdk1.8.0_60</span><br><span class="line">PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">export JAVA_HOME  PATH  CLASSPATH</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">é‡æ–°åŠ è½½ç³»ç»Ÿé…ç½®æ–‡ä»¶</span></span><br><span class="line">source /etc/profile</span><br><span class="line"></span><br><span class="line">java -version</span><br><span class="line">java</span><br><span class="line">javac</span><br></pre></td></tr></table></figure>



]]></content>
      <tags>
        <tag>canal</tag>
      </tags>
  </entry>
  <entry>
    <title>docker</title>
    <url>/2022/12/20/docker/</url>
    <content><![CDATA[<h1 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h1><h2 id="1-æ™®é€šå®‰è£…jdk"><a href="#1-æ™®é€šå®‰è£…jdk" class="headerlink" title="1.æ™®é€šå®‰è£…jdk"></a>1.æ™®é€šå®‰è£…jdk</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tar -xvf jdk-8u60-linux-x64.tar.gz -C /usr/lib/jvm</span><br><span class="line"></span><br><span class="line">cd /etc/</span><br><span class="line">cp profile profile.bak</span><br><span class="line">vim  profile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">åœ¨ç»“å°¾æ·»åŠ </span></span><br><span class="line">export JAVA_HOME=/usr/lib/jvm/jdk1.8.0_60</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">æˆ–è€…</span></span><br><span class="line">JAVA_HOME=/usr/lib/jvm/jdk1.8.0_60</span><br><span class="line">PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">export JAVA_HOME  PATH  CLASSPATH</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">é‡æ–°åŠ è½½ç³»ç»Ÿé…ç½®æ–‡ä»¶</span></span><br><span class="line">source /etc/profile</span><br><span class="line"></span><br><span class="line">java -version</span><br><span class="line">java</span><br><span class="line">javac</span><br></pre></td></tr></table></figure>



<h2 id="2-å®‰è£…docker-compose"><a href="#2-å®‰è£…docker-compose" class="headerlink" title="2.å®‰è£…docker-compose"></a>2.å®‰è£…docker-compose</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.24.0/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç»™æƒé™</span></span><br><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹ç‰ˆæœ¬</span></span><br><span class="line">docker-compose --version</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="3-dockerå®‰è£…rocketmq"><a href="#3-dockerå®‰è£…rocketmq" class="headerlink" title="3.dockerå®‰è£…rocketmq"></a>3.dockerå®‰è£…rocketmq</h2><h3 id="3-1-æ–‡ä»¶ç»“æ„"><a href="#3-1-æ–‡ä»¶ç»“æ„" class="headerlink" title="3.1 æ–‡ä»¶ç»“æ„"></a>3.1 æ–‡ä»¶ç»“æ„</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker-compose.yml</span><br><span class="line">conf</span><br><span class="line">	- broker.conf</span><br><span class="line">logs</span><br><span class="line">store</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="3-2-docker-compose-yml"><a href="#3-2-docker-compose-yml" class="headerlink" title="3.2 docker-compose.yml"></a>3.2 docker-compose.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.5&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">rmqnamesrv:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">foxiswho/rocketmq:server</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rmqnamesrv</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9876</span><span class="string">:9876</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/opt/logs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./store:/opt/store</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">        <span class="attr">rmq:</span></span><br><span class="line">          <span class="attr">aliases:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">rmqnamesrv</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">rmqbroker:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">foxiswho/rocketmq:broker</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rmqbroker</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10909</span><span class="string">:10909</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10911</span><span class="string">:10911</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logs:/opt/logs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./store:/opt/store</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf/broker.conf:/etc/rocketmq/broker.conf</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">        <span class="attr">NAMESRV_ADDR:</span> <span class="string">&quot;rmqnamesrv:9876&quot;</span></span><br><span class="line">        <span class="attr">JAVA_OPTS:</span> <span class="string">&quot; -Duser.home=/opt&quot;</span></span><br><span class="line">        <span class="attr">JAVA_OPT_EXT:</span> <span class="string">&quot;-server -Xms128m -Xmx128m -Xmn128m&quot;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">mqbroker</span> <span class="string">-c</span> <span class="string">/etc/rocketmq/broker.conf</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rmqnamesrv</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">rmq:</span></span><br><span class="line">        <span class="attr">aliases:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">rmqbroker</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">rmqconsole:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">styletang/rocketmq-console-ng</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">rmqconsole</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:8080</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">        <span class="attr">JAVA_OPTS:</span> <span class="string">&quot;-Drocketmq.namesrv.addr=rmqnamesrv:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">rmqnamesrv</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="attr">rmq:</span></span><br><span class="line">        <span class="attr">aliases:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">rmqconsole</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">rmq:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">rmq</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="3-3-broker-conf"><a href="#3-3-broker-conf" class="headerlink" title="3.3 broker.conf"></a>3.3 broker.conf</h3><figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="comment"># contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="comment"># this work for additional information regarding copyright ownership.</span></span><br><span class="line"><span class="comment"># The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="comment"># (the &quot;License&quot;); you may not use this file except in compliance with</span></span><br><span class="line"><span class="comment"># the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">#  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment">#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">#  See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">#  limitations under the License.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># æ‰€å±é›†ç¾¤åå­—</span></span><br><span class="line"><span class="attr">brokerClusterName</span>=<span class="string">DefaultCluster</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># broker åå­—ï¼Œæ³¨æ„æ­¤å¤„ä¸åŒçš„é…ç½®æ–‡ä»¶å¡«å†™çš„ä¸ä¸€æ ·ï¼Œå¦‚æœåœ¨ broker-a.properties ä½¿ç”¨: broker-a,</span></span><br><span class="line"><span class="comment"># åœ¨ broker-b.properties ä½¿ç”¨: broker-b</span></span><br><span class="line"><span class="attr">brokerName</span>=<span class="string">broker-a</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># 0 è¡¨ç¤º Masterï¼Œ&amp;gt; 0 è¡¨ç¤º Slave</span></span><br><span class="line"><span class="attr">brokerId</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># nameServeråœ°å€ï¼Œåˆ†å·åˆ†å‰²</span></span><br><span class="line"><span class="comment"># namesrvAddr=rocketmq-nameserver1:9876;rocketmq-nameserver2:9876</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># å¯åŠ¨IP,å¦‚æœ docker æŠ¥ com.alibaba.rocketmq.remoting.exception.RemotingConnectException: connect to &amp;lt;192.168.0.120:10909&amp;gt; failed</span></span><br><span class="line"><span class="comment"># è§£å†³æ–¹å¼1 åŠ ä¸Šä¸€å¥ producer.setVipChannelEnabled(false);ï¼Œè§£å†³æ–¹å¼2 brokerIP1 è®¾ç½®å®¿ä¸»æœºIPï¼Œä¸è¦ä½¿ç”¨docker å†…éƒ¨IP è¦æ¢åšä½ è‡ªå·±çš„IP</span></span><br><span class="line"><span class="attr">brokerIP1</span>=<span class="string">192.168.1.16</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºæœåŠ¡å™¨ä¸å­˜åœ¨çš„topicï¼Œé»˜è®¤åˆ›å»ºçš„é˜Ÿåˆ—æ•°</span></span><br><span class="line"><span class="attr">defaultTopicQueueNums</span>=<span class="string">4</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># æ˜¯å¦å…è®¸ Broker è‡ªåŠ¨åˆ›å»º Topicï¼Œå»ºè®®çº¿ä¸‹å¼€å¯ï¼Œçº¿ä¸Šå…³é—­ ï¼ï¼ï¼è¿™é‡Œä»”ç»†çœ‹æ˜¯ falseï¼Œfalseï¼Œfalse</span></span><br><span class="line"><span class="attr">autoCreateTopicEnable</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># æ˜¯å¦å…è®¸ Broker è‡ªåŠ¨åˆ›å»ºè®¢é˜…ç»„ï¼Œå»ºè®®çº¿ä¸‹å¼€å¯ï¼Œçº¿ä¸Šå…³é—­</span></span><br><span class="line"><span class="attr">autoCreateSubscriptionGroup</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Broker å¯¹å¤–æœåŠ¡çš„ç›‘å¬ç«¯å£</span></span><br><span class="line"><span class="attr">listenPort</span>=<span class="string">10911</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># åˆ é™¤æ–‡ä»¶æ—¶é—´ç‚¹ï¼Œé»˜è®¤å‡Œæ™¨4ç‚¹</span></span><br><span class="line"><span class="attr">deleteWhen</span>=<span class="string">04</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># æ–‡ä»¶ä¿ç•™æ—¶é—´ï¼Œé»˜è®¤48å°æ—¶</span></span><br><span class="line"><span class="attr">fileReservedTime</span>=<span class="string">120</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># commitLog æ¯ä¸ªæ–‡ä»¶çš„å¤§å°é»˜è®¤1G</span></span><br><span class="line"><span class="attr">mapedFileSizeCommitLog</span>=<span class="string">1073741824</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># ConsumeQueue æ¯ä¸ªæ–‡ä»¶é»˜è®¤å­˜ 30W æ¡ï¼Œæ ¹æ®ä¸šåŠ¡æƒ…å†µè°ƒæ•´</span></span><br><span class="line"><span class="attr">mapedFileSizeConsumeQueue</span>=<span class="string">300000</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># destroyMapedFileIntervalForcibly=120000</span></span><br><span class="line"><span class="comment"># redeleteHangedFileInterval=120000</span></span><br><span class="line"><span class="comment"># æ£€æµ‹ç‰©ç†æ–‡ä»¶ç£ç›˜ç©ºé—´</span></span><br><span class="line"><span class="attr">diskMaxUsedSpaceRatio</span>=<span class="string">88</span></span><br><span class="line"><span class="comment"># å­˜å‚¨è·¯å¾„</span></span><br><span class="line"><span class="comment"># storePathRootDir=/home/ztztdata/rocketmq-all-4.1.0-incubating/store</span></span><br><span class="line"><span class="comment"># commitLog å­˜å‚¨è·¯å¾„</span></span><br><span class="line"><span class="comment"># storePathCommitLog=/home/ztztdata/rocketmq-all-4.1.0-incubating/store/commitlog</span></span><br><span class="line"><span class="comment"># æ¶ˆè´¹é˜Ÿåˆ—å­˜å‚¨</span></span><br><span class="line"><span class="comment"># storePathConsumeQueue=/home/ztztdata/rocketmq-all-4.1.0-incubating/store/consumequeue</span></span><br><span class="line"><span class="comment"># æ¶ˆæ¯ç´¢å¼•å­˜å‚¨è·¯å¾„</span></span><br><span class="line"><span class="comment"># storePathIndex=/home/ztztdata/rocketmq-all-4.1.0-incubating/store/index</span></span><br><span class="line"><span class="comment"># checkpoint æ–‡ä»¶å­˜å‚¨è·¯å¾„</span></span><br><span class="line"><span class="comment"># storeCheckpoint=/home/ztztdata/rocketmq-all-4.1.0-incubating/store/checkpoint</span></span><br><span class="line"><span class="comment"># abort æ–‡ä»¶å­˜å‚¨è·¯å¾„</span></span><br><span class="line"><span class="comment"># abortFile=/home/ztztdata/rocketmq-all-4.1.0-incubating/store/abort</span></span><br><span class="line"><span class="comment"># é™åˆ¶çš„æ¶ˆæ¯å¤§å°</span></span><br><span class="line"><span class="attr">maxMessageSize</span>=<span class="string">65536</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># flushCommitLogLeastPages=4</span></span><br><span class="line"><span class="comment"># flushConsumeQueueLeastPages=2</span></span><br><span class="line"><span class="comment"># flushCommitLogThoroughInterval=10000</span></span><br><span class="line"><span class="comment"># flushConsumeQueueThoroughInterval=60000</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Broker çš„è§’è‰²</span></span><br><span class="line"><span class="comment"># - ASYNC_MASTER å¼‚æ­¥å¤åˆ¶Master</span></span><br><span class="line"><span class="comment"># - SYNC_MASTER åŒæ­¥åŒå†™Master</span></span><br><span class="line"><span class="comment"># - SLAVE</span></span><br><span class="line"><span class="attr">brokerRole</span>=<span class="string">ASYNC_MASTER</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># åˆ·ç›˜æ–¹å¼</span></span><br><span class="line"><span class="comment"># - ASYNC_FLUSH å¼‚æ­¥åˆ·ç›˜</span></span><br><span class="line"><span class="comment"># - SYNC_FLUSH åŒæ­¥åˆ·ç›˜</span></span><br><span class="line"><span class="attr">flushDiskType</span>=<span class="string">ASYNC_FLUSH</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># å‘æ¶ˆæ¯çº¿ç¨‹æ± æ•°é‡</span></span><br><span class="line"><span class="comment"># sendMessageThreadPoolNums=128</span></span><br><span class="line"><span class="comment"># æ‹‰æ¶ˆæ¯çº¿ç¨‹æ± æ•°é‡</span></span><br><span class="line"><span class="comment"># pullMessageThreadPoolNums=128</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span><br><span class="line">è®¿é—® localhost:8080</span><br></pre></td></tr></table></figure>



<h2 id="4-dockerå®‰è£…nginx"><a href="#4-dockerå®‰è£…nginx" class="headerlink" title="4. dockerå®‰è£…nginx"></a>4. dockerå®‰è£…nginx</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker pull nginx</span><br><span class="line">docker run --name nginx -p 80:80 -d nginx</span><br></pre></td></tr></table></figure>



<h2 id="5-dockeréƒ¨ç½²minio"><a href="#5-dockeréƒ¨ç½²minio" class="headerlink" title="5.dockeréƒ¨ç½²minio"></a>5.dockeréƒ¨ç½²minio</h2><h3 id="5-1æ‹‰å–é•œåƒ"><a href="#5-1æ‹‰å–é•œåƒ" class="headerlink" title="5.1æ‹‰å–é•œåƒ"></a>5.1æ‹‰å–é•œåƒ</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker pull minio/minio</span><br><span class="line"></span><br><span class="line">docker images</span><br></pre></td></tr></table></figure>

<h3 id="5-2-åˆ›å»ºç›®å½•"><a href="#5-2-åˆ›å»ºç›®å½•" class="headerlink" title="5.2.åˆ›å»ºç›®å½•"></a>5.2.åˆ›å»ºç›®å½•</h3><blockquote>
<p>ä¸€ä¸ªç”¨æ¥å­˜æ”¾é…ç½®ï¼Œä¸€ä¸ªç”¨æ¥å­˜å‚¨ä¸Šä¼ æ–‡ä»¶çš„ç›®å½•</p>
<p>å¯åŠ¨å‰éœ€è¦å…ˆåˆ›å»ºMinioå¤–éƒ¨æŒ‚è½½çš„é…ç½®æ–‡ä»¶ï¼ˆ &#x2F;home&#x2F;minio&#x2F;configï¼‰,</p>
<p>å’Œå­˜å‚¨ä¸Šä¼ æ–‡ä»¶çš„ç›®å½•ï¼ˆ &#x2F;home&#x2F;minio&#x2F;dataï¼‰</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir -p /home/minio/config</span><br><span class="line">mkdir -p /home/minio/data</span><br></pre></td></tr></table></figure>

<h3 id="5-3å¯åŠ¨"><a href="#5-3å¯åŠ¨" class="headerlink" title="5.3å¯åŠ¨"></a>5.3å¯åŠ¨</h3><p>å•è¡Œä»£ç ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -p 9000:9000 -p 9090:9090      --net=host      --name minio      -d --restart=always      -e &quot;MINIO_ACCESS_KEY=minioadmin&quot;      -e &quot;MINIO_SECRET_KEY=minioadmin&quot;      -v /home/minio/data:/data      -v /home/minio/config:/root/.minio      minio/minio server      /data --console-address &quot;:9090&quot; -address &quot;:9000&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¤šè¡Œä»£ç ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -p 9000:9000 -p 9090:9090 \</span><br><span class="line">     --net=host \</span><br><span class="line">     --name minio \</span><br><span class="line">     -d --restart=always \</span><br><span class="line">     -e &quot;MINIO_ACCESS_KEY=minioadmin&quot; \</span><br><span class="line">     -e &quot;MINIO_SECRET_KEY=minioadmin&quot; \</span><br><span class="line">     -v /home/minio/data:/data \</span><br><span class="line">     -v /home/minio/config:/root/.minio \</span><br><span class="line">     minio/minio server \</span><br><span class="line">     /data --console-address &quot;:9090&quot; -address &quot;:9000&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>9090ç«¯å£æŒ‡çš„æ˜¯minioçš„å®¢æˆ·ç«¯ç«¯å£ 9000æ˜¯çœŸå®çš„apiç«¯å£</strong></p>
<p>MINIO_ACCESS_KEY ï¼šè´¦å·</p>
<p>MINIO_SECRET_KEY ï¼šå¯†ç ï¼ˆè´¦å·é•¿åº¦å¿…é¡»å¤§äºç­‰äº5ï¼Œå¯†ç é•¿åº¦å¿…é¡»å¤§äºç­‰äº8ä½ï¼‰</p>
</blockquote>
<h3 id="6-4åˆ›å»ºç”¨æˆ·"><a href="#6-4åˆ›å»ºç”¨æˆ·" class="headerlink" title="6.4åˆ›å»ºç”¨æˆ·"></a>6.4åˆ›å»ºç”¨æˆ·</h3><blockquote>
<p>admin admin123456</p>
</blockquote>
<blockquote>
<p> Service Account  </p>
<p>[{â€œaccess_keyâ€:â€ZBT79S0EA7P41R77GEY1â€,â€secret_keyâ€:â€GdsL5YzILY2glg4L2ez1eY4kVVLXeX2+L5IRryELâ€}]}</p>
<p>key  12345678</p>
</blockquote>
]]></content>
      <categories>
        <category>è¿ç»´</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>mysql</title>
    <url>/2023/02/11/mysql/</url>
    <content><![CDATA[<h1 id="Mysqlâ€”-gt-è²ğŸ–"><a href="#Mysqlâ€”-gt-è²ğŸ–" class="headerlink" title="Mysqlâ€”&gt;è²ğŸ–"></a>Mysqlâ€”&gt;è²ğŸ–</h1><h2 id="1-æ¶æ„"><a href="#1-æ¶æ„" class="headerlink" title="1.æ¶æ„"></a>1.æ¶æ„</h2><h3 id="1-1-sqlç»„ä»¶"><a href="#1-1-sqlç»„ä»¶" class="headerlink" title="1.1 sqlç»„ä»¶"></a>1.1 sqlç»„ä»¶</h3><p><img src="/pic/mysql/sql%E7%BB%84%E4%BB%B6.webp" alt="sqlç»„ä»¶"></p>
<blockquote>
<ol>
<li>è¿æ¥å™¨ï¼š å…ˆè¿æ¥åˆ°è¿™ä¸ªæ•°æ®åº“ä¸Šï¼Œè¿™æ—¶å€™æ¥å¾…ä½ çš„å°±æ˜¯è¿æ¥å™¨ã€‚è¿æ¥å™¨è´Ÿè´£è·Ÿå®¢æˆ·ç«¯å»ºç«‹è¿æ¥ã€è·å–æƒé™ã€ç»´æŒå’Œç®¡ç†è¿æ¥ mysql -h$ip -P$port -u$user -p</li>
<li>æŸ¥è¯¢ç¼“å­˜ï¼šMySQLæ‹¿åˆ°ä¸€ä¸ªæŸ¥è¯¢è¯·æ±‚åï¼Œä¼šå…ˆåˆ°æŸ¥è¯¢ç¼“å­˜çœ‹çœ‹ï¼Œä¹‹å‰æ˜¯ä¸æ˜¯æ‰§è¡Œè¿‡è¿™æ¡è¯­å¥ã€‚ä¹‹å‰æ‰§è¡Œè¿‡çš„è¯­å¥åŠå…¶ç»“æœå¯èƒ½ä¼šä»¥key-valueå¯¹çš„å½¢å¼ï¼Œè¢«ç›´æ¥ç¼“å­˜åœ¨å†…å­˜ä¸­ã€‚ select SQL_CACHE * from T where ID&#x3D;10ï¼›ï¼ˆmysql 8.0æŠŠè¿™ä¸ªåŠŸèƒ½åˆ é™¤äº†ï¼‰</li>
<li>åˆ†æå™¨ï¼šå¼€å§‹çœŸæ­£æ‰§è¡Œè¯­å¥ï¼Œå¯¹SQLè¯­å¥åšè§£æã€‚</li>
<li>ä¼˜åŒ–å™¨ï¼šä¼˜åŒ–å™¨æ˜¯åœ¨è¡¨é‡Œé¢æœ‰å¤šä¸ªç´¢å¼•çš„æ—¶å€™ï¼Œå†³å®šä½¿ç”¨å“ªä¸ªç´¢å¼•ï¼›æˆ–è€…åœ¨ä¸€ä¸ªè¯­å¥æœ‰å¤šè¡¨å…³è”ï¼ˆjoinï¼‰çš„æ—¶å€™ï¼Œå†³å®šå„ä¸ªè¡¨çš„è¿æ¥é¡ºåº</li>
<li>æ‰§è¡Œå™¨ï¼šå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œè¦å…ˆåˆ¤æ–­ä¸€ä¸‹ä½ å¯¹è¿™ä¸ªè¡¨Tæœ‰æ²¡æœ‰æ‰§è¡ŒæŸ¥è¯¢çš„æƒé™ï¼Œæ‰§è¡Œå™¨å°±ä¼šæ ¹æ®è¡¨çš„å¼•æ“</li>
</ol>
</blockquote>
<h3 id="1-2-æ—¥å¿—"><a href="#1-2-æ—¥å¿—" class="headerlink" title="1.2 æ—¥å¿—"></a>1.2 æ—¥å¿—</h3><h4 id="1-2-1-redo-logï¼ˆé‡åšæ—¥å¿—ï¼‰"><a href="#1-2-1-redo-logï¼ˆé‡åšæ—¥å¿—ï¼‰" class="headerlink" title="1.2.1  redo logï¼ˆé‡åšæ—¥å¿—ï¼‰"></a>1.2.1  redo logï¼ˆé‡åšæ—¥å¿—ï¼‰</h4><p>innodbå¼•æ“ ç‰¹æœ‰çš„æ—¥å¿—</p>
<blockquote>
<p>InnoDBçš„redo log æ˜¯å›ºå®šå¤§å°ï¼Œå¯ä»¥è¿›è¡Œå­˜å‚¨æ—¥å¿—ã€‚åœ¨åšæ“ä½œæ—¶ï¼Œå¯ä»¥å…ˆæ›´æ–°æ—¥å¿—ã€è·Ÿæ–°å†…å­˜ã€‚åœ¨è¿›è¡Œç£ç›˜ioçš„æ—¶å€™å¯ä»¥æ”¾åœ¨ç³»ç»Ÿç©ºé—²çš„æ—¶å€™è¿›è¡Œã€‚å¦‚æœæ»¡äº†ï¼Œåªèƒ½å¾ªç¯åˆ°æ–‡ä»¶å¼€å§‹çš„æ—¶å€™æ¸…é™¤ä¸€éƒ¨åˆ†æ•°æ®ï¼Œå†å†™å…¥ã€‚</p>
<p>æœ‰äº†redo logï¼ŒInnoDBå°±å¯ä»¥ä¿è¯å³ä½¿æ•°æ®åº“å‘ç”Ÿå¼‚å¸¸é‡å¯ï¼Œä¹‹å‰æäº¤çš„è®°å½•éƒ½ä¸ä¼šä¸¢å¤±ï¼Œè¿™ä¸ªèƒ½åŠ›ç§°ä¸º<strong>crash-safe</strong>ã€‚ï¼ˆåœ¨æ•°æ®åº“æ¢å¤åï¼Œå°±å¯ä»¥æ ¹æ®redo log æ¢å¤æ•°æ®ï¼‰</p>
</blockquote>
<h4 id="1-2-2-binlogï¼ˆå½’æ¡£æ—¥å¿—ï¼‰"><a href="#1-2-2-binlogï¼ˆå½’æ¡£æ—¥å¿—ï¼‰" class="headerlink" title="1.2.2  binlogï¼ˆå½’æ¡£æ—¥å¿—ï¼‰"></a>1.2.2  binlogï¼ˆå½’æ¡£æ—¥å¿—ï¼‰</h4><p>Serverå±‚ä¹Ÿæœ‰è‡ªå·±çš„æ—¥å¿—ï¼Œç§°ä¸ºbinlog</p>
<p>å› ä¸ºæœ€å¼€å§‹MySQLé‡Œå¹¶æ²¡æœ‰InnoDBå¼•æ“ã€‚MySQLè‡ªå¸¦çš„å¼•æ“æ˜¯MyISAMï¼Œä½†æ˜¯MyISAMæ²¡æœ‰crash-safeçš„èƒ½åŠ›ï¼Œbinlogæ—¥å¿—åªèƒ½ç”¨äºå½’æ¡£ã€‚è€ŒInnoDBæ˜¯å¦ä¸€ä¸ªå…¬å¸ä»¥æ’ä»¶å½¢å¼å¼•å…¥MySQLçš„ï¼Œæ—¢ç„¶åªä¾é binlogæ˜¯æ²¡æœ‰crash-safeèƒ½åŠ›çš„ï¼Œæ‰€ä»¥InnoDBä½¿ç”¨å¦å¤–ä¸€å¥—æ—¥å¿—ç³»ç»Ÿâ€”â€”ä¹Ÿå°±æ˜¯redo logæ¥å®ç°crash-safeèƒ½åŠ›ã€‚</p>
<p> ä¸åŒç‚¹ï¼š</p>
<blockquote>
<ol>
<li>redo logæ˜¯InnoDBå¼•æ“ç‰¹æœ‰çš„ï¼›binlogæ˜¯MySQLçš„Serverå±‚å®ç°çš„ï¼Œæ‰€æœ‰å¼•æ“éƒ½å¯ä»¥ä½¿ç”¨ã€‚</li>
<li>redo logæ˜¯ç‰©ç†æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯â€œåšäº†ä»€ä¹ˆæ”¹åŠ¨â€ï¼›binlogæ˜¯é€»è¾‘æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯è¿™ä¸ªè¯­å¥çš„åŸå§‹é€»è¾‘ï¼Œstatement æ ¼å¼çš„è¯æ˜¯è®°sqlè¯­å¥ï¼Œ rowæ ¼å¼ä¼šè®°å½•è¡Œçš„å†…å®¹ï¼Œè®°ä¸¤æ¡ï¼Œæ›´æ–°å‰å’Œæ›´æ–°åéƒ½æœ‰</li>
<li>redo logæ˜¯å¾ªç¯å†™çš„ï¼Œç©ºé—´å›ºå®šä¼šç”¨å®Œï¼›binlogæ˜¯å¯ä»¥è¿½åŠ å†™å…¥çš„ã€‚â€œè¿½åŠ å†™â€æ˜¯æŒ‡binlogæ–‡ä»¶å†™åˆ°ä¸€å®šå¤§å°åä¼šåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªï¼Œå¹¶ä¸ä¼šè¦†ç›–ä»¥å‰çš„æ—¥å¿—ã€‚</li>
</ol>
</blockquote>
<p>æ‰§è¡Œæµç¨‹ï¼š</p>
<p>idä¸ºä¸»é”®</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">update</span> T <span class="keyword">set</span> c<span class="operator">=</span>c<span class="operator">+</span><span class="number">1</span> <span class="keyword">where</span> ID<span class="operator">=</span><span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/pic/mysql/%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.webp" alt="æ‰§è¡Œæµç¨‹"></p>
<p>å°†redo logçš„å†™å…¥æ‹†æˆäº†ä¸¤ä¸ªæ­¥éª¤ï¼šprepareå’Œcommitï¼Œè¿™å°±æ˜¯â€ä¸¤é˜¶æ®µæäº¤â€</p>
<h4 id="1-2-3-ä¸¤é˜¶æ®µæäº¤"><a href="#1-2-3-ä¸¤é˜¶æ®µæäº¤" class="headerlink" title="1.2.3 ä¸¤é˜¶æ®µæäº¤"></a>1.2.3 ä¸¤é˜¶æ®µæäº¤</h4><p><strong>A.æ€æ ·è®©æ•°æ®åº“æ¢å¤åˆ°åŠä¸ªæœˆå†…ä»»æ„ä¸€ç§’çš„çŠ¶æ€ï¼Ÿ</strong></p>
<blockquote>
<p>å‰é¢æˆ‘ä»¬è¯´è¿‡äº†ï¼Œbinlogä¼šè®°å½•æ‰€æœ‰çš„é€»è¾‘æ“ä½œï¼Œå¹¶ä¸”æ˜¯é‡‡ç”¨â€œè¿½åŠ å†™â€çš„å½¢å¼ã€‚å¦‚æœä½ çš„DBAæ‰¿è¯ºè¯´åŠä¸ªæœˆå†…å¯ä»¥æ¢å¤ï¼Œé‚£ä¹ˆå¤‡ä»½ç³»ç»Ÿä¸­ä¸€å®šä¼šä¿å­˜æœ€è¿‘åŠä¸ªæœˆçš„æ‰€æœ‰binlogï¼ŒåŒæ—¶ç³»ç»Ÿä¼šå®šæœŸåšæ•´åº“å¤‡ä»½ã€‚è¿™é‡Œçš„â€œå®šæœŸâ€å–å†³äºç³»ç»Ÿçš„é‡è¦æ€§ï¼Œå¯ä»¥æ˜¯ä¸€å¤©ä¸€å¤‡ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€å‘¨ä¸€å¤‡ã€‚</p>
<p>å½“éœ€è¦æ¢å¤åˆ°æŒ‡å®šçš„æŸä¸€ç§’æ—¶ï¼Œæ¯”å¦‚æŸå¤©ä¸‹åˆä¸¤ç‚¹å‘ç°ä¸­åˆåäºŒç‚¹æœ‰ä¸€æ¬¡è¯¯åˆ è¡¨ï¼Œéœ€è¦æ‰¾å›æ•°æ®ï¼Œé‚£ä½ å¯ä»¥è¿™ä¹ˆåšï¼š</p>
<ul>
<li>é¦–å…ˆï¼Œæ‰¾åˆ°æœ€è¿‘çš„ä¸€æ¬¡å…¨é‡å¤‡ä»½ï¼Œå¦‚æœä½ è¿æ°”å¥½ï¼Œå¯èƒ½å°±æ˜¯æ˜¨å¤©æ™šä¸Šçš„ä¸€ä¸ªå¤‡ä»½ï¼Œä»è¿™ä¸ªå¤‡ä»½æ¢å¤åˆ°ä¸´æ—¶åº“ï¼›</li>
<li>ç„¶åï¼Œä»å¤‡ä»½çš„æ—¶é—´ç‚¹å¼€å§‹ï¼Œå°†å¤‡ä»½çš„binlogä¾æ¬¡å–å‡ºæ¥ï¼Œé‡æ”¾åˆ°ä¸­åˆè¯¯åˆ è¡¨ä¹‹å‰çš„é‚£ä¸ªæ—¶åˆ»ã€‚</li>
</ul>
<p>è¿™æ ·ä½ çš„ä¸´æ—¶åº“å°±è·Ÿè¯¯åˆ ä¹‹å‰çš„çº¿ä¸Šåº“ä¸€æ ·äº†ï¼Œç„¶åä½ å¯ä»¥æŠŠè¡¨æ•°æ®ä»ä¸´æ—¶åº“å–å‡ºæ¥ï¼ŒæŒ‰éœ€è¦æ¢å¤åˆ°çº¿ä¸Šåº“å»ã€‚</p>
</blockquote>
<p><strong>B.å¦‚æœä¸é‡‡ç”¨ä¸¤é˜¶æ®µæäº¤</strong></p>
<blockquote>
<ol>
<li><strong>å…ˆå†™redo logåå†™binlog</strong>ã€‚å‡è®¾åœ¨redo logå†™å®Œï¼Œbinlogè¿˜æ²¡æœ‰å†™å®Œçš„æ—¶å€™ï¼ŒMySQLè¿›ç¨‹å¼‚å¸¸é‡å¯ã€‚ç”±äºæˆ‘ä»¬å‰é¢è¯´è¿‡çš„ï¼Œredo logå†™å®Œä¹‹åï¼Œç³»ç»Ÿå³ä½¿å´©æºƒï¼Œä»ç„¶èƒ½å¤ŸæŠŠæ•°æ®æ¢å¤å›æ¥ï¼Œæ‰€ä»¥æ¢å¤åè¿™ä¸€è¡Œcçš„å€¼æ˜¯1ã€‚<br>  ä½†æ˜¯ç”±äºbinlogæ²¡å†™å®Œå°±crashäº†ï¼Œè¿™æ—¶å€™binlogé‡Œé¢å°±æ²¡æœ‰è®°å½•è¿™ä¸ªè¯­å¥ã€‚å› æ­¤ï¼Œä¹‹åå¤‡ä»½æ—¥å¿—çš„æ—¶å€™ï¼Œå­˜èµ·æ¥çš„binlogé‡Œé¢å°±æ²¡æœ‰è¿™æ¡è¯­å¥ã€‚<br>  ç„¶åä½ ä¼šå‘ç°ï¼Œå¦‚æœéœ€è¦ç”¨è¿™ä¸ªbinlogæ¥æ¢å¤ä¸´æ—¶åº“çš„è¯ï¼Œç”±äºè¿™ä¸ªè¯­å¥çš„binlogä¸¢å¤±ï¼Œè¿™ä¸ªä¸´æ—¶åº“å°±ä¼šå°‘äº†è¿™ä¸€æ¬¡æ›´æ–°ï¼Œæ¢å¤å‡ºæ¥çš„è¿™ä¸€è¡Œcçš„å€¼å°±æ˜¯0ï¼Œä¸åŸåº“çš„å€¼ä¸åŒã€‚</li>
<li><strong>å…ˆå†™binlogåå†™redo log</strong>ã€‚å¦‚æœåœ¨binlogå†™å®Œä¹‹åcrashï¼Œç”±äºredo logè¿˜æ²¡å†™ï¼Œå´©æºƒæ¢å¤ä»¥åè¿™ä¸ªäº‹åŠ¡æ— æ•ˆï¼Œæ‰€ä»¥è¿™ä¸€è¡Œcçš„å€¼æ˜¯0ã€‚ä½†æ˜¯binlogé‡Œé¢å·²ç»è®°å½•äº†â€œæŠŠcä»0æ”¹æˆ1â€è¿™ä¸ªæ—¥å¿—ã€‚æ‰€ä»¥ï¼Œåœ¨ä¹‹åç”¨binlogæ¥æ¢å¤çš„æ—¶å€™å°±å¤šäº†ä¸€ä¸ªäº‹åŠ¡å‡ºæ¥ï¼Œæ¢å¤å‡ºæ¥çš„è¿™ä¸€è¡Œcçš„å€¼å°±æ˜¯1ï¼Œä¸åŸåº“çš„å€¼ä¸åŒã€‚</li>
</ol>
</blockquote>
<p>éœ€è¦å†å¤šæ­å»ºä¸€äº›å¤‡åº“æ¥å¢åŠ ç³»ç»Ÿçš„è¯»èƒ½åŠ›çš„æ—¶å€™ï¼Œç°åœ¨å¸¸è§çš„åšæ³•ä¹Ÿæ˜¯ç”¨å…¨é‡å¤‡ä»½åŠ ä¸Šåº”ç”¨binlogæ¥å®ç°çš„</p>
<h3 id="1-3äº‹åŠ¡éš”ç¦»"><a href="#1-3äº‹åŠ¡éš”ç¦»" class="headerlink" title="1.3äº‹åŠ¡éš”ç¦»"></a>1.3äº‹åŠ¡éš”ç¦»</h3><h4 id="1-3-1éš”ç¦»æ€§ä¸éš”ç¦»çº§åˆ«"><a href="#1-3-1éš”ç¦»æ€§ä¸éš”ç¦»çº§åˆ«" class="headerlink" title="1.3.1éš”ç¦»æ€§ä¸éš”ç¦»çº§åˆ«"></a>1.3.1éš”ç¦»æ€§ä¸éš”ç¦»çº§åˆ«</h4><p>SQLæ ‡å‡†çš„äº‹åŠ¡éš”ç¦»çº§åˆ«åŒ…æ‹¬ï¼šè¯»æœªæäº¤ï¼ˆread uncommittedï¼‰ã€è¯»æäº¤ï¼ˆread committedï¼‰ã€å¯é‡å¤è¯»ï¼ˆrepeatable readï¼‰å’Œä¸²è¡ŒåŒ–ï¼ˆserializable ï¼‰</p>
<p>show variables æŸ¥çœ‹éš”ç¦»çº§åˆ« transaction-isolation</p>
<blockquote>
<ul>
<li>è¯»æœªæäº¤æ˜¯æŒ‡ï¼Œä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤æ—¶ï¼Œå®ƒåšçš„å˜æ›´å°±èƒ½è¢«åˆ«çš„äº‹åŠ¡çœ‹åˆ°ã€‚</li>
<li>è¯»æäº¤æ˜¯æŒ‡ï¼Œä¸€ä¸ªäº‹åŠ¡æäº¤ä¹‹åï¼Œå®ƒåšçš„å˜æ›´æ‰ä¼šè¢«å…¶ä»–äº‹åŠ¡çœ‹åˆ°ã€‚</li>
<li>å¯é‡å¤è¯»æ˜¯æŒ‡ï¼Œä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çœ‹åˆ°çš„æ•°æ®ï¼Œæ€»æ˜¯è·Ÿè¿™ä¸ªäº‹åŠ¡åœ¨å¯åŠ¨æ—¶çœ‹åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚å½“ç„¶åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œæœªæäº¤å˜æ›´å¯¹å…¶ä»–äº‹åŠ¡ä¹Ÿæ˜¯ä¸å¯è§çš„ã€‚</li>
<li>ä¸²è¡ŒåŒ–ï¼Œé¡¾åæ€ä¹‰æ˜¯å¯¹äºåŒä¸€è¡Œè®°å½•ï¼Œâ€œå†™â€ä¼šåŠ â€œå†™é”â€ï¼Œâ€œè¯»â€ä¼šåŠ â€œè¯»é”â€ã€‚å½“å‡ºç°è¯»å†™é”å†²çªçš„æ—¶å€™ï¼Œåè®¿é—®çš„äº‹åŠ¡å¿…é¡»ç­‰å‰ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚</li>
</ul>
</blockquote>
<h4 id="1-3-2-å¯é‡å¤è¯»çš„å®ç°"><a href="#1-3-2-å¯é‡å¤è¯»çš„å®ç°" class="headerlink" title="1.3.2 å¯é‡å¤è¯»çš„å®ç°"></a>1.3.2 å¯é‡å¤è¯»çš„å®ç°</h4><p>å‡è®¾ä¸€ä¸ªå€¼ä»1è¢«æŒ‰é¡ºåºæ”¹æˆäº†2ã€3ã€4ï¼Œåœ¨å›æ»šæ—¥å¿—é‡Œé¢å°±ä¼šæœ‰ç±»ä¼¼ä¸‹é¢çš„è®°å½•ã€‚</p>
<p><img src="/pic/mysql/%E4%BA%8B%E5%8A%A1.webp" alt="äº‹åŠ¡"></p>
<p>å½“å‰å€¼æ˜¯4ï¼Œä½†æ˜¯åœ¨æŸ¥è¯¢è¿™æ¡è®°å½•çš„æ—¶å€™ï¼Œä¸åŒæ—¶åˆ»å¯åŠ¨çš„äº‹åŠ¡ä¼šæœ‰ä¸åŒçš„read-viewã€‚å¦‚å›¾ä¸­çœ‹åˆ°çš„ï¼Œåœ¨è§†å›¾Aã€Bã€Cé‡Œé¢ï¼Œè¿™ä¸€ä¸ªè®°å½•çš„å€¼åˆ†åˆ«æ˜¯1ã€2ã€4ï¼ŒåŒä¸€æ¡è®°å½•åœ¨ç³»ç»Ÿä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªç‰ˆæœ¬ï¼Œå°±æ˜¯æ•°æ®åº“çš„å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰ã€‚å¯¹äºread-view Aï¼Œè¦å¾—åˆ°1ï¼Œå°±å¿…é¡»å°†å½“å‰å€¼ä¾æ¬¡æ‰§è¡Œå›¾ä¸­æ‰€æœ‰çš„å›æ»šæ“ä½œå¾—åˆ°ã€‚</p>
<p>åŒæ—¶ä½ ä¼šå‘ç°ï¼Œå³ä½¿ç°åœ¨æœ‰å¦å¤–ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨å°†4æ”¹æˆ5ï¼Œè¿™ä¸ªäº‹åŠ¡è·Ÿread-view Aã€Bã€Cå¯¹åº”çš„äº‹åŠ¡æ˜¯ä¸ä¼šå†²çªçš„ã€‚</p>
<p>ä½ ä¸€å®šä¼šé—®ï¼Œå›æ»šæ—¥å¿—æ€»ä¸èƒ½ä¸€ç›´ä¿ç•™å§ï¼Œä»€ä¹ˆæ—¶å€™åˆ é™¤å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œåœ¨ä¸éœ€è¦çš„æ—¶å€™æ‰åˆ é™¤ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç³»ç»Ÿä¼šåˆ¤æ–­ï¼Œå½“æ²¡æœ‰äº‹åŠ¡å†éœ€è¦ç”¨åˆ°è¿™äº›å›æ»šæ—¥å¿—æ—¶ï¼Œå›æ»šæ—¥å¿—ä¼šè¢«åˆ é™¤ã€‚</p>
<p>ä»€ä¹ˆæ—¶å€™æ‰ä¸éœ€è¦äº†å‘¢ï¼Ÿå°±æ˜¯å½“ç³»ç»Ÿé‡Œæ²¡æœ‰æ¯”è¿™ä¸ªå›æ»šæ—¥å¿—æ›´æ—©çš„read-viewçš„æ—¶å€™</p>
<h4 id="1-3-3-é•¿äº‹åŠ¡"><a href="#1-3-3-é•¿äº‹åŠ¡" class="headerlink" title="1.3.3 é•¿äº‹åŠ¡"></a>1.3.3 é•¿äº‹åŠ¡</h4><p>ä¸ºä»€ä¹ˆå°½é‡ä¸è¦ä½¿ç”¨é•¿äº‹åŠ¡ã€‚é•¿äº‹åŠ¡æ„å‘³ç€ç³»ç»Ÿé‡Œé¢ä¼šå­˜åœ¨å¾ˆè€çš„äº‹åŠ¡è§†å›¾ï¼Œåœ¨è¿™ä¸ªäº‹åŠ¡æäº¤ä¹‹å‰ï¼Œå›æ»šè®°å½•éƒ½è¦ä¿ç•™ï¼Œè¿™ä¼šå¯¼è‡´å¤§é‡å ç”¨å­˜å‚¨ç©ºé—´ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œé•¿äº‹åŠ¡è¿˜å ç”¨é”èµ„æºï¼Œå¯èƒ½ä¼šæ‹–å®åº“ã€‚</p>
<h3 id="1-4ç´¢å¼•"><a href="#1-4ç´¢å¼•" class="headerlink" title="1.4ç´¢å¼•"></a>1.4ç´¢å¼•</h3><h4 id="1-4-1-ç´¢å¼•æ¨¡å‹"><a href="#1-4-1-ç´¢å¼•æ¨¡å‹" class="headerlink" title="1.4.1 ç´¢å¼•æ¨¡å‹"></a>1.4.1 ç´¢å¼•æ¨¡å‹</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> T(</span><br><span class="line">id <span class="type">int</span> <span class="keyword">primary</span> key, </span><br><span class="line">k <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span>, </span><br><span class="line">name <span class="type">varchar</span>(<span class="number">16</span>),</span><br><span class="line">index (k))engine<span class="operator">=</span>InnoDB;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>å¦‚æœè¯­å¥æ˜¯select * from T where ID&#x3D;500ï¼Œå³ä¸»é”®æŸ¥è¯¢æ–¹å¼ï¼Œåˆ™åªéœ€è¦æœç´¢IDè¿™æ£µB+æ ‘ï¼›</li>
<li>å¦‚æœè¯­å¥æ˜¯select * from T where k&#x3D;5ï¼Œå³æ™®é€šç´¢å¼•æŸ¥è¯¢æ–¹å¼ï¼Œåˆ™éœ€è¦å…ˆæœç´¢kç´¢å¼•æ ‘ï¼Œå¾—åˆ°IDçš„å€¼ä¸º500ï¼Œå†åˆ°IDç´¢å¼•æ ‘æœç´¢ä¸€æ¬¡ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå›è¡¨ã€‚</li>
</ul>
</blockquote>
<h4 id="1-4-2-ç´¢å¼•ç»´æŠ¤"><a href="#1-4-2-ç´¢å¼•ç»´æŠ¤" class="headerlink" title="1.4.2 ç´¢å¼•ç»´æŠ¤"></a>1.4.2 ç´¢å¼•ç»´æŠ¤</h4><blockquote>
<p>é¡µåˆ†è£‚ ï¼šä¸€ä¸ªæ•°æ®é¡µæ»¡äº†ï¼ŒæŒ‰ç…§B+Treeç®—æ³•ï¼Œæ–°å¢åŠ ä¸€ä¸ªæ•°æ®é¡µï¼Œå«åšé¡µåˆ†è£‚ï¼Œä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚ç©ºé—´åˆ©ç”¨ç‡é™ä½å¤§æ¦‚50%ã€‚å½“ç›¸é‚»çš„ä¸¤ä¸ªæ•°æ®é¡µåˆ©ç”¨ç‡å¾ˆä½çš„æ—¶å€™ä¼šåšæ•°æ®é¡µåˆå¹¶ï¼Œåˆå¹¶çš„è¿‡ç¨‹æ˜¯åˆ†è£‚è¿‡ç¨‹çš„é€†è¿‡ç¨‹ã€‚</p>
</blockquote>
<p>æ‰€ä»¥ä¸€èˆ¬éœ€è¦ä½¿ç”¨è‡ªå¢ä¸»é”®</p>
<p><strong>ä¸»é”®é•¿åº¦è¶Šå°ï¼Œæ™®é€šç´¢å¼•çš„å¶å­èŠ‚ç‚¹å°±è¶Šå°ï¼Œæ™®é€šç´¢å¼•å ç”¨çš„ç©ºé—´ä¹Ÿå°±è¶Šå°ã€‚</strong></p>
]]></content>
      <categories>
        <category>sql</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>minio</title>
    <url>/2023/01/07/minio/</url>
    <content><![CDATA[<h1 id="minio"><a href="#minio" class="headerlink" title="minio"></a>minio</h1><h2 id="1-dockeréƒ¨ç½²minio"><a href="#1-dockeréƒ¨ç½²minio" class="headerlink" title="1.dockeréƒ¨ç½²minio"></a>1.dockeréƒ¨ç½²minio</h2><p>1.1æ‹‰å–é•œåƒ</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker pull minio/minio</span><br><span class="line"></span><br><span class="line">docker images</span><br></pre></td></tr></table></figure>





<p>1.2.åˆ›å»ºç›®å½•</p>
<blockquote>
<p>ä¸€ä¸ªç”¨æ¥å­˜æ”¾é…ç½®ï¼Œä¸€ä¸ªç”¨æ¥å­˜å‚¨ä¸Šä¼ æ–‡ä»¶çš„ç›®å½•</p>
<p>å¯åŠ¨å‰éœ€è¦å…ˆåˆ›å»ºMinioå¤–éƒ¨æŒ‚è½½çš„é…ç½®æ–‡ä»¶ï¼ˆ &#x2F;home&#x2F;minio&#x2F;configï¼‰,</p>
<p>å’Œå­˜å‚¨ä¸Šä¼ æ–‡ä»¶çš„ç›®å½•ï¼ˆ &#x2F;home&#x2F;minio&#x2F;dataï¼‰</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir -p /home/minio/config</span><br><span class="line">mkdir -p /home/minio/data</span><br></pre></td></tr></table></figure>



<p>1.3å¯åŠ¨</p>
<p>å•è¡Œä»£ç ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -p 9000:9000 -p 9090:9090      --net=host      --name minio      -d --restart=always      -e &quot;MINIO_ACCESS_KEY=minioadmin&quot;      -e &quot;MINIO_SECRET_KEY=minioadmin&quot;      -v /home/minio/data:/data      -v /home/minio/config:/root/.minio      minio/minio server      /data --console-address &quot;:9090&quot; -address &quot;:9000&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¤šè¡Œä»£ç ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -p 9000:9000 -p 9090:9090 \</span><br><span class="line">     --net=host \</span><br><span class="line">     --name minio \</span><br><span class="line">     -d --restart=always \</span><br><span class="line">     -e &quot;MINIO_ACCESS_KEY=minioadmin&quot; \</span><br><span class="line">     -e &quot;MINIO_SECRET_KEY=minioadmin&quot; \</span><br><span class="line">     -v /home/minio/data:/data \</span><br><span class="line">     -v /home/minio/config:/root/.minio \</span><br><span class="line">     minio/minio server \</span><br><span class="line">     /data --console-address &quot;:9090&quot; -address &quot;:9000&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>9090ç«¯å£æŒ‡çš„æ˜¯minioçš„å®¢æˆ·ç«¯ç«¯å£</p>
<p>MINIO_ACCESS_KEY ï¼šè´¦å·</p>
<p>MINIO_SECRET_KEY ï¼šå¯†ç ï¼ˆè´¦å·é•¿åº¦å¿…é¡»å¤§äºç­‰äº5ï¼Œå¯†ç é•¿åº¦å¿…é¡»å¤§äºç­‰äº8ä½ï¼‰</p>
</blockquote>
<p>1.4åˆ›å»ºç”¨æˆ·</p>
<blockquote>
<p>admin admin123456</p>
</blockquote>
<blockquote>
<p> Service Account  </p>
<p> [{â€œaccess_keyâ€:â€ZBT79S0EA7P41R77GEY1â€,â€secret_keyâ€:â€GdsL5YzILY2glg4L2ez1eY4kVVLXeX2+L5IRryELâ€}]}</p>
<p> key  12345678</p>
</blockquote>
<h2 id="2-springbootæ•´åˆ"><a href="#2-springbootæ•´åˆ" class="headerlink" title="2.springbootæ•´åˆ"></a>2.springbootæ•´åˆ</h2><h3 id="1-pom"><a href="#1-pom" class="headerlink" title="1.pom"></a>1.pom</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">&lt;dependency&gt;</span></span><br><span class="line">            <span class="string">&lt;groupId&gt;io.minio&lt;/groupId&gt;</span></span><br><span class="line">            <span class="string">&lt;artifactId&gt;minio&lt;/artifactId&gt;</span></span><br><span class="line">            <span class="string">&lt;version&gt;7.0.2&lt;/version&gt;</span></span><br><span class="line">        <span class="string">&lt;/dependency&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">&lt;dependency&gt;</span></span><br><span class="line">            <span class="string">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line">            <span class="string">&lt;artifactId&gt;spring-boot-test&lt;/artifactId&gt;</span></span><br><span class="line">            <span class="string">&lt;version&gt;2.3.2.RELEASE&lt;/version&gt;</span></span><br><span class="line">        <span class="string">&lt;/dependency&gt;</span></span><br><span class="line">        <span class="string">&lt;dependency&gt;</span></span><br><span class="line">            <span class="string">&lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span></span><br><span class="line">            <span class="string">&lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;</span></span><br><span class="line">            <span class="string">&lt;version&gt;2.8.0&lt;/version&gt;</span></span><br><span class="line">        <span class="string">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="2-MinioProperties"><a href="#2-MinioProperties" class="headerlink" title="2.MinioProperties"></a>2.MinioProperties</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.project.minio.properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> biyc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 13:10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;minio&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxIdlePerKey</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** å¯¹è±¡æ± æ¯ä¸ªkeyæœ€å¤§å®ä¾‹åŒ–å¯¹è±¡æ•° */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxTotalPerKey</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Long</span> <span class="variable">maxWaitMillis</span> <span class="operator">=</span> <span class="number">3000L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Long</span> <span class="variable">softMinEvictableIdleTimeMillis</span> <span class="operator">=</span> <span class="number">3</span> * <span class="number">60</span> * <span class="number">1000L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">endpoint</span> <span class="operator">=</span> <span class="string">&quot;http://192.168.17.100&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">9000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">accessKey</span> <span class="operator">=</span> <span class="string">&quot;key&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">secretKey</span> <span class="operator">=</span> <span class="string">&quot;12345678&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">secure</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-MinioUtil"><a href="#3-MinioUtil" class="headerlink" title="3.MinioUtil"></a>3.MinioUtil</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.project.minio.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.RandomUtil;</span><br><span class="line"><span class="keyword">import</span> com.project.minio.properties.MinioProperties;</span><br><span class="line"><span class="keyword">import</span> io.minio.MinioClient;</span><br><span class="line"><span class="keyword">import</span> io.minio.ObjectStat;</span><br><span class="line"><span class="keyword">import</span> io.minio.PutObjectOptions;</span><br><span class="line"><span class="keyword">import</span> io.minio.Result;</span><br><span class="line"><span class="keyword">import</span> io.minio.messages.Bucket;</span><br><span class="line"><span class="keyword">import</span> io.minio.messages.Item;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.pool2.BaseKeyedPooledObjectFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.pool2.PooledObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.pool2.impl.DefaultPooledObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.pool2.impl.GenericKeyedObjectPool;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.pool2.impl.GenericKeyedObjectPoolConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> biyc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/5 18:09</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioUtil</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        minioProperties = applicationContext.getBean(MinioProperties.class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> MinioProperties minioProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** å¯¹è±¡æ±  */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> GenericKeyedObjectPool&lt;String, MinioClient&gt; pool;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** å¯¹è±¡æ± çš„å‚æ•°è®¾ç½® */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">GenericKeyedObjectPoolConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericKeyedObjectPoolConfig</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; DEFAULT_KEY_LIST = Arrays.asList(<span class="string">&quot;DEFAULT_KEY_1&quot;</span>, <span class="string">&quot;DEFAULT_KEY_2&quot;</span>, <span class="string">&quot;DEFAULT_KEY_3&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–å¯¹è±¡æ± </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        config.setMaxIdlePerKey(minioProperties.getMaxIdlePerKey());</span><br><span class="line">        config.setMaxTotalPerKey(minioProperties.getMaxTotalPerKey());</span><br><span class="line">        <span class="comment">/** æ”¯æŒjmxç®¡ç†æ‰©å±• */</span></span><br><span class="line">        config.setJmxEnabled(<span class="literal">true</span>);</span><br><span class="line">        config.setJmxNamePrefix(<span class="string">&quot;MinioClientPool&quot;</span>);</span><br><span class="line">        <span class="comment">/** ä¿è¯è·å–æœ‰æ•ˆçš„æ± å¯¹è±¡ */</span></span><br><span class="line">        config.setTestOnBorrow(<span class="literal">true</span>);</span><br><span class="line">        config.setTestOnReturn(<span class="literal">false</span>);</span><br><span class="line">        config.setMaxWaitMillis(minioProperties.getMaxWaitMillis());</span><br><span class="line">        config.setTestWhileIdle(<span class="literal">true</span>);</span><br><span class="line">        config.setSoftMinEvictableIdleTimeMillis(minioProperties.getSoftMinEvictableIdleTimeMillis());</span><br><span class="line"></span><br><span class="line">        pool = <span class="keyword">new</span> <span class="title class_">GenericKeyedObjectPool</span>&lt;String, MinioClient&gt;(<span class="keyword">new</span> <span class="title class_">MinioClientPooledFactory</span>(), config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ********************************************* æ¡¶ç›¸å…³ *********************************************************</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºæ¡¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucketName</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createBucket</span><span class="params">(String bucketName)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">MinioClient</span> <span class="variable">client</span> <span class="operator">=</span> getClient();</span><br><span class="line">            <span class="keyword">if</span> (!client.bucketExists(bucketName)) &#123;</span><br><span class="line">                client.makeBucket(bucketName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;åˆ›å»ºæ¡¶å¤±è´¥:&#123;&#125;&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–æ‰€æœ‰æ¡¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Bucket&gt; <span class="title function_">getAllBuckets</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">MinioClient</span> <span class="variable">client</span> <span class="operator">=</span> getClient();</span><br><span class="line">        <span class="keyword">return</span> client.listBuckets();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç§»é™¤æ¡¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucketName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeBucket</span><span class="params">(String bucketName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">MinioClient</span> <span class="variable">client</span> <span class="operator">=</span> getClient();</span><br><span class="line">        client.removeBucket(bucketName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ********************************************* æ–‡ä»¶ç›¸å…³ *********************************************************</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucketName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dirName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mkdir</span><span class="params">(String bucketName, String dirName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        upload(bucketName, dirName, <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;), <span class="keyword">new</span> <span class="title class_">PutObjectOptions</span>(<span class="number">0</span>, -<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ¤æ–­æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucketName    æ¡¶åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> prefix        æ–‡ä»¶å¤¹åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="type">boolean</span> <span class="title function_">doesFolderExist</span><span class="params">(String bucketName, String prefix)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">MinioClient</span> <span class="variable">client</span> <span class="operator">=</span> getClient();</span><br><span class="line">        Iterable&lt;Result&lt;Item&gt;&gt; results = client.listObjects(bucketName, prefix, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">for</span> (Result&lt;Item&gt; itemResult : results) &#123;</span><br><span class="line">            <span class="type">Item</span> <span class="variable">item</span> <span class="operator">=</span> itemResult.get();</span><br><span class="line">            <span class="keyword">if</span> (item.isDir() &amp;&amp; <span class="literal">null</span> != prefix &amp;&amp; prefix.equals(item.objectName())) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucketName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="type">boolean</span> <span class="title function_">doesObjectExist</span><span class="params">(String bucketName, String objectName)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">exist</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">MinioClient</span> <span class="variable">client</span> <span class="operator">=</span> getClient();</span><br><span class="line">            <span class="comment">// æœªæŠ›å‡ºå¼‚å¸¸è¡¨ç¤ºæ–‡ä»¶å­˜åœ¨</span></span><br><span class="line">            <span class="type">ObjectStat</span> <span class="variable">objectStat</span> <span class="operator">=</span> client.statObject(bucketName, objectName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            exist = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> exist;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ********************************************* æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ç›¸å…³ *********************************************************</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»¥æ–‡ä»¶çš„æ–¹å¼ä¸Šä¼ æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucketName    æ¡¶åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName    æ–‡ä»¶å¤¹åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filename      æ–‡ä»¶åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">(String bucketName, String objectName, String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        upload(bucketName, objectName, filename, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»¥æ–‡ä»¶çš„æ–¹å¼ä¸Šä¼ æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucketName    æ¡¶åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName    æ–‡ä»¶å¤¹åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filename      æ–‡ä»¶åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> options</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">(String bucketName, String objectName, String filename, PutObjectOptions options)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span> getClient();</span><br><span class="line">        minioClient.putObject(bucketName, objectName, filename, options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»¥æ–‡ä»¶çš„æ–¹å¼ä¸Šä¼ æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucketName    æ¡¶åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName    æ–‡ä»¶å¤¹åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file          æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">(String bucketName, String objectName, MultipartFile file)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        upload(bucketName, objectName, file, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»¥æ–‡ä»¶çš„æ–¹å¼ä¸Šä¼ æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucketName    æ¡¶åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName    æ–‡ä»¶å¤¹åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file          æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> options</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">(String bucketName, String objectName, MultipartFile file, PutObjectOptions options)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        upload(bucketName, objectName, file.getInputStream(), options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»¥æµçš„æ–¹å¼ä¸Šä¼ æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucketName    æ¡¶åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName    æ–‡ä»¶å¤¹åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inputStream   æµ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">(String bucketName, String objectName, InputStream inputStream)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        upload(bucketName, objectName, inputStream, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»¥æµçš„æ–¹å¼ä¸Šä¼ æ–‡ä»¶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucketName    æ¡¶åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName    æ–‡ä»¶å¤¹åç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inputStream   æµ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> options</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">(String bucketName, String objectName, InputStream inputStream, PutObjectOptions options)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">MinioClient</span> <span class="variable">client</span> <span class="operator">=</span> getClient();</span><br><span class="line">        client.putObject(bucketName, objectName, inputStream, options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–æ–‡ä»¶æµ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucketName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> InputStream <span class="title function_">getFileStream</span><span class="params">(String bucketName, String objectName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> getClient().getObject(bucketName, objectName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä»å¯¹è±¡æ± ä¸­è·å–å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> MinioClient <span class="title function_">getClient</span><span class="params">(String key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> pool.borrowObject(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MinioClient <span class="title function_">getClient</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> pool.borrowObject(DEFAULT_KEY_LIST.get(RandomUtil.randomInt(<span class="number">0</span>, <span class="number">3</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å…³é—­å¯¹è±¡æ± </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pool != <span class="literal">null</span> &amp;&amp; !pool.isClosed()) &#123;</span><br><span class="line">            pool.close();</span><br><span class="line">            pool = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">MinioClientPooledFactory</span> <span class="keyword">extends</span> <span class="title class_">BaseKeyedPooledObjectFactory</span>&lt;String, MinioClient&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> MinioClient <span class="title function_">create</span><span class="params">(String key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MinioClient</span>(minioProperties.getEndpoint(),minioProperties.getPort(),</span><br><span class="line">                    minioProperties.getAccessKey(), minioProperties.getSecretKey(),minioProperties.isSecure());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> PooledObject&lt;MinioClient&gt; <span class="title function_">wrap</span><span class="params">(MinioClient minioClient)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultPooledObject</span>&lt;MinioClient&gt;(minioClient);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="4-è°ƒç”¨"><a href="#4-è°ƒç”¨" class="headerlink" title="4.è°ƒç”¨"></a>4.è°ƒç”¨</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/minio&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MinioUtil minioUtil;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        minioUtil.upload(<span class="string">&quot;public&quot;</span>, <span class="string">&quot;flod/hhh1.txt&quot;</span>, <span class="string">&quot;C:/Users/17432/Desktop/æ— äººæœº.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;download&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">download</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;testfileName&quot;</span>;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> minioUtil.getFileStream(<span class="string">&quot;public&quot;</span>, <span class="string">&quot;flod/hhh1.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> File.createTempFile(fileName, <span class="string">&quot;.txt&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file);</span><br><span class="line">        <span class="type">int</span> length;</span><br><span class="line">        <span class="keyword">while</span> ((length= inputStream.read(b))&gt;<span class="number">0</span>) &#123;</span><br><span class="line">            fos.write(b,<span class="number">0</span>,length);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        List&lt;CapitalDTO&gt; capitalDTOList = new ExcelAnalysisHelper().getList(file, CapitalDTO.class, 0, 1);</span></span><br><span class="line">        System.out.println(<span class="string">&quot;ä¸‹è½½æˆåŠŸï¼Œæ–‡ä»¶åœ°å€ï¼š&quot;</span>+file.getPath());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-è¯»å–å‡ºexcelå®ä½“ç±»"><a href="#3-è¯»å–å‡ºexcelå®ä½“ç±»" class="headerlink" title="3.è¯»å–å‡ºexcelå®ä½“ç±»"></a>3.è¯»å–å‡ºexcelå®ä½“ç±»</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">&lt;dependency&gt;</span></span><br><span class="line">  <span class="string">&lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span></span><br><span class="line">  <span class="string">&lt;artifactId&gt;easyexcel&lt;/artifactId&gt;</span></span><br><span class="line">  <span class="string">&lt;version&gt;2.2.7&lt;/version&gt;</span></span><br><span class="line"><span class="string">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="1-listener-gt-MergeDataListener"><a href="#1-listener-gt-MergeDataListener" class="headerlink" title="1.listener -&gt; MergeDataListener"></a>1.listener -&gt; MergeDataListener</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.project.minio.listener;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.excel.context.AnalysisContext;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.excel.event.AnalysisEventListener;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.excel.metadata.CellExtra;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MergeDataListener</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">AnalysisEventListener</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è§£æçš„æ•°æ®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;T&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ­£æ–‡èµ·å§‹è¡Œ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer headRowNumber;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå¹¶å•å…ƒæ ¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;CellExtra&gt; extraMergeInfoList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MergeDataListener</span><span class="params">(Integer headRowNumber)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.headRowNumber = headRowNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿™ä¸ªæ¯ä¸€æ¡æ•°æ®è§£æéƒ½ä¼šæ¥è°ƒç”¨</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data    one row value. Is is same as &#123;<span class="doctag">@link</span> AnalysisContext#readRowHolder()&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(T data, AnalysisContext context)</span> &#123;</span><br><span class="line"><span class="comment">//        log.info(&quot;è§£æåˆ°ä¸€æ¡æ•°æ®:&#123;&#125;&quot;, JSON.toJSONString(data));</span></span><br><span class="line">        list.add(data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰€æœ‰æ•°æ®è§£æå®Œæˆäº† éƒ½ä¼šæ¥è°ƒç”¨</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAfterAllAnalysed</span><span class="params">(AnalysisContext context)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;æ‰€æœ‰æ•°æ®è§£æå®Œæˆï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŠ ä¸Šå­˜å‚¨æ•°æ®åº“</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;T&gt; <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">extra</span><span class="params">(CellExtra extra, AnalysisContext context)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (extra.getType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> COMMENT: &#123;</span><br><span class="line">                log.info(<span class="string">&quot;æ‰¹æ³¨,åœ¨rowIndex:&#123;&#125;,columnIndex;&#123;&#125;,å†…å®¹æ˜¯:&#123;&#125;&quot;</span>, extra.getRowIndex(), extra.getColumnIndex(), extra.getText());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> HYPERLINK: &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;Sheet1!A1&quot;</span>.equals(extra.getText())) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;è¶…é“¾æ¥,åœ¨rowIndex:&#123;&#125;,columnIndex;&#123;&#125;,å†…å®¹æ˜¯:&#123;&#125;&quot;</span>, extra.getRowIndex(), extra.getColumnIndex(), extra.getText());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;Sheet2!A1&quot;</span>.equals(extra.getText())) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;è¶…é“¾æ¥,è€Œä¸”è¦†ç›–äº†ä¸€ä¸ªåŒºé—´,åœ¨firstRowIndex:&#123;&#125;,firstColumnIndex;&#123;&#125;,lastRowIndex:&#123;&#125;,lastColumnIndex:&#123;&#125;,å†…å®¹æ˜¯:&#123;&#125;&quot;</span>,</span><br><span class="line">                            extra.getFirstRowIndex(), extra.getFirstColumnIndex(), extra.getLastRowIndex(),</span><br><span class="line">                            extra.getLastColumnIndex(), extra.getText());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;Unknown hyperlink!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> MERGE: &#123;</span><br><span class="line">                log.info(<span class="string">&quot;åˆå¹¶å•å…ƒæ ¼,è€Œä¸”è¦†ç›–äº†ä¸€ä¸ªåŒºé—´,åœ¨firstRowIndex:&#123;&#125;,firstColumnIndex;&#123;&#125;,lastRowIndex:&#123;&#125;,lastColumnIndex:&#123;&#125;&quot;</span>,</span><br><span class="line">                        extra.getFirstRowIndex(), extra.getFirstColumnIndex(), extra.getLastRowIndex(),</span><br><span class="line">                        extra.getLastColumnIndex());</span><br><span class="line">                <span class="keyword">if</span> (extra.getRowIndex() &gt;= headRowNumber) &#123;</span><br><span class="line">                    extraMergeInfoList.add(extra);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">default</span>: &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;CellExtra&gt; <span class="title function_">getExtraMergeInfoList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> extraMergeInfoList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-util-gt-ExcelAnalysisHelper"><a href="#2-util-gt-ExcelAnalysisHelper" class="headerlink" title="2.util -&gt; ExcelAnalysisHelper"></a>2.util -&gt; ExcelAnalysisHelper</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.project.minio.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.collection.CollectionUtil;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.excel.EasyExcel;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.excel.annotation.ExcelProperty;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.excel.enums.CellExtraTypeEnum;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.excel.metadata.CellExtra;</span><br><span class="line"><span class="keyword">import</span> com.project.minio.listener.MergeDataListener;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤„ç†åˆå¹¶å•å…ƒæ ¼ï¼Œè¿”å›æ‰å¹³åŒ–ç»“æ„çš„å®ä½“ç±»åˆ—è¡¨</span></span><br><span class="line"><span class="comment"> * å»ºè®®åŠ ä¸€ä¸ªåºå·åˆ—</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> biyc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/9/6 10:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExcelAnalysisHelper</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;T&gt; <span class="title function_">getList</span><span class="params">(File file, Class&lt;T&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getList(file, clazz, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;T&gt; <span class="title function_">getList</span><span class="params">(File file, Class&lt;T&gt; clazz, Integer sheetNo, Integer headRowNumber)</span> &#123;</span><br><span class="line">        MergeDataListener&lt;T&gt; listener = <span class="keyword">new</span> <span class="title class_">MergeDataListener</span>&lt;&gt;(headRowNumber);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            EasyExcel.read(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file), clazz, listener).extraRead(CellExtraTypeEnum.MERGE).sheet(sheetNo).headRowNumber(headRowNumber).doRead();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;CellExtra&gt; extraMergeInfoList = listener.getExtraMergeInfoList();</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtil.isEmpty(extraMergeInfoList)) &#123;</span><br><span class="line">            <span class="keyword">return</span> listener.getData();</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;T&gt; data = explainMergeData(listener.getData(), extraMergeInfoList, headRowNumber);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†åˆå¹¶å•å…ƒæ ¼</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data               è§£ææ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> extraMergeInfoList åˆå¹¶å•å…ƒæ ¼ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> headRowNumber      èµ·å§‹è¡Œ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> å¡«å……å¥½çš„è§£ææ•°æ®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; <span class="title function_">explainMergeData</span><span class="params">(List&lt;T&gt; data, List&lt;CellExtra&gt; extraMergeInfoList, Integer headRowNumber)</span> &#123;</span><br><span class="line">        <span class="comment">// å¾ªç¯æ‰€æœ‰åˆå¹¶å•å…ƒæ ¼ä¿¡æ¯</span></span><br><span class="line">        extraMergeInfoList.forEach(cellExtra -&gt; &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">firstRowIndex</span> <span class="operator">=</span> cellExtra.getFirstRowIndex() - headRowNumber;</span><br><span class="line">            <span class="type">int</span> <span class="variable">lastRowIndex</span> <span class="operator">=</span> cellExtra.getLastRowIndex() - headRowNumber;</span><br><span class="line">            <span class="type">int</span> <span class="variable">firstColumnIndex</span> <span class="operator">=</span> cellExtra.getFirstColumnIndex();</span><br><span class="line">            <span class="type">int</span> <span class="variable">lastColumnIndex</span> <span class="operator">=</span> cellExtra.getLastColumnIndex();</span><br><span class="line">            <span class="comment">// è·å–åˆå§‹å€¼</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">initValue</span> <span class="operator">=</span> getInitValueFromList(firstRowIndex, firstColumnIndex, data);</span><br><span class="line">            <span class="comment">// è®¾ç½®å€¼</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> firstRowIndex; i &lt;= lastRowIndex; i++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> firstColumnIndex; j &lt;= lastColumnIndex; j++) &#123;</span><br><span class="line">                    setInitValueToList(initValue, i, j, data);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¾ç½®åˆå¹¶å•å…ƒæ ¼çš„å€¼</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filedValue  å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rowIndex    è¡Œ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> columnIndex åˆ—</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data        è§£ææ•°æ®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setInitValueToList</span><span class="params">(Object filedValue, Integer rowIndex, Integer columnIndex, List&lt;T&gt; data)</span> &#123;</span><br><span class="line">        <span class="type">T</span> <span class="variable">object</span> <span class="operator">=</span> data.get(rowIndex);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Field field : object.getClass().getDeclaredFields()) &#123;</span><br><span class="line">            <span class="comment">// æå‡åå°„æ€§èƒ½ï¼Œå…³é—­å®‰å…¨æ£€æŸ¥</span></span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">ExcelProperty</span> <span class="variable">annotation</span> <span class="operator">=</span> field.getAnnotation(ExcelProperty.class);</span><br><span class="line">            <span class="keyword">if</span> (annotation != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (annotation.index() == columnIndex) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        field.set(object, filedValue);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;è§£ææ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸!&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–åˆå¹¶å•å…ƒæ ¼çš„åˆå§‹å€¼</span></span><br><span class="line"><span class="comment">     * rowIndexå¯¹åº”listçš„ç´¢å¼•</span></span><br><span class="line"><span class="comment">     * columnIndexå¯¹åº”å®ä½“å†…çš„å­—æ®µ</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> firstRowIndex    èµ·å§‹è¡Œ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> firstColumnIndex èµ·å§‹åˆ—</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data             åˆ—æ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> åˆå§‹å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">getInitValueFromList</span><span class="params">(Integer firstRowIndex, Integer firstColumnIndex, List&lt;T&gt; data)</span> &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">filedValue</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">T</span> <span class="variable">object</span> <span class="operator">=</span> data.get(firstRowIndex);</span><br><span class="line">        <span class="keyword">for</span> (Field field : object.getClass().getDeclaredFields()) &#123;</span><br><span class="line">            <span class="comment">//æå‡åå°„æ€§èƒ½ï¼Œå…³é—­å®‰å…¨æ£€æŸ¥</span></span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">ExcelProperty</span> <span class="variable">annotation</span> <span class="operator">=</span> field.getAnnotation(ExcelProperty.class);</span><br><span class="line">            <span class="keyword">if</span> (annotation != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (annotation.index() == firstColumnIndex) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        filedValue = field.get(object);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;è§£ææ•°æ®æ—¶å‘ç”Ÿå¼‚å¸¸!&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> filedValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="3-è°ƒç”¨"><a href="#3-è°ƒç”¨" class="headerlink" title="3.è°ƒç”¨"></a>3.è°ƒç”¨</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;downloadExcel&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;IotProductDTO&gt; <span class="title function_">downloadExcel</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">&quot;iot-pro&quot;</span>;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> minioUtil.getFileStream(<span class="string">&quot;public&quot;</span>, <span class="string">&quot;flod/iot_product_t_20230110.xlsx&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> File.createTempFile(fileName, <span class="string">&quot;.xlsx&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file);</span><br><span class="line">        <span class="type">int</span> length;</span><br><span class="line">        <span class="keyword">while</span> ((length= inputStream.read(b))&gt;<span class="number">0</span>) &#123;</span><br><span class="line">            fos.write(b,<span class="number">0</span>,length);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;IotProductDTO&gt; list = <span class="keyword">new</span> <span class="title class_">ExcelAnalysisHelper</span>().getList(file, IotProductDTO.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;ä¸‹è½½æˆåŠŸï¼Œæ–‡ä»¶åœ°å€ï¼š&quot;</span>+file.getPath());</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>è¿ç»´</category>
      </categories>
      <tags>
        <tag>minio</tag>
      </tags>
  </entry>
  <entry>
    <title>redis</title>
    <url>/2023/01/15/redis/</url>
    <content><![CDATA[<h1 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h1><h2 id="1-æ’è¡Œæ¦œ-zset"><a href="#1-æ’è¡Œæ¦œ-zset" class="headerlink" title="1.æ’è¡Œæ¦œ (zset)"></a>1.æ’è¡Œæ¦œ (zset)</h2><blockquote>
<p>ä»å°åˆ°å¤§ 0-10æ¡      .range(REDIS_KEY_RANKING, 0, 10)</p>
<p>ä»å¤§åˆ°å° 0-10æ¡      .reverseRange(REDIS_KEY_RANKING, 0, 10)</p>
<p>æ•´ä¸ªé›†åˆçš„æ•°é‡      .zCard(REDIS_KEY_RANKING)</p>
<p>åˆ†æ•°åœ¨2000 ~ 5000çš„äºº    .count(REDIS_KEY_RANKING, 2000, 5000)</p>
<p>å¢åŠ ä¸€ä¸ªäºº               .add(REDIS_KEY_RANKING,â€æå››â€,10000001)</p>
<p>åŠ åˆ†                            .incrementScore(REDIS_KEY_RANKING, â€œæå››â€, 1000)</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.project.redis.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.RandomUtil;</span><br><span class="line"><span class="keyword">import</span> com.project.redis.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> NieZiHan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/1/15 15:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;ranking&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RankingController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_KEY_RANKING</span> <span class="operator">=</span> <span class="string">&quot;RANKING&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;getRanking&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span>  <span class="title function_">getRanking</span><span class="params">()</span>&#123;</span><br><span class="line">        Set&lt;User&gt; userHashSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">score</span> <span class="operator">=</span> RandomUtil.randomInt(<span class="number">100000</span>);</span><br><span class="line">            userHashSet.add(<span class="keyword">new</span> <span class="title class_">User</span>(RandomUtil.randomString(<span class="number">5</span>),<span class="string">&quot;å¼ ä¸‰&quot;</span>+ score,score));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        userHashSet.stream().map(user -&gt; stringRedisTemplate.opsForZSet().add(REDIS_KEY_RANKING,user.getId()+<span class="string">&quot;:&quot;</span>+user.getName(),user.getScore())).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»å°åˆ°å¤§ 0-10æ¡</span></span><br><span class="line">        Set&lt;String&gt; set = stringRedisTemplate.opsForZSet().range(REDIS_KEY_RANKING, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ä»å°åˆ°å¤§ 0-10æ¡ï¼š&quot;</span>+ set);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»å¤§åˆ°å° 0-10æ¡</span></span><br><span class="line">        Set&lt;String&gt; set2 = stringRedisTemplate.opsForZSet().reverseRange(REDIS_KEY_RANKING, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ä»å¤§åˆ°å° 0-10æ¡ï¼š&quot;</span>+ set2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ•´ä¸ªé›†åˆçš„æ•°é‡</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().zCard(REDIS_KEY_RANKING);</span><br><span class="line">        System.out.println(<span class="string">&quot;æ•´ä¸ªé›†åˆçš„æ•°é‡ï¼š&quot;</span>+ count);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ†æ•°åœ¨2000 ~ 5000çš„äºº</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">countUser</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().count(REDIS_KEY_RANKING, <span class="number">2000</span>, <span class="number">5000</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;åˆ†æ•°åœ¨2000 ~ 5000çš„äººï¼š&quot;</span>+countUser);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¢åŠ ä¸€ä¸ªäºº</span></span><br><span class="line">        stringRedisTemplate.opsForZSet().add(REDIS_KEY_RANKING,<span class="string">&quot;æå››&quot;</span>,<span class="number">10000001</span>);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">sort</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().reverseRank(REDIS_KEY_RANKING, <span class="string">&quot;æå››&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;æå››åœ¨é›†åˆçš„æ’åºï¼š&quot;</span>+sort);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">score</span> <span class="operator">=</span> stringRedisTemplate.opsForZSet().score(REDIS_KEY_RANKING, <span class="string">&quot;æå››&quot;</span>).intValue();</span><br><span class="line">        System.out.println(<span class="string">&quot;æå››çš„åˆ†æ•°ï¼š&quot;</span>+ score);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Set&lt;String&gt; set3 = stringRedisTemplate.opsForZSet().reverseRange(REDIS_KEY_RANKING, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;ä»å¤§åˆ°å° 0-10æ¡ï¼š&quot;</span>+ set3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ä»å°åˆ°å¤§ <span class="number">0</span>-<span class="number">10</span>æ¡ï¼š[ae3x4:å¼ ä¸‰<span class="number">6</span>, kbtua:å¼ ä¸‰<span class="number">9</span>, n25yq:å¼ ä¸‰<span class="number">9</span>, 54n1b:å¼ ä¸‰<span class="number">25</span>, we7so:å¼ ä¸‰<span class="number">36</span>, 5so31:å¼ ä¸‰<span class="number">54</span>, odwno:å¼ ä¸‰<span class="number">73</span>, 44p6w:å¼ ä¸‰<span class="number">102</span>, 8ruae:å¼ ä¸‰<span class="number">108</span>, 5xtyw:å¼ ä¸‰<span class="number">118</span>, tzaz1:å¼ ä¸‰<span class="number">119</span>]</span><br><span class="line">ä»å¤§åˆ°å° <span class="number">0</span>-<span class="number">10</span>æ¡ï¼š[4rce6:å¼ ä¸‰<span class="number">99994</span>, 2bq4t:å¼ ä¸‰<span class="number">99994</span>, cnp6d:å¼ ä¸‰<span class="number">99977</span>, wuw9n:å¼ ä¸‰<span class="number">99963</span>, ruwyz:å¼ ä¸‰<span class="number">99961</span>, f6wfu:å¼ ä¸‰<span class="number">99961</span>, wmfmr:å¼ ä¸‰<span class="number">99958</span>, g718y:å¼ ä¸‰<span class="number">99956</span>, szjzb:å¼ ä¸‰<span class="number">99954</span>, qpi6y:å¼ ä¸‰<span class="number">99945</span>, v60wg:å¼ ä¸‰<span class="number">99934</span>]</span><br><span class="line">æ•´ä¸ªé›†åˆçš„æ•°é‡ï¼š<span class="number">10000</span></span><br><span class="line">åˆ†æ•°åœ¨<span class="number">2000</span> ~ <span class="number">5000</span>çš„äººï¼š<span class="number">273</span></span><br><span class="line">æå››åœ¨é›†åˆçš„æ’åºï¼š<span class="number">0</span></span><br><span class="line">æå››çš„åˆ†æ•°ï¼š<span class="number">10000001</span></span><br><span class="line">ä»å¤§åˆ°å° <span class="number">0</span>-<span class="number">10</span>æ¡ï¼š[æå››, 4rce6:å¼ ä¸‰<span class="number">99994</span>, 2bq4t:å¼ ä¸‰<span class="number">99994</span>, cnp6d:å¼ ä¸‰<span class="number">99977</span>, wuw9n:å¼ ä¸‰<span class="number">99963</span>, ruwyz:å¼ ä¸‰<span class="number">99961</span>, f6wfu:å¼ ä¸‰<span class="number">99961</span>, wmfmr:å¼ ä¸‰<span class="number">99958</span>, g718y:å¼ ä¸‰<span class="number">99956</span>, szjzb:å¼ ä¸‰<span class="number">99954</span>, qpi6y:å¼ ä¸‰<span class="number">99945</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="2-æœ€æ–°20æ¡è¯„è®ºï¼ˆåˆ©ç”¨listï¼‰"><a href="#2-æœ€æ–°20æ¡è¯„è®ºï¼ˆåˆ©ç”¨listï¼‰" class="headerlink" title="2.æœ€æ–°20æ¡è¯„è®ºï¼ˆåˆ©ç”¨listï¼‰"></a>2.æœ€æ–°20æ¡è¯„è®ºï¼ˆåˆ©ç”¨listï¼‰</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ¨¡æ‹Ÿä»å·¦è¾¹æ’å…¥ä¸¤æ¡æ•°æ®</span></span><br><span class="line">redisTemplate.opsForList().leftPush(<span class="string">&quot;commons:id001&quot;</span>,<span class="string">&quot;idä¸º001çš„æ–‡ç« ç¬¬1æ¡è¯„è®º&quot;</span>);</span><br><span class="line">redisTemplate.opsForList().leftPush(<span class="string">&quot;commons:id001&quot;</span>,<span class="string">&quot;idä¸º001çš„æ–‡ç« ç¬¬2æ¡è¯„è®º&quot;</span>);</span><br><span class="line"><span class="comment">//è·å–æœ€æ–°çš„ä¸€æ¡æ•°æ®ï¼ˆ0-0åŒºé—´ï¼‰</span></span><br><span class="line">List&lt;String&gt; range1 = redisTemplate.opsForList().range(<span class="string">&quot;commons:id001&quot;</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">System.out.println(range1);</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
      </categories>
      <tags>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title>rocketmq</title>
    <url>/2022/12/20/rocketmq/</url>
    <content><![CDATA[<h1 id="rocketmq"><a href="#rocketmq" class="headerlink" title="rocketmq"></a>rocketmq</h1><h2 id="1-æ•´åˆä½¿ç”¨"><a href="#1-æ•´åˆä½¿ç”¨" class="headerlink" title="1.æ•´åˆä½¿ç”¨"></a>1.æ•´åˆä½¿ç”¨</h2><h3 id="1-1-ä¾èµ–"><a href="#1-1-ä¾èµ–" class="headerlink" title="1.1 ä¾èµ–"></a>1.1 ä¾èµ–</h3><h4 id="1-1-1æ•´åˆspring-boot-starter"><a href="#1-1-1æ•´åˆspring-boot-starter" class="headerlink" title="1.1.1æ•´åˆspring-boot-starter"></a>1.1.1æ•´åˆspring-boot-starter</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;rocketmq-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;!--2.1.0å¯¹åº”çš„mqæ˜¯4.6.x--&gt;</span><br><span class="line">    &lt;!--2.2.0å¯¹åº”çš„mqæ˜¯4.7.x--&gt;</span><br><span class="line">    &lt;version&gt;2.2.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-1-2æ•´åˆé…ç½®rocketmq-client"><a href="#1-1-2æ•´åˆé…ç½®rocketmq-client" class="headerlink" title="1.1.2æ•´åˆé…ç½®rocketmq-client"></a>1.1.2æ•´åˆé…ç½®rocketmq-client</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;rocketmq-client&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.7.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>



<h3 id="1-2-application-ymlé…ç½®"><a href="#1-2-application-ymlé…ç½®" class="headerlink" title="1.2 application.ymlé…ç½®"></a>1.2 application.ymlé…ç½®</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">rocketmq:</span></span><br><span class="line">  <span class="attr">name-server:</span> <span class="number">192.168</span><span class="number">.17</span><span class="number">.100</span><span class="string">:9876</span></span><br><span class="line">  <span class="attr">producer:</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">mysql_sync_pro_group</span></span><br><span class="line">    <span class="attr">name-server:</span> <span class="number">192.168</span><span class="number">.17</span><span class="number">.100</span><span class="string">:9876</span> <span class="comment">#è¿™ä¸ªåªåœ¨clientæ¨¡å¼ä¸‹åŠ </span></span><br><span class="line">    <span class="attr">send-message-timeout:</span> <span class="number">3000</span> <span class="comment"># å‘é€æ¶ˆæ¯è¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚é»˜è®¤ä¸º 3000 ã€‚</span></span><br><span class="line">    <span class="attr">compress-message-body-threshold:</span> <span class="number">4096</span> <span class="comment"># æ¶ˆæ¯å‹ç¼©é˜€å€¼ï¼Œå½“æ¶ˆæ¯ä½“çš„å¤§å°è¶…è¿‡è¯¥é˜€å€¼åï¼Œè¿›è¡Œæ¶ˆæ¯å‹ç¼©ã€‚é»˜è®¤ä¸º 4 * 1024B</span></span><br><span class="line">    <span class="attr">max-message-size:</span> <span class="number">4194304</span> <span class="comment"># æ¶ˆæ¯ä½“çš„æœ€å¤§å…è®¸å¤§å°ã€‚ã€‚é»˜è®¤ä¸º 4 * 1024 * 1024B</span></span><br><span class="line">    <span class="attr">retry-times-when-send-failed:</span> <span class="number">2</span> <span class="comment"># åŒæ­¥å‘é€æ¶ˆæ¯æ—¶ï¼Œå¤±è´¥é‡è¯•æ¬¡æ•°ã€‚é»˜è®¤ä¸º 2 æ¬¡ã€‚</span></span><br><span class="line">    <span class="attr">retry-times-when-send-async-failed:</span> <span class="number">2</span> <span class="comment"># å¼‚æ­¥å‘é€æ¶ˆæ¯æ—¶ï¼Œå¤±è´¥é‡è¯•æ¬¡æ•°ã€‚é»˜è®¤ä¸º 2 æ¬¡ã€‚</span></span><br><span class="line">    <span class="attr">retry-next-server:</span> <span class="literal">false</span> <span class="comment"># å‘é€æ¶ˆæ¯ç»™ Broker æ—¶ï¼Œå¦‚æœå‘é€å¤±è´¥ï¼Œæ˜¯å¦é‡è¯•å¦å¤–ä¸€å° Broker ã€‚é»˜è®¤ä¸º false</span></span><br><span class="line">  <span class="comment">#ä»¥ä¸‹æ˜¯é…ç½®æ–‡ä»¶configçš„é…ç½®  spring-boot-starter ä¸éœ€è¦ä¸‹é¢çš„é…ç½®</span></span><br><span class="line">  <span class="attr">consumer:</span></span><br><span class="line">    <span class="attr">namesrvAddrs:</span> <span class="number">192.168</span><span class="number">.17</span><span class="number">.100</span><span class="string">:9876</span></span><br><span class="line">    <span class="attr">consumerTopic:</span> <span class="string">canal_source</span></span><br><span class="line">    <span class="attr">consumeThreadMin:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">consumeThreadMax:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">consumerGroupName:</span> <span class="string">mysql_sync_con_group</span></span><br><span class="line">    <span class="attr">consumeMessageBatchMaxSize:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">maxReconsumeTimes:</span> <span class="number">10</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="1-3-Listener"><a href="#1-3-Listener" class="headerlink" title="1.3 Listener"></a>1.3 Listener</h3><h4 id="1-3-1-åŸºäºæ³¨è§£ç›‘å¬"><a href="#1-3-1-åŸºäºæ³¨è§£ç›‘å¬" class="headerlink" title="1.3.1 åŸºäºæ³¨è§£ç›‘å¬"></a>1.3.1 åŸºäºæ³¨è§£ç›‘å¬</h4><h5 id="1-3-1-1-MQlistener"><a href="#1-3-1-1-MQlistener" class="headerlink" title="1.3.1.1 MQlistener"></a>1.3.1.1 MQlistener</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.project.canal.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.spring.annotation.RocketMQMessageListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.spring.core.RocketMQListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é…ç½®RocketMQç›‘å¬</span></span><br><span class="line"><span class="comment"> * é‡‡ç”¨ RocketMQTemplate rocketMQTemplate åŸºäºæ³¨è§£çš„</span></span><br><span class="line"><span class="comment"> * RocketMQListener&lt;&gt;æ³›å‹å¿…é¡»å’Œæ¥æ”¶çš„æ¶ˆæ¯ç±»å‹ç›¸åŒ</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1.topicï¼šæ¶ˆæ¯çš„å‘é€è€…ä½¿ç”¨åŒä¸€ä¸ªtopic</span></span><br><span class="line"><span class="comment"> * 2.groupï¼šä¸ç”¨å’Œç”Ÿäº§è€…groupç›¸åŒ ( åœ¨RocketMQä¸­æ¶ˆè´¹è€…å’Œå‘é€è€…ç»„æ²¡æœ‰å…³ç³» )</span></span><br><span class="line"><span class="comment"> * 3.tagï¼šè®¾ç½®ä¸º * æ—¶ï¼Œè¡¨ç¤ºå…¨éƒ¨ã€‚</span></span><br><span class="line"><span class="comment"> * 4.æ¶ˆè´¹æ¨¡å¼ï¼šé»˜è®¤ CLUSTERING ï¼ˆ CLUSTERINGï¼šè´Ÿè½½å‡è¡¡ ï¼‰ï¼ˆ BROADCASTINGï¼šå¹¿æ’­æœºåˆ¶ ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RocketMQMessageListener(consumerGroup = &quot;delay_group&quot;,topic = &quot;delay_topic&quot;,selectorExpression = &quot;*&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RocketMQDelayConsumerListener</span> <span class="keyword">implements</span> <span class="title class_">RocketMQListener</span>&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String s)</span> &#123;</span><br><span class="line"><span class="comment">//        Map&lt;String,Object&gt; orderMap = JSONObject.parseObject(s,Map.class);</span></span><br><span class="line"><span class="comment">//        String orderNumber = String.valueOf(orderMap.get(&quot;orderNumber&quot;));</span></span><br><span class="line"><span class="comment">//        String createTime = String.valueOf(orderMap.get(&quot;createTime&quot;));</span></span><br><span class="line">        <span class="comment">//æ ¹æ®orderNumber æŸ¥è¯¢è®¢å•çŠ¶æ€ï¼Œè‹¥ä¸ºæœªæ”¯ä»˜ï¼Œåˆ™æ¶ˆæ¯è®¢å•å¹¶ä¿®æ”¹åº“å­˜</span></span><br><span class="line"></span><br><span class="line">        System.out.println(s);</span><br><span class="line">        System.out.println(<span class="string">&quot;æ¶ˆè´¹æ—¶é—´ï¼š&quot;</span>+System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="1-3-2åŸºäºé…ç½®æ–‡ä»¶ç›‘å¬"><a href="#1-3-2åŸºäºé…ç½®æ–‡ä»¶ç›‘å¬" class="headerlink" title="1.3.2åŸºäºé…ç½®æ–‡ä»¶ç›‘å¬"></a>1.3.2åŸºäºé…ç½®æ–‡ä»¶ç›‘å¬</h4><blockquote>
<p>åŸºäºé…ç½®æ–‡ä»¶ï¼šè¦é…ç½®æ¶ˆè´¹è€…</p>
</blockquote>
<h5 id="1-3-2-1-æ¶ˆè´¹è€…é…ç½®"><a href="#1-3-2-1-æ¶ˆè´¹è€…é…ç½®" class="headerlink" title="1.3.2.1  æ¶ˆè´¹è€…é…ç½®"></a>1.3.2.1  æ¶ˆè´¹è€…é…ç½®</h5><h5 id="1-3-2-2-MQConsumerPropertis"><a href="#1-3-2-2-MQConsumerPropertis" class="headerlink" title="1.3.2.2 MQConsumerPropertis"></a>1.3.2.2 MQConsumerPropertis</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.project.canal.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;rocketmq.consumer&quot;)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQConsumerPropertis</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String namesrvAddrs;</span><br><span class="line">    <span class="keyword">private</span> String consumerTopic;</span><br><span class="line">    <span class="keyword">private</span> Integer consumeThreadMin;</span><br><span class="line">    <span class="keyword">private</span> Integer consumeThreadMax;</span><br><span class="line">    <span class="keyword">private</span> String  consumerGroupName;</span><br><span class="line">    <span class="keyword">private</span> Integer consumeMessageBatchMaxSize;</span><br><span class="line">    <span class="keyword">private</span> Integer maxReconsumeTimes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="1-3-2-3MQConsumerConfig"><a href="#1-3-2-3MQConsumerConfig" class="headerlink" title="1.3.2.3MQConsumerConfig"></a>1.3.2.3MQConsumerConfig</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.project.canal.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.project.canal.listener.MysqlDestTableListener;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.MessageListenerOrderly;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.exception.MQClientException;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.consumer.ConsumeFromWhere;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.protocol.heartbeat.MessageModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RocketMQæ¶ˆè´¹è€…é…ç½®</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2022/9/8 15:03</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQConsumerConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MQConsumerPropertis mqConsumerPropertis;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;unReturnConsume&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DefaultMQPushConsumer <span class="title function_">unReturnConsume</span><span class="params">(MysqlDestTableListener mysqlDestTableListener)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> createDefaultMQPushConsumer(mysqlDestTableListener, mqConsumerPropertis.getConsumerTopic(), mqConsumerPropertis.getConsumerGroupName(), mqConsumerPropertis.getMaxReconsumeTimes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DefaultMQPushConsumer <span class="title function_">createDefaultMQPushConsumer</span><span class="params">(MessageListenerOrderly messageListenerOrderly,</span></span><br><span class="line"><span class="params">                                                             String topic,</span></span><br><span class="line"><span class="params">                                                             String groupName, Integer maxReconsumeTimes)</span> &#123;</span><br><span class="line">        <span class="type">DefaultMQPushConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQPushConsumer</span>(groupName);</span><br><span class="line">        consumer.setNamesrvAddr(mqConsumerPropertis.getNamesrvAddrs());</span><br><span class="line">        consumer.setConsumeThreadMin(mqConsumerPropertis.getConsumeThreadMin());</span><br><span class="line">        consumer.setConsumeThreadMax(mqConsumerPropertis.getConsumeThreadMax());</span><br><span class="line">        consumer.registerMessageListener(messageListenerOrderly);</span><br><span class="line">        <span class="comment">//è®¾ç½®Consumerç¬¬ä¸€æ¬¡å¯åŠ¨æ˜¯ä»é˜Ÿåˆ—å¤´éƒ¨å¼€å§‹æ¶ˆè´¹è¿˜æ˜¯é˜Ÿåˆ—å°¾éƒ¨å¼€å§‹æ¶ˆè´¹</span></span><br><span class="line">        <span class="comment">// è®¾ç½®ä¸ºä»å¤´æ¶ˆè´¹ é¡ºåºæ¶ˆè´¹ é¡ºåºæ¶ˆè´¹å¦‚æœå¤±è´¥å°†ä¼šmaxReconsumeTimes=Integer.MAX_VALUEï¼Œä¹Ÿå°±æ˜¯æ— é™æ¬¡</span></span><br><span class="line">        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);</span><br><span class="line">        <span class="comment">//è®¾ç½®æ¶ˆè´¹æ¨¡å‹ï¼Œé›†ç¾¤è¿˜æ˜¯å¹¿æ’­ï¼Œé»˜è®¤ä¸ºé›†ç¾¤ã€‚å¹¿æ’­èƒ½ä¿è¯è‡³å°‘ä¸€æ¬¡æ¶ˆè´¹ï¼Œä½†æ˜¯æ¶ˆè´¹å¤±è´¥åä¸åšé‡è¯•,é›†ç¾¤æ¶ˆè´¹æ¨¡å¼ï¼šå½“ä½¿ç”¨é›†ç¾¤æ¶ˆè´¹æ¨¡å¼æ—¶ï¼ŒRocketMQ è®¤ä¸ºä»»æ„ä¸€æ¡æ¶ˆæ¯åªéœ€è¦è¢«æ¶ˆè´¹ç»„å†…çš„ä»»æ„ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†å³å¯ã€‚</span></span><br><span class="line">        <span class="comment">//å¹¿æ’­æ¶ˆè´¹æ¨¡å¼ï¼šå½“ä½¿ç”¨å¹¿æ’­æ¶ˆè´¹æ¨¡å¼æ—¶ï¼ŒRocketMQ ä¼šå°†æ¯æ¡æ¶ˆæ¯æ¨é€ç»™æ¶ˆè´¹ç»„æ‰€æœ‰çš„æ¶ˆè´¹è€…ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¯ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ä¸€æ¬¡ã€‚ æ¶ˆæ¯é‡è¯•åªé’ˆå¯¹é›†ç¾¤æ¶ˆè´¹æ¨¡å¼ç”Ÿæ•ˆï¼›å¹¿æ’­æ¶ˆè´¹æ¨¡å¼ä¸æä¾›å¤±è´¥é‡è¯•ç‰¹æ€§ï¼Œå³æ¶ˆè´¹å¤±è´¥åï¼Œå¤±è´¥æ¶ˆæ¯ä¸å†é‡è¯•ï¼Œç»§ç»­æ¶ˆè´¹æ–°çš„æ¶ˆæ¯</span></span><br><span class="line">        consumer.setMessageModel(MessageModel.CLUSTERING);</span><br><span class="line">        <span class="comment">//è®¾ç½®ä¸€æ¬¡æ¶ˆè´¹æ¶ˆæ¯çš„æ¡æ•°ï¼Œé»˜è®¤ä¸º1æ¡</span></span><br><span class="line">        consumer.setConsumeMessageBatchMaxSize(mqConsumerPropertis.getConsumeMessageBatchMaxSize());</span><br><span class="line">        consumer.setInstanceName(topic);</span><br><span class="line">        <span class="keyword">if</span> (maxReconsumeTimes != <span class="literal">null</span>) &#123;</span><br><span class="line">            consumer.setMaxReconsumeTimes(maxReconsumeTimes);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            consumer.subscribe(topic, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">            consumer.start();</span><br><span class="line">            log.info(<span class="string">&quot;=====================ã€RocketMQ-consumerå¯åŠ¨æˆåŠŸï¼ŒgroupNameï¼š&#123;&#125;ï¼ŒnamesrvAddrï¼š&#123;&#125;ï¼Œtopic: &#123;&#125;ã€‘======================&quot;</span>, groupName, mqConsumerPropertis.getNamesrvAddrs(), topic);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;======================ã€RocketMQ-consumerå¯åŠ¨å¤±è´¥ï¼ŒåŸå› ï¼š&#123;&#125;=====================ã€‘&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> consumer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="1-3-2-4-ç”Ÿäº§è€…é…ç½®"><a href="#1-3-2-4-ç”Ÿäº§è€…é…ç½®" class="headerlink" title="1.3.2.4 ç”Ÿäº§è€…é…ç½®"></a>1.3.2.4 ç”Ÿäº§è€…é…ç½®</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.project.canal.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.exception.MQClientException;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.DefaultMQProducer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> biyc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/5/30 21:26</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;rocketmq.producer&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQProducerConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String group;</span><br><span class="line">    <span class="keyword">private</span> String nameServer;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¶ˆæ¯æœ€å¤§å€¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer compressMessageBodyThreshold;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¶ˆæ¯å‘é€è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer sendMessageTimeout;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤±è´¥é‡è¯•æ¬¡æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer retryTimesWhenSendFailed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * mq ç”Ÿæˆè€…é…ç½®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> MQClientException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(name = &quot;thresholdProducer&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DefaultMQProducer <span class="title function_">thresholdProducer</span><span class="params">()</span> <span class="keyword">throws</span> MQClientException &#123;</span><br><span class="line">        <span class="keyword">return</span> createMQProducer(group);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DefaultMQProducer <span class="title function_">createMQProducer</span><span class="params">(String groupName)</span> <span class="keyword">throws</span> MQClientException &#123;</span><br><span class="line">        log.info(<span class="string">&quot;defaultProducer æ­£åœ¨åˆ›å»º---------------------------------------&quot;</span>);</span><br><span class="line">        <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMQProducer</span>(groupName);</span><br><span class="line">        producer.setNamesrvAddr(nameServer);</span><br><span class="line">        producer.setVipChannelEnabled(<span class="literal">false</span>);</span><br><span class="line">        producer.setMaxMessageSize(compressMessageBodyThreshold);</span><br><span class="line">        producer.setSendMsgTimeout(sendMessageTimeout);</span><br><span class="line">        producer.setRetryTimesWhenSendAsyncFailed(retryTimesWhenSendFailed);</span><br><span class="line">        producer.start();</span><br><span class="line">        log.info(<span class="string">&quot;rocketmq producer server å¼€å¯æˆåŠŸ----------------------------------&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> producer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="1-3-2-5-MQListener"><a href="#1-3-2-5-MQListener" class="headerlink" title="1.3.2.5 MQListener"></a>1.3.2.5 MQListener</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.project.canal.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeOrderlyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeOrderlyStatus;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.MessageListenerOrderly;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.MessageExt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> NieZiHan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/12/21 9:42</span></span><br><span class="line"><span class="comment"> * é‡‡ç”¨è‡ªå®šä¹‰çš„ åŸºäºé…ç½®æ–‡ä»¶çš„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MysqlDestTableListener</span> <span class="keyword">implements</span> <span class="title class_">MessageListenerOrderly</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ConsumeOrderlyStatus <span class="title function_">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; list, ConsumeOrderlyContext consumeOrderlyContext)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (MessageExt messageExt : list) &#123;</span><br><span class="line">                <span class="comment">//è·å–æ¶ˆæ¯çš„topic</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> messageExt.getTopic();</span><br><span class="line">                <span class="comment">//è·å–æ¶ˆæ¯çš„æ ‡ç­¾</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">tags</span> <span class="operator">=</span> messageExt.getTags();</span><br><span class="line">                <span class="comment">//è·å–æ¶ˆæ¯å†…å®¹</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(messageExt.getBody());</span><br><span class="line">                System.out.println(<span class="string">&quot;å¼€å§‹æ¶ˆè´¹æ¶ˆæ¯====ã€‹&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;topic&quot;</span>+topic+<span class="string">&quot;==tags&quot;</span>+tags+<span class="string">&quot;==content&quot;</span>+content);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ConsumeOrderlyStatus.SUCCESS;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">            exception.printStackTrace();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ConsumeOrderlyStatus.SUSPEND_CURRENT_QUEUE_A_MOMENT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="1-4è°ƒç”¨"><a href="#1-4è°ƒç”¨" class="headerlink" title="1.4è°ƒç”¨"></a>1.4è°ƒç”¨</h3><blockquote>
<p>é‡‡ç”¨é…ç½®æ—¶ï¼ŒrocketMQTemplateæ³¨å…¥ä¼šå¤±æ•ˆ</p>
<p>å»¶æ—¶æ¶ˆæ¯ï¼š</p>
<p>åœ¨æœåŠ¡å™¨ç«¯ï¼ˆrocketmq-brokerç«¯ï¼‰çš„å±æ€§é…ç½®æ–‡ä»¶ä¸­åŠ å…¥ä»¥ä¸‹è¡Œï¼š</p>
<p>messageDelayLevel &#x3D; 1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h 1d</p>
</blockquote>
<h4 id="1-4-1boot-start"><a href="#1-4-1boot-start" class="headerlink" title="1.4.1boot-start"></a>1.4.1boot-start</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RocketMQTemplate rocketMQTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation(value=&quot;å‘é€å»¶æ—¶æ¶ˆæ¯åˆ°message&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/sendDelayMqMessage&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendDelayMqMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        SendResult result=rocketMQTemplate.syncSend(<span class="string">&quot;delay_topic&quot;</span>, MessageBuilder.withPayload(<span class="string">&quot;ç“œç”°æä¸‹ delay&quot;</span>).build(),<span class="number">2000</span>,<span class="number">2</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;å‘é€æ—¶é—´ï¼š&quot;</span>+System.currentTimeMillis());</span><br><span class="line">        System.out.println(result);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ™®é€šå­—ç¬¦ä¸²æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;æ™®é€šæ¶ˆæ¯&quot;</span>;</span><br><span class="line">        rocketMQTemplate.convertAndSend(<span class="string">&quot;sendMessage&quot;</span>, json);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŒæ­¥æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">syncSend</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;åŒæ­¥æ¶ˆæ¯&quot;</span>;</span><br><span class="line">        <span class="type">SendResult</span> <span class="variable">sendMessage</span> <span class="operator">=</span> rocketMQTemplate.syncSend(<span class="string">&quot;sendMessage&quot;</span>, json);</span><br><span class="line">        System.out.println(sendMessage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¼‚æ­¥æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">asyncSend</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;å¼‚æ­¥æ¶ˆæ¯&quot;</span>;</span><br><span class="line">        <span class="type">SendCallback</span> <span class="variable">callback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SendCallback</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(SendResult sendResult)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onException</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;456&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        rocketMQTemplate.asyncSend(<span class="string">&quot;sendMessage&quot;</span>, json, callback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å•å‘æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onewaySend</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;å•å‘æ¶ˆæ¯&quot;</span>;</span><br><span class="line">        rocketMQTemplate.sendOneWay(<span class="string">&quot;sendMessage&quot;</span>, json);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h4 id="1-4-2-client"><a href="#1-4-2-client" class="headerlink" title="1.4.2 client"></a>1.4.2 client</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MQProducerConfig mqProducerConfig;</span><br><span class="line">   <span class="meta">@ApiOperation(value=&quot;å‘é€æ™®é€šæ¶ˆæ¯åˆ°message&quot;)</span></span><br><span class="line">   <span class="meta">@GetMapping(value = &quot;/sendMqMessage&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMqMessage</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> mqProducerConfig.thresholdProducer();</span><br><span class="line">           <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>(<span class="string">&quot;canal_source&quot;</span>,(<span class="string">&quot;mqå‘é€æ¶ˆæ¯&quot;</span>+ RandomUtil.randomString(<span class="number">5</span>)).getBytes());</span><br><span class="line">           message.setKeys(<span class="string">&quot;key1&quot;</span>);</span><br><span class="line">           message.setTags(<span class="string">&quot;tags1&quot;</span>);</span><br><span class="line">         <span class="comment">// è®¾ç½®ä¸ºå»¶æ—¶æ¶ˆæ¯</span></span><br><span class="line">        	message.setDelayTimeLevel(<span class="number">1</span>);</span><br><span class="line">           <span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> producer.send(message);</span><br><span class="line">           System.out.println(<span class="string">&quot;sendResult&quot;</span>+ sendResult);</span><br><span class="line">           log.info(<span class="string">&quot;proå‘é€æ¶ˆæ¯å®Œæˆ&quot;</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>ä¸­é—´ä»¶</category>
      </categories>
      <tags>
        <tag>rocketmq</tag>
      </tags>
  </entry>
  <entry>
    <title>start Hexo</title>
    <url>/2022/12/09/startHexo/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /study</span><br><span class="line">hexo new <span class="string">&quot;fileName&quot;</span></span><br><span class="line">hexo s æœ¬åœ°æŸ¥çœ‹</span><br><span class="line">hexo g</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">å…³é—­æœ¬åœ° hexo</span><br><span class="line">taskkill /F /IM node.exe  </span><br><span class="line"></span><br><span class="line">taskkill /F /pid 4000</span><br></pre></td></tr></table></figure>



]]></content>
  </entry>
  <entry>
    <title>Stream</title>
    <url>/2022/12/09/stream/</url>
    <content><![CDATA[<h1 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h1><h2 id="1-Stream-Collectorsç±»"><a href="#1-Stream-Collectorsç±»" class="headerlink" title="1.Stream  Collectorsç±»"></a>1.Stream  Collectorsç±»</h2><h3 id="1-1-åœºæ™¯"><a href="#1-1-åœºæ™¯" class="headerlink" title="1.1 åœºæ™¯"></a>1.1 åœºæ™¯</h3><h4 id="1-1-1å°†åç§°ç´¯ç§¯åˆ°åˆ—è¡¨ä¸­"><a href="#1-1-1å°†åç§°ç´¯ç§¯åˆ°åˆ—è¡¨ä¸­" class="headerlink" title="1.1.1å°†åç§°ç´¯ç§¯åˆ°åˆ—è¡¨ä¸­"></a>1.1.1å°†åç§°ç´¯ç§¯åˆ°åˆ—è¡¨ä¸­</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; list = people.stream().map(Person::getName).collect(Collectors.toList());</span><br></pre></td></tr></table></figure>



<h4 id="1-1-2å°†å…ƒç´ è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶è¿æ¥å®ƒä»¬ï¼Œç”¨é€—å·åˆ†éš”"><a href="#1-1-2å°†å…ƒç´ è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶è¿æ¥å®ƒä»¬ï¼Œç”¨é€—å·åˆ†éš”" class="headerlink" title="1.1.2å°†å…ƒç´ è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶è¿æ¥å®ƒä»¬ï¼Œç”¨é€—å·åˆ†éš”"></a>1.1.2å°†å…ƒç´ è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶è¿æ¥å®ƒä»¬ï¼Œç”¨é€—å·åˆ†éš”</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">joined</span> <span class="operator">=</span> things.stream().map(Object::toString).collect(Collectors.joining(<span class="string">&quot;, &quot;</span>));</span><br></pre></td></tr></table></figure>



<h4 id="1-1-3è®¡ç®—å‘˜å·¥å·¥èµ„æ€»é¢"><a href="#1-1-3è®¡ç®—å‘˜å·¥å·¥èµ„æ€»é¢" class="headerlink" title="1.1.3è®¡ç®—å‘˜å·¥å·¥èµ„æ€»é¢"></a>1.1.3è®¡ç®—å‘˜å·¥å·¥èµ„æ€»é¢</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">total</span> <span class="operator">=</span> employees.stream().collect(Collectors.summingInt(Employee::getSalary)));</span><br></pre></td></tr></table></figure>



<h4 id="1-1-4æŒ‰éƒ¨é—¨åˆ†ç»„å‘˜å·¥"><a href="#1-1-4æŒ‰éƒ¨é—¨åˆ†ç»„å‘˜å·¥" class="headerlink" title="1.1.4æŒ‰éƒ¨é—¨åˆ†ç»„å‘˜å·¥"></a>1.1.4æŒ‰éƒ¨é—¨åˆ†ç»„å‘˜å·¥</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;Department, List&lt;Employee&gt;&gt; byDept</span><br><span class="line">		= employees.stream().collect(Collectors.groupingBy(Employee::getDepartment));</span><br></pre></td></tr></table></figure>



<h4 id="1-1-5æŒ‰éƒ¨é—¨è®¡ç®—å·¥èµ„æ€»é¢"><a href="#1-1-5æŒ‰éƒ¨é—¨è®¡ç®—å·¥èµ„æ€»é¢" class="headerlink" title="1.1.5æŒ‰éƒ¨é—¨è®¡ç®—å·¥èµ„æ€»é¢"></a>1.1.5æŒ‰éƒ¨é—¨è®¡ç®—å·¥èµ„æ€»é¢</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;Department, Integer&gt; totalByDept</span><br><span class="line">         = employees.stream()</span><br><span class="line">  			.collect(Collectors.groupingBy(Employee::getDepartment,</span><br><span class="line">                      Collectors.summingInt(Employee::getSalary)));</span><br></pre></td></tr></table></figure>



<h4 id="1-1-6å°†å­¦ç”Ÿåˆ†ä¸ºåŠæ ¼å’Œä¸åŠæ ¼"><a href="#1-1-6å°†å­¦ç”Ÿåˆ†ä¸ºåŠæ ¼å’Œä¸åŠæ ¼" class="headerlink" title="1.1.6å°†å­¦ç”Ÿåˆ†ä¸ºåŠæ ¼å’Œä¸åŠæ ¼"></a>1.1.6å°†å­¦ç”Ÿåˆ†ä¸ºåŠæ ¼å’Œä¸åŠæ ¼</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;Boolean, List&lt;Student&gt;&gt; passingFailing =</span><br><span class="line">    students.stream()</span><br><span class="line">           .collect(Collectors.partitioningBy(s -&gt; s.getGrade() &gt;= PASS_THRESHOLD));</span><br></pre></td></tr></table></figure>



<h3 id="1-2-api"><a href="#1-2-api" class="headerlink" title="1.2 api"></a>1.2 api</h3><h4 id="1-2-1Collectors-toList"><a href="#1-2-1Collectors-toList" class="headerlink" title="1.2.1Collectors.toList()"></a>1.2.1Collectors.toList()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å°†streamè½¬æ¢ä¸ºlistã€‚è¿™é‡Œè½¬æ¢çš„listæ˜¯ArrayListï¼Œå¦‚æœæƒ³è¦è½¬æ¢æˆç‰¹å®šçš„listï¼Œéœ€è¦ä½¿ç”¨toCollectionæ–¹æ³•ã€‚</span></span><br><span class="line">List&lt;String&gt; listResult = list.stream().collect(Collectors.toList());</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125;&quot;</span>,listResult);</span><br></pre></td></tr></table></figure>



<h4 id="1-2-2Collectors-toSet"><a href="#1-2-2Collectors-toSet" class="headerlink" title="1.2.2Collectors.toSet()"></a>1.2.2Collectors.toSet()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//toSetå°†Streamè½¬æ¢æˆä¸ºsetã€‚è¿™é‡Œè½¬æ¢çš„æ˜¯HashSetã€‚å¦‚æœéœ€è¦ç‰¹åˆ«æŒ‡å®šsetï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨toCollectionæ–¹æ³•ã€‚</span></span><br><span class="line">Set&lt;String&gt; setResult = list.stream().collect(Collectors.toSet());</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125;&quot;</span>,setResult);</span><br></pre></td></tr></table></figure>



<h4 id="1-2-3Collectors-toCollection"><a href="#1-2-3Collectors-toCollection" class="headerlink" title="1.2.3Collectors.toCollection"></a>1.2.3Collectors.toCollection</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä¸Šé¢çš„toMap,toSetè½¬æ¢å‡ºæ¥çš„éƒ½æ˜¯ç‰¹å®šçš„ç±»å‹ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ï¼Œ</span></span><br><span class="line"><span class="comment">// åˆ™å¯ä»¥ä½¿ç”¨toCollection(),è½¬æ¢æˆäº†LinkedList</span></span><br><span class="line">List&lt;String&gt; custListResult = list.stream().collect(Collectors.toCollection(LinkedList::<span class="keyword">new</span>));</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125;&quot;</span>,custListResult);</span><br></pre></td></tr></table></figure>



<h4 id="1-2-4Collectors-toMap"><a href="#1-2-4Collectors-toMap" class="headerlink" title="1.2.4Collectors.toMap"></a>1.2.4Collectors.toMap</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// toMapæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯keyMapperï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯valueMapper</span></span><br><span class="line"><span class="comment">// å¦‚æœstreamä¸­æœ‰é‡å¤çš„å€¼ï¼Œåˆ™è½¬æ¢ä¼šæŠ¥IllegalStateExceptionå¼‚å¸¸ï¼š</span></span><br><span class="line">Map&lt;String, Integer&gt; mapResult = list.stream()</span><br><span class="line">                .collect(Collectors.toMap(Function.identity(), String::length));</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125;&quot;</span>,mapResult);</span><br><span class="line"></span><br><span class="line"><span class="comment">//toMapä¸­æ·»åŠ ç¬¬ä¸‰ä¸ªå‚æ•°mergeFunctionï¼Œæ¥è§£å†³å†²çª</span></span><br><span class="line">Map&lt;String, Integer&gt; duplicateMapResult2 = duplicateList.stream()</span><br><span class="line">                .collect(Collectors.toMap(Function.identity(), String::length, </span><br><span class="line">                 (item, identicalItem) -&gt; item));</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125;&quot;</span>,duplicateMapResult2);</span><br></pre></td></tr></table></figure>



<h4 id="1-2-5Collectors-collectingAndThen"><a href="#1-2-5Collectors-collectingAndThen" class="headerlink" title="1.2.5Collectors.collectingAndThen"></a>1.2.5Collectors.collectingAndThen</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// collectingAndThenå…è®¸æˆ‘ä»¬å¯¹ç”Ÿæˆçš„é›†åˆå†åšä¸€æ¬¡æ“ä½œã€‚</span></span><br><span class="line">List&lt;String&gt; collectAndThenResult = list.stream()</span><br><span class="line">                .collect(Collectors.collectingAndThen(Collectors.toList(), </span><br><span class="line">                 l -&gt; &#123;<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(l);&#125;));</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125;&quot;</span>,collectAndThenResult);</span><br></pre></td></tr></table></figure>



<h4 id="1-2-6Collectors-joining"><a href="#1-2-6Collectors-joining" class="headerlink" title="1.2.6Collectors.joining()"></a>1.2.6Collectors.joining()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Joiningç”¨æ¥è¿æ¥streamä¸­çš„å…ƒç´ </span></span><br><span class="line"><span class="comment">// å¯ä»¥ä¸å¸¦å‚æ•°ï¼Œä¹Ÿå¯ä»¥å¸¦ä¸€ä¸ªå‚æ•°ï¼Œä¹Ÿå¯ä»¥å¸¦ä¸‰ä¸ªå‚æ•°ï¼Œæ ¹æ®æˆ‘ä»¬çš„éœ€è¦è¿›è¡Œé€‰æ‹©ã€‚</span></span><br><span class="line"><span class="type">String</span> <span class="variable">joinResult</span> <span class="operator">=</span> list.stream().collect(Collectors.joining());</span><br><span class="line"><span class="type">String</span> <span class="variable">joinResult1</span> <span class="operator">=</span> list.stream().collect(Collectors.joining(<span class="string">&quot; &quot;</span>));</span><br><span class="line"><span class="type">String</span> <span class="variable">joinResult2</span> <span class="operator">=</span> list.stream().collect(Collectors.joining(<span class="string">&quot; &quot;</span>, <span class="string">&quot;prefix&quot;</span>,<span class="string">&quot;suffix&quot;</span>));</span><br></pre></td></tr></table></figure>



<h4 id="1-2-7Collectors-counting"><a href="#1-2-7Collectors-counting" class="headerlink" title="1.2.7Collectors.counting()"></a>1.2.7Collectors.counting()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// countingä¸»è¦ç”¨æ¥ç»Ÿè®¡streamä¸­å…ƒç´ çš„ä¸ªæ•°ï¼š</span></span><br><span class="line"><span class="type">Long</span> <span class="variable">countResult</span> <span class="operator">=</span> list.stream().collect(Collectors.counting());</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125;&quot;</span>,countResult);</span><br></pre></td></tr></table></figure>



<h4 id="1-2-8Collectors-summarizingDouble-x2F-Long-x2F-Int"><a href="#1-2-8Collectors-summarizingDouble-x2F-Long-x2F-Int" class="headerlink" title="1.2.8Collectors.summarizingDouble&#x2F;Long&#x2F;Int()"></a>1.2.8Collectors.summarizingDouble&#x2F;Long&#x2F;Int()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SummarizingDouble/Long/Intä¸ºstreamä¸­çš„å…ƒç´ ç”Ÿæˆäº†ç»Ÿè®¡ä¿¡æ¯ï¼Œè¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ªç»Ÿè®¡ç±»ï¼š</span></span><br><span class="line"><span class="type">IntSummaryStatistics</span> <span class="variable">intResult</span> <span class="operator">=</span> list.stream()</span><br><span class="line">                .collect(Collectors.summarizingInt(String::length));</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125;&quot;</span>,intResult);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¾“å‡ºç»“æœï¼š</span><br><span class="line">IntSummaryStatistics&#123;count=4, sum=16, min=3, average=4.000000, max=5&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="1-2-8-1Collectors-averagingDouble-x2F-Long-x2F-Int"><a href="#1-2-8-1Collectors-averagingDouble-x2F-Long-x2F-Int" class="headerlink" title="1.2.8.1Collectors.averagingDouble&#x2F;Long&#x2F;Int()"></a>1.2.8.1Collectors.averagingDouble&#x2F;Long&#x2F;Int()</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// averagingDouble/Long/Int()å¯¹streamä¸­çš„å…ƒç´ åšå¹³å‡ï¼š</span></span><br><span class="line"><span class="type">Double</span> <span class="variable">averageResult</span> <span class="operator">=</span> list.stream().collect(Collectors.averagingInt(String::length));</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125;&quot;</span>,averageResult);</span><br></pre></td></tr></table></figure>



<h5 id="1-2-8-2Collectors-maxBy-x2F-minBy"><a href="#1-2-8-2Collectors-maxBy-x2F-minBy" class="headerlink" title="1.2.8.2Collectors.maxBy()&#x2F;minBy()"></a>1.2.8.2Collectors.maxBy()&#x2F;minBy()</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// maxBy()/minBy()æ ¹æ®æä¾›çš„Comparatorï¼Œè¿”å›streamä¸­çš„æœ€å¤§æˆ–è€…æœ€å°å€¼ï¼š</span></span><br><span class="line">Optional&lt;String&gt; maxByResult = list.stream().collect(Collectors.maxBy(Comparator.naturalOrder()));</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125;&quot;</span>,maxByResult);d</span><br></pre></td></tr></table></figure>



<h4 id="1-2-9Collectors-groupingBy"><a href="#1-2-9Collectors-groupingBy" class="headerlink" title="1.2.9Collectors.groupingBy()"></a>1.2.9Collectors.groupingBy()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// GroupingByæ ¹æ®æŸäº›å±æ€§è¿›è¡Œåˆ†ç»„ï¼Œå¹¶è¿”å›ä¸€ä¸ªMapï¼š</span></span><br><span class="line">Optional&lt;String&gt; maxByResult = list.stream().collect(Collectors.maxBy(Comparator.naturalOrder()));</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125;&quot;</span>,maxByResult);d</span><br></pre></td></tr></table></figure>

<h4 id="1-2-10Collectors-partitioningBy"><a href="#1-2-10Collectors-partitioningBy" class="headerlink" title="1.2.10Collectors.partitioningBy()"></a>1.2.10Collectors.partitioningBy()</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// PartitioningByæ˜¯ä¸€ä¸ªç‰¹åˆ«çš„groupingByï¼ŒPartitioningByè¿”å›ä¸€ä¸ªMapï¼Œè¿™ä¸ªMapæ˜¯ä»¥booleanå€¼ä¸ºkeyï¼Œä»è€Œå°†streamåˆ†æˆä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯åŒ¹é…PartitioningByæ¡ä»¶çš„ï¼Œä¸€éƒ¨åˆ†æ˜¯ä¸æ»¡è¶³æ¡ä»¶çš„ï¼š</span></span><br><span class="line">Map&lt;Boolean, List&lt;String&gt;&gt; partitionResult = list.stream()</span><br><span class="line">                .collect(Collectors.partitioningBy(s -&gt; s.length() &gt; <span class="number">3</span>));</span><br><span class="line">        log.info(<span class="string">&quot;&#123;&#125;&quot;</span>,partitionResult);</span><br></pre></td></tr></table></figure>





<h2 id="2-List"><a href="#2-List" class="headerlink" title="2.List"></a>2.List</h2><h3 id="2-1Collections"><a href="#2-1Collections" class="headerlink" title="2.1Collections"></a>2.1Collections</h3><h4 id="2-1-1æ’åº"><a href="#2-1-1æ’åº" class="headerlink" title="2.1.1æ’åº"></a>2.1.1æ’åº</h4><ul>
<li>void reverse(List list)ï¼šå¯¹æŒ‡å®š List é›†åˆå…ƒç´ è¿›è¡Œé€†å‘æ’åºã€‚</li>
<li>void shuffle(List list)ï¼šå¯¹ List é›†åˆå…ƒç´ è¿›è¡Œéšæœºæ’åºï¼ˆshuffle æ–¹æ³•æ¨¡æ‹Ÿäº†â€œæ´—ç‰Œâ€åŠ¨ä½œï¼‰ã€‚</li>
<li>void shuffle(List list)ï¼šå¯¹ List é›†åˆå…ƒç´ è¿›è¡Œéšæœºæ’åºï¼ˆshuffle æ–¹æ³•æ¨¡æ‹Ÿäº†â€œæ´—ç‰Œâ€åŠ¨ä½œï¼‰ã€‚</li>
<li>void sort(List list, Comparator c)ï¼šæ ¹æ®æŒ‡å®š Comparator äº§ç”Ÿçš„é¡ºåºå¯¹ List é›†åˆå…ƒç´ è¿›è¡Œæ’åºã€‚</li>
<li>void swap(List list, int i, int j)ï¼šå°†æŒ‡å®š List é›†åˆä¸­çš„ i å¤„å…ƒç´ å’Œ j å¤„å…ƒç´ è¿›è¡Œäº¤æ¢ã€‚</li>
<li>void rotate(List list, int distance)ï¼šå½“ distance ä¸ºæ­£æ•°æ—¶ï¼Œå°† list é›†åˆçš„å distance ä¸ªå…ƒç´ â€œæ•´ä½“â€ç§»åˆ°å‰é¢ï¼›å½“ distance ä¸ºè´Ÿæ•°æ—¶ï¼Œå°† list é›†åˆçš„å‰ distance ä¸ªå…ƒç´ â€œæ•´ä½“â€ç§»åˆ°åé¢ã€‚è¯¥æ–¹æ³•ä¸ä¼šæ”¹å˜é›†åˆçš„é•¿åº¦ã€‚</li>
</ul>
<h4 id="2-1-2æŸ¥æ‰¾æ›¿æ¢"><a href="#2-1-2æŸ¥æ‰¾æ›¿æ¢" class="headerlink" title="2.1.2æŸ¥æ‰¾æ›¿æ¢"></a>2.1.2æŸ¥æ‰¾æ›¿æ¢</h4><ul>
<li>int binarySearch(List list, Object key)ï¼šä½¿ç”¨äºŒåˆ†æœç´¢æ³•æœç´¢æŒ‡å®šçš„ List é›†åˆï¼Œä»¥è·å¾—æŒ‡å®šå¯¹è±¡åœ¨ List é›†åˆä¸­çš„ç´¢å¼•ã€‚å¦‚æœè¦ä½¿è¯¥æ–¹æ³•å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œåˆ™å¿…é¡»ä¿è¯ List ä¸­çš„å…ƒç´ å·²ç»å¤„äºæœ‰åºçŠ¶æ€ã€‚</li>
<li>Object max(Collection coll)ï¼šæ ¹æ®å…ƒç´ çš„è‡ªç„¶é¡ºåºï¼Œè¿”å›ç»™å®šé›†åˆä¸­çš„æœ€å¤§å…ƒç´ ã€‚</li>
<li>Object min(Collection coll)ï¼šæ ¹æ®å…ƒç´ çš„è‡ªç„¶é¡ºåºï¼Œè¿”å›ç»™å®šé›†åˆä¸­çš„æœ€å°å…ƒç´ ã€‚</li>
<li>Object min(Collection coll, Comparator comp)ï¼šæ ¹æ® Comparator æŒ‡å®šçš„é¡ºåºï¼Œè¿”å›ç»™å®šé›†åˆä¸­çš„æœ€å°å…ƒç´ ã€‚<br>void fill(List list, Object obj)ï¼šä½¿ç”¨æŒ‡å®šå…ƒç´  obj æ›¿æ¢æŒ‡å®š List é›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚</li>
<li>int frequency(Collection c, Object o)ï¼šè¿”å›æŒ‡å®šé›†åˆä¸­æŒ‡å®šå…ƒç´ çš„å‡ºç°æ¬¡æ•°ã€‚</li>
<li>int indexOfSubList(List source, List target)ï¼šè¿”å›å­ List å¯¹è±¡åœ¨çˆ¶ List å¯¹è±¡ä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®ç´¢å¼•ï¼›å¦‚æœçˆ¶ List ä¸­æ²¡æœ‰å‡ºç°è¿™æ ·çš„å­ Listï¼Œåˆ™è¿”å› -1ã€‚</li>
<li>int lastIndexOfSubList(List source, List target)ï¼šè¿”å›å­ List å¯¹è±¡åœ¨çˆ¶ List å¯¹è±¡ä¸­æœ€åä¸€æ¬¡å‡ºç°çš„ä½ç½®ç´¢å¼•ï¼›å¦‚æœçˆ¶ List ä¸­æ²¡æœ‰å²€ç°è¿™æ ·çš„å­ Listï¼Œåˆ™è¿”å› -1ã€‚</li>
<li>boolean replaceAll(List list, Object oldVal, Object newVal)ï¼šä½¿ç”¨ä¸€ä¸ªæ–°å€¼ newVal æ›¿æ¢ List å¯¹è±¡çš„æ‰€æœ‰æ—§å€¼ oldValã€‚</li>
</ul>
<h4 id="2-1-2-å¤åˆ¶"><a href="#2-1-2-å¤åˆ¶" class="headerlink" title="2.1.2 å¤åˆ¶"></a>2.1.2 å¤åˆ¶</h4><ul>
<li>void copy(List &lt;? super T&gt; dest,List&lt;? extends T&gt; src)</li>
</ul>
]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
      </categories>
      <tags>
        <tag>Stream</tag>
      </tags>
  </entry>
  <entry>
    <title>summary</title>
    <url>/2022/12/09/summary/</url>
    <content><![CDATA[<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><h3 id="1-å¯¹listä¸­çš„å¸ƒå°”å€¼æ’åº"><a href="#1-å¯¹listä¸­çš„å¸ƒå°”å€¼æ’åº" class="headerlink" title="1.å¯¹listä¸­çš„å¸ƒå°”å€¼æ’åº"></a>1.å¯¹listä¸­çš„å¸ƒå°”å€¼æ’åº</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ArrayList&lt;Boolean&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list.add(<span class="literal">false</span>);</span><br><span class="line">        list.add(<span class="literal">false</span>);</span><br><span class="line">        list.add(<span class="literal">true</span>);</span><br><span class="line">        list.add(<span class="literal">false</span>);</span><br><span class="line">        list.add(<span class="literal">false</span>);</span><br><span class="line">        list.add(<span class="literal">true</span>);</span><br><span class="line">        list.add(<span class="literal">true</span>);</span><br><span class="line">        list.add(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        list.sort((v1,v2) -&gt; v1 ? <span class="number">1</span> : (v2 ? -<span class="number">1</span> : <span class="number">0</span>));</span><br><span class="line">        list.forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="literal">false</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>



<h3 id="2-Wrappersæ„é€ å™¨"><a href="#2-Wrappersæ„é€ å™¨" class="headerlink" title="2.Wrappersæ„é€ å™¨"></a>2.Wrappersæ„é€ å™¨</h3><h4 id="2-1-ä¿®æ”¹"><a href="#2-1-ä¿®æ”¹" class="headerlink" title="2.1 ä¿®æ”¹"></a>2.1 ä¿®æ”¹</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">pointStatusService.update(Wrappers.&lt;PointStatus&gt;lambdaUpdate()</span><br><span class="line">                .set(PointStatus::getStatus,<span class="number">1</span>).set(PointStatus::getResult,patrolResult.toString())</span><br><span class="line">                .eq(PointStatus::getId, patrolResult.getPointId()).eq(PointStatus::getSource, source));</span><br></pre></td></tr></table></figure>

<h4 id="2-2-æŸ¥è¯¢"><a href="#2-2-æŸ¥è¯¢" class="headerlink" title="2.2 æŸ¥è¯¢"></a>2.2 æŸ¥è¯¢</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">TargetPointInfo</span> <span class="variable">pointInfo</span> <span class="operator">=</span> targetPointInfoService.getOne(Wrappers.&lt;TargetPointInfo&gt;lambdaQuery().eq(TargetPointInfo::getName, pointName)</span><br><span class="line">                .eq(TargetPointInfo::getAssetId, astId).eq(TargetPointInfo::getPartId, lastPartId).eq(TargetPointInfo::getDelStatus, DateStateEnum.OK.getState()).last(<span class="string">&quot;limit 1&quot;</span>));</span><br></pre></td></tr></table></figure>



<h3 id="3-Assert-notNullçš„ä½œç”¨"><a href="#3-Assert-notNullçš„ä½œç”¨" class="headerlink" title="3.Assert.notNullçš„ä½œç”¨"></a>3.Assert.notNullçš„ä½œç”¨</h3><blockquote>
<p><strong>åˆ¤æ–­ä¼ è¿›æ¥çš„å‚æ•°å€¼æ˜¯å¦ä¸ä¸ºç©ºå€¼ï¼Œå¦‚æœä¸ºç©ºå°±æŠ›å‡ºå¼‚å¸¸throw new IllegalArgumentException(msg)ï¼Œä»£ç å¦‚æœä¸æ•æ‰å¤„ç†è¿™ä¸ªå¼‚å¸¸ï¼Œä»£ç ä¸å¾€ä¸‹æ‰§è¡Œï¼Œä¸ä¸ºç©ºä»£ç ç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Assert.notNull(temp,<span class="string">&quot;tempçš„å€¼ä¸èƒ½ä¸ºç©º&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="4-å°†jsonè½¬ä¸ºjavaå¯¹è±¡"><a href="#4-å°†jsonè½¬ä¸ºjavaå¯¹è±¡" class="headerlink" title="4.å°†jsonè½¬ä¸ºjavaå¯¹è±¡"></a>4.å°†jsonè½¬ä¸ºjavaå¯¹è±¡</h3><h4 id="4-1-fastjson"><a href="#4-1-fastjson" class="headerlink" title="4.1.fastjson"></a>4.1.fastjson</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">getResultData</span><span class="params">(String response, Class&lt;T&gt; cls)</span> &#123;</span><br><span class="line">    <span class="type">BaseResponse</span> <span class="variable">baseResponse</span> <span class="operator">=</span> JSONObject.parseObject(response, BaseResponse.class);</span><br><span class="line">    <span class="keyword">return</span> JSONObject.parseObject(baseResponse.getData(), cls);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">getArrayResultData</span><span class="params">(String response, Class&lt;T&gt; cls)</span> &#123;</span><br><span class="line">    <span class="type">BaseResponse</span> <span class="variable">baseResponse</span> <span class="operator">=</span> JSONObject.parseObject(response, BaseResponse.class);</span><br><span class="line">    <span class="keyword">return</span> JSONObject.parseArray(baseResponse.getData(), cls);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-2-hutool"><a href="#4-2-hutool" class="headerlink" title="4.2 hutool"></a>4.2 hutool</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">       <span class="type">UserToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserToken</span>();</span><br><span class="line">       token.setId(<span class="string">&quot;10&quot;</span>);</span><br><span class="line">       token.setName(<span class="string">&quot;å¼ å±±&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="type">UserToken</span> <span class="variable">token1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserToken</span>();</span><br><span class="line">       token1.setId(<span class="string">&quot;101&quot;</span>);</span><br><span class="line">       token1.setName(<span class="string">&quot;å¼ å±±1&quot;</span>);</span><br><span class="line"></span><br><span class="line">       ArrayList&lt;UserToken&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">       list.add(token);</span><br><span class="line">       list.add(token1);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> JSONUtil.toJsonStr(token);</span><br><span class="line">       System.out.println(s+<span class="string">&quot;==&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="type">UserToken</span> <span class="variable">userToken</span> <span class="operator">=</span> JSONUtil.toBean(s, UserToken.class);</span><br><span class="line">       System.out.println(userToken);</span><br><span class="line"></span><br><span class="line">       <span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> JSONUtil.toJsonStr(list);</span><br><span class="line">       System.out.println(s1+<span class="string">&quot;===&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       List&lt;UserToken&gt; userTokens = JSONUtil.toList(JSONUtil.parseArray(s1), UserToken.class);</span><br><span class="line">       userTokens.forEach(System.out::println);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h3 id="5-æ‹¦æˆªå™¨çš„ä½¿ç”¨"><a href="#5-æ‹¦æˆªå™¨çš„ä½¿ç”¨" class="headerlink" title="5.æ‹¦æˆªå™¨çš„ä½¿ç”¨"></a>5.æ‹¦æˆªå™¨çš„ä½¿ç”¨</h3><h4 id="5-1-Interceptor"><a href="#5-1-Interceptor" class="headerlink" title="5.1.Interceptor"></a>5.1.Interceptor</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogCostInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        start = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Interceptor cost=&quot;</span>+(System.currentTimeMillis()-start));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="5-2-InterceptorConfig"><a href="#5-2-InterceptorConfig" class="headerlink" title="5.2.InterceptorConfig"></a>5.2.InterceptorConfig</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InterceptorConfig</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">LogCostInterceptor</span>()).addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">        <span class="built_in">super</span>.addInterceptors(registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-è¿‡æ»¤å™¨ä¸æ‹¦æˆªå™¨"><a href="#6-è¿‡æ»¤å™¨ä¸æ‹¦æˆªå™¨" class="headerlink" title="6.è¿‡æ»¤å™¨ä¸æ‹¦æˆªå™¨"></a>6.è¿‡æ»¤å™¨ä¸æ‹¦æˆªå™¨</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¿‡æ»¤å™¨ï¼Œæ˜¯åœ¨java webä¸­ï¼Œä½ ä¼ å…¥çš„request,responseæå‰è¿‡æ»¤æ‰ä¸€äº›ä¿¡æ¯ï¼Œæˆ–è€…æå‰è®¾ç½®ä¸€äº›å‚æ•°ï¼Œç„¶åå†ä¼ å…¥servletæˆ–è€…strutsçš„ actionè¿›è¡Œä¸šåŠ¡é€»è¾‘ï¼Œæ¯”å¦‚è¿‡æ»¤æ‰éæ³•urlï¼ˆä¸æ˜¯login.doçš„åœ°å€è¯·æ±‚ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰ç™»é™†éƒ½è¿‡æ»¤æ‰ï¼‰,æˆ–è€…åœ¨ä¼ å…¥servletæˆ–è€… strutsçš„actionå‰ç»Ÿä¸€è®¾ç½®å­—ç¬¦é›†ï¼Œæˆ–è€…å»é™¤æ‰ä¸€äº›éæ³•å­—ç¬¦</span><br><span class="line"></span><br><span class="line">æ‹¦æˆªå™¨ï¼Œæ˜¯åœ¨é¢å‘åˆ‡é¢ç¼–ç¨‹çš„å°±æ˜¯åœ¨ä½ çš„serviceæˆ–è€…ä¸€ä¸ªæ–¹æ³•ï¼Œå‰è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ï¼Œæˆ–è€…åœ¨æ–¹æ³•åè°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ¯”å¦‚åŠ¨æ€ä»£ç†å°±æ˜¯æ‹¦æˆªå™¨çš„ç®€å•å®ç°ï¼Œåœ¨ä½ è°ƒç”¨æ–¹æ³•å‰æ‰“å°å‡ºå­—ç¬¦ä¸²ï¼ˆæˆ–è€…åšå…¶å®ƒä¸šåŠ¡é€»è¾‘çš„æ“ä½œï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨ä½ è°ƒç”¨æ–¹æ³•åæ‰“å°å‡ºå­—ç¬¦ä¸²ï¼Œç”šè‡³åœ¨ä½ æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™åšä¸šåŠ¡é€»è¾‘çš„æ“ä½œã€‚</span><br><span class="line"></span><br><span class="line">æ‹¦æˆªå™¨ä¸è¿‡æ»¤å™¨çš„åŒºåˆ«ï¼š</span><br><span class="line">æ‹¦æˆªå™¨æ˜¯åŸºäºjavaçš„åå°„æœºåˆ¶çš„ï¼Œè€Œè¿‡æ»¤å™¨æ˜¯åŸºäºå‡½æ•°å›è°ƒã€‚</span><br><span class="line">æ‹¦æˆªå™¨ä¸ä¾èµ–ä¸servletå®¹å™¨ï¼Œè¿‡æ»¤å™¨ä¾èµ–ä¸servletå®¹å™¨ã€‚</span><br><span class="line">æ‹¦æˆªå™¨åªèƒ½å¯¹actionè¯·æ±‚èµ·ä½œç”¨ï¼Œè€Œè¿‡æ»¤å™¨åˆ™å¯ä»¥å¯¹å‡ ä¹æ‰€æœ‰çš„è¯·æ±‚èµ·ä½œç”¨ã€‚</span><br><span class="line">æ‹¦æˆªå™¨å¯ä»¥è®¿é—®actionä¸Šä¸‹æ–‡ã€å€¼æ ˆé‡Œçš„å¯¹è±¡ï¼Œè€Œè¿‡æ»¤å™¨ä¸èƒ½è®¿é—®ã€‚</span><br><span class="line">åœ¨actionçš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œæ‹¦æˆªå™¨å¯ä»¥å¤šæ¬¡è¢«è°ƒç”¨ï¼Œè€Œè¿‡æ»¤å™¨åªèƒ½åœ¨å®¹å™¨åˆå§‹åŒ–æ—¶è¢«è°ƒç”¨ä¸€æ¬¡</span><br><span class="line"></span><br><span class="line">æ‰§è¡Œé¡ºåºï¼šè¿‡æ»¤å‰ â€“ æ‹¦æˆªå‰ â€“ Actionå¤„ç† â€“ æ‹¦æˆªå â€“ è¿‡æ»¤åã€‚ä¸ªäººè®¤ä¸ºè¿‡æ»¤æ˜¯ä¸€ä¸ªæ¨ªå‘çš„è¿‡ç¨‹ï¼Œé¦–å…ˆæŠŠå®¢æˆ·ç«¯æäº¤çš„å†…å®¹è¿›è¡Œè¿‡æ»¤(ä¾‹å¦‚æœªç™»å½•ç”¨æˆ·ä¸èƒ½è®¿é—®å†…éƒ¨é¡µé¢çš„å¤„ç†)ï¼›è¿‡æ»¤é€šè¿‡åï¼Œæ‹¦æˆªå™¨å°†æ£€æŸ¥ç”¨æˆ·æäº¤æ•°æ®çš„éªŒè¯ï¼Œåšä¸€äº›å‰æœŸçš„æ•°æ®å¤„ç†ï¼Œæ¥ç€æŠŠå¤„ç†åçš„æ•°æ®å‘ç»™å¯¹åº”çš„Actionï¼›Actionå¤„ç†å®Œæˆè¿”å›åï¼Œæ‹¦æˆªå™¨è¿˜å¯ä»¥åšå…¶ä»–è¿‡ç¨‹(è¿˜æ²¡æƒ³åˆ°è¦åšå•¥)ï¼Œå†å‘ä¸Šè¿”å›åˆ°è¿‡æ»¤å™¨çš„åç»­æ“ä½œã€‚</span><br></pre></td></tr></table></figure>



<h3 id="7-Optional"><a href="#7-Optional" class="headerlink" title="7.Optional"></a>7.Optional</h3><blockquote>
<p>ä¼ å€¼å°±ç”¨orElseï¼Œéœ€è¦è°ƒç”¨æ–¹æ³•è·å–å°±ç”¨orElseGet</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Optional.of(<span class="string">&quot;has value&quot;</span>).orElse(getDefault()); <span class="comment">//do invoke ä¼šæ‰§è¡Œ</span></span><br><span class="line">Optional.of(<span class="string">&quot;has value&quot;</span>).orElseGet(() -&gt; getDefault()); <span class="comment">// ä¸ä¼šæ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDefault</span><span class="params">()</span> &#123;</span><br><span class="line">  System.out.println(<span class="string">&quot;do invoke&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;default&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">å½“Optonalä¸ºç©ºæ—¶ï¼Œæ— è®ºorElseè¿˜æ˜¯orElseGetéƒ½ä¼šæ‰§è¡Œï¼›</span><br><span class="line">å½“Optionalæœ‰å€¼æ—¶ï¼ŒorElseä¼šæ‰§è¡Œï¼Œè€ŒorElseGetä¸ä¼šæ‰§è¡Œã€‚</span><br></pre></td></tr></table></figure>



<h3 id="8-è‡ªåŠ¨è£…é…"><a href="#8-è‡ªåŠ¨è£…é…" class="headerlink" title="8.è‡ªåŠ¨è£…é…"></a>8.è‡ªåŠ¨è£…é…</h3><p>ConditionalOnProperty ä¸­value &#x3D; havingValue åˆ™è‡ªåŠ¨è£…é…ç”Ÿæ•ˆï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(value = &quot;iot.message.uwb&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UwbMessageService</span> &#123;</span><br></pre></td></tr></table></figure>



<h3 id="9-ymlé…ç½®æ•°ç»„"><a href="#9-ymlé…ç½®æ•°ç»„" class="headerlink" title="9.ymlé…ç½®æ•°ç»„"></a>9.ymlé…ç½®æ•°ç»„</h3><h4 id="1-ls1"><a href="#1-ls1" class="headerlink" title="1.ls1"></a>1.ls1</h4><p>@Valueå¯ä»¥æ³¨å…¥é›†åˆå’Œæ•°ç»„ï¼Œä½†æ˜¯åªæœ‰å½“ä»¥,åˆ†å‰²çš„å­—ç¬¦ä¸²çš„æ—¶å€™æœ‰æ•ˆã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;iot.message.patrol&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> List&lt;String&gt; patrolSystemCodeList;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">iot:</span></span><br><span class="line">  <span class="attr">message:</span></span><br><span class="line">    <span class="attr">patrol:</span> <span class="number">0303</span><span class="string">,0402,0502,0503,0602</span></span><br></pre></td></tr></table></figure>





<h4 id="2-ls2"><a href="#2-ls2" class="headerlink" title="2.ls2"></a>2.ls2</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;#&#123;&#x27;$&#123;test.list&#125;&#x27;.split(&#x27;.&#x27;)&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String[] list2;</span><br></pre></td></tr></table></figure>



<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">list:</span> <span class="string">a.b.c</span></span><br></pre></td></tr></table></figure>



<h4 id="3-ls3"><a href="#3-ls3" class="headerlink" title="3.ls3"></a>3.ls3</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">map1:</span> <span class="string">&quot;&#123;key1:&#x27;4aad510231484dd18b9dfccca70b9846&#x27;,key2:&#x27;fbd747342b6d4cd3b887881060eb2ecc&#x27;&#125;&quot;</span></span><br><span class="line">  <span class="attr">map2:</span> <span class="string">&quot;&#123;key1:10434,key2:10037&#125;&quot;</span></span><br><span class="line">  <span class="attr">array:</span> <span class="number">1</span><span class="string">,2</span></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OpenConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;$&#123;test.map1&#125;&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; map1;</span><br><span class="line">    <span class="meta">@Value(&quot;#&#123;$&#123;test.map2&#125;&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Long&gt; map2; </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;test.array&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String[] arrays;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="10-è®¾è®¡æ¨¡å¼"><a href="#10-è®¾è®¡æ¨¡å¼" class="headerlink" title="10.è®¾è®¡æ¨¡å¼"></a>10.è®¾è®¡æ¨¡å¼</h3><h4 id="1-è´£ä»»é“¾æ¨¡å¼-if-else-åµŒå¥—"><a href="#1-è´£ä»»é“¾æ¨¡å¼-if-else-åµŒå¥—" class="headerlink" title="1.è´£ä»»é“¾æ¨¡å¼(if else åµŒå¥—)"></a>1.è´£ä»»é“¾æ¨¡å¼(if else åµŒå¥—)</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨ã€è´£ä»»é“¾æ¨¡å¼ã€æ¥ä¼˜åŒ– å‚æ•°å¤šé‡æ ¡éªŒï¼Œéå¸¸ä¼˜é›…ï¼</span></span><br><span class="line"><span class="comment"> * ä¹‹å‰åœ¨åšéœ€æ±‚ï¼Œå†™ä¸€ä¸ªæ–¹æ³•ï¼Œå…ˆåœ¨å‰é¢åšéªŒè¯ï¼Œ</span></span><br><span class="line"><span class="comment"> * ifä¸æ»¡è¶³Aæ¡ä»¶åˆ™returnï¼Œ</span></span><br><span class="line"><span class="comment"> * ifä¸æ»¡è¶³Bæ¡ä»¶åˆ™return...</span></span><br><span class="line"><span class="comment"> * ä¸€å…±å†™äº†5ä¸ªéªŒè¯ï¼Œç­‰éªŒè¯é€šè¿‡ä»¥åæ‰æ‰§è¡Œä¸‹é¢çš„é€»è¾‘ï¼Œ</span></span><br><span class="line"><span class="comment"> * è¿‡äº†ä¸€é˜µäº§å“æäº†éœ€æ±‚ï¼Œè·Ÿè¿™ä¸ªæ–¹æ³•ç±»ä¼¼ï¼Œ</span></span><br><span class="line"><span class="comment"> * æˆ‘åˆæŠŠè¿™ä¸ªæ–¹æ³•copyäº†ä¸€ä»½ï¼Œåªä¸è¿‡éªŒè¯æ¡ä»¶ç¨å¾®æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œå˜æˆ6ä¸ªéªŒè¯äº†ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Handler.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Handler</span>.Builder();</span><br><span class="line">        <span class="comment">//é“¾å¼ç¼–ç¨‹ï¼Œè°åœ¨å‰è°åœ¨åçœ‹çš„æ¸…æ¸…æ¥šæ¥š</span></span><br><span class="line">        builder.addHandler(<span class="keyword">new</span> <span class="title class_">ValidateHandler</span>())</span><br><span class="line">                .addHandler(<span class="keyword">new</span> <span class="title class_">LoginHandler</span>())</span><br><span class="line">                .addHandler(<span class="keyword">new</span> <span class="title class_">AuthHandler</span>())</span><br><span class="line">                .addHandler(<span class="keyword">new</span> <span class="title class_">BusinessLogicHandler</span>());</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setUserName(<span class="string">&quot;woniu&quot;</span>);</span><br><span class="line">        user.setPassWord(<span class="string">&quot;666&quot;</span>);</span><br><span class="line">        builder.build().doHandler(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.woniu.zerenliandemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String passWord;</span><br><span class="line">    <span class="keyword">private</span> String roleName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.woniu.zerenliandemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Handler</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Handler next;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">next</span><span class="params">(Handler next)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.next = next;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">doHandler</span><span class="params">(User user)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Builder</span>&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> Handler&lt;T&gt; head;</span><br><span class="line">        <span class="keyword">private</span> Handler&lt;T&gt; tail;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Builder&lt;T&gt; <span class="title function_">addHandler</span><span class="params">(Handler handler)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.head == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.head = <span class="built_in">this</span>.tail = handler;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.tail.next(handler);</span><br><span class="line">            <span class="built_in">this</span>.tail = handler;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Handler&lt;T&gt; <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.head;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doHandler</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;ç®¡ç†å‘˜&quot;</span>.equals(user.getRoleName())) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ‚¨ä¸æ˜¯ç®¡ç†å‘˜ï¼Œæ²¡æœ‰æ“ä½œæƒé™&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != next) &#123;</span><br><span class="line">            next.doHandler(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.woniu.zerenliandemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doHandler</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;woniu&quot;</span>.equals(user.getUserName()) || !<span class="string">&quot;666&quot;</span>.equals(user.getPassWord())) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç”¨æˆ·åå¯†ç ä¸æ­£ç¡®&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != next) &#123;</span><br><span class="line">            next.doHandler(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-ç­–ç•¥æ¨¡å¼ï¼ˆ-å¤šå±‚if-else-ï¼‰"><a href="#2-ç­–ç•¥æ¨¡å¼ï¼ˆ-å¤šå±‚if-else-ï¼‰" class="headerlink" title="2.ç­–ç•¥æ¨¡å¼ï¼ˆ å¤šå±‚if else ï¼‰"></a>2.ç­–ç•¥æ¨¡å¼ï¼ˆ å¤šå±‚if else ï¼‰</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿˜åœ¨ç”¨ç­–ç•¥æ¨¡å¼è§£å†³ if-elseï¼Ÿ</span></span><br><span class="line"><span class="comment"> * Map + å‡½æ•°å¼æ¥å£æ¥å¸®ä½ æå®šï¼</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æ ¹æ®ä¼˜æƒ åˆ¸ç±»å‹resourceType -&gt; ç¡®å®šæŸ¥è¯¢å“ªä¸ªæ•°æ®è¡¨</span></span><br><span class="line"><span class="comment"> * æ ¹æ®ç¼–ç resourceId -&gt; åˆ°å¯¹åº”çš„æ•°æ®è¡¨é‡Œè¾¹æŸ¥è¯¢ä¼˜æƒ åˆ¸çš„æ´¾å‘æ–¹å¼</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ä¼˜æƒ åˆ¸æœ‰å¤šç§ç±»å‹ï¼Œåˆ†åˆ«å¯¹åº”äº†ä¸åŒçš„æ•°æ®åº“è¡¨ï¼š</span></span><br><span class="line"><span class="comment"> * çº¢åŒ… â€”â€” çº¢åŒ…å‘æ”¾è§„åˆ™è¡¨</span></span><br><span class="line"><span class="comment"> * è´­ç‰©åˆ¸ â€”â€” è´­ç‰©åˆ¸è¡¨</span></span><br><span class="line"><span class="comment"> * ...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GrantTypeController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> QueryGrantTypeService queryGrantTypeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/grantType&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">(String resourceName,String resourceId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> queryGrantTypeService.getResult(resourceName,resourceId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryGrantTypeService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GrantTypeSerive grantTypeSerive;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Function&lt;String, String&gt;&gt; grantTypeMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–ä¸šåŠ¡åˆ†æ´¾é€»è¾‘,ä»£æ›¿äº†if-elseéƒ¨åˆ†</span></span><br><span class="line"><span class="comment">     * key: ä¼˜æƒ åˆ¸ç±»å‹</span></span><br><span class="line"><span class="comment">     * value: lambdaè¡¨è¾¾å¼,æœ€ç»ˆä¼šè·å¾—è¯¥ä¼˜æƒ åˆ¸çš„å‘æ”¾æ–¹å¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dispatcherInit</span><span class="params">()</span> &#123;</span><br><span class="line">        grantTypeMap.put(<span class="string">&quot;çº¢åŒ…&quot;</span>, resourceId -&gt; grantTypeSerive.redPaper(resourceId));</span><br><span class="line">        grantTypeMap.put(<span class="string">&quot;è´­ç‰©åˆ¸&quot;</span>, resourceId -&gt; grantTypeSerive.shopping(resourceId));</span><br><span class="line">        grantTypeMap.put(<span class="string">&quot;qqä¼šå‘˜&quot;</span>, resourceId -&gt; grantTypeSerive.QQVip(resourceId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getResult</span><span class="params">(String resourceType, String resourceId)</span> &#123;</span><br><span class="line">        <span class="comment">//Controlleræ ¹æ® ä¼˜æƒ åˆ¸ç±»å‹resourceTypeã€ç¼–ç resourceId å»æŸ¥è¯¢ å‘æ”¾æ–¹å¼grantType</span></span><br><span class="line">        Function&lt;String, String&gt; result = grantTypeMap.get(resourceType);</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//ä¼ å…¥resourceId æ‰§è¡Œè¿™æ®µè¡¨è¾¾å¼è·å¾—Stringå‹çš„grantType</span></span><br><span class="line">            <span class="keyword">return</span> result.apply(resourceId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;æŸ¥è¯¢ä¸åˆ°è¯¥ä¼˜æƒ åˆ¸çš„å‘æ”¾æ–¹å¼&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;	</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GrantTypeSerive</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">redPaper</span><span class="params">(String resourceId)</span> &#123;</span><br><span class="line">        <span class="comment">//çº¢åŒ…çš„å‘æ”¾æ–¹å¼</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;æ¯å‘¨æœ«9ç‚¹å‘æ”¾&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">shopping</span><span class="params">(String resourceId)</span> &#123;</span><br><span class="line">        <span class="comment">//è´­ç‰©åˆ¸çš„å‘æ”¾æ–¹å¼</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;æ¯å‘¨ä¸‰9ç‚¹å‘æ”¾&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">QQVip</span><span class="params">(String resourceId)</span> &#123;</span><br><span class="line">        <span class="comment">//qqä¼šå‘˜çš„å‘æ”¾æ–¹å¼</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;æ¯å‘¨ä¸€0ç‚¹å¼€å§‹ç§’æ€&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="11-druid-æŠ¥é”™"><a href="#11-druid-æŠ¥é”™" class="headerlink" title="11.druid æŠ¥é”™"></a>11.druid æŠ¥é”™</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* è§£å†³druid æ—¥å¿—æŠ¥é”™ï¼šdiscard long time none received connection:xxx</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setProperties</span><span class="params">()</span>&#123;</span><br><span class="line">    System.setProperty(<span class="string">&quot;druid.mysql.usePingMethod&quot;</span>,<span class="string">&quot;false&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    System.setProperty(<span class="string">&quot;druid.mysql.usePingMethod&quot;</span>,<span class="string">&quot;false&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="12-mapepræ˜ å°„"><a href="#12-mapepræ˜ å°„" class="headerlink" title="12.mapepræ˜ å°„"></a>12.mapepræ˜ å°„</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.nrec.integration.iot.entity.EquipmentInfo;</span><br><span class="line"><span class="keyword">import</span> com.nrec.integration.iot.entity.IotSubsystemAppInfo;</span><br><span class="line"><span class="keyword">import</span> com.nrec.integration.iot.model.dto.IntelligentEquipment;</span><br><span class="line"><span class="keyword">import</span> org.mapstruct.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.mapstruct.Mapping;</span><br><span class="line"><span class="keyword">import</span> org.mapstruct.factory.Mappers;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EquipmentConvert</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">EquipmentConvert</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> Mappers.getMapper(EquipmentConvert.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * intelligentEquipment è½¬ equipmentInfo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> intelligentEquipment</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Mapping(source = &quot;intelligentEquipment.deviceId&quot;, target = &quot;id&quot;)</span></span><br><span class="line">    <span class="meta">@Mapping(source = &quot;iotSubsystemAppInfo.subsystemCode&quot;, target = &quot;systemCode&quot;)</span></span><br><span class="line">    EquipmentInfo <span class="title function_">toEquipmentInfo</span><span class="params">(IntelligentEquipment intelligentEquipment,</span></span><br><span class="line"><span class="params">                                  IotSubsystemAppInfo iotSubsystemAppInfo)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">EquipmentInfo</span> <span class="variable">equipmentInfo</span> <span class="operator">=</span> EquipmentConvert.INSTANCE.toEquipmentInfo(intelligentEquipment, iotSubsystemAppInfo)</span><br></pre></td></tr></table></figure>



<h3 id="13-å¾—åˆ°æ³¨è§£ä¸Šçš„å€¼"><a href="#13-å¾—åˆ°æ³¨è§£ä¸Šçš„å€¼" class="headerlink" title="13.å¾—åˆ°æ³¨è§£ä¸Šçš„å€¼"></a>13.å¾—åˆ°æ³¨è§£ä¸Šçš„å€¼</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.FIELD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> TestAn &#123;</span><br><span class="line"></span><br><span class="line">    String [] value() <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">index</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TestAn(value = &#123;&quot;value1&quot;,&quot;value2&quot;&#125;, index = 1)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TestAn(value = &#123;&quot;value3&quot;&#125;, index = 2)</span></span><br><span class="line">    <span class="keyword">private</span> Integer score;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException &#123;</span><br><span class="line">        Map&lt;Integer, String&gt; nameMap = getIndexNameMap(User.class);</span><br><span class="line">        System.out.println(nameMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> é€šè¿‡classè·å–ç±»å­—æ®µä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;Integer, String&gt; <span class="title function_">getIndexNameMap</span><span class="params">(Class clazz)</span> <span class="keyword">throws</span> NoSuchFieldException &#123;</span><br><span class="line">        <span class="comment">//è·å–ç±»ä¸­æ‰€æœ‰çš„å±æ€§</span></span><br><span class="line">        Field[] fields = clazz.getDeclaredFields();</span><br><span class="line">        Map&lt;Integer, String&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(fields.length);</span><br><span class="line">        Field field;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; fields.length; i++) &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fields[i].getName());</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">//è·å–æ ¹æ®æ³¨è§£çš„æ–¹å¼è·å–ExcelPropertyä¿®é¥°çš„å­—æ®µ</span></span><br><span class="line">            <span class="type">TestAn</span> <span class="variable">annotation</span> <span class="operator">=</span> field.getAnnotation(TestAn.class);</span><br><span class="line">            <span class="keyword">if</span> (annotation != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//ç´¢å¼•å€¼</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> annotation.index();</span><br><span class="line">                <span class="comment">//å­—æ®µå€¼</span></span><br><span class="line">                String[] values = annotation.value();</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">value</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                <span class="keyword">for</span> (String v : values) &#123;</span><br><span class="line">                    value.append(v);</span><br><span class="line">                &#125;</span><br><span class="line">                result.put(index, value.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="14-aop"><a href="#14-aop" class="headerlink" title="14.aop"></a>14.aop</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼š joinPoint.proceed() ï¼Œreturnçš„æ•°æ®å°±æ˜¯ è°ƒç”¨ç€çš„return</span><br><span class="line"> è‡ªå·± return ï¼Œreturnçš„æ•°æ®å°±æ˜¯åœ¨è¿™é‡Œaround()è¿™é‡Œçš„æ–¹æ³•ã€è°ƒç”¨è€…returnçš„å€¼æ— æ•ˆ</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>summary</category>
      </categories>
      <tags>
        <tag>summary</tag>
      </tags>
  </entry>
  <entry>
    <title>å¤šçº¿ç¨‹</title>
    <url>/2022/12/09/%E5%A4%9A%E7%BA%BF%E7%A8%8B/</url>
    <content><![CDATA[<p>ç›¸å…³æ–‡ç« </p>
<p>å¹¶å‘é¢è¯•é¢˜<br><a href="https://www.javazhiyin.com/32391.html">https://www.javazhiyin.com/32391.html</a></p>
<p><strong>javaé”æ–‡ç« </strong></p>
<h3 id="Java-å†…å­˜æ¨¡å‹"><a href="#Java-å†…å­˜æ¨¡å‹" class="headerlink" title="Java å†…å­˜æ¨¡å‹"></a>Java å†…å­˜æ¨¡å‹</h3><p>Java å†…å­˜æ¨¡å‹è¯•å›¾å±è”½å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œä»¥å®ç°è®© Java ç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å†…å­˜è®¿é—®æ•ˆæœã€‚</p>
<h3 id="ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜"><a href="#ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜" class="headerlink" title="ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜"></a>ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜</h3><p>å¤„ç†å™¨ä¸Šçš„å¯„å­˜å™¨çš„è¯»å†™çš„é€Ÿåº¦æ¯”å†…å­˜å¿«å‡ ä¸ªæ•°é‡çº§ï¼Œä¸ºäº†è§£å†³è¿™ç§é€Ÿåº¦çŸ›ç›¾ï¼Œåœ¨å®ƒä»¬ä¹‹é—´åŠ å…¥äº†é«˜é€Ÿç¼“å­˜ã€‚</p>
<p>åŠ å…¥é«˜é€Ÿç¼“å­˜å¸¦æ¥äº†ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼šç¼“å­˜ä¸€è‡´æ€§ã€‚å¦‚æœå¤šä¸ªç¼“å­˜å…±äº«åŒä¸€å—ä¸»å†…å­˜åŒºåŸŸï¼Œé‚£ä¹ˆå¤šä¸ªç¼“å­˜çš„æ•°æ®å¯èƒ½ä¼šä¸ä¸€è‡´ï¼Œéœ€è¦ä¸€äº›åè®®æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p><a href="https://camo.githubusercontent.com/7e289aaee2d8533d8870f92659a8984be81eb432/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f39343263613064322d396435632d343561342d383963622d3566643839623631393133662e706e67"><img src="https://camo.githubusercontent.com/7e289aaee2d8533d8870f92659a8984be81eb432/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f39343263613064322d396435632d343561342d383963622d3566643839623631393133662e706e67" alt="img"></a></p>
<p>æ‰€æœ‰çš„å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹è¿˜æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œå·¥ä½œå†…å­˜å­˜å‚¨åœ¨é«˜é€Ÿç¼“å­˜æˆ–è€…å¯„å­˜å™¨ä¸­ï¼Œä¿å­˜äº†è¯¥çº¿ç¨‹ä½¿ç”¨çš„å˜é‡çš„ä¸»å†…å­˜å‰¯æœ¬æ‹·è´ã€‚</p>
<p>çº¿ç¨‹åªèƒ½ç›´æ¥æ“ä½œå·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´çš„å˜é‡å€¼ä¼ é€’éœ€è¦é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆã€‚</p>
<p><a href="https://camo.githubusercontent.com/fce232dcfc7411192b429ae86765aa9bef029427/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f31353835313535352d356162632d343937642d616433342d6566656431306634336136622e706e67"><img src="https://camo.githubusercontent.com/fce232dcfc7411192b429ae86765aa9bef029427/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f31353835313535352d356162632d343937642d616433342d6566656431306634336136622e706e67" alt="img"></a></p>
<h3 id="å†…å­˜é—´äº¤äº’æ“ä½œ"><a href="#å†…å­˜é—´äº¤äº’æ“ä½œ" class="headerlink" title="å†…å­˜é—´äº¤äº’æ“ä½œ"></a>å†…å­˜é—´äº¤äº’æ“ä½œ</h3><p>Java å†…å­˜æ¨¡å‹å®šä¹‰äº† 8 ä¸ªæ“ä½œæ¥å®Œæˆä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜çš„äº¤äº’æ“ä½œã€‚</p>
<p><a href="https://camo.githubusercontent.com/42696b8f0b2cfbf78024f9cd0d806e0e6decb5fe/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f38623765626261642d393630342d343337352d383465332d6634313230393964313730632e706e67"><img src="https://camo.githubusercontent.com/42696b8f0b2cfbf78024f9cd0d806e0e6decb5fe/68747470733a2f2f63732d6e6f7465732d313235363130393739362e636f732e61702d6775616e677a686f752e6d7971636c6f75642e636f6d2f38623765626261642d393630342d343337352d383465332d6634313230393964313730632e706e67" alt="img"></a></p>
<ul>
<li>readï¼šæŠŠä¸€ä¸ªå˜é‡çš„å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°å·¥ä½œå†…å­˜ä¸­</li>
<li>loadï¼šåœ¨ read ä¹‹åæ‰§è¡Œï¼ŒæŠŠ read å¾—åˆ°çš„å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ä¸­</li>
<li>useï¼šæŠŠå·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€’ç»™æ‰§è¡Œå¼•æ“</li>
<li>assignï¼šæŠŠä¸€ä¸ªä»æ‰§è¡Œå¼•æ“æ¥æ”¶åˆ°çš„å€¼èµ‹ç»™å·¥ä½œå†…å­˜çš„å˜é‡</li>
<li>storeï¼šæŠŠå·¥ä½œå†…å­˜çš„ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜ä¸­</li>
<li>writeï¼šåœ¨ store ä¹‹åæ‰§è¡Œï¼ŒæŠŠ store å¾—åˆ°çš„å€¼æ”¾å…¥ä¸»å†…å­˜çš„å˜é‡ä¸­</li>
<li>lockï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡</li>
<li>unlock</li>
</ul>
<h3 id="å•æ ¸-CPU-å’Œå¤šæ ¸-CPU"><a href="#å•æ ¸-CPU-å’Œå¤šæ ¸-CPU" class="headerlink" title="å•æ ¸ CPU å’Œå¤šæ ¸ CPU"></a>å•æ ¸ CPU å’Œå¤šæ ¸ CPU</h3><p>æ¥æ€è€ƒä¸€ä¸ªé—®é¢˜å§ã€‚å‡å¦‚ CPU åªæœ‰ä¸€ä¸ªï¼Œæ ¸æ•°ä¹Ÿåªæœ‰ä¸€ä¸ªï¼Œå¤šçº¿ç¨‹è¿˜ä¼šæœ‰ä¼˜åŠ¿å—ï¼Ÿ</p>
<p>é—­ä¸Šçœ¼ï¼Œè®©æ€ç»´æ—‹è½¬è·³è·ƒä¼šã€‚</p>
<p>æ¥çœ‹ç­”æ¡ˆå§ã€‚</p>
<p>å•æ ¸ CPU ä¸Šè¿è¡Œçš„å¤šçº¿ç¨‹ç¨‹åºï¼ŒåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è·‘ï¼Œç³»ç»Ÿå¸®å¿™è¿›è¡Œçº¿ç¨‹åˆ‡æ¢ï¼›ç³»ç»Ÿç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…æ—¶é—´ç‰‡ï¼ˆå¤§æ¦‚ 10msï¼‰æ¥æ‰§è¡Œï¼Œçœ‹èµ·æ¥åƒæ˜¯åœ¨åŒæ—¶è·‘ï¼Œä½†å®é™…ä¸Šæ˜¯æ¯ä¸ªçº¿ç¨‹è·‘ä¸€ç‚¹ç‚¹å°±æ¢åˆ°å…¶å®ƒçº¿ç¨‹ç»§ç»­è·‘ã€‚æ‰€ä»¥æ•ˆç‡ä¸ä¼šæœ‰æ‰€æé«˜ï¼Œçº¿ç¨‹çš„åˆ‡æ¢ååˆ°å¢åŠ äº†ç³»ç»Ÿå¼€é”€ã€‚</p>
<p>é‚£å¤šæ ¸ CPU å‘¢ï¼Ÿ</p>
<p>å½“ç„¶æœ‰ä¼˜åŠ¿äº†ï¼å¤šæ ¸éœ€è¦å¤šçº¿ç¨‹æ‰èƒ½å‘æŒ¥ä¼˜åŠ¿ï¼ˆä¸ç„¶å·§å¦‡éš¾ä¸ºæ— ç±³ä¹‹ç‚Šå•Šï¼‰ï¼ŒåŒæ ·ï¼Œå¤šçº¿ç¨‹è¦åœ¨å¤šæ ¸ä¸Šæ‰èƒ½æœ‰æ‰€å‘æŒ¥ï¼ˆå¥½é©¬é…å¥½éå•Šï¼‰ã€‚</p>
<p>å¤šæ ¸ CPU å¤šçº¿ç¨‹ä¸ä»…å–„äºå¤„ç† IO å¯†é›†å‹çš„ä»»åŠ¡ï¼ˆå‡å°‘é˜»å¡æ—¶é—´ï¼‰ï¼Œè¿˜å–„äºå¤„ç†è®¡ç®—å¯†é›†å‹çš„ä»»åŠ¡ï¼Œæ¯”å¦‚åŠ å¯†è§£å¯†ã€æ•°æ®å‹ç¼©è§£å‹ç¼©ï¼ˆè§†é¢‘ã€éŸ³é¢‘ã€æ™®é€šæ•°æ®ç­‰ï¼‰ï¼Œè®©æ¯ä¸ªæ ¸å¿ƒéƒ½ç‰©å°½å…¶ç”¨ã€‚</p>
<h3 id="åº”è¯¥äº†è§£çš„æ¦‚å¿µ"><a href="#åº”è¯¥äº†è§£çš„æ¦‚å¿µ" class="headerlink" title="åº”è¯¥äº†è§£çš„æ¦‚å¿µ"></a>åº”è¯¥äº†è§£çš„æ¦‚å¿µ</h3><ol>
<li>åŒæ­¥VSå¼‚æ­¥</li>
</ol>
<blockquote>
<p>åŒæ­¥å’Œå¼‚æ­¥é€šå¸¸ç”¨æ¥å½¢å®¹ä¸€æ¬¡æ–¹æ³•è°ƒç”¨ã€‚åŒæ­¥æ–¹æ³•è°ƒç”¨ä¸€å¼€å§‹ï¼Œè°ƒç”¨è€…å¿…é¡»ç­‰å¾…è¢«è°ƒç”¨çš„æ–¹æ³•ç»“æŸåï¼Œè°ƒç”¨è€…åé¢çš„ä»£ç æ‰èƒ½æ‰§è¡Œã€‚è€Œå¼‚æ­¥è°ƒç”¨ï¼ŒæŒ‡çš„æ˜¯ï¼Œè°ƒç”¨è€…ä¸ç”¨ç®¡è¢«è°ƒç”¨æ–¹æ³•æ˜¯å¦å®Œæˆï¼Œéƒ½ä¼šç»§ç»­æ‰§è¡Œåé¢çš„ä»£ç ï¼Œå½“è¢«è°ƒç”¨çš„æ–¹æ³•å®Œæˆåä¼šé€šçŸ¥è°ƒç”¨è€…ã€‚æ¯”å¦‚ï¼Œåœ¨è¶…æ—¶è´­ç‰©ï¼Œå¦‚æœä¸€ä»¶ç‰©å“æ²¡äº†ï¼Œä½ å¾—ç­‰ä»“åº“äººå‘˜è·Ÿä½ è°ƒè´§ï¼Œç›´åˆ°ä»“åº“äººå‘˜è·Ÿä½ æŠŠè´§ç‰©é€è¿‡æ¥ï¼Œä½ æ‰èƒ½ç»§ç»­å»æ”¶é“¶å°ä»˜æ¬¾ï¼Œè¿™å°±ç±»ä¼¼åŒæ­¥è°ƒç”¨ã€‚è€Œå¼‚æ­¥è°ƒç”¨äº†ï¼Œå°±åƒç½‘è´­ï¼Œä½ åœ¨ç½‘ä¸Šä»˜æ¬¾ä¸‹å•åï¼Œä»€ä¹ˆäº‹å°±ä¸ç”¨ç®¡äº†ï¼Œè¯¥å¹²å˜›å°±å¹²å˜›å»äº†ï¼Œå½“è´§ç‰©åˆ°è¾¾åä½ æ”¶åˆ°é€šçŸ¥å»å–å°±å¥½ã€‚</p>
</blockquote>
<ol>
<li>å¹¶å‘ä¸å¹¶è¡Œ</li>
</ol>
<blockquote>
<p>å¹¶å‘å’Œå¹¶è¡Œæ˜¯ååˆ†å®¹æ˜“æ··æ·†çš„æ¦‚å¿µã€‚å¹¶å‘æŒ‡çš„æ˜¯å¤šä¸ªä»»åŠ¡äº¤æ›¿è¿›è¡Œï¼Œè€Œå¹¶è¡Œåˆ™æ˜¯æŒ‡çœŸæ­£æ„ä¹‰ä¸Šçš„â€œåŒæ—¶è¿›è¡Œâ€ã€‚å®é™…ä¸Šï¼Œå¦‚æœç³»ç»Ÿå†…åªæœ‰ä¸€ä¸ªCPUï¼Œè€Œä½¿ç”¨å¤šçº¿ç¨‹æ—¶ï¼Œé‚£ä¹ˆçœŸå®ç³»ç»Ÿç¯å¢ƒä¸‹ä¸èƒ½å¹¶è¡Œï¼Œåªèƒ½é€šè¿‡åˆ‡æ¢æ—¶é—´ç‰‡çš„æ–¹å¼äº¤æ›¿è¿›è¡Œï¼Œè€Œæˆä¸ºå¹¶å‘æ‰§è¡Œä»»åŠ¡ã€‚çœŸæ­£çš„å¹¶è¡Œä¹Ÿåªèƒ½å‡ºç°åœ¨æ‹¥æœ‰å¤šä¸ªCPUçš„ç³»ç»Ÿä¸­ã€‚</p>
</blockquote>
<ol>
<li>é˜»å¡å’Œéé˜»å¡</li>
</ol>
<blockquote>
<p>é˜»å¡å’Œéé˜»å¡é€šå¸¸ç”¨æ¥å½¢å®¹å¤šçº¿ç¨‹é—´çš„ç›¸äº’å½±å“ï¼Œæ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹å æœ‰äº†ä¸´ç•ŒåŒºèµ„æºï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹éœ€è¦è¿™ä¸ªèµ„æºå°±å¿…é¡»è¿›è¡Œç­‰å¾…è¯¥èµ„æºçš„é‡Šæ”¾ï¼Œä¼šå¯¼è‡´ç­‰å¾…çš„çº¿ç¨‹æŒ‚èµ·ï¼Œè¿™ç§æƒ…å†µå°±æ˜¯é˜»å¡ï¼Œè€Œéé˜»å¡å°±æ°å¥½ç›¸åï¼Œå®ƒå¼ºè°ƒæ²¡æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥é˜»å¡å…¶ä»–çº¿ç¨‹ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä¼šå°è¯•åœ°å¾€å‰è¿è¡Œã€‚</p>
</blockquote>
<ol>
<li>ä¸´ç•ŒåŒº</li>
</ol>
<blockquote>
<p>ä¸´ç•ŒåŒºç”¨æ¥è¡¨ç¤ºä¸€ç§å…¬å…±èµ„æºæˆ–è€…è¯´æ˜¯å…±äº«æ•°æ®ï¼Œå¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹ä½¿ç”¨ã€‚ä½†æ˜¯æ¯ä¸ªçº¿ç¨‹ä½¿ç”¨æ—¶ï¼Œä¸€æ—¦ä¸´ç•ŒåŒºèµ„æºè¢«ä¸€ä¸ªçº¿ç¨‹å æœ‰ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…ã€‚</p>
</blockquote>
<h3 id="åˆ›å»ºå¤šå°‘ä¸ªçº¿ç¨‹åˆé€‚"><a href="#åˆ›å»ºå¤šå°‘ä¸ªçº¿ç¨‹åˆé€‚" class="headerlink" title="åˆ›å»ºå¤šå°‘ä¸ªçº¿ç¨‹åˆé€‚"></a>åˆ›å»ºå¤šå°‘ä¸ªçº¿ç¨‹åˆé€‚</h3><blockquote>
<p>ä½¿ç”¨å¤šçº¿ç¨‹å°±æ˜¯åœ¨æ­£ç¡®çš„åœºæ™¯ä¸‹é€šè¿‡è®¾ç½®æ­£ç¡®ä¸ªæ•°çš„çº¿ç¨‹æ¥æœ€å¤§åŒ–ç¨‹åºçš„è¿è¡Œé€Ÿåº¦</p>
</blockquote>
<p>åœ¨èŠå…·ä½“åœºæ™¯çš„æ—¶å€™ï¼Œç»“åˆå…·ä½“çš„ä¸šåŠ¡ï¼Œåˆ†ä¸ºä»¥ä¸‹ä¸¤ç§</p>
<ul>
<li>CPU å¯†é›†å‹ç¨‹åº</li>
<li>I&#x2F;O å¯†é›†å‹ç¨‹åº</li>
</ul>
<h4 id="CPU-å¯†é›†å‹ç¨‹åº"><a href="#CPU-å¯†é›†å‹ç¨‹åº" class="headerlink" title="CPU å¯†é›†å‹ç¨‹åº"></a>CPU å¯†é›†å‹ç¨‹åº</h4><blockquote>
<p>ä¸€ä¸ªå®Œæ•´è¯·æ±‚ï¼ŒI&#x2F;Oæ“ä½œå¯ä»¥åœ¨å¾ˆçŸ­æ—¶é—´å†…å®Œæˆï¼Œ CPUè¿˜æœ‰å¾ˆå¤šè¿ç®—è¦å¤„ç†ï¼Œä¹Ÿå°±æ˜¯è¯´ CPU è®¡ç®—çš„æ¯”ä¾‹å å¾ˆå¤§ä¸€éƒ¨åˆ†</p>
</blockquote>
<p>å‡å¦‚æˆ‘ä»¬è¦è®¡ç®— 1+2+â€¦.100äº¿ çš„æ€»å’Œï¼Œå¾ˆæ˜æ˜¾ï¼Œè¿™å°±æ˜¯ä¸€ä¸ª CPU å¯†é›†å‹ç¨‹åº</p>
<p>åœ¨ã€å•æ ¸ã€‘CPUä¸‹ï¼Œå¦‚æœæˆ‘ä»¬åˆ›å»º 4 ä¸ªçº¿ç¨‹æ¥åˆ†æ®µè®¡ç®—ï¼Œå³ï¼š</p>
<ol>
<li>çº¿ç¨‹1è®¡ç®— <code>[1,25äº¿ï¼‰</code></li>
<li>â€¦â€¦ ä»¥æ­¤ç±»æ¨</li>
<li>çº¿ç¨‹4è®¡ç®— &#96;[75äº¿ï¼Œ100äº¿]</li>
</ol>
<p>ç”±äºæ˜¯å•æ ¸ CPUï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½åœ¨ç­‰å¾… CPU æ—¶é—´ç‰‡ã€‚æŒ‰ç…§ç†æƒ³æƒ…å†µæ¥çœ‹ï¼Œå››ä¸ªçº¿ç¨‹æ‰§è¡Œçš„æ—¶é—´æ€»å’Œä¸ä¸€ä¸ªçº¿ç¨‹5ç‹¬è‡ªå®Œæˆæ˜¯ç›¸ç­‰çš„ï¼Œå®é™…ä¸Šæˆ‘ä»¬è¿˜å¿½ç•¥äº†å››ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€</p>
<p><strong>æ‰€ä»¥ï¼Œå•æ ¸CPUå¤„ç†CPUå¯†é›†å‹ç¨‹åºï¼Œè¿™ç§æƒ…å†µå¹¶ä¸å¤ªé€‚åˆä½¿ç”¨å¤šçº¿ç¨‹ï¼Œå¦‚æœæ˜¯å¤šæ ¸CPU å¤„ç† CPU å¯†é›†å‹ç¨‹åºï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥æœ€å¤§åŒ–çš„åˆ©ç”¨ CPU æ ¸å¿ƒæ•°ï¼Œåº”ç”¨å¹¶å‘ç¼–ç¨‹æ¥æé«˜æ•ˆç‡</strong></p>
<h3 id="I-x2F-Oå¯†é›†å‹ç¨‹åº"><a href="#I-x2F-Oå¯†é›†å‹ç¨‹åº" class="headerlink" title="I&#x2F;Oå¯†é›†å‹ç¨‹åº"></a>I&#x2F;Oå¯†é›†å‹ç¨‹åº</h3><blockquote>
<p>ä¸ CPU å¯†é›†å‹ç¨‹åºç›¸å¯¹ï¼Œä¸€ä¸ªå®Œæ•´è¯·æ±‚ï¼ŒCPUè¿ç®—æ“ä½œå®Œæˆä¹‹åè¿˜æœ‰å¾ˆå¤š I&#x2F;O æ“ä½œè¦åšï¼Œä¹Ÿå°±æ˜¯è¯´ I&#x2F;O æ“ä½œå æ¯”å¾ˆå¤§éƒ¨åˆ†</p>
</blockquote>
<p>æˆ‘ä»¬éƒ½çŸ¥é“åœ¨è¿›è¡Œ I&#x2F;O æ“ä½œæ—¶ï¼ŒCPUæ˜¯ç©ºé—²çŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æœ€å¤§åŒ–çš„åˆ©ç”¨ CPUï¼Œä¸èƒ½è®©å…¶æ˜¯ç©ºé—²çŠ¶æ€</p>
<h4 id="CPU-å¯†é›†å‹ç¨‹åºåˆ›å»ºå¤šå°‘ä¸ªçº¿ç¨‹åˆé€‚ï¼Ÿ"><a href="#CPU-å¯†é›†å‹ç¨‹åºåˆ›å»ºå¤šå°‘ä¸ªçº¿ç¨‹åˆé€‚ï¼Ÿ" class="headerlink" title="CPU å¯†é›†å‹ç¨‹åºåˆ›å»ºå¤šå°‘ä¸ªçº¿ç¨‹åˆé€‚ï¼Ÿ"></a>CPU å¯†é›†å‹ç¨‹åºåˆ›å»ºå¤šå°‘ä¸ªçº¿ç¨‹åˆé€‚ï¼Ÿ</h4><p>å¯¹äº CPU å¯†é›†å‹æ¥è¯´ï¼Œç†è®ºä¸Š <code>çº¿ç¨‹æ•°é‡ = CPU æ ¸æ•°(é€»è¾‘)</code>å°±å¯ä»¥äº†ï¼Œä½†æ˜¯å®é™…ä¸Šï¼Œæ•°é‡ä¸€èˆ¬ä¼šè®¾ç½®ä¸º <code>CPU æ ¸æ•°ï¼ˆé€»è¾‘ï¼‰+ 1</code>ï¼Œ ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹è¿™ä¹ˆè¯´ï¼š</p>
<blockquote>
<p>è®¡ç®—(CPU)å¯†é›†å‹çš„çº¿ç¨‹æ°å¥½åœ¨æŸæ—¶å› ä¸ºå‘ç”Ÿä¸€ä¸ªé¡µé”™è¯¯æˆ–è€…å› å…¶ä»–åŸå› è€Œæš‚åœï¼Œåˆšå¥½æœ‰ä¸€ä¸ªâ€œé¢å¤–â€çš„çº¿ç¨‹ï¼Œå¯ä»¥ç¡®ä¿åœ¨è¿™ç§æƒ…å†µä¸‹CPUå‘¨æœŸä¸ä¼šä¸­æ–­å·¥ä½œã€‚</p>
</blockquote>
<p>æ‰€ä»¥å¯¹äºCPUå¯†é›†å‹ç¨‹åºï¼Œ  <code>CPU æ ¸æ•°ï¼ˆé€»è¾‘ï¼‰+ 1</code> ä¸ªçº¿ç¨‹æ•°æ˜¯æ¯”è¾ƒå¥½çš„ç»éªŒå€¼çš„åŸå› äº†</p>
<h3 id="çº¿ç¨‹"><a href="#çº¿ç¨‹" class="headerlink" title="çº¿ç¨‹"></a>çº¿ç¨‹</h3><h4 id="å¤šçº¿ç¨‹çš„ç‰¹æ€§"><a href="#å¤šçº¿ç¨‹çš„ç‰¹æ€§" class="headerlink" title="å¤šçº¿ç¨‹çš„ç‰¹æ€§"></a>å¤šçº¿ç¨‹çš„ç‰¹æ€§</h4><blockquote>
<p>javaå¤šçº¿ç¨‹å¼€å‘å½“ä¸­æˆ‘ä»¬ä¸ºäº†çº¿ç¨‹å®‰å…¨æ‰€åšçš„ä»»ä½•æ“ä½œå…¶å®éƒ½æ˜¯å›´ç»•å¤šçº¿ç¨‹çš„ä¸‰ä¸ªç‰¹æ€§ï¼šåŸå­æ€§ã€å¯è§æ€§ã€æœ‰åºæ€§å±•å¼€çš„</p>
</blockquote>
<ol>
<li>ä»€ä¹ˆæ˜¯åŸå­æ€§</li>
</ol>
<p>å³ä¸€ä¸ªæ“ä½œæˆ–è€…å¤šä¸ªæ“ä½œ è¦ä¹ˆå…¨éƒ¨æ‰§è¡Œå¹¶ä¸”æ‰§è¡Œçš„è¿‡ç¨‹ä¸ä¼šè¢«ä»»ä½•å› ç´ æ‰“æ–­ï¼Œè¦ä¹ˆå°±éƒ½ä¸æ‰§è¡Œã€‚</p>
<p>ä¸€ä¸ªå¾ˆç»å…¸çš„ä¾‹å­å°±æ˜¯é“¶è¡Œè´¦æˆ·è½¬è´¦é—®é¢˜ï¼š</p>
<p>æ¯”å¦‚ä»è´¦æˆ·Aå‘è´¦æˆ·Bè½¬1000å…ƒï¼Œé‚£ä¹ˆå¿…ç„¶åŒ…æ‹¬2ä¸ªæ“ä½œï¼šä»è´¦æˆ·Aå‡å»1000å…ƒï¼Œå¾€è´¦æˆ·BåŠ ä¸Š1000å…ƒã€‚è¿™2ä¸ªæ“ä½œå¿…é¡»è¦å…·å¤‡åŸå­æ€§æ‰èƒ½ä¿è¯ä¸å‡ºç°ä¸€äº›æ„å¤–çš„é—®é¢˜ã€‚<br>æˆ‘ä»¬æ“ä½œæ•°æ®ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œæ¯”å¦‚i &#x3D; i+1ï¼›å…¶ä¸­å°±åŒ…æ‹¬ï¼Œè¯»å–içš„å€¼ï¼Œè®¡ç®—iï¼Œå†™å…¥iã€‚è¿™è¡Œä»£ç åœ¨Javaä¸­æ˜¯ä¸å…·å¤‡åŸå­æ€§çš„ï¼Œåˆ™å¤šçº¿ç¨‹è¿è¡Œè‚¯å®šä¼šå‡ºé—®é¢˜ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦æˆ‘ä»¬ä½¿ç”¨åŒæ­¥å’Œlockè¿™äº›ä¸œè¥¿æ¥ç¡®ä¿è¿™ä¸ªç‰¹æ€§äº†ã€‚<br>åŸå­æ€§å…¶å®å°±æ˜¯ä¿è¯æ•°æ®ä¸€è‡´ã€çº¿ç¨‹å®‰å…¨ä¸€éƒ¨åˆ†ï¼Œ</p>
<ol>
<li>ä»€ä¹ˆæ˜¯å¯è§æ€§</li>
</ol>
<p>å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹å¾—åˆ°ä¿®æ”¹çš„å€¼ã€‚</p>
<p>è‹¥ä¸¤ä¸ªçº¿ç¨‹åœ¨ä¸åŒçš„cpuï¼Œé‚£ä¹ˆçº¿ç¨‹1æ”¹å˜äº†içš„å€¼è¿˜æ²¡åˆ·æ–°åˆ°ä¸»å­˜ï¼Œçº¿ç¨‹2åˆä½¿ç”¨äº†iï¼Œé‚£ä¹ˆè¿™ä¸ªiå€¼è‚¯å®šè¿˜æ˜¯ä¹‹å‰çš„ï¼Œçº¿ç¨‹1å¯¹å˜é‡çš„ä¿®æ”¹çº¿ç¨‹æ²¡çœ‹åˆ°è¿™å°±æ˜¯å¯è§æ€§é—®é¢˜ã€‚</p>
<ol>
<li>ä»€ä¹ˆæ˜¯æœ‰åºæ€§</li>
</ol>
<p>ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚<br>ä¸€èˆ¬æ¥è¯´å¤„ç†å™¨ä¸ºäº†æé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ï¼Œå¯èƒ½ä¼šå¯¹è¾“å…¥ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œå®ƒä¸ä¿è¯ç¨‹åºä¸­å„ä¸ªè¯­å¥çš„æ‰§è¡Œå…ˆåé¡ºåºåŒä»£ç ä¸­çš„é¡ºåºä¸€è‡´ï¼Œä½†æ˜¯å®ƒä¼šä¿è¯ç¨‹åºæœ€ç»ˆæ‰§è¡Œç»“æœå’Œä»£ç é¡ºåºæ‰§è¡Œçš„ç»“æœæ˜¯ä¸€è‡´çš„ã€‚</p>
<h4 id="è¿›ç¨‹-çº¿ç¨‹"><a href="#è¿›ç¨‹-çº¿ç¨‹" class="headerlink" title="è¿›ç¨‹ çº¿ç¨‹"></a>è¿›ç¨‹ çº¿ç¨‹</h4><p><strong>ä»€ä¹ˆæ˜¯è¿›ç¨‹</strong></p>
<p>è¿›ç¨‹æ˜¯æŒ‡åœ¨ç³»ç»Ÿä¸­æ­£åœ¨è¿è¡Œçš„ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼›ç¨‹åºä¸€æ—¦è¿è¡Œå°±æ˜¯è¿›ç¨‹ï¼Œæˆ–è€…æ›´ä¸“ä¸šåŒ–æ¥è¯´ï¼šè¿›ç¨‹æ˜¯æŒ‡ç¨‹åºæ‰§è¡Œæ—¶çš„ä¸€ä¸ªå®ä¾‹ã€‚</p>
<p><strong>è¿›ç¨‹æ—¶é—´ç‰‡çš„æ¦‚å¿µ</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ä¸€ä¸ªæ“ä½œç³»ç»Ÿä¸­ï¼Œå¦‚æœåŒæ—¶è¿è¡Œç€å¤šä¸ªè¿›ç¨‹ï¼Œä»–ä»¬æ˜¯ä¸€å®šäº¤æ›¿è¿è¡Œçš„ã€‚æ¯ä¸ªè¿›ç¨‹ä¸ç®¡æœ‰æ²¡æœ‰è¿è¡Œå®Œæ¯•ï¼Œéƒ½åªå æ®ä¸€æ®µæ—¶é—´çš„CPUã€‚</span><br><span class="line">è¿™ä¸ªè¿è¡Œæ—¶é—´å°±æ˜¯è¿›ç¨‹æ—¶é—´ç‰‡ã€‚å®ƒéå¸¸çŸ­ä¿ƒï¼Œæ‰€ä»¥æ„Ÿè§‰ä¸åˆ°ä»–ä»¬æ˜¯äº¤æ›¿å ç”¨CPUã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>ä»€ä¹ˆæ˜¯çº¿ç¨‹</strong></p>
<ul>
<li>çº¿ç¨‹ï¼šè¿›ç¨‹å†…éƒ¨çš„æ§åˆ¶æµã€‚å®ƒä¹Ÿæ˜¯ä¸€æ®µå¯è¿è¡Œçš„æŒ‡ä»¤ã€‚</li>
<li>ç‰¹ç‚¹ï¼šèµ„æºå ç”¨å°ï¼Œçº¿ç¨‹é—´é€šä¿¡å®¹æ˜“ã€‚</li>
<li>å¤šè¿›ç¨‹æ˜¯æŒ‡æ“ä½œç³»ç»Ÿèƒ½åŒæ—¶è¿è¡Œå¤šä¸ªä»»åŠ¡ï¼ˆç¨‹åºï¼‰ã€‚</li>
</ul>
<p>å¤šçº¿ç¨‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æŒ‡çš„æ˜¯è¿™ä¸ªç¨‹åºï¼ˆä¸€ä¸ªè¿›ç¨‹ï¼‰è¿è¡Œæ—¶äº§ç”Ÿäº†ä¸æ­¢ä¸€ä¸ªçº¿ç¨‹</span><br></pre></td></tr></table></figure>

<p><strong>çº¿ç¨‹è¿›ç¨‹çš„åŒºåˆ«ä½“ç°åœ¨å‡ ä¸ªæ–¹é¢ï¼š</strong></p>
<ol>
<li>å› ä¸ºè¿›ç¨‹æ‹¥æœ‰<strong>ç‹¬ç«‹çš„å †æ ˆç©ºé—´å’Œæ•°æ®æ®µ</strong>ï¼Œæ‰€ä»¥æ¯å½“å¯åŠ¨ä¸€ä¸ªæ–°çš„è¿›ç¨‹å¿…é¡»åˆ†é…ç»™å®ƒç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œå»ºç«‹ä¼—å¤šçš„æ•°æ®è¡¨æ¥ç»´æŠ¤å®ƒçš„ä»£ç æ®µã€å †æ ˆæ®µå’Œæ•°æ®æ®µï¼Œè¿™å¯¹äºå¤šè¿›ç¨‹æ¥è¯´ååˆ†â€œå¥¢ä¾ˆâ€ï¼Œç³»ç»Ÿå¼€é”€æ¯”è¾ƒå¤§ï¼Œè€Œçº¿ç¨‹ä¸ä¸€æ ·ï¼Œ<strong>çº¿ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„å †æ ˆç©ºé—´ï¼Œä½†æ˜¯å…±äº«æ•°æ®æ®µ</strong>ï¼Œå®ƒä»¬å½¼æ­¤ä¹‹é—´ä½¿ç”¨ç›¸åŒçš„åœ°å€ç©ºé—´ï¼Œå…±äº«å¤§éƒ¨åˆ†æ•°æ®ï¼Œæ¯”è¿›ç¨‹æ›´èŠ‚ä¿­ï¼Œå¼€é”€æ¯”è¾ƒå°ï¼Œåˆ‡æ¢é€Ÿåº¦ä¹Ÿæ¯”è¿›ç¨‹å¿«ï¼Œæ•ˆç‡é«˜ï¼Œä½†æ˜¯æ­£ç”±äºè¿›ç¨‹ä¹‹é—´ç‹¬ç«‹çš„ç‰¹ç‚¹ï¼Œä½¿å¾—è¿›ç¨‹å®‰å…¨æ€§æ¯”è¾ƒé«˜ï¼Œä¹Ÿå› ä¸ºè¿›ç¨‹æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œä¸€ä¸ªè¿›ç¨‹å´©æºƒåï¼Œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ä¸ä¼šå¯¹å…¶å®ƒè¿›ç¨‹äº§ç”Ÿå½±å“ï¼Œè€Œçº¿ç¨‹åªæ˜¯ä¸€ä¸ªè¿›ç¨‹ä¸­çš„ä¸åŒæ‰§è¡Œè·¯å¾„ã€‚ä¸€ä¸ªçº¿ç¨‹æ­»æ‰å°±ç­‰äºæ•´ä¸ªè¿›ç¨‹æ­»æ‰ã€‚</li>
<li>ä½“ç°åœ¨é€šä¿¡æœºåˆ¶ä¸Šé¢ï¼Œæ­£å› ä¸ºè¿›ç¨‹ä¹‹é—´äº’ä¸å¹²æ‰°ï¼Œç›¸äº’ç‹¬ç«‹ï¼Œè¿›ç¨‹çš„é€šä¿¡æœºåˆ¶ç›¸å¯¹å¾ˆå¤æ‚ï¼Œè­¬å¦‚ç®¡é“ï¼Œä¿¡å·ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…±äº«å†…å­˜ï¼Œå¥—æ¥å­—ç­‰é€šä¿¡æœºåˆ¶ï¼Œè€Œçº¿ç¨‹ç”±äºå…±äº«æ•°æ®æ®µæ‰€ä»¥é€šä¿¡æœºåˆ¶å¾ˆæ–¹ä¾¿ã€‚</li>
<li>å±äºåŒä¸€ä¸ªè¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹å…±äº«è¯¥è¿›ç¨‹çš„æ‰€æœ‰èµ„æºï¼ŒåŒ…æ‹¬æ–‡ä»¶æè¿°ç¬¦ã€‚è€Œä¸åŒè¿‡çš„è¿›ç¨‹ç›¸äº’ç‹¬ç«‹ã€‚</li>
<li>çº¿ç¨‹åˆç§°ä¸ºè½»é‡çº§è¿›ç¨‹ï¼Œè¿›ç¨‹æœ‰è¿›ç¨‹æ§åˆ¶å—ï¼Œçº¿ç¨‹æœ‰çº¿ç¨‹æ§åˆ¶å—ï¼›</li>
<li>çº¿ç¨‹å¿…å®šä¹Ÿåªèƒ½å±äºä¸€ä¸ªè¿›ç¨‹ï¼Œè€Œè¿›ç¨‹å¯ä»¥æ‹¥æœ‰å¤šä¸ªçº¿ç¨‹è€Œä¸”è‡³å°‘æ‹¥æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼›</li>
<li>ä½“ç°åœ¨ç¨‹åºç»“æ„ä¸Šï¼Œä¸¾ä¸€ä¸ªç®€æ˜æ˜“æ‡‚çš„åˆ—å­ï¼šå½“æˆ‘ä»¬ä½¿ç”¨è¿›ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸è‡ªä¸»çš„ä½¿ç”¨if elseåµŒå¥—æ¥åˆ¤æ–­pidï¼Œä½¿å¾—ç¨‹åºç»“æ„ç¹çï¼Œä½†æ˜¯å½“æˆ‘ä»¬ä½¿ç”¨çº¿ç¨‹çš„æ—¶å€™ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥ç”©æ‰å®ƒï¼Œå½“ç„¶ç¨‹åºå†…éƒ¨æ‰§è¡ŒåŠŸèƒ½å•å…ƒéœ€è¦ä½¿ç”¨çš„æ—¶å€™è¿˜æ˜¯è¦ä½¿ç”¨ï¼Œæ‰€ä»¥çº¿ç¨‹å¯¹ç¨‹åºç»“æ„çš„æ”¹å–„æœ‰å¾ˆå¤§å¸®åŠ©ã€‚</li>
</ol>
<h4 id="é«˜å¹¶å‘ä¸å¤šçº¿ç¨‹çš„å…³ç³»"><a href="#é«˜å¹¶å‘ä¸å¤šçº¿ç¨‹çš„å…³ç³»" class="headerlink" title="é«˜å¹¶å‘ä¸å¤šçº¿ç¨‹çš„å…³ç³»"></a>é«˜å¹¶å‘ä¸å¤šçº¿ç¨‹çš„å…³ç³»</h4><ol>
<li>ä»€ä¹ˆæ˜¯é«˜å¹¶å‘</li>
</ol>
<p>é«˜å¹¶å‘ï¼ˆHigh Concurrencyï¼‰æ˜¯ä¸€ç§ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€ç§â€œçŸ­æ—¶é—´å†…é‡åˆ°å¤§é‡æ“ä½œè¯·æ±‚â€çš„æƒ…å†µï¼Œä¸»è¦å‘ç”Ÿåœ¨webç³»ç»Ÿé›†ä¸­å¤§é‡è®¿é—®æ”¶åˆ°å¤§é‡è¯·æ±‚ï¼ˆä¾‹å¦‚ï¼š12306çš„æŠ¢ç¥¨æƒ…å†µï¼›å¤©çŒ«åŒåä¸€æ´»åŠ¨ï¼‰ã€‚</p>
<p>è¯¥æƒ…å†µçš„å‘ç”Ÿä¼šå¯¼è‡´ç³»ç»Ÿåœ¨è¿™æ®µæ—¶é—´å†…æ‰§è¡Œå¤§é‡æ“ä½œï¼Œä¾‹å¦‚å¯¹èµ„æºçš„è¯·æ±‚ï¼Œæ•°æ®åº“çš„æ“ä½œç­‰ã€‚</p>
<ol>
<li><p>é«˜å¹¶å‘å…³æ³¨å“ªäº›æŒ‡æ ‡</p>
<ol>
<li>å“åº”æ—¶é—´ï¼ˆResponse Timeï¼‰</li>
</ol>
<p>å“åº”æ—¶é—´ï¼šç³»ç»Ÿå¯¹è¯·æ±‚åšå‡ºå“åº”çš„æ—¶é—´ã€‚ä¾‹å¦‚ç³»ç»Ÿå¤„ç†ä¸€ä¸ªHTTPè¯·æ±‚éœ€è¦200msï¼Œè¿™ä¸ª200mså°±æ˜¯ç³»ç»Ÿçš„å“åº”æ—¶é—´</p>
</li>
<li><p>ååé‡ï¼ˆThroughputï¼‰</p>
<p>ååé‡ï¼šå•ä½æ—¶é—´å†…å¤„ç†çš„è¯·æ±‚æ•°é‡ã€‚</p>
</li>
<li><p>æ¯ç§’æŸ¥è¯¢ç‡QPSï¼ˆQuery Per Secondï¼‰</p>
<p>QPSï¼šæ¯ç§’å“åº”è¯·æ±‚æ•°ã€‚åœ¨äº’è”ç½‘é¢†åŸŸï¼Œè¿™ä¸ªæŒ‡æ ‡å’Œååé‡åŒºåˆ†çš„æ²¡æœ‰è¿™ä¹ˆæ˜æ˜¾ã€‚</p>
</li>
<li><p>å¹¶å‘ç”¨æˆ·æ•°</p>
<p>å¹¶å‘ç”¨æˆ·æ•°ï¼šåŒæ—¶æ‰¿è½½æ­£å¸¸ä½¿ç”¨ç³»ç»ŸåŠŸèƒ½çš„ç”¨æˆ·æ•°é‡ã€‚ä¾‹å¦‚ä¸€ä¸ªå³æ—¶é€šè®¯ç³»ç»Ÿï¼ŒåŒæ—¶åœ¨çº¿é‡ä¸€å®šç¨‹åº¦ä¸Šä»£è¡¨äº†ç³»ç»Ÿçš„å¹¶å‘ç”¨æˆ·æ•°ã€‚</p>
</li>
<li><p>é«˜å¹¶å‘ä¸å¤šçº¿ç¨‹çš„å…³ç³»</p>
</li>
</ol>
<p><strong>â€œé«˜å¹¶å‘å’Œå¤šçº¿ç¨‹â€æ€»æ˜¯è¢«ä¸€èµ·æèµ·ï¼Œç»™äººæ„Ÿè§‰ä¸¤è€…å¥½åƒç›¸ç­‰ï¼Œå®åˆ™ é«˜å¹¶å‘ â‰  å¤šçº¿ç¨‹ã€‚</strong></p>
<p><strong>å¤šçº¿ç¨‹å¯ä»¥è¿™ä¹ˆç†è§£ï¼šå¤šçº¿ç¨‹æ˜¯å¤„ç†é«˜å¹¶å‘çš„ä¸€ç§ç¼–ç¨‹æ–¹æ³•ã€‚</strong></p>
<p>é«˜å¹¶å‘ä¸æ˜¯Javaä¸“æœ‰çš„ä¸œè¥¿ï¼Œæ˜¯è¯­è¨€æ— å…³çš„ï¼Œä¸ºæä¾›æ›´å¥½äº’è”ç½‘æœåŠ¡è€Œæå‡ºçš„æ¦‚å¿µã€‚å¦‚æœè¦æƒ³ç³»ç»Ÿèƒ½å¤Ÿé€‚åº”é«˜å¹¶å‘çŠ¶æ€ï¼Œåˆ™éœ€è¦ä»å„ä¸ªæ–¹é¢è¿›è¡Œç³»ç»Ÿä¼˜åŒ–ï¼ŒåŒ…æ‹¬ï¼Œç¡¬ä»¶ã€ç½‘ç»œã€ç³»ç»Ÿæ¶æ„ã€å¼€å‘è¯­è¨€çš„é€‰å–ã€æ•°æ®ç»“æ„çš„è¿ç”¨ã€ç®—æ³•ä¼˜åŒ–ã€æ•°æ®åº“ä¼˜åŒ–ç­‰â€¦â€¦è€Œå¤šçº¿ç¨‹åªæ˜¯å…¶ä¸­è§£å†³æ–¹æ³•ä¹‹ä¸€ã€‚</p>
<p><strong>å¹¶è¡Œä¸å¹¶å‘ï¼š</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.	å¹¶è¡Œï¼šå¤šä¸ªcpuå®ä¾‹æˆ–è€…å¤šå°æœºå™¨åŒæ—¶æ‰§è¡Œä¸€æ®µå¤„ç†é€»è¾‘ï¼Œæ˜¯çœŸæ­£çš„åŒæ—¶ã€‚</span><br><span class="line">2.	å¹¶å‘ï¼šé€šè¿‡cpuè°ƒåº¦ç®—æ³•ï¼Œè®©ç”¨æˆ·çœ‹ä¸Šå»åŒæ—¶æ‰§è¡Œï¼Œå®é™…ä¸Šä»cpuæ“ä½œå±‚é¢ä¸æ˜¯çœŸæ­£çš„åŒæ—¶ã€‚å¹¶å‘å¾€å¾€åœ¨åœºæ™¯ä¸­æœ‰å…¬ç”¨çš„èµ„æºï¼Œ</span><br><span class="line">é‚£ä¹ˆé’ˆå¯¹è¿™ä¸ªå…¬ç”¨çš„èµ„æºå¾€å¾€äº§ç”Ÿç“¶é¢ˆï¼Œæˆ‘ä»¬ä¼šç”¨TPSæˆ–è€…QPSæ¥ååº”è¿™ä¸ªç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›ã€‚</span><br><span class="line">å¹¶å‘æ€§ï¼ˆconcurrencyï¼‰å’Œå¹¶è¡Œæ€§ï¼ˆparallelï¼‰</span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<h4 id="çº¿ç¨‹çŠ¶æ€ã€ç”Ÿå‘½å‘¨æœŸ"><a href="#çº¿ç¨‹çŠ¶æ€ã€ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="çº¿ç¨‹çŠ¶æ€ã€ç”Ÿå‘½å‘¨æœŸ"></a>çº¿ç¨‹çŠ¶æ€ã€ç”Ÿå‘½å‘¨æœŸ</h4><p><img src="https://gitee.com/fly_tom/use/raw/master/jc25.png"><br><img src="https://gitee.com/fly_tom/use/raw/master/xc2.png"></p>
<p>javaä¸­çš„çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå¤§ä½“å¯åˆ†ä¸º5ç§çŠ¶æ€ã€‚</p>
<ol>
<li><p>æ–°å»º(NEW)ï¼šæ–°åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ã€‚</p>
</li>
<li><p>å°±ç»ª(RUNNABLE)ï¼šçº¿ç¨‹å¯¹è±¡åˆ›å»ºåï¼Œå…¶ä»–çº¿ç¨‹(æ¯”å¦‚mainçº¿ç¨‹ï¼‰è°ƒç”¨äº†è¯¥å¯¹è±¡çš„start()æ–¹æ³•ã€‚è¯¥çŠ¶æ€çš„çº¿ç¨‹ä½äºå¯è¿è¡Œçº¿ç¨‹æ± ä¸­ï¼Œç­‰å¾…è¢«çº¿ç¨‹è°ƒåº¦é€‰ä¸­ï¼Œè·å–cpu çš„ä½¿ç”¨æƒ ã€‚</p>
</li>
<li><p>è¿è¡Œ(RUNNING)ï¼šå¯è¿è¡ŒçŠ¶æ€(runnable)çš„çº¿ç¨‹è·å¾—äº†cpu æ—¶é—´ç‰‡ï¼ˆtimesliceï¼‰ ï¼Œæ‰§è¡Œç¨‹åºä»£ç ã€‚</p>
</li>
<li><p>é˜»å¡(BLOCKED)ï¼šé˜»å¡çŠ¶æ€æ˜¯æŒ‡çº¿ç¨‹å› ä¸ºæŸç§åŸå› æ”¾å¼ƒäº†cpu ä½¿ç”¨æƒï¼Œä¹Ÿå³è®©å‡ºäº†cpu timesliceï¼Œæš‚æ—¶åœæ­¢è¿è¡Œã€‚ç›´åˆ°çº¿ç¨‹è¿›å…¥å¯è¿è¡Œ(runnable)çŠ¶æ€ï¼Œæ‰æœ‰æœºä¼šå†æ¬¡è·å¾—cpu timeslice è½¬åˆ°è¿è¡Œ(running)çŠ¶æ€ã€‚é˜»å¡çš„æƒ…å†µåˆ†ä¸‰ç§ï¼š </p>
<p>(ä¸€). ç­‰å¾…é˜»å¡ï¼šè¿è¡Œ(running)çš„çº¿ç¨‹æ‰§è¡Œo.wait()æ–¹æ³•ï¼ŒJVMä¼šæŠŠè¯¥çº¿ç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—(waitting queue)ä¸­ã€‚</p>
<p>(äºŒ). åŒæ­¥é˜»å¡ï¼šè¿è¡Œ(running)çš„çº¿ç¨‹åœ¨è·å–å¯¹è±¡çš„åŒæ­¥é”æ—¶ï¼Œè‹¥è¯¥åŒæ­¥é”è¢«åˆ«çš„çº¿ç¨‹å ç”¨ï¼Œåˆ™JVMä¼šæŠŠè¯¥çº¿ç¨‹æ”¾å…¥é”æ± (lock pool)ä¸­ã€‚</p>
<p>(ä¸‰). å…¶ä»–é˜»å¡ï¼šè¿è¡Œ(running)çš„çº¿ç¨‹æ‰§è¡ŒThread.sleep(long ms)æˆ–t.join()æ–¹æ³•ï¼Œæˆ–è€…å‘å‡ºäº†I&#x2F;Oè¯·æ±‚æ—¶ï¼ŒJVMä¼šæŠŠè¯¥çº¿ç¨‹ç½®ä¸ºé˜»å¡çŠ¶æ€ã€‚å½“sleep()çŠ¶æ€è¶…æ—¶ã€join()ç­‰å¾…çº¿ç¨‹ç»ˆæ­¢æˆ–è€…è¶…æ—¶ã€æˆ–è€…I&#x2F;Oå¤„ç†å®Œæ¯•æ—¶ï¼Œçº¿ç¨‹é‡æ–°è½¬å…¥å¯è¿è¡Œ(runnable)çŠ¶æ€ã€‚</p>
</li>
<li><p>æ­»äº¡(DEAD)ï¼šçº¿ç¨‹run()ã€main() æ–¹æ³•æ‰§è¡Œç»“æŸï¼Œæˆ–è€…å› å¼‚å¸¸é€€å‡ºäº†run()æ–¹æ³•ï¼Œåˆ™è¯¥çº¿ç¨‹ç»“æŸç”Ÿå‘½å‘¨æœŸã€‚æ­»äº¡çš„çº¿ç¨‹ä¸å¯å†æ¬¡å¤ç”Ÿã€‚</p>
</li>
</ol>
<h4 id="ä¸Šä¸‹æ–‡åˆ‡æ¢"><a href="#ä¸Šä¸‹æ–‡åˆ‡æ¢" class="headerlink" title="ä¸Šä¸‹æ–‡åˆ‡æ¢"></a>ä¸Šä¸‹æ–‡åˆ‡æ¢</h4><p>å¯¹äº<strong>å•æ ¸CPU</strong>æ¥è¯´ï¼ˆå¯¹äºå¤šæ ¸CPUï¼Œæ­¤å¤„å°±ç†è§£ä¸ºä¸€ä¸ªæ ¸ï¼‰ï¼ŒCPUåœ¨ä¸€ä¸ªæ—¶åˆ»åªèƒ½è¿è¡Œä¸€ä¸ªçº¿ç¨‹ï¼Œå½“åœ¨è¿è¡Œä¸€ä¸ªçº¿ç¨‹çš„è¿‡ç¨‹ä¸­è½¬å»è¿è¡Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªå«åšçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆå¯¹äºè¿›ç¨‹ä¹Ÿæ˜¯ç±»ä¼¼ï¼‰ã€‚</p>
<p>ç”±äºå¯èƒ½å½“å‰çº¿ç¨‹çš„ä»»åŠ¡å¹¶æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œæ‰€ä»¥åœ¨åˆ‡æ¢æ—¶éœ€è¦ä¿å­˜çº¿ç¨‹çš„è¿è¡ŒçŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡é‡æ–°åˆ‡æ¢å›æ¥æ—¶èƒ½å¤Ÿç»§ç»­åˆ‡æ¢ä¹‹å‰çš„çŠ¶æ€è¿è¡Œã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼šæ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹Aæ­£åœ¨è¯»å–ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œæ­£è¯»åˆ°æ–‡ä»¶çš„ä¸€åŠï¼Œæ­¤æ—¶éœ€è¦æš‚åœçº¿ç¨‹Aï¼Œè½¬å»æ‰§è¡Œçº¿ç¨‹Bï¼Œå½“å†æ¬¡åˆ‡æ¢å›æ¥æ‰§è¡Œçº¿ç¨‹Açš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›çº¿ç¨‹Aåˆä»æ–‡ä»¶çš„å¼€å¤´æ¥è¯»å–ã€‚</p>
<p>å› æ­¤éœ€è¦è®°å½•çº¿ç¨‹Açš„è¿è¡ŒçŠ¶æ€ï¼Œé‚£ä¹ˆä¼šè®°å½•å“ªäº›æ•°æ®å‘¢ï¼Ÿå› ä¸ºä¸‹æ¬¡æ¢å¤æ—¶éœ€è¦çŸ¥é“åœ¨è¿™ä¹‹å‰å½“å‰çº¿ç¨‹å·²ç»æ‰§è¡Œåˆ°å“ªæ¡æŒ‡ä»¤äº†ï¼Œæ‰€ä»¥éœ€è¦è®°å½•ç¨‹åºè®¡æ•°å™¨çš„å€¼ï¼Œå¦å¤–æ¯”å¦‚è¯´çº¿ç¨‹æ­£åœ¨è¿›è¡ŒæŸä¸ªè®¡ç®—çš„æ—¶å€™è¢«æŒ‚èµ·äº†ï¼Œé‚£ä¹ˆä¸‹æ¬¡ç»§ç»­æ‰§è¡Œçš„æ—¶å€™éœ€è¦çŸ¥é“ä¹‹å‰æŒ‚èµ·æ—¶å˜é‡çš„å€¼æ—¶å¤šå°‘ï¼Œå› æ­¤éœ€è¦è®°å½•CPUå¯„å­˜å™¨çš„çŠ¶æ€ã€‚æ‰€ä»¥ä¸€èˆ¬æ¥è¯´ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢è¿‡ç¨‹ä¸­ä¼šè®°å½•ç¨‹åºè®¡æ•°å™¨ã€CPUå¯„å­˜å™¨çŠ¶æ€ç­‰æ•°æ®ã€‚</p>
<p>è¯´ç®€å•ç‚¹çš„ï¼šå¯¹äºçº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å®é™…ä¸Šå°±æ˜¯ å­˜å‚¨å’Œæ¢å¤CPUçŠ¶æ€çš„è¿‡ç¨‹ï¼Œå®ƒä½¿å¾—çº¿ç¨‹æ‰§è¡Œèƒ½å¤Ÿä»ä¸­æ–­ç‚¹æ¢å¤æ‰§è¡Œã€‚</p>
<p>è™½ç„¶å¤šçº¿ç¨‹å¯ä»¥ä½¿å¾—ä»»åŠ¡æ‰§è¡Œçš„æ•ˆç‡å¾—åˆ°æå‡ï¼Œä½†æ˜¯ç”±äºåœ¨çº¿ç¨‹åˆ‡æ¢æ—¶åŒæ ·ä¼šå¸¦æ¥ä¸€å®šçš„å¼€é”€ä»£ä»·ï¼Œå¹¶ä¸”å¤šä¸ªçº¿ç¨‹ä¼šå¯¼è‡´ç³»ç»Ÿèµ„æºå ç”¨çš„å¢åŠ ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œå¤šçº¿ç¨‹ç¼–ç¨‹æ—¶è¦æ³¨æ„è¿™äº›å› ç´ ã€‚</p>
<h4 id="åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼"><a href="#åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼" class="headerlink" title="åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼"></a>åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼</h4><blockquote>
<p>æ‰©å……ï¼šæ¯æ¬¡ç¨‹åºå¯åŠ¨æœ€å°‘ä¼šå¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œä¸€ä¸ªæ•°mainçº¿ç¨‹ï¼Œä¸€ä¸ªæ˜¯åƒåœ¾æ”¶é›†çº¿ç¨‹.</p>
</blockquote>
<p>ã€€ã€€åœ¨javaä¸­å¦‚æœè¦åˆ›å»ºçº¿ç¨‹çš„è¯ï¼Œä¸€èˆ¬æœ‰ä¸‰ç§æ–¹å¼ï¼š<strong>1ï¼‰ç»§æ‰¿Threadç±»ï¼›2ï¼‰å®ç°Runnableæ¥å£ï¼›3ï¼‰Callableæ–¹å¼</strong> ; </p>
<p><strong>ç»§æ‰¿Threadç±»åˆ›å»º</strong></p>
<p>ç»§æ‰¿Threadåˆ›å»ºå¹¶å¯åŠ¨å¤šçº¿ç¨‹æœ‰ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>å®šä¹‰ç±»å¹¶ç»§æ‰¿Thread,é‡å†™run()æ–¹æ³•,run()æ–¹æ³•ä¸­ä¸ºéœ€è¦å¤šçº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡ã€‚</li>
<li>åˆ›å»ºè¯¥ç±»çš„å®ä¾‹ï¼Œå³åˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ã€‚</li>
<li>è°ƒç”¨å®ä¾‹çš„start()æ–¹æ³•å¯åŠ¨çº¿ç¨‹ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ç»§æ‰¿java.lang.Threadç±»ï¼Œå¹¶è¦†ç›–run( )æ–¹æ³•ã€‚</span><br><span class="line"> <span class="keyword">class</span> <span class="title class_">Mythread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">( )</span> &#123;</span><br><span class="line">         <span class="comment">/* è¦†ç›–è¯¥æ–¹æ³•*/</span></span><br><span class="line">      &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// è°ƒç”¨æ–¹å¼ï¼š</span></span><br><span class="line"> <span class="type">Mythread</span>  <span class="variable">m</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mythread</span>();</span><br><span class="line"> m.start();</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬äºŒç§æ–¹å¼</strong></p>
<p>å®ç°Runnableæ¥å£åˆ›å»ºå¹¶å¯åŠ¨å¤šçº¿ç¨‹ä¹Ÿæœ‰ä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>å®šä¹‰ç±»å¹¶ç»§æ‰¿Runnableæ¥å£,é‡å†™run()æ–¹æ³•,run()æ–¹æ³•ä¸­ä¸ºéœ€è¦å¤šçº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡ã€‚</li>
<li>åˆ›å»ºè¯¥ç±»çš„å®ä¾‹ï¼Œå¹¶ä»¥æ­¤å®ä¾‹ä½œä¸ºtargetä¸ºå‚æ•°æ¥åˆ›å»ºThreadå¯¹è±¡ï¼Œè¿™ä¸ªThreadå¯¹è±¡æ‰æ˜¯çœŸæ­£çš„å¤šçº¿ç¨‹å¯¹è±¡ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å®ç°java.lang.Runnableæ¥å£ï¼Œå¹¶å®ç°run( )æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">// æ¨èæ­¤æ–¹å¼</span></span><br><span class="line">   <span class="comment">// a. è¦†å†™Runnableæ¥å£å®ç°å¤šçº¿ç¨‹å¯ä»¥é¿å…å•ç»§æ‰¿å±€é™</span></span><br><span class="line">   <span class="comment">// b. å½“å­ç±»å®ç°Runnableæ¥å£ï¼Œæ­¤æ—¶å­ç±»å’ŒThreadçš„ä»£ç†æ¨¡å¼ï¼ˆå­ç±»è´Ÿè´£çœŸæ˜¯ä¸šåŠ¡çš„æ“ä½œï¼Œthreadè´Ÿè´£èµ„æºè°ƒåº¦ä¸çº¿ç¨‹åˆ›å»ºè¾…åŠ©çœŸå®ä¸šåŠ¡ã€‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Mythread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">	  <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">( )</span> &#123;</span><br><span class="line">          <span class="comment">/* å®ç°è¯¥æ–¹æ³•*/</span></span><br><span class="line">      &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// è°ƒç”¨</span></span><br><span class="line"> <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Mythread</span>());</span><br><span class="line"> thread.start();</span><br></pre></td></tr></table></figure>

<p><strong>ç¬¬ä¸‰ç§</strong></p>
<p><img src="https://gitee.com/fly_tom/use/raw/master/jc29.png"></p>
<p>Callableæ˜¯Runnableçš„å¢åŠ ç‰ˆï¼Œä¸»è¦æ˜¯æ¥å£ä¸­çš„<strong>call()æ–¹æ³•å¯ä»¥æœ‰è¿”å›å€¼</strong>ï¼Œå¹¶ä¸”å¯ä»¥ç”³æ˜<strong>æŠ›å‡ºå¼‚å¸¸</strong>ï¼Œä½¿ç”¨Callableåˆ›å»ºçš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>å®šä¹‰ç±»å¹¶å®ç°Callableæ¥å£,é‡å†™call()æ–¹æ³•,run()æ–¹æ³•ä¸­ä¸ºéœ€è¦å¤šçº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡ã€‚</li>
<li>åˆ›å»ºç±»å®ä¾‹ï¼Œä½¿ç”¨FutureTaskæ¥åŒ…è£…å¯¹è±¡å®ä¾‹ï¼Œ</li>
<li>ä½¿ç”¨FutureTaskå¯¹è±¡ä½œä¸ºThreadçš„targetæ¥åˆ›å»ºå¤šçº¿ç¨‹ï¼Œå¹¶å¯åŠ¨çº¿ç¨‹ã€‚</li>
<li>è°ƒç”¨FutureTaskå¯¹è±¡çš„get()æ–¹æ³•æ¥è·å–å­çº¿ç¨‹ç»“æŸåçš„è¿”å›å€¼ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CallableTest</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Callss</span> <span class="variable">callss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Callss</span>();</span><br><span class="line">        FutureTask&lt;Integer&gt; futureTask = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(callss);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(futureTask);</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¥æ”¶çº¿ç¨‹è¿ç®—åçš„ç»“æœ</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// FutureTask å¯ç”¨äº é—­é” ç±»ä¼¼äºCountDownLatchçš„ä½œç”¨ï¼Œåœ¨æ‰€æœ‰çš„çº¿ç¨‹æ²¡æœ‰æ‰§è¡Œå®Œæˆä¹‹åè¿™é‡Œæ˜¯ä¸ä¼šæ‰§è¡Œçš„</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">sum</span> <span class="operator">=</span> futureTask.get();</span><br><span class="line">            System.out.println(sum);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç›¸è¾ƒäºå®ç° Runnable æ¥å£çš„æ–¹å¼ï¼Œæ–¹æ³•å¯ä»¥æœ‰è¿”å›å€¼ï¼Œå¹¶ä¸”å¯ä»¥æŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line"><span class="comment"> * æ‰§è¡Œ Callable æ–¹å¼ï¼Œéœ€è¦ FutureTask å®ç°ç±»çš„æ”¯æŒï¼Œç”¨äºæ¥æ”¶è¿ç®—ç»“æœï¼ŒFutureTask æ˜¯  Future æ¥å£çš„å®ç°ç±»</span></span><br><span class="line"><span class="comment"> * è¿è¡ŒCallableä»»åŠ¡å¯æ‹¿åˆ°ä¸€ä¸ªFutureå¯¹è±¡ï¼Œ Futureè¡¨ç¤ºå¼‚æ­¥è®¡ç®—çš„ç»“æœã€‚ </span></span><br><span class="line"><span class="comment"> * å®ƒæä¾›äº†æ£€æŸ¥è®¡ç®—æ˜¯å¦å®Œæˆçš„æ–¹æ³•ï¼Œä»¥ç­‰å¾…è®¡ç®—çš„å®Œæˆï¼Œå¹¶æ£€ç´¢è®¡ç®—çš„ç»“æœã€‚ </span></span><br><span class="line"><span class="comment"> * é€šè¿‡Futureå¯¹è±¡å¯äº†è§£ä»»åŠ¡æ‰§è¡Œæƒ…å†µï¼Œå¯å–æ¶ˆä»»åŠ¡çš„æ‰§è¡Œï¼Œè¿˜å¯è·å–ä»»åŠ¡æ‰§è¡Œçš„ç»“æœã€‚ </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Callss</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;Integer&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            a++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Threadå’ŒRunnableçš„åŒºåˆ«"><a href="#Threadå’ŒRunnableçš„åŒºåˆ«" class="headerlink" title="Threadå’ŒRunnableçš„åŒºåˆ«"></a>Threadå’ŒRunnableçš„åŒºåˆ«</h5><p>å®ç°Runnableæ¥å£æ¯”ç»§æ‰¿Threadç±»æ‰€å…·æœ‰çš„ä¼˜åŠ¿ï¼š</p>
<p>1ï¼‰ï¼šé€‚åˆå¤šä¸ªç›¸åŒçš„ç¨‹åºä»£ç çš„çº¿ç¨‹å»å¤„ç†åŒä¸€ä¸ªèµ„æº</p>
<p>2ï¼‰ï¼šå¯ä»¥é¿å…javaä¸­çš„å•ç»§æ‰¿çš„é™åˆ¶</p>
<p>3ï¼‰ï¼šå¢åŠ ç¨‹åºçš„å¥å£®æ€§ï¼Œä»£ç å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œä»£ç å’Œæ•°æ®ç‹¬ç«‹</p>
<p>4ï¼‰ï¼šçº¿ç¨‹æ± åªèƒ½æ”¾å…¥å®ç°Runableæˆ–callableç±»çº¿ç¨‹ï¼Œä¸èƒ½ç›´æ¥æ”¾å…¥ç»§æ‰¿Threadçš„ç±»</p>
<h5 id="Runnableå’ŒCallableçš„åŒºåˆ«"><a href="#Runnableå’ŒCallableçš„åŒºåˆ«" class="headerlink" title="Runnableå’ŒCallableçš„åŒºåˆ«"></a>Runnableå’ŒCallableçš„åŒºåˆ«</h5><p>ç›¸åŒç‚¹</p>
<ul>
<li>éƒ½æ˜¯æ¥å£</li>
<li>éƒ½å¯ä»¥ç¼–å†™å¤šçº¿ç¨‹ç¨‹åº</li>
<li>éƒ½é‡‡ç”¨Thread.start()å¯åŠ¨çº¿ç¨‹</li>
</ul>
<p>ä¸åŒç‚¹</p>
<ul>
<li>Runnableæ²¡æœ‰è¿”å›å€¼ï¼›Callableå¯ä»¥è¿”å›æ‰§è¡Œç»“æœï¼Œæ˜¯ä¸ªæ³›å‹ï¼Œå’ŒFutureã€FutureTaské…åˆå¯ä»¥ç”¨æ¥è·å–å¼‚æ­¥æ‰§è¡Œçš„ç»“æœ</li>
<li>Callableæ¥å£çš„call()æ–¹æ³•å…è®¸æŠ›å‡ºå¼‚å¸¸ï¼›Runnableçš„run()æ–¹æ³•å¼‚å¸¸åªèƒ½åœ¨å†…éƒ¨æ¶ˆåŒ–ï¼Œä¸èƒ½å¾€ä¸Šç»§ç»­æŠ›</li>
<li>å®ç°Callableæ¥å£çš„çº¿ç¨‹å¯ä»¥è°ƒç”¨<strong>Future.cancelå–æ¶ˆæ‰§è¡Œ</strong>ï¼ŒRunnableæ–¹å¼ä¸æ”¯æŒ</li>
</ul>
<p>æ³¨ï¼šCallalbeæ¥å£æ”¯æŒè¿”å›æ‰§è¡Œç»“æœï¼Œéœ€è¦è°ƒç”¨FutureTask.get()å¾—åˆ°ï¼Œæ­¤æ–¹æ³•ä¼š<strong>é˜»å¡ä¸»è¿›ç¨‹</strong>çš„ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå¦‚æœä¸è°ƒç”¨ä¸ä¼šé˜»å¡ã€‚</p>
<p><strong>ä¸€ä¸ªçº¿ç¨‹çš„å¯¹è±¡åªèƒ½æ‰§è¡Œä¸€æ¬¡start()æ–¹æ³•</strong></p>
<p>*<strong>æ³¨</strong> å¤šæ¬¡è°ƒç”¨start()æ–¹æ³•ï¼Œä¼šå‡ºç°å¼‚å¸¸ java.lang.IllegalThreadStateException</p>
<p><strong>çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹</strong></p>
<ul>
<li>è°ƒç”¨start( )æ–¹æ³•æ—¶ï¼Œå°†åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œå¹¶ä¸ºçº¿ç¨‹åˆ†é…ç³»ç»Ÿèµ„æºï¼Œå¦‚å†…å­˜ã€‚æ¥ç€å®ƒå°†è°ƒç”¨ run( ) æ–¹æ³•ã€‚</li>
<li>run( ) æ–¹æ³•ä¸­çš„ä»£ç å®šä¹‰æ‰§è¡Œçº¿ç¨‹æ‰€éœ€çš„åŠŸèƒ½ã€‚<ul>
<li>run()æ–¹æ³•èƒ½å¤Ÿè°ƒç”¨å…¶ä»–æ–¹æ³•ï¼Œå¼•ç”¨å…¶ä»–çš„ç±»ï¼Œç”³æ˜å˜é‡ã€‚</li>
<li>run()æ–¹æ³•åœ¨ç¨‹åºä¸­ç¡®å®šå¦ä¸€ä¸ªå¹¶å‘çº¿ç¨‹çš„æ‰§è¡Œå…¥å£ã€‚</li>
</ul>
</li>
<li>å½“run()æ–¹æ³•ä¸­çš„ä»»åŠ¡å®Œæˆè¿”å›æ—¶ï¼Œè¯¥çº¿ç¨‹ä¹Ÿå°†ç»“æŸã€‚</li>
</ul>
<p><strong>æ³¨æ„ï¼šstart()æ–¹æ³•çš„è°ƒç”¨åå¹¶ä¸æ˜¯ç«‹å³æ‰§è¡Œå¤šçº¿ç¨‹ä»£ç ï¼Œè€Œæ˜¯ä½¿å¾—è¯¥çº¿ç¨‹å˜ä¸ºå¯è¿è¡Œæ€ï¼ˆRunnableï¼‰ï¼Œä»€ä¹ˆæ—¶å€™è¿è¡Œæ˜¯ç”±æ“ä½œç³»ç»Ÿå†³å®šçš„ã€‚<br>ä»ç¨‹åºè¿è¡Œçš„ç»“æœå¯ä»¥å‘ç°ï¼Œå¤šçº¿ç¨‹ç¨‹åºæ˜¯ä¹±åºæ‰§è¡Œã€‚</strong></p>
<p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>
<blockquote>
<p>æ‰§è¡Œstart()æ–¹æ³•çš„é¡ºåºä¸ä»£è¡¨çº¿ç¨‹å¯åŠ¨çš„æ‰§è¡Œé¡ºåº</p>
</blockquote>
<h3 id="å®ä¾‹å˜é‡ä¸çº¿ç¨‹å®‰å…¨"><a href="#å®ä¾‹å˜é‡ä¸çº¿ç¨‹å®‰å…¨" class="headerlink" title="å®ä¾‹å˜é‡ä¸çº¿ç¨‹å®‰å…¨"></a>å®ä¾‹å˜é‡ä¸çº¿ç¨‹å®‰å…¨</h3><blockquote>
<p>è‡ªå®šä¹‰çš„çº¿ç¨‹ç±»ä¸­å®ä¾‹å˜é‡é’ˆå¯¹å…¶ä»–çº¿ç¨‹å¯ä»¥æœ‰å…±äº«å’Œä¸å…±äº«ä¹‹åˆ†</p>
</blockquote>
<ul>
<li>ä¸å…±äº«æ•°æ®ï¼šæ¯ä¸ªçº¿ç¨‹è®¿é—®å„è‡ªçš„å®ä¾‹å˜é‡ã€‚</li>
<li>å…±äº«æ•°æ®ï¼šå¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå˜é‡ã€‚</li>
</ul>
<p>é¦–å…ˆæ¥åˆ†æä¸‹ï¼Œåœ¨JVMä¸­ï¼Œiâ€“çš„æ“ä½œ</p>
<ul>
<li>å–å¾—åŸæœ‰iå€¼ã€‚</li>
<li>è®¡ç®—i-1ã€‚</li>
<li>å¯¹iè¿›è¡Œèµ‹å€¼ã€‚</li>
</ul>
<p>éçº¿ç¨‹å®‰å…¨ï¼šæ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªå¯¹è±¡ä¸­çš„åŒä¸€ä¸ªå®ä¾‹å˜é‡è¿›è¡Œæ“ä½œæ—¶ä¼šå‡ºç°å€¼è¢«æ›´æ”¹ã€å€¼ä¸åŒæ­¥çš„æƒ…å†µï¼Œè¿›è€Œå½±å“ç¨‹åºçš„æ‰§è¡Œæµç¨‹ã€‚</p>
<p>åœ¨runæ–¹æ³•ä¸­åŠ ä¸Šsynchronizedå…³é”®å­—ï¼Œä½¿å¤šä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œrunæ–¹æ³•çš„æ—¶å€™ï¼Œä»¥é˜Ÿåˆ—çš„æ–¹å¼è¿›è¡Œå¤„ç†ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨runæ–¹æ³•å‰ï¼Œå…ˆåˆ¤æ–­runæ–¹æ³•æœ‰æ²¡æœ‰è¢«ä¸Šé”ï¼Œå¦‚æœä¸Šé”ï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹åœ¨è°ƒç”¨runæ–¹æ³•ï¼Œå¿…é¡»ç­‰å¾…å…¶ä»–çº¿ç¨‹å¯¹runæ–¹æ³•è°ƒç”¨ç»“æŸæ‰èƒ½æ‰§è¡Œrunæ–¹æ³•ï¼Œè¿™æ ·å®ç°äº†æ’é˜Ÿè°ƒç”¨çš„ç›®çš„ï¼Œä¹Ÿå°±å®ç°äº†å¯¹countä¾æ¬¡â€“ï¼Œsynchronizedå¯ä»¥å¯¹ä»»æ„å¯¹è±¡åŠæ–¹æ³•åŠ ä¸Šé”ï¼Œè€Œæ·é”çš„è¿™æ®µä»£ç å«åš â€œäº’æ–¥åŒºâ€æˆ–â€œä¸´ç•ŒåŒºâ€ã€‚</p>
<h3 id="çº¿ç¨‹çš„å¸¸ç”¨æ–¹æ³•"><a href="#çº¿ç¨‹çš„å¸¸ç”¨æ–¹æ³•" class="headerlink" title="çº¿ç¨‹çš„å¸¸ç”¨æ–¹æ³•"></a>çº¿ç¨‹çš„å¸¸ç”¨æ–¹æ³•</h3><ul>
<li><p>getNameå’ŒsetName</p>
<p>ç”¨æ¥å¾—åˆ°æˆ–è€…è®¾ç½®çº¿ç¨‹åç§°ã€‚</p>
</li>
<li><p>getPriorityå’ŒsetPriority</p>
<p>ç”¨æ¥è·å–å’Œè®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§(åªæ˜¯ä¿®æ”¹äº†è¿™ä¸ªçº¿ç¨‹å¯ä»¥æŠ¢åˆ°CUPæ—¶é—´ç‰‡çš„æ¦‚ç‡)ã€‚</p>
</li>
<li><p>setDaemonå’ŒisDaemon</p>
<p>ç”¨æ¥è®¾ç½®çº¿ç¨‹æ˜¯å¦æˆä¸ºå®ˆæŠ¤çº¿ç¨‹å’Œåˆ¤æ–­çº¿ç¨‹æ˜¯å¦æ˜¯å®ˆæŠ¤çº¿ç¨‹ã€‚</p>
<p>å®ˆæŠ¤çº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹çš„åŒºåˆ«åœ¨äºï¼šå®ˆæŠ¤çº¿ç¨‹ä¾èµ–äºåˆ›å»ºå®ƒçš„çº¿ç¨‹ï¼Œè€Œç”¨æˆ·çº¿ç¨‹åˆ™ä¸ä¾èµ–ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼šå¦‚æœåœ¨mainçº¿ç¨‹ä¸­åˆ›å»ºäº†ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹ï¼Œå½“mainæ–¹æ³•è¿è¡Œå®Œæ¯•ä¹‹åï¼Œå®ˆæŠ¤çº¿ç¨‹ä¹Ÿä¼šéšç€æ¶ˆäº¡ã€‚è€Œç”¨æˆ·çº¿ç¨‹åˆ™ä¸ä¼šï¼Œç”¨æˆ·çº¿ç¨‹ä¼šä¸€ç›´è¿è¡Œç›´åˆ°å…¶è¿è¡Œå®Œæ¯•ã€‚åœ¨JVMä¸­ï¼Œåƒåƒåœ¾æ”¶é›†å™¨çº¿ç¨‹å°±æ˜¯å®ˆæŠ¤çº¿ç¨‹ã€‚</p>
</li>
</ul>
<h4 id="1ï¼start-ï¼š"><a href="#1ï¼start-ï¼š" class="headerlink" title="1ï¼start() ï¼š"></a>1ï¼start() ï¼š</h4><p>çº¿ç¨‹è°ƒç”¨è¯¥æ–¹æ³•å°†å¯åŠ¨çº¿ç¨‹ï¼Œä½¿ä¹‹ä»æ–°å»ºçŠ¶æ€è¿›å…¥å°±ç»ªé˜Ÿåˆ—æ’é˜Ÿï¼Œä¸€æ—¦è½®åˆ°å®ƒæ¥äº«ç”¨CPUèµ„æºæ—¶ï¼Œå°±å¯ä»¥è„±ç¦»åˆ›å»ºå®ƒçš„çº¿ç¨‹ç‹¬ç«‹å¼€å§‹è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸäº†ã€‚</p>
<h4 id="2ï¼run"><a href="#2ï¼run" class="headerlink" title="2ï¼run():"></a>2ï¼run():</h4><p>Threadç±»çš„run()æ–¹æ³•ä¸Runnableæ¥å£ä¸­çš„run()æ–¹æ³•çš„åŠŸèƒ½å’Œä½œç”¨ç›¸åŒï¼Œéƒ½ç”¨æ¥å®šä¹‰çº¿ç¨‹å¯¹è±¡è¢«è°ƒåº¦ä¹‹åæ‰€æ‰§è¡Œçš„æ“ä½œï¼Œéƒ½æ˜¯ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨è€Œç”¨æˆ·ç¨‹åºä¸å¾—å¼•ç”¨çš„æ–¹æ³•ã€‚</p>
<h4 id="3ï¼çº¿ç¨‹ä¼‘çœ â€”â€”sleep-int-millsecond"><a href="#3ï¼çº¿ç¨‹ä¼‘çœ â€”â€”sleep-int-millsecond" class="headerlink" title="3ï¼çº¿ç¨‹ä¼‘çœ â€”â€”sleep(int millsecond):"></a>3ï¼çº¿ç¨‹ä¼‘çœ â€”â€”sleep(int millsecond):</h4><p>ï¼ˆ1ï¼‰çº¿ç¨‹ä¼‘çœ ä¼šäº¤å‡ºCPUï¼Œè®©CPUå»æ‰§è¡Œå…¶ä»–çš„ä»»åŠ¡ã€‚</p>
<p>ï¼ˆ2ï¼‰è°ƒç”¨sleep()æ–¹æ³•è®©çº¿ç¨‹è¿›å…¥ä¼‘çœ çŠ¶æ€åï¼Œsleep()æ–¹æ³•å¹¶ä¸ä¼šé‡Šæ”¾é”ï¼Œå³å½“å‰çº¿ç¨‹æŒæœ‰æŸä¸ªå¯¹è±¡é”æ—¶ï¼Œå³ä½¿è°ƒç”¨sleep()æ–¹æ³•å…¶ä»–çº¿ç¨‹ä¹Ÿæ— æ³•è®¿é—®è¿™ä¸ªå¯¹è±¡ã€‚</p>
<p>ï¼ˆ3ï¼‰è°ƒç”¨sleep()æ–¹æ³•è®©çº¿ç¨‹ä»è¿è¡ŒçŠ¶æ€è½¬æ¢ä¸ºé˜»å¡çŠ¶æ€ï¼›sleep()æ–¹æ³•è°ƒç”¨ç»“æŸåï¼Œçº¿ç¨‹ä»é˜»å¡çŠ¶æ€è½¬æ¢ä¸ºå¯æ‰§è¡ŒçŠ¶æ€ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æºç </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">(<span class="type">long</span> millis)</span> <span class="keyword">throws</span> InterruptedException;</span><br></pre></td></tr></table></figure>

<h4 id="4ï¼isAlive"><a href="#4ï¼isAlive" class="headerlink" title="4ï¼isAlive():"></a>4ï¼isAlive():</h4><p>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œçº¿ç¨‹å¤„äºâ€œæ–°å»ºâ€çŠ¶æ€æ—¶ï¼Œçº¿ç¨‹è°ƒç”¨isAlive()æ–¹æ³•è¿”å›falseã€‚åœ¨çº¿ç¨‹çš„run()æ–¹æ³•ç»“æŸä¹‹å‰ï¼Œå³æ²¡æœ‰è¿›å…¥æ­»äº¡çŠ¶æ€ä¹‹å‰ï¼Œçº¿ç¨‹è°ƒç”¨isAlive()æ–¹æ³•è¿”å›true.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æºç </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">isAlive</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<h4 id="5ï¼currentThread"><a href="#5ï¼currentThread" class="headerlink" title="5ï¼currentThread():"></a>5ï¼currentThread():</h4><p>è¯¥æ–¹æ³•æ˜¯Threadç±»ä¸­çš„ç±»æ–¹æ³•ï¼Œå¯ä»¥ç”¨ç±»åè°ƒç”¨ï¼Œè¯¥æ–¹æ³•è¿”å›å½“å‰æ­£åœ¨ä½¿ç”¨CPUèµ„æºçš„çº¿ç¨‹ã€‚</p>
<h4 id="6ï¼interrupt-ï¼š"><a href="#6ï¼interrupt-ï¼š" class="headerlink" title="6ï¼interrupt() ï¼š"></a>6ï¼interrupt() ï¼š</h4><p>ä¸€ä¸ªå æœ‰CPUèµ„æºçš„çº¿ç¨‹å¯ä»¥è®©ä¼‘çœ çš„çº¿ç¨‹è°ƒç”¨interrupt()æ–¹æ³•â€œåµé†’â€è‡ªå·±ï¼Œå³å¯¼è‡´ä¼‘çœ çš„çº¿ç¨‹å‘ç”ŸInterruptedExceptionå¼‚å¸¸ï¼ŒåŒæ—¶ä¼šæ¸…é™¤ä¸­æ–­æ ‡å¿—ï¼Œä»è€Œç»“æŸä¼‘çœ ï¼Œé‡æ–°æ’é˜Ÿç­‰å¾…CPUèµ„æºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æºç </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span> != Thread.currentThread())</span><br><span class="line">            checkAccess();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (blockerLock) &#123;</span><br><span class="line">            <span class="type">Interruptible</span> <span class="variable">b</span> <span class="operator">=</span> blocker;</span><br><span class="line">            <span class="keyword">if</span> (b != <span class="literal">null</span>) &#123;</span><br><span class="line">                interrupt0();           <span class="comment">// Just to set the interrupt flag</span></span><br><span class="line">                b.interrupt(<span class="built_in">this</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        interrupt0();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-getId-ï¼š"><a href="#7-getId-ï¼š" class="headerlink" title="7. getId()ï¼š"></a>7. getId()ï¼š</h4><p>è·å¾—çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æºç </span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> tid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="8-yield"><a href="#8-yield" class="headerlink" title="8.  yield():"></a>8.  yield():</h4><p>çº¿ç¨‹è®©æ­¥ï¼šæš‚åœå½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹å¯¹è±¡ï¼Œå¹¶æ‰§è¡Œå…¶ä»–çº¿ç¨‹ã€‚</p>
<p>ï¼ˆ1ï¼‰è°ƒç”¨yield()æ–¹æ³•è®©å½“å‰çº¿ç¨‹äº¤å‡ºCPUæƒé™ï¼Œè®©CPUå»æ‰§è¡Œå…¶ä»–çº¿ç¨‹ã€‚</p>
<p>ï¼ˆ2ï¼‰yield()æ–¹æ³•å’Œsleep()æ–¹æ³•ç±»ä¼¼ï¼Œä¸ä¼šé‡Šæ”¾é”ï¼Œä½†yield()æ–¹æ³•ä¸èƒ½æ§åˆ¶å…·ä½“äº¤å‡ºCPUçš„æ—¶é—´,ä¸èƒ½ç”±ç”¨æˆ·æŒ‡å®šæš‚åœå¤šé•¿æ—¶é—´ã€‚</p>
<p>ï¼ˆ3ï¼‰yield()æ–¹æ³•åªèƒ½è®©æ‹¥æœ‰ç›¸åŒä¼˜å…ˆçº§çš„çº¿ç¨‹è·å–CPUæ‰§è¡Œçš„æœºä¼šã€‚</p>
<p>ï¼ˆ4ï¼‰ä½¿ç”¨yield()æ–¹æ³•ä¸ä¼šè®©çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè€Œæ˜¯è®©çº¿ç¨‹ä»è¿è¡ŒçŠ¶æ€è½¬æ¢ä¸ºå°±ç»ªçŠ¶æ€ï¼Œåªéœ€è¦ç­‰å¾…é‡æ–°è·å–CPUæ‰§è¡Œçš„æœºä¼šã€‚</p>
<p>ï¼ˆ5ï¼‰å®é™…ä¸­æ— æ³•ä¿è¯yield()è¾¾åˆ°è®©æ­¥ç›®çš„ï¼Œå› ä¸ºè®©æ­¥çš„çº¿ç¨‹è¿˜æœ‰å¯èƒ½è¢«çº¿ç¨‹è°ƒåº¦ç¨‹åºå†æ¬¡é€‰ä¸­ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æºç </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">yield</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<h4 id="9-suspend"><a href="#9-suspend" class="headerlink" title="9. suspend():"></a>9. suspend():</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æºç </span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">suspend</span><span class="params">()</span> &#123;</span><br><span class="line">    checkAccess();</span><br><span class="line">    suspend0();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="10-resume-ï¼š"><a href="#10-resume-ï¼š" class="headerlink" title="10. resume()ï¼š"></a>10. resume()ï¼š</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æºç </span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">resume</span><span class="params">()</span> &#123;</span><br><span class="line">    checkAccess();</span><br><span class="line">    resume0();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="11-join"><a href="#11-join" class="headerlink" title="11. join():"></a>11. join():</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æºç </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">join</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    join(<span class="number">0</span>); <span class="comment">//join()ç­‰åŒäºjoin(0)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨çº¿ç¨‹ä¸­è°ƒç”¨å¦ä¸€ä¸ªçº¿ç¨‹çš„ join() æ–¹æ³•ï¼Œä¼šå°†å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œè€Œä¸æ˜¯å¿™ç­‰å¾…ï¼Œç›´åˆ°ç›®æ ‡çº¿ç¨‹ç»“æŸã€‚</p>
<p>å¯¹äºä»¥ä¸‹ä»£ç ï¼Œè™½ç„¶ b çº¿ç¨‹å…ˆå¯åŠ¨ï¼Œä½†æ˜¯å› ä¸ºåœ¨ b çº¿ç¨‹ä¸­è°ƒç”¨äº† a çº¿ç¨‹çš„ join() æ–¹æ³•ï¼Œb çº¿ç¨‹ä¼šç­‰å¾… a çº¿ç¨‹ç»“æŸæ‰ç»§ç»­æ‰§è¡Œï¼Œå› æ­¤æœ€åèƒ½å¤Ÿä¿è¯ a çº¿ç¨‹çš„è¾“å‡ºå…ˆäº b çº¿ç¨‹çš„è¾“å‡ºã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JoinExample</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">A</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> A a;</span><br><span class="line"></span><br><span class="line">        B(A a) &#123;</span><br><span class="line">            <span class="built_in">this</span>.a = a;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                a.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;B&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">A</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">        <span class="type">B</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">B</span>(a);</span><br><span class="line">        b.start();</span><br><span class="line">        a.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">JoinExample</span> <span class="variable">example</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JoinExample</span>();</span><br><span class="line">    example.test();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç»“æœ</span></span><br><span class="line">A</span><br><span class="line">B</span><br></pre></td></tr></table></figure>

<h4 id="12-wait"><a href="#12-wait" class="headerlink" title="12. wait() :"></a>12. wait() :</h4><p>è°ƒç”¨è¯¥æ–¹æ³•çš„çº¿ç¨‹è¿›å…¥WATTINGçŠ¶æ€ï¼Œåªæœ‰ç­‰å¾…å¦å¤–çº¿ç¨‹çš„é€šçŸ¥æˆ–ä¸­æ–­æ‰ä¼šè¿”å›ï¼Œè°ƒç”¨wait()æ–¹æ³•åï¼Œä¼šé‡Šæ”¾å¯¹è±¡çš„é”ã€‚</p>
<ul>
<li>wait(long):è¶…æ—¶ç­‰å¾…æœ€å¤šlongæ¯«ç§’ï¼Œå¦‚æœæ²¡æœ‰é€šçŸ¥å°±è¶…æ—¶è¿”å›ã€‚</li>
</ul>
<h4 id="14-notify"><a href="#14-notify" class="headerlink" title="14. notify() :"></a>14. notify() :</h4><p>é€šçŸ¥ä¸€ä¸ªåœ¨å¯¹è±¡ä¸Šç­‰å¾…çš„çº¿ç¨‹ï¼Œä½¿å…¶ä»wait()æ–¹æ³•è¿”å›ï¼Œè€Œè¿”å›çš„å‰ææ˜¯è¯¥çº¿ç¨‹è·å–åˆ°äº†å¯¹è±¡çš„é”ã€‚</p>
<h4 id="15-notifyAll-ï¼š"><a href="#15-notifyAll-ï¼š" class="headerlink" title="15. notifyAll()ï¼š"></a>15. notifyAll()ï¼š</h4><p>é€šçŸ¥æ‰€æœ‰ç­‰å¾…åœ¨è¯¥å¯¹è±¡ä¸Šçš„çº¿ç¨‹ã€‚</p>
<h4 id="å®ˆæŠ¤çº¿ç¨‹Daemon"><a href="#å®ˆæŠ¤çº¿ç¨‹Daemon" class="headerlink" title="å®ˆæŠ¤çº¿ç¨‹Daemon"></a>å®ˆæŠ¤çº¿ç¨‹Daemon</h4><p>&amp;#160; &amp;#160; &amp;#160; &amp;#160;å®ˆæŠ¤çº¿ç¨‹æ˜¯ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹ï¼Œå°±å’Œå®ƒçš„åå­—ä¸€æ ·ï¼Œå®ƒæ˜¯ç³»ç»Ÿçš„å®ˆæŠ¤è€…ï¼Œåœ¨åå°é»˜é»˜åœ°å®ˆæŠ¤ä¸€äº›ç³»ç»ŸæœåŠ¡ï¼Œæ¯”å¦‚åƒåœ¾å›æ”¶çº¿ç¨‹ï¼ŒJITçº¿ç¨‹å°±å¯ä»¥ç†è§£å®ˆæŠ¤çº¿ç¨‹ã€‚ä¸ä¹‹å¯¹åº”çš„å°±æ˜¯ç”¨æˆ·çº¿ç¨‹ï¼Œç”¨æˆ·çº¿ç¨‹å°±å¯ä»¥è®¤ä¸ºæ˜¯ç³»ç»Ÿçš„å·¥ä½œçº¿ç¨‹ï¼Œå®ƒä¼šå®Œæˆæ•´ä¸ªç³»ç»Ÿçš„ä¸šåŠ¡æ“ä½œã€‚ç”¨æˆ·çº¿ç¨‹å®Œå…¨ç»“æŸåå°±æ„å‘³ç€æ•´ä¸ªç³»ç»Ÿçš„ä¸šåŠ¡ä»»åŠ¡å…¨éƒ¨ç»“æŸäº†ï¼Œå› æ­¤ç³»ç»Ÿå°±æ²¡æœ‰å¯¹è±¡éœ€è¦å®ˆæŠ¤çš„äº†ï¼Œå®ˆæŠ¤çº¿ç¨‹è‡ªç„¶è€Œç„¶å°±ä¼šé€€ã€‚å½“ä¸€ä¸ªJavaåº”ç”¨ï¼Œåªæœ‰å®ˆæŠ¤çº¿ç¨‹çš„æ—¶å€™ï¼Œè™šæ‹Ÿæœºå°±ä¼šè‡ªç„¶é€€å‡ºã€‚ä¸‹é¢ä»¥ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è¡¨è¿°Daemonçº¿ç¨‹çš„ä½¿ç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DaemonDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">daemonThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;i am alive&quot;</span>);</span><br><span class="line">                        Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;finally block&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        daemonThread.setDaemon(<span class="literal">true</span>);</span><br><span class="line">        daemonThread.start();</span><br><span class="line">        <span class="comment">//ç¡®ä¿mainçº¿ç¨‹ç»“æŸå‰èƒ½ç»™daemonThreadèƒ½å¤Ÿåˆ†åˆ°æ—¶é—´ç‰‡</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">800</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœä¸ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&gt; i am alive</span><br><span class="line">&gt; <span class="keyword">finally</span> block</span><br><span class="line">&gt; i am alive</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä¾‹å­ä¸­daemodThread runæ–¹æ³•ä¸­æ˜¯ä¸€ä¸ªwhileæ­»å¾ªç¯ï¼Œä¼šä¸€ç›´æ‰“å°,ä½†æ˜¯å½“mainçº¿ç¨‹ç»“æŸådaemonThreadå°±ä¼šé€€å‡ºæ‰€ä»¥ä¸ä¼šå‡ºç°æ­»å¾ªç¯çš„æƒ…å†µã€‚mainçº¿ç¨‹å…ˆç¡çœ 800msä¿è¯daemonThreadèƒ½å¤Ÿæ‹¥æœ‰ä¸€æ¬¡æ—¶é—´ç‰‡çš„æœºä¼šï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥æ­£å¸¸æ‰§è¡Œä¸€æ¬¡æ‰“å°â€œi am aliveâ€æ“ä½œå’Œä¸€æ¬¡finallyå—ä¸­â€finally blockâ€æ“ä½œã€‚ç´§æ¥ç€main çº¿ç¨‹ç»“æŸåï¼ŒdaemonThreadé€€å‡ºï¼Œè¿™ä¸ªæ—¶å€™åªæ‰“å°äº†â€i am aliveâ€å¹¶æ²¡æœ‰æ‰“å°finnalå—ä¸­çš„ã€‚å› æ­¤ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>å®ˆæŠ¤çº¿ç¨‹åœ¨é€€å‡ºçš„æ—¶å€™å¹¶ä¸ä¼šæ‰§è¡Œfinnalyå—ä¸­çš„ä»£ç ï¼Œæ‰€ä»¥å°†é‡Šæ”¾èµ„æºç­‰æ“ä½œä¸è¦æ”¾åœ¨finnalyå—ä¸­æ‰§è¡Œï¼Œè¿™ç§æ“ä½œæ˜¯ä¸å®‰å…¨çš„</strong></p>
<p><strong>çº¿ç¨‹å¯ä»¥é€šè¿‡setDaemon(true)çš„æ–¹æ³•å°†çº¿ç¨‹è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚å¹¶ä¸”éœ€è¦æ³¨æ„çš„æ˜¯è®¾ç½®å®ˆæŠ¤çº¿ç¨‹è¦å…ˆäºstart()æ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ¥</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&gt; Exception in thread <span class="string">&quot;main&quot;</span> java.lang.IllegalThreadStateException</span><br><span class="line">&gt; at java.lang.Thread.setDaemon(Thread.java:<span class="number">1365</span>)</span><br><span class="line">&gt; at learn.DaemonDemo.main(DaemonDemo.java:<span class="number">19</span>)</span><br></pre></td></tr></table></figure>

<h4 id="run-å’Œstart-çš„åŒºåˆ«"><a href="#run-å’Œstart-çš„åŒºåˆ«" class="headerlink" title="run() å’Œstart()çš„åŒºåˆ«"></a>run() å’Œstart()çš„åŒºåˆ«</h4><ol>
<li>start() æ–¹æ³•æ¥å¯åŠ¨çº¿ç¨‹ï¼ŒçœŸæ­£å®ç°äº†å¤šçº¿ç¨‹è¿è¡Œã€‚è¿™æ—¶æ— éœ€ç­‰å¾… run æ–¹æ³•ä½“ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œå¯ä»¥ç›´æ¥ç»§ç»­æ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼›é€šè¿‡è°ƒç”¨ Thread ç±»çš„ start() æ–¹æ³•æ¥å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œ è¿™æ—¶æ­¤çº¿ç¨‹æ˜¯å¤„äºå°±ç»ªçŠ¶æ€ï¼Œ å¹¶æ²¡æœ‰è¿è¡Œã€‚ ç„¶åé€šè¿‡æ­¤ Thread ç±»è°ƒç”¨æ–¹æ³• run() æ¥å®Œæˆå…¶è¿è¡Œæ“ä½œçš„ï¼Œ è¿™é‡Œæ–¹æ³• run() ç§°ä¸ºçº¿ç¨‹ä½“ï¼Œå®ƒåŒ…å«äº†è¦æ‰§è¡Œçš„è¿™ä¸ªçº¿ç¨‹çš„å†…å®¹ï¼Œ run æ–¹æ³•è¿è¡Œç»“æŸï¼Œ æ­¤çº¿ç¨‹ç»ˆæ­¢ã€‚ç„¶å CPU å†è°ƒåº¦å…¶å®ƒçº¿ç¨‹ã€‚</li>
<li>run() æ–¹æ³•å½“ä½œæ™®é€šæ–¹æ³•çš„æ–¹å¼è°ƒç”¨ã€‚ç¨‹åºè¿˜æ˜¯è¦é¡ºåºæ‰§è¡Œï¼Œè¦ç­‰å¾… run æ–¹æ³•ä½“æ‰§è¡Œå®Œæ¯•åï¼Œæ‰å¯ç»§ç»­æ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼› ç¨‹åºä¸­åªæœ‰ä¸»çº¿ç¨‹â€”â€”è¿™ä¸€ä¸ªçº¿ç¨‹ï¼Œ å…¶ç¨‹åºæ‰§è¡Œè·¯å¾„è¿˜æ˜¯åªæœ‰ä¸€æ¡ï¼Œ è¿™æ ·å°±æ²¡æœ‰è¾¾åˆ°å†™çº¿ç¨‹çš„ç›®çš„ã€‚</li>
</ol>
<p>run()ï¼Œå®è´¨ä¸Šæ˜¯æ–¹æ³•ï¼Œä½œç”¨æ˜¯è¿è¡Œçº¿ç¨‹ï¼Œæ— æ³•å¼€å¯æ–°çš„çº¿ç¨‹</p>
<p>start()ï¼Œåˆ›å»ºå¯åŠ¨æ–°çš„çº¿ç¨‹ï¼Œå¯ä»¥å®ç°å¤šçº¿ç¨‹å·¥ä½œã€‚é€šè¿‡start()ä½¿å¾—çº¿ç¨‹å¤„äºå°±ç»ªçŠ¶æ€ï¼Œåœ¨è·å¾—CPUæ—¶é—´ç‰‡åé€šè¿‡run()å¼€å§‹è¿è¡Œ</p>
<h4 id="sleep-å’Œwait-çš„åŒºåˆ«"><a href="#sleep-å’Œwait-çš„åŒºåˆ«" class="headerlink" title="sleep() å’Œwait()çš„åŒºåˆ«"></a>sleep() å’Œwait()çš„åŒºåˆ«</h4><ol>
<li>sleep()æ–¹æ³•æ˜¯Threadçš„é™æ€æ–¹æ³•ï¼Œè€Œwaitæ˜¯Objectå®ä¾‹æ–¹æ³•</li>
<li>wait()æ–¹æ³•å¿…é¡»è¦åœ¨åŒæ­¥æ–¹æ³•æˆ–è€…åŒæ­¥å—ä¸­è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯å¿…é¡»å·²ç»è·å¾—å¯¹è±¡é”ã€‚è€Œsleep()æ–¹æ³•æ²¡æœ‰è¿™ä¸ªé™åˆ¶å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ç§ä½¿ç”¨ã€‚å¦å¤–ï¼Œwait()æ–¹æ³•ä¼šé‡Šæ”¾å æœ‰çš„å¯¹è±¡é”ï¼Œä½¿å¾—è¯¥çº¿ç¨‹è¿›å…¥ç­‰å¾…æ± ä¸­ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è·å–èµ„æºã€‚è€Œsleep()æ–¹æ³•åªæ˜¯ä¼šè®©å‡ºCPUå¹¶ä¸ä¼šé‡Šæ”¾æ‰å¯¹è±¡é”ï¼›</li>
<li>sleep()æ–¹æ³•åœ¨ä¼‘çœ æ—¶é—´è¾¾åˆ°åå¦‚æœå†æ¬¡è·å¾—CPUæ—¶é—´ç‰‡å°±ä¼šç»§ç»­æ‰§è¡Œï¼Œè€Œwait()æ–¹æ³•å¿…é¡»ç­‰å¾…Object.notift&#x2F;Object.notifyAllé€šçŸ¥åï¼Œæ‰ä¼šç¦»å¼€ç­‰å¾…æ± ï¼Œå¹¶ä¸”å†æ¬¡è·å¾—CPUæ—¶é—´ç‰‡æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚</li>
</ol>
<h4 id="çº¿ç¨‹è°ƒåº¦â€”â€”ä¼˜å…ˆçº§"><a href="#çº¿ç¨‹è°ƒåº¦â€”â€”ä¼˜å…ˆçº§" class="headerlink" title="çº¿ç¨‹è°ƒåº¦â€”â€”ä¼˜å…ˆçº§"></a>çº¿ç¨‹è°ƒåº¦â€”â€”ä¼˜å…ˆçº§</h4><p>void setPriority(int newPriority)å‡½æ•°è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§<br>ä¸çº¿ç¨‹ä¼‘çœ ç±»ä¼¼ï¼Œçº¿ç¨‹çš„ä¼˜å…ˆçº§ä»ç„¶æ— æ³•ä¿éšœçº¿ç¨‹çš„æ‰§è¡Œæ¬¡åºã€‚åªä¸è¿‡ï¼Œä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹è·å–<strong>CPUèµ„æºçš„æ¦‚ç‡è¾ƒå¤§</strong>ï¼Œä¼˜å…ˆçº§ä½çš„å¹¶éæ²¡æœºä¼šæ‰§è¡Œã€‚</p>
<p>çº¿ç¨‹çš„ä¼˜å…ˆçº§ç”¨1-10ä¹‹é—´çš„æ•´æ•°è¡¨ç¤ºï¼Œæ•°å€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œé»˜è®¤çš„ä¼˜å…ˆçº§ä¸º5ã€‚<br>åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¼€å¯å¦å¤–ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œåˆ™æ–°å¼€çº¿ç¨‹ç§°ä¸ºè¯¥çº¿ç¨‹çš„å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹åˆå§‹ä¼˜å…ˆçº§ä¸çˆ¶çº¿ç¨‹ç›¸åŒã€‚</p>
<p><strong>è¦åœ¨start()æ–¹æ³•ä¹‹å‰æ‰§è¡Œ</strong></p>
<h4 id="isAlive"><a href="#isAlive" class="headerlink" title="isAlive()"></a>isAlive()</h4><p> æ–¹æ³•isAlive()åŠŸèƒ½æ˜¯åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚</p>
<p>æ´»åŠ¨çŠ¶æ€å°±æ˜¯çº¿ç¨‹å¯åŠ¨ä¸”å°šæœªç»ˆæ­¢ï¼Œæ¯”å¦‚æ­£åœ¨è¿è¡Œæˆ–å‡†å¤‡å¼€å§‹è¿è¡Œã€‚</p>
<h4 id="Sleep"><a href="#Sleep" class="headerlink" title="Sleep()"></a>Sleep()</h4><p>Thread.sleep()æ˜¯Threadç±»çš„ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œä½¿å½“å‰çº¿ç¨‹ä¼‘çœ ï¼Œè¿›å…¥é˜»å¡çŠ¶æ€ï¼ˆæš‚åœæ‰§è¡Œï¼‰ï¼Œå¦‚æœçº¿ç¨‹åœ¨ç¡çœ çŠ¶æ€è¢«ä¸­æ–­ï¼Œå°†ä¼šæŠ›å‡ºIterruptedExceptionä¸­æ–­å¼‚å¸¸ã€‚æŠŠcpuçš„æ—¶é—´ç‰‡äº¤ç»™å…¶ä»–çº¿ç¨‹ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æŒ‡å®šæŠŠCPUçš„æ—¶é—´ç‰‡æ¥ä¸‹æ¥åˆ°åº•äº¤ç»™å“ªä¸ªçº¿ç¨‹ï¼Œè€Œæ˜¯è®©è¿™äº›çº¿ç¨‹è‡ªå·±å»ç«äº‰</p>
<p>ã€‚ä¸»è¦æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<p>ã€aã€‘sleep(long millis)Â  çº¿ç¨‹ç¡çœ  millis æ¯«ç§’</p>
<p>ã€bã€‘sleep(long millis, int nanos)Â Â çº¿ç¨‹ç¡çœ  millis æ¯«ç§’ + nanos çº³ç§’</p>
<h4 id="interrupt"><a href="#interrupt" class="headerlink" title="interrupt()"></a>interrupt()</h4><ul>
<li>æœ¬çº¿ç¨‹ä¸­æ–­è‡ªèº«æ˜¯è¢«å…è®¸çš„ï¼Œä¸”â€ä¸­æ–­æ ‡è®°â€è®¾ç½®ä¸ºtrue</li>
<li>å…¶å®ƒçº¿ç¨‹è°ƒç”¨æœ¬çº¿ç¨‹çš„interrupt()æ–¹æ³•æ—¶ï¼Œä¼šé€šè¿‡checkAccess()æ£€æŸ¥æƒé™ã€‚è¿™æœ‰å¯èƒ½æŠ›å‡ºSecurityExceptionå¼‚å¸¸ã€‚ <ul>
<li>è‹¥çº¿ç¨‹åœ¨é˜»å¡çŠ¶æ€æ—¶ï¼Œè°ƒç”¨äº†å®ƒçš„interrupt()æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒçš„<strong>â€œä¸­æ–­çŠ¶æ€â€ä¼šè¢«æ¸…é™¤</strong>å¹¶ä¸”ä¼šæ”¶åˆ°ä¸€ä¸ªInterruptedExceptionå¼‚å¸¸ã€‚ <ul>
<li>ä¾‹å¦‚ï¼Œå¦‚æœçº¿ç¨‹ç”±äºè°ƒç”¨Objectç±»çš„wait()æ–¹æ³•ã€Threadç±»çš„join()å®ä¾‹æ–¹æ³•ä»¥åŠThread.sleep()é™æ€æ–¹æ³•è€Œè¢«æŒ‚èµ·ï¼Œæ­¤æ—¶å…¶ä»–çº¿ç¨‹è°ƒç”¨äº†è¿™ä¸ªçº¿ç¨‹çš„interruptæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ä¼šè¢«æ¸…é™¤ä¸ºâ€œfalseâ€ï¼Œå¹¶ä¼šæŠ›å‡ºä¸€ä¸ªInterruptedExceptionå¼‚å¸¸ã€‚</li>
</ul>
</li>
<li>å¦‚æœçº¿ç¨‹è¢«é˜»å¡åœ¨ä¸€ä¸ªSelectoré€‰æ‹©å™¨ä¸­ï¼Œé‚£ä¹ˆé€šè¿‡interrupt()ä¸­æ–­å®ƒæ—¶ï¼›çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°ä¼šè¢«è®¾ç½®ä¸ºtrueï¼Œå¹¶ä¸”å®ƒä¼šç«‹å³ä»é€‰æ‹©æ“ä½œä¸­è¿”å›ã€‚<br>å¦‚æœä¸å±äºå‰é¢æ‰€è¯´çš„æƒ…å†µï¼Œé‚£ä¹ˆé€šè¿‡interrupt()ä¸­æ–­çº¿ç¨‹æ—¶ï¼Œå®ƒçš„ä¸­æ–­æ ‡è®°ä¼šè¢«è®¾ç½®ä¸ºâ€œtrueâ€ã€‚</li>
</ul>
</li>
</ul>
<p>å¯ä»¥å¾—å‡ºä¸¤ç‚¹ç»“è®ºï¼š</p>
<p>ã€€ã€€1 å³ä¾¿è°ƒç”¨äº†interruptæ–¹æ³•ï¼Œä¹‹åç”¨isInterrupted()æ–¹æ³•æ£€æŸ¥å®ƒçš„ä¸­æ–­çŠ¶æ€æ—¶ä¹Ÿä¸ä¸€å®šèƒ½å¾—åˆ°trueã€‚</p>
<p>ã€€ã€€2 å¦‚æœçº¿ç¨‹å½“å‰è¿è¡Œå¤„çš„ä»£ç å—ä¸å¯¹InterruptedExceptionå¼‚å¸¸è¿›è¡Œåˆé€‚çš„å¤„ç†ï¼Œé‚£ä¹ˆinterruptæ–¹æ³•å°±æ²¡æœ‰ä»»ä½•æ•ˆæœã€‚</p>
<p>interruptedå¹¶ä¸æ˜¯é©¬ä¸Šåœæ­¢çº¿ç¨‹ï¼Œè€Œæ˜¯ç»™çº¿ç¨‹æ‰“ä¸€ä¸ªåœæ­¢æ ‡è®°ï¼Œå°†çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€è®¾ç½®ä¸ºtrue,è¿™ç±»ä¼¼è€æ¿è®©ä½ å¥½å¥½å·¥ä½œï¼Œä½†æ˜¯åˆ°åº•å¥½ä¸å¥½å·¥ä½œè¦çœ‹ä½ è‡ªå·±ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">50000</span>; i++) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;i=&quot;</span> + (i + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">MyThread</span> <span class="variable">myThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread</span>();</span><br><span class="line">            myThread.start();</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            myThread.interrupt();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç»“æœæ˜¾ç¤ºè¿˜æ˜¯ä¼šæ‰“å°5ä¸‡è¡Œæ•°æ®ã€‚</p>
<p>Threadæä¾›äº†ä¸¤ä¸ªæ–¹æ³•æ¥åˆ¤æ–­çº¿ç¨‹æ˜¯å¦ç»ˆæ­¢</p>
<p>interrupt() å½“æŠ›å‡ºå¼‚å¸¸æ—¶ï¼Œä¼šæ¸…é™¤ä¸­æ–­çŠ¶æ€</p>
<p>static boolean interrupted()ï¼šåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸­æ–­ï¼Œæ¸…é™¤ä¸­æ–­æ ‡å¿—ã€‚</p>
<p>boolean isInterrupted()ï¼šåˆ¤æ–­çº¿ç¨‹æ˜¯å¦ä¸­æ–­ï¼Œä¸æ¸…é™¤ä¸­æ–­æ ‡å¿—ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Thread.currentThread().interrupt();</span><br><span class="line">System.out.println(&quot;æ˜¯å¦åœæ­¢1ï¼Ÿ=&quot; + Thread.interrupted());//trueï¼Œæ‰§è¡Œæ–¹æ³•åæ¸…é™¤äº†æ ‡è®°</span><br><span class="line">System.out.println(&quot;æ˜¯å¦åœæ­¢2ï¼Ÿ=&quot; + Thread.interrupted());//false</span><br><span class="line">å½“è°ƒç”¨äº†interruptedåçº¿ç¨‹æœªçœŸæ­£çš„åœæ­¢ï¼Œä½†å·²ç»æœ‰äº†æ ‡å¿—çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡æ ‡å¿—çŠ¶æ€æ¥å¯¹æˆ‘ä»¬çš„å¤šçº¿ç¨‹æ‰§è¡Œçš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FiveThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">500000</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.isInterrupted()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å·²ç»æ˜¯åœæ­¢çŠ¶æ€äº†!é€€å‡º!&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;i=&quot;</span> + (i + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;666&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">FiveThread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FiveThread</span>();</span><br><span class="line">        thread.start();</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        thread.interrupt();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;main catch&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;end!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¼‚å¸¸æ³•åœæ­¢çº¿ç¨‹</p>
<p>è¿™æ ·è™½ç„¶å¯ä»¥å®ç°é€€å‡ºforå¾ªç¯ï¼Œä½†æ˜¯åœ¨forå¾ªç¯ä¹‹å¤–çš„ä»£ç ä¾ç„¶ä¼šè¢«æ‰§è¡Œï¼Œå¾ˆæ˜æ˜¾è¿™æ ·æ²¡æœ‰è¾¾åˆ°æ•ˆæœï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥æŠ›å‡ºå¼‚å¸¸ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">500000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.isInterrupted()) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;å·²ç»æ˜¯åœæ­¢çŠ¶æ€äº†!é€€å‡º!&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;i=&quot;</span> + (i + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        System.out.println(<span class="string">&quot;æŠ›å‡ºäº†é”™è¯¯ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;666&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨returnæ–¹å¼è¿›è¡Œå¤„ç†ï¼Œä½†è¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸å¤„ç†æ¯”è¾ƒå¥½ï¼Œå¯ä»¥è®©çº¿ç¨‹ä¸­æ–­äº‹ä»¶å¾—åˆ°ä¼ æ’­ã€‚</p>
<h4 id="interrupted"><a href="#interrupted" class="headerlink" title="interrupted()"></a>interrupted()</h4><p>åˆ¤æ–­çš„æ˜¯å½“å‰çº¿ç¨‹æ˜¯å¦å¤„äºä¸­æ–­çŠ¶æ€ã€‚æ˜¯ç±»çš„é™æ€æ–¹æ³•ï¼ŒåŒæ—¶ä¼šæ¸…é™¤çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">interrupted</span><span class="params">()</span> &#123;</span><br><span class="line">ã€€ã€€<span class="keyword">return</span> currentThread().isInterrupted(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="isInterrupted"><a href="#isInterrupted" class="headerlink" title="isInterrupted()"></a>isInterrupted()</h4><p>åˆ¤æ–­è°ƒç”¨çº¿ç¨‹æ˜¯å¦å¤„äºä¸­æ–­çŠ¶æ€ï¼Œä¸æ¸…é™¤ä¸­æ–­æ ‡å¿—ã€‚<br>ä¾‹å¦‚:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">ã€€ã€€<span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;&#125;); <span class="comment">//å®šä¹‰ä¸€ä¸ªçº¿ç¨‹ï¼Œä¼ªä»£ç æ²¡æœ‰å…·ä½“å®ç°</span></span><br><span class="line">ã€€ã€€thread.isInterrupted();<span class="comment">//åˆ¤æ–­threadæ˜¯å¦å¤„äºä¸­æ–­çŠ¶æ€ï¼Œè€Œä¸æ˜¯ä¸»çº¿ç¨‹æ˜¯å¦å¤„äºä¸­æ–­çŠ¶æ€</span></span><br><span class="line">ã€€ã€€Thread.isInterrupted(); <span class="comment">//åˆ¤æ–­ä¸»çº¿ç¨‹æ˜¯å¦å¤„äºä¸­æ–­çŠ¶æ€</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="wait-notify-notifyAll"><a href="#wait-notify-notifyAll" class="headerlink" title="wait() notify() notifyAll()"></a>wait() notify() notifyAll()</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">wait</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    wait(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">notify</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>Object.waitï¼ˆï¼‰ - æŒ‚èµ·ä¸€ä¸ªçº¿ç¨‹</li>
<li>Object.notifyï¼ˆï¼‰ -å”¤é†’çº¿ç¨‹</li>
</ul>
<p>waitï¼ˆï¼‰æ–¹æ³•å¸¦æœ‰ä¸‰ä¸ªé‡è½½ã€‚</p>
<h4 id="waitï¼ˆï¼‰"><a href="#waitï¼ˆï¼‰" class="headerlink" title="waitï¼ˆï¼‰"></a>waitï¼ˆï¼‰</h4><ol>
<li>è¯¥waitï¼ˆï¼‰æ–¹æ³•å¯¼è‡´å½“å‰çº¿ç¨‹æ— é™æœŸåœ°ç­‰å¾…ï¼Œç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è¦ä¹ˆè°ƒç”¨notifyï¼ˆï¼‰æ­¤å¯¹è±¡æˆ–notifyAllçš„ï¼ˆï¼‰ ã€‚</li>
<li>waitï¼ˆlong timeoutï¼‰<br>ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šä¸€ä¸ªè¶…æ—¶ï¼Œåœ¨è¯¥è¶…æ—¶ä¹‹åå°†è‡ªåŠ¨å”¤é†’çº¿ç¨‹ã€‚å¯ä»¥ä½¿ç”¨notifyï¼ˆï¼‰æˆ–notifyAllï¼ˆï¼‰åœ¨è¾¾åˆ°è¶…æ—¶ä¹‹å‰å”¤é†’çº¿ç¨‹ã€‚<br>è¯·æ³¨æ„ï¼Œè°ƒç”¨waitï¼ˆ0ï¼‰ä¸è°ƒç”¨waitï¼ˆï¼‰ç›¸åŒã€‚</li>
<li>waitï¼ˆlong timeoutï¼Œint nanosï¼‰<br>è¿™æ˜¯å¦ä¸€ä¸ªæä¾›ç›¸åŒåŠŸèƒ½çš„ç­¾åï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯è¿™ä¸ªå¯ä»¥æä¾›æ›´é«˜çš„ç²¾åº¦ã€‚<br>æ€»è¶…æ—¶æ—¶é—´ï¼ˆä»¥çº³ç§’ä¸ºå•ä½ï¼‰è®¡ç®—ä¸º1_000_000 *timeout+ nanosã€‚</li>
</ol>
<h4 id="notifyï¼ˆï¼‰å’ŒnotifyAllï¼ˆï¼‰"><a href="#notifyï¼ˆï¼‰å’ŒnotifyAllï¼ˆï¼‰" class="headerlink" title="notifyï¼ˆï¼‰å’ŒnotifyAllï¼ˆï¼‰"></a>notifyï¼ˆï¼‰å’ŒnotifyAllï¼ˆï¼‰</h4><p>è¯¥notifyï¼ˆï¼‰æ–¹æ³•ç”¨äºå”¤é†’æ­£åœ¨ç­‰å¾…åˆ°è¯¥å¯¹è±¡çš„ç›‘è§†å™¨æ¥å…¥çº¿ç¨‹ã€‚<br>æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥é€šçŸ¥ç­‰å¾…çº¿ç¨‹ã€‚</p>
<ol>
<li>notifyï¼ˆï¼‰<br>å¯¹äºåœ¨æ­¤å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹ï¼ˆé€šè¿‡ä½¿ç”¨ä»»ä½•ä¸€ä¸ªwaitï¼ˆï¼‰æ–¹æ³•ï¼‰ï¼Œæ–¹æ³•notifyï¼ˆï¼‰é€šçŸ¥ä»»ä½•ä¸€ä¸ªçº¿ç¨‹ä»»æ„å”¤é†’ã€‚ç¡®åˆ‡å”¤é†’å“ªä¸ªçº¿ç¨‹çš„é€‰æ‹©æ˜¯éç¡®å®šæ€§çš„ ï¼Œå–å†³äºå®ç°ã€‚<br>ç”±äºnotifyï¼ˆï¼‰å”¤é†’äº†ä¸€ä¸ªéšæœºçº¿ç¨‹ï¼Œå› æ­¤å®ƒå¯ç”¨äºå®ç°çº¿ç¨‹æ‰§è¡Œç±»ä¼¼ä»»åŠ¡çš„äº’æ–¥é”å®šï¼Œä½†åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå®ç°notifyAllï¼ˆï¼‰ä¼šæ›´å¯è¡Œã€‚</li>
<li>notifyAllï¼ˆï¼‰<br>æ­¤æ–¹æ³•åªæ˜¯å”¤é†’æ­£åœ¨æ­¤å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹ã€‚<br>å”¤é†’çš„çº¿ç¨‹å°†ä»¥é€šå¸¸çš„æ–¹å¼å®Œæˆ - å°±åƒä»»ä½•å…¶ä»–çº¿ç¨‹ä¸€æ ·ã€‚<br>ä½†æ˜¯åœ¨æˆ‘ä»¬å…è®¸å®ƒä»¬ç»§ç»­æ‰§è¡Œä¹‹å‰ï¼Œæ€»æ˜¯è¦å®šä¹‰å¿«é€Ÿæ£€æŸ¥ç»§ç»­æ‰§è¡Œçº¿ç¨‹æ‰€éœ€çš„æ¡ä»¶ - å› ä¸ºå¯èƒ½å­˜åœ¨æŸäº›æƒ…å†µä¸‹çº¿ç¨‹è¢«å”¤é†’è€Œæ²¡æœ‰æ”¶åˆ°é€šçŸ¥</li>
</ol>
<h4 id="æ‰§è¡Œ"><a href="#æ‰§è¡Œ" class="headerlink" title="æ‰§è¡Œ"></a>æ‰§è¡Œ</h4><ol>
<li>é¦–å…ˆï¼Œwaitè·å–å¯¹è±¡é”ï¼Œç„¶åè°ƒç”¨wait()æ–¹æ³•ï¼Œæ­¤æ—¶ï¼Œ<strong>waitçº¿ç¨‹ä¼šæ”¾å¼ƒå¯¹è±¡é”</strong>ï¼ŒåŒæ—¶è¿›å…¥å¯¹è±¡çš„ç­‰å¾…é˜Ÿåˆ—WaitQueueä¸­;</li>
<li>notifyçº¿ç¨‹æŠ¢å åˆ°å¯¹è±¡é”ï¼Œæ‰§è¡Œä¸€äº›æ“ä½œåï¼Œè°ƒç”¨notify()æ–¹æ³•ï¼Œæ­¤æ—¶ä¼šå°†ç­‰å¾…çº¿ç¨‹waitThreadä»ç­‰å¾…é˜Ÿåˆ—WaitQueueä¸­ç§»åˆ°åŒæ­¥é˜Ÿåˆ—SynchronizedQueueä¸­ï¼Œwaitç”±waittingçŠ¶æ€å˜ä¸ºblockedçŠ¶æ€ã€‚éœ€è¦æ³¨æ„çš„æ—¶ï¼Œ<strong>notifyæ­¤æ—¶å¹¶ä¸ä¼šç«‹å³é‡Šæ”¾é”</strong>ï¼Œå®ƒç»§ç»­è¿è¡Œï¼ŒæŠŠè‡ªå·±å‰©ä½™çš„äº‹å„¿å¹²å®Œä¹‹åæ‰ä¼šé‡Šæ”¾é”;</li>
<li>waitå†æ¬¡è·å–åˆ°å¯¹è±¡é”ï¼Œä»wait()æ–¹æ³•è¿”å›ç»§ç»­æ‰§è¡Œåç»­çš„æ“ä½œ;</li>
<li>ä¸€ä¸ªåŸºäºç­‰å¾…&#x2F;é€šçŸ¥æœºåˆ¶çš„çº¿ç¨‹é—´é€šä¿¡çš„è¿‡ç¨‹ç»“æŸã€‚</li>
</ol>
<p>è‡³äºnotifyAllåˆ™æ˜¯åœ¨ç¬¬äºŒæ­¥ä¸­å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰çº¿ç¨‹ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­å»ã€‚</p>
<p><strong>é¿å…è¸©å‘</strong></p>
<p>ã€€ã€€åœ¨ä½¿ç”¨wait&#x2F;notify&#x2F;notifyAllæ—¶æœ‰ä¸€äº›ç‰¹åˆ«ç•™æ„çš„ï¼Œåœ¨æ­¤å†æ€»ç»“ä¸€ä¸‹ï¼š</p>
<ol>
<li>ä¸€å®šåœ¨synchronizedä¸­ä½¿ç”¨wait()&#x2F;notify()&#x2F;notifyAll()ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€å®šè¦å…ˆè·å–é”ï¼Œè¿™ä¸ªå‰é¢æˆ‘ä»¬è®²è¿‡ï¼Œå› ä¸ºåªæœ‰åŠ é”åï¼Œæ‰èƒ½è·å¾—ç›‘è§†å™¨ã€‚å¦åˆ™jvmä¹Ÿä¼šæŠ›å‡ºIllegalMonitorStateExceptionå¼‚å¸¸ã€‚</li>
<li>ä½¿ç”¨wait()æ—¶ï¼Œåˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¿›å…¥waitçŠ¶æ€çš„æ¡ä»¶ä¸€å®šè¦ä½¿ç”¨whileè€Œä¸è¦ä½¿ç”¨ifï¼Œå› ä¸ºç­‰å¾…çº¿ç¨‹å¯èƒ½ä¼šè¢«é”™è¯¯åœ°å”¤é†’ï¼Œæ‰€ä»¥åº”è¯¥ä½¿ç”¨whileå¾ªç¯åœ¨ç­‰å¾…å‰ç­‰å¾…åéƒ½æ£€æŸ¥å”¤é†’æ¡ä»¶æ˜¯å¦è¢«æ»¡è¶³ï¼Œä¿è¯å®‰å…¨æ€§ã€‚</li>
<li>notify()æˆ–notifyAll()æ–¹æ³•è°ƒç”¨åï¼Œçº¿ç¨‹ä¸ä¼šç«‹å³é‡Šæ”¾é”ã€‚è°ƒç”¨åªä¼šå°†waitä¸­çš„çº¿ç¨‹ä»ç­‰å¾…é˜Ÿåˆ—ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹çŠ¶æ€ä»waittingå˜ä¸ºblocked;</li>
<li>ä»wait()æ–¹æ³•è¿”å›çš„å‰ææ˜¯çº¿ç¨‹é‡æ–°è·å¾—äº†è°ƒç”¨å¯¹è±¡çš„é”ã€‚</li>
</ol>
<h3 id="åœæ­¢çº¿ç¨‹"><a href="#åœæ­¢çº¿ç¨‹" class="headerlink" title="åœæ­¢çº¿ç¨‹"></a>åœæ­¢çº¿ç¨‹</h3><p>åœæ­¢ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œæœ‰ä¸‰ç§åŠæ³•ï¼š</p>
<ol>
<li>è°ƒç”¨Threadå¯¹è±¡çš„stop()æ–¹æ³•ï¼Œstop()å’Œsupendå’Œresumeå·²ç»è¢«å¼ƒç”¨</li>
<li>interrupt()é…åˆisInterrupt()ä½¿ç”¨ ä¸Šé¢çš„ä»£ç </li>
<li>ä½¿ç”¨volatileå‹å…±äº«å˜é‡ï¼ˆæ—¥å¿—é¡¹ç›®ä¸­ä½¿ç”¨æ­¤æ–¹æ³•ï¼‰</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä½†æ˜¯ä½¿ç”¨æ ‡å¿—ä½è¿™ç§æ–¹æ³•æœ‰ä¸ªå¾ˆå¤§çš„å±€é™æ€§ï¼Œé‚£å°±æ˜¯é€šè¿‡å¾ªç¯æ¥ä½¿æ¯æ¬¡çš„æ“ä½œéƒ½éœ€è¦æ£€æŸ¥ä¸€ä¸‹æ ‡å¿—ä½ã€‚</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BestPractice</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">finished</span> <span class="operator">=</span> <span class="literal">false</span>;   <span class="comment">// â‘  volatileæ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stopMe</span><span class="params">()</span> &#123;</span><br><span class="line">        finished = <span class="literal">true</span>;    <span class="comment">// â‘¡ å‘å‡ºåœæ­¢ä¿¡å·</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (!finished) &#123;    <span class="comment">// â‘¢ æ£€æµ‹æ¡ä»¶å˜é‡</span></span><br><span class="line">            <span class="comment">// do dirty work   // â‘£ä¸šåŠ¡ä»£ç </span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="stopä¸æ¨è"><a href="#stopä¸æ¨è" class="headerlink" title="stopä¸æ¨è"></a>stopä¸æ¨è</h5><p>ä¸å°‘å¼€å‘è€…ç”¨è¿‡Threadçš„stopå»åœæ­¢çº¿ç¨‹ï¼Œå½“ç„¶æ­¤å‡½æ•°ç¡®å®èƒ½åœæ­¢çº¿ç¨‹ï¼Œä¸è¿‡Javaå®˜æ–¹æ—©å·²å°†å®ƒåºŸå¼ƒï¼Œä¸æ¨èä½¿ç”¨ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</p>
<p>stopæ˜¯é€šè¿‡ç«‹å³æŠ›å‡ºThreadDeathå¼‚å¸¸ï¼Œæ¥è¾¾åˆ°åœæ­¢çº¿ç¨‹çš„ç›®çš„ï¼Œæ­¤å¼‚å¸¸æŠ›å‡ºæœ‰å¯èƒ½å‘ç”Ÿåœ¨ä»»ä½•ä¸€æ—¶é—´ç‚¹ï¼ŒåŒ…æ‹¬åœ¨catchã€finallyç­‰è¯­å¥å—ä¸­ï¼Œä½†æ˜¯æ­¤å¼‚å¸¸å¹¶ä¸ä¼šå¼•èµ·ç¨‹åºé€€å‡º(ç¬”è€…åªæµ‹è¯•äº†Java8)ã€‚<br>ç”±äºæœ‰å¼‚å¸¸æŠ›å‡ºï¼Œå¯¼è‡´çº¿ç¨‹ä¼šé‡Šæ”¾å…¨éƒ¨æ‰€æŒæœ‰çš„é”ï¼Œæå¯èƒ½å¼•èµ·çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p>
<p>ç”±äºä»¥ä¸Š2ç‚¹ï¼Œstopè¿™ç§æ–¹å¼åœæ­¢çº¿ç¨‹æ˜¯ä¸å®‰å…¨çš„ã€‚</p>
<h3 id="æš‚åœçº¿ç¨‹"><a href="#æš‚åœçº¿ç¨‹" class="headerlink" title="æš‚åœçº¿ç¨‹"></a>æš‚åœçº¿ç¨‹</h3><ol>
<li>å­˜åœ¨æ­»é”çš„å¯èƒ½æ€§ </li>
<li>æœ‰å¯èƒ½å‡ºç°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå› ä¸ºæ•°æ®å¯èƒ½è¢«å…¶ä»–è¿è¡Œçš„çº¿ç¨‹æ›´æ”¹ï¼</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æš‚åœçº¿ç¨‹çš„æ–¹å¼ suspend() å·²ç»ä¸æ¨èä½¿ç”¨è¿™ç§æ–¹å¼</span></span><br><span class="line"><span class="comment"> * æ¢å¤æš‚åœçº¿ç¨‹çš„æ–¹å¼ resume()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SuspendThreadTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">th3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">th</span>());</span><br><span class="line">        System.out.println(th3.getName() + <span class="string">&quot;å¯åŠ¨&quot;</span>);</span><br><span class="line">        th3.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        System.out.println(th3.getName() + <span class="string">&quot;æš‚åœ&quot;</span>);</span><br><span class="line">        <span class="comment">// æš‚åœçº¿ç¨‹</span></span><br><span class="line">        th3.suspend();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(th3.getName() + <span class="string">&quot;æ¢å¤æ‰§è¡Œ&quot;</span>);</span><br><span class="line">        <span class="comment">// æ¢å¤æš‚åœçº¿ç¨‹</span></span><br><span class="line">        th3.resume();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é™æ€å†…éƒ¨ç±»</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">th</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;æ‰§è¡Œï¼&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                System.out.println(System.currentTimeMillis());</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">20</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;æŠ›å‡ºå¼‚å¸¸&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="çº¿ç¨‹å®‰å…¨"><a href="#çº¿ç¨‹å®‰å…¨" class="headerlink" title="çº¿ç¨‹å®‰å…¨"></a>çº¿ç¨‹å®‰å…¨</h3><p>å¤šä¸ªçº¿ç¨‹ä¸ç®¡ä»¥ä½•ç§æ–¹å¼è®¿é—®æŸä¸ªç±»ï¼Œå¹¶ä¸”åœ¨ä¸»è°ƒä»£ç ä¸­ä¸éœ€è¦è¿›è¡ŒåŒæ­¥ï¼Œéƒ½èƒ½è¡¨ç°æ­£ç¡®çš„è¡Œä¸ºã€‚</p>
<p>çº¿ç¨‹å®‰å…¨æœ‰ä»¥ä¸‹å‡ ç§å®ç°æ–¹å¼ï¼š</p>
<h4 id="ä¸å¯å˜"><a href="#ä¸å¯å˜" class="headerlink" title="ä¸å¯å˜"></a>ä¸å¯å˜</h4><p>ä¸å¯å˜ï¼ˆImmutableï¼‰çš„å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸éœ€è¦å†é‡‡å–ä»»ä½•çš„çº¿ç¨‹å®‰å…¨ä¿éšœæªæ–½ã€‚åªè¦ä¸€ä¸ªä¸å¯å˜çš„å¯¹è±¡è¢«æ­£ç¡®åœ°æ„å»ºå‡ºæ¥ï¼Œæ°¸è¿œä¹Ÿä¸ä¼šçœ‹åˆ°å®ƒåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹ä¸­å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ã€‚å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œåº”å½“å°½é‡ä½¿å¯¹è±¡æˆä¸ºä¸å¯å˜ï¼Œæ¥æ»¡è¶³çº¿ç¨‹å®‰å…¨ã€‚</p>
<p>ä¸å¯å˜çš„ç±»å‹ï¼š</p>
<ul>
<li>final å…³é”®å­—ä¿®é¥°çš„åŸºæœ¬æ•°æ®ç±»å‹</li>
<li>String</li>
<li>æšä¸¾ç±»å‹</li>
<li>Number éƒ¨åˆ†å­ç±»ï¼Œå¦‚ Long å’Œ Double ç­‰æ•°å€¼åŒ…è£…ç±»å‹ï¼ŒBigInteger å’Œ BigDecimal ç­‰å¤§æ•°æ®ç±»å‹ã€‚ä½†åŒä¸º Number çš„åŸå­ç±» AtomicInteger å’Œ AtomicLong åˆ™æ˜¯å¯å˜çš„ã€‚</li>
</ul>
<p>å¯¹äºé›†åˆç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ Collections.unmodifiableXXX() æ–¹æ³•æ¥è·å–ä¸€ä¸ªä¸å¯å˜çš„é›†åˆã€‚</p>
<h3 id="Synchronized-amp-Volatile-amp-ThreadLocal"><a href="#Synchronized-amp-Volatile-amp-ThreadLocal" class="headerlink" title="Synchronized &amp; Volatile &amp; ThreadLocal"></a>Synchronized &amp; Volatile &amp; ThreadLocal</h3><h4 id="Synchronized"><a href="#Synchronized" class="headerlink" title="Synchronized"></a>Synchronized</h4><p><a href="https://zhuanlan.zhihu.com/p/378429667">https://zhuanlan.zhihu.com/p/378429667</a></p>
<p>é€ æˆçº¿ç¨‹å®‰å…¨é—®é¢˜çš„ä¸»è¦è¯±å› æœ‰ä¸¤ç‚¹ï¼Œä¸€æ˜¯å­˜åœ¨å…±äº«æ•°æ®(ä¹Ÿç§°ä¸´ç•Œèµ„æº)ï¼ŒäºŒæ˜¯å­˜åœ¨å¤šæ¡çº¿ç¨‹å…±åŒæ“ä½œå…±äº«æ•°æ®ã€‚å› æ­¤ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦è¿™æ ·ä¸€ä¸ªæ–¹æ¡ˆï¼Œå½“å­˜åœ¨å¤šä¸ªçº¿ç¨‹æ“ä½œå…±äº«æ•°æ®æ—¶ï¼Œéœ€è¦ä¿è¯åŒä¸€æ—¶åˆ»æœ‰ä¸”åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ“ä½œå…±äº«æ•°æ®ï¼Œå…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰åˆ°è¯¥çº¿ç¨‹å¤„ç†å®Œæ•°æ®åå†è¿›è¡Œï¼Œè¿™ç§æ–¹å¼æœ‰ä¸ªé«˜å°šçš„åç§°å«äº’æ–¥é”ï¼Œå³èƒ½è¾¾åˆ°äº’æ–¥è®¿é—®ç›®çš„çš„é”ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ä¸€ä¸ªå…±äº«æ•°æ®è¢«å½“å‰æ­£åœ¨è®¿é—®çš„çº¿ç¨‹åŠ ä¸Šäº’æ–¥é”åï¼Œåœ¨åŒä¸€ä¸ªæ—¶åˆ»ï¼Œå…¶ä»–çº¿ç¨‹åªèƒ½å¤„äºç­‰å¾…çš„çŠ¶æ€ï¼Œç›´åˆ°å½“å‰çº¿ç¨‹å¤„ç†å®Œæ¯•é‡Šæ”¾è¯¥é”ã€‚åœ¨ Java ä¸­ï¼Œå…³é”®å­— synchronizedå¯ä»¥ä¿è¯åœ¨åŒä¸€ä¸ªæ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡ŒæŸä¸ªæ–¹æ³•æˆ–è€…æŸä¸ªä»£ç å—(ä¸»è¦æ˜¯å¯¹æ–¹æ³•æˆ–è€…ä»£ç å—ä¸­å­˜åœ¨å…±äº«æ•°æ®çš„æ“ä½œ)ï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜åº”è¯¥æ³¨æ„åˆ°synchronizedå¦å¤–ä¸€ä¸ªé‡è¦çš„ä½œç”¨ï¼Œsynchronizedå¯ä¿è¯ä¸€ä¸ªçº¿ç¨‹çš„å˜åŒ–(ä¸»è¦æ˜¯å…±äº«æ•°æ®çš„å˜åŒ–)è¢«å…¶ä»–çº¿ç¨‹æ‰€çœ‹åˆ°ï¼ˆä¿è¯å¯è§æ€§ï¼Œå®Œå…¨å¯ä»¥æ›¿ä»£VolatileåŠŸèƒ½ï¼‰ï¼Œè¿™ç‚¹ç¡®å®ä¹Ÿæ˜¯å¾ˆé‡è¦çš„ã€‚</p>
<p><strong>javaçš„å†…ç½®é”ï¼š</strong> æ¯ä¸ªjavaå¯¹è±¡éƒ½å¯ä»¥ç”¨åšä¸€ä¸ªå®ç°åŒæ­¥çš„é”ï¼Œè¿™äº›é”æˆä¸ºå†…ç½®é”ã€‚çº¿ç¨‹è¿›å…¥åŒæ­¥ä»£ç å—æˆ–æ–¹æ³•çš„æ—¶å€™ä¼šè‡ªåŠ¨è·å¾—è¯¥é”ï¼Œåœ¨é€€å‡ºåŒæ­¥ä»£ç å—æˆ–æ–¹æ³•æ—¶ä¼šé‡Šæ”¾è¯¥é”ã€‚è·å¾—å†…ç½®é”çš„å”¯ä¸€é€”å¾„å°±æ˜¯è¿›å…¥è¿™ä¸ªé”çš„ä¿æŠ¤çš„åŒæ­¥ä»£ç å—æˆ–æ–¹æ³•ã€‚</p>
<p>javaå†…ç½®é”æ˜¯ä¸€ä¸ª<strong>äº’æ–¥é”</strong>ï¼Œè¿™å°±æ˜¯æ„å‘³ç€æœ€å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè·å¾—è¯¥é”ï¼Œå½“çº¿ç¨‹Aå°è¯•å»è·å¾—çº¿ç¨‹BæŒæœ‰çš„å†…ç½®é”æ—¶ï¼Œçº¿ç¨‹Aå¿…é¡»ç­‰å¾…æˆ–è€…é˜»å¡ï¼ŒçŸ¥é“çº¿ç¨‹Bé‡Šæ”¾è¿™ä¸ªé”ï¼Œå¦‚æœBçº¿ç¨‹ä¸é‡Šæ”¾è¿™ä¸ªé”ï¼Œé‚£ä¹ˆAçº¿ç¨‹å°†æ°¸è¿œç­‰å¾…ä¸‹å»ã€‚</p>
<p><strong>éšå¼é”</strong>ï¼šåŠ é”å’Œè§£é”çš„è¿‡ç¨‹éƒ½æœ‰jvmå¸®åŠ©æˆ‘ä»¬å®Œæˆï¼ˆ<strong>Lockä¸ºæ˜¾ç¤ºé”</strong>ï¼‰</p>
<p><strong>javaçš„å¯¹è±¡é”å’Œç±»é”ï¼š</strong> javaçš„å¯¹è±¡é”å’Œç±»é”åœ¨é”çš„æ¦‚å¿µä¸ŠåŸºæœ¬ä¸Šå’Œå†…ç½®é”æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯ï¼Œä¸¤ä¸ªé”å®é™…æ˜¯æœ‰å¾ˆå¤§çš„åŒºåˆ«çš„ï¼Œå¯¹è±¡é”æ˜¯ç”¨äºå¯¹è±¡å®ä¾‹æ–¹æ³•ï¼Œæˆ–è€…ä¸€ä¸ªå¯¹è±¡å®ä¾‹ä¸Šçš„ï¼Œç±»é”æ˜¯ç”¨äºç±»çš„é™æ€æ–¹æ³•æˆ–è€…ä¸€ä¸ªç±»çš„classå¯¹è±¡ä¸Šçš„ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œç±»çš„å¯¹è±¡å®ä¾‹å¯ä»¥æœ‰å¾ˆå¤šä¸ªï¼Œä½†æ˜¯æ¯ä¸ªç±»åªæœ‰ä¸€ä¸ªclasså¯¹è±¡ï¼Œæ‰€ä»¥ä¸åŒå¯¹è±¡å®ä¾‹çš„å¯¹è±¡é”æ˜¯äº’ä¸å¹²æ‰°çš„ï¼Œä½†æ˜¯æ¯ä¸ªç±»åªæœ‰ä¸€ä¸ªç±»é”ã€‚ä½†æ˜¯æœ‰ä¸€ç‚¹å¿…é¡»æ³¨æ„çš„æ˜¯ï¼Œå…¶å®ç±»é”åªæ˜¯ä¸€ä¸ªæ¦‚å¿µä¸Šçš„ä¸œè¥¿ï¼Œå¹¶ä¸æ˜¯çœŸå®å­˜åœ¨çš„ï¼Œå®ƒåªæ˜¯ç”¨æ¥å¸®åŠ©æˆ‘ä»¬ç†è§£é”å®šå®ä¾‹æ–¹æ³•å’Œé™æ€æ–¹æ³•çš„åŒºåˆ«çš„</p>
<h5 id="synchronizedçš„ä¸‰ç§åº”ç”¨æ–¹å¼"><a href="#synchronizedçš„ä¸‰ç§åº”ç”¨æ–¹å¼" class="headerlink" title="synchronizedçš„ä¸‰ç§åº”ç”¨æ–¹å¼"></a>synchronizedçš„ä¸‰ç§åº”ç”¨æ–¹å¼</h5><p>synchronizedå…³é”®å­—æœ€ä¸»è¦æœ‰ä»¥ä¸‹3ç§åº”ç”¨æ–¹å¼</p>
<ul>
<li>ä¿®é¥°å®ä¾‹æ–¹æ³•ï¼Œä½œç”¨äºå½“å‰å®ä¾‹åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾—å½“å‰å®ä¾‹çš„é”</li>
<li>ä¿®é¥°é™æ€æ–¹æ³•ï¼Œä½œç”¨äºå½“å‰ç±»å¯¹è±¡åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾—å½“å‰ç±»å¯¹è±¡çš„é”</li>
<li>ä¿®é¥°ä»£ç å—ï¼ŒæŒ‡å®šåŠ é”å¯¹è±¡ï¼Œå¯¹ç»™å®šå¯¹è±¡åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç åº“å‰è¦è·å¾—ç»™å®šå¯¹è±¡çš„é”ã€‚</li>
</ul>
<h6 id="synchronizedä½œç”¨äºé™æ€æ–¹æ³•"><a href="#synchronizedä½œç”¨äºé™æ€æ–¹æ³•" class="headerlink" title="synchronizedä½œç”¨äºé™æ€æ–¹æ³•"></a>synchronizedä½œç”¨äºé™æ€æ–¹æ³•</h6><p>å½“synchronizedä½œç”¨äºé™æ€æ–¹æ³•æ—¶ï¼Œå…¶é”å°±æ˜¯å½“å‰ç±»çš„classå¯¹è±¡é”ã€‚ç”±äºé™æ€æˆå‘˜ä¸ä¸“å±äºä»»ä½•ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œæ˜¯ç±»æˆå‘˜ï¼Œå› æ­¤é€šè¿‡classå¯¹è±¡é”å¯ä»¥æ§åˆ¶é™æ€ æˆå‘˜çš„å¹¶å‘æ“ä½œã€‚éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœä¸€ä¸ªçº¿ç¨‹Aè°ƒç”¨ä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„éstatic synchronizedæ–¹æ³•ï¼Œè€Œçº¿ç¨‹Béœ€è¦è°ƒç”¨è¿™ä¸ªå®ä¾‹å¯¹è±¡æ‰€å±ç±»çš„é™æ€ synchronizedæ–¹æ³•ï¼Œæ˜¯å…è®¸çš„ï¼Œä¸ä¼šå‘ç”Ÿäº’æ–¥ç°è±¡ï¼Œå› ä¸ºè®¿é—®é™æ€ synchronized æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰ç±»çš„classå¯¹è±¡ï¼Œè€Œè®¿é—®éé™æ€ synchronized æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡é”</p>
<h4 id="Volatile"><a href="#Volatile" class="headerlink" title="Volatile"></a>Volatile</h4><ul>
<li>å†…å­˜å¯è§æ€§</li>
<li>ç•™æ„å¤åˆç±»æ“ä½œï¼šnum++æ“ä½œçš„åŸå­æ€§é—®é¢˜</li>
<li>ç¦æ­¢æŒ‡ä»¤é‡æ’åº</li>
</ul>
<h5 id="å†…å­˜å¯è§æ€§"><a href="#å†…å­˜å¯è§æ€§" class="headerlink" title="å†…å­˜å¯è§æ€§"></a>å†…å­˜å¯è§æ€§</h5><p>ã€€ã€€volatileæ˜¯Javaæä¾›çš„ä¸€ç§è½»é‡çº§çš„åŒæ­¥æœºåˆ¶ï¼Œåœ¨å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œå®ƒä¹Ÿæ‰®æ¼”ç€æ¯”è¾ƒé‡è¦çš„è§’è‰²ã€‚åŒsynchronizedç›¸æ¯”ï¼ˆsynchronizedé€šå¸¸ç§°ä¸ºé‡é‡çº§é”ï¼‰ï¼Œvolatileæ›´è½»é‡çº§ï¼Œç›¸æ¯”ä½¿ç”¨synchronizedæ‰€å¸¦æ¥çš„åºå¤§å¼€é”€ï¼Œå€˜è‹¥èƒ½æ°å½“çš„åˆç†çš„ä½¿ç”¨volatileï¼Œè‡ªç„¶æ˜¯ç¾äº‹ä¸€æ¡©ã€‚</p>
<p><strong>æ‰€è°“å¯è§æ€§ï¼Œæ˜¯æŒ‡å½“ä¸€æ¡çº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡çš„å€¼ï¼Œæ–°å€¼å¯¹äºå…¶ä»–çº¿ç¨‹æ¥è¯´æ˜¯å¯ä»¥ç«‹å³å¾—çŸ¥çš„ã€‚</strong></p>
<h5 id="ç¦æ­¢æŒ‡ä»¤é‡æ’åº"><a href="#ç¦æ­¢æŒ‡ä»¤é‡æ’åº" class="headerlink" title="ç¦æ­¢æŒ‡ä»¤é‡æ’åº"></a>ç¦æ­¢æŒ‡ä»¤é‡æ’åº</h5><p>volatileè¿˜æœ‰ä¸€ä¸ªç‰¹æ€§ï¼šç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ã€‚</p>
<p>é‡æ’åºæ˜¯æŒ‡ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ºäº†ä¼˜åŒ–ç¨‹åºæ€§èƒ½è€Œå¯¹æŒ‡ä»¤åºåˆ—è¿›è¡Œæ’åºçš„ä¸€ç§æ‰‹æ®µã€‚ä½†æ˜¯é‡æ’åºä¹Ÿéœ€è¦éµå®ˆä¸€å®šè§„åˆ™ï¼š</p>
<ol>
<li>é‡æ’åºæ“ä½œä¸ä¼šå¯¹å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»çš„æ“ä½œè¿›è¡Œé‡æ’åºã€‚</li>
</ol>
<p>ã€€ã€€ã€€ã€€æ¯”å¦‚ï¼ša&#x3D;1;b&#x3D;a; è¿™ä¸ªæŒ‡ä»¤åºåˆ—ï¼Œç”±äºç¬¬äºŒä¸ªæ“ä½œä¾èµ–äºç¬¬ä¸€ä¸ªæ“ä½œï¼Œæ‰€ä»¥åœ¨ç¼–è¯‘æ—¶å’Œå¤„ç†å™¨è¿è¡Œæ—¶è¿™ä¸¤ä¸ªæ“ä½œä¸ä¼šè¢«é‡æ’åºã€‚</p>
<ol>
<li>é‡æ’åºæ˜¯ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œä½†æ˜¯ä¸ç®¡æ€ä¹ˆé‡æ’åºï¼Œå•çº¿ç¨‹ä¸‹ç¨‹åºçš„æ‰§è¡Œç»“æœä¸èƒ½è¢«æ”¹å˜</li>
</ol>
<p>ã€€ã€€ã€€ã€€æ¯”å¦‚ï¼ša&#x3D;1;b&#x3D;2;c&#x3D;a+bè¿™ä¸‰ä¸ªæ“ä½œï¼Œç¬¬ä¸€æ­¥ï¼ˆa&#x3D;1)å’Œç¬¬äºŒæ­¥(b&#x3D;2)ç”±äºä¸å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå‘ç”Ÿé‡æ’åºï¼Œä½†æ˜¯c&#x3D;a+bè¿™ä¸ªæ“ä½œæ˜¯ä¸ä¼šè¢«é‡æ’åºçš„ï¼Œå› ä¸ºéœ€è¦ä¿è¯æœ€ç»ˆçš„ç»“æœä¸€å®šæ˜¯c&#x3D;a+b&#x3D;3ã€‚</p>
<p>ã€€ã€€é‡æ’åºåœ¨å•çº¿ç¨‹æ¨¡å¼ä¸‹æ˜¯ä¸€å®šä¼šä¿è¯æœ€ç»ˆç»“æœçš„æ­£ç¡®æ€§ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œé—®é¢˜å°±å‡ºæ¥äº†</p>
<p><strong>ç®€å•æ€»ç»“ä¸‹ï¼Œvolatileæ˜¯ä¸€ç§è½»é‡çº§çš„åŒæ­¥æœºåˆ¶ï¼Œå®ƒä¸»è¦æœ‰ä¸¤ä¸ªç‰¹æ€§ï¼šä¸€æ˜¯ä¿è¯å…±äº«å˜é‡å¯¹æ‰€æœ‰çº¿ç¨‹çš„å¯è§æ€§ï¼›äºŒæ˜¯ç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ã€‚åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œvolatileå¯¹äºå•ä¸ªçš„å…±äº«å˜é‡çš„è¯»&#x2F;å†™å…·æœ‰åŸå­æ€§ï¼Œä½†æ˜¯åƒnum++è¿™ç§å¤åˆæ“ä½œï¼Œvolatileæ— æ³•ä¿è¯å…¶åŸå­æ€§</strong></p>
<h5 id="Javaå†…å­˜æ¨¡å‹"><a href="#Javaå†…å­˜æ¨¡å‹" class="headerlink" title="Javaå†…å­˜æ¨¡å‹"></a>Javaå†…å­˜æ¨¡å‹</h5><p>ã€€ã€€ä¸ºä»€ä¹ˆå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä¸€ä¸‹JMMï¼ˆjavaå†…å­˜æ¨¡å‹ï¼‰</p>
<p>ã€€ã€€javaè™šæ‹Ÿæœºæœ‰è‡ªå·±çš„å†…å­˜æ¨¡å‹ï¼ˆJava Memory Modelï¼ŒJMMï¼‰ï¼ŒJMMå¯ä»¥å±è”½æ‰å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œä»¥å®ç°è®©javaç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å†…å­˜è®¿é—®æ•ˆæœã€‚</p>
<blockquote>
<p>å¤§å®¶éƒ½çŸ¥é“ï¼Œè®¡ç®—æœºåœ¨æ‰§è¡Œç¨‹åºæ—¶ï¼Œæ¯æ¡æŒ‡ä»¤éƒ½æ˜¯åœ¨ <code>CPU</code> ä¸­æ‰§è¡Œçš„ï¼Œè€Œæ‰§è¡ŒæŒ‡ä»¤è¿‡ç¨‹ä¸­ï¼ŒåŠ¿å¿…æ¶‰åŠåˆ°æ•°æ®çš„è¯»å–å’Œå†™å…¥ã€‚ç”±äºç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ•°æ®æ˜¯å­˜æ”¾åœ¨<code>ä¸»å­˜ï¼ˆç‰©ç†å†…å­˜ï¼‰</code>å½“ä¸­çš„ï¼Œè¿™æ—¶å°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºCPUæ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ï¼Œè€Œä»å†…å­˜è¯»å–æ•°æ®å’Œå‘å†…å­˜å†™å…¥æ•°æ®çš„è¿‡ç¨‹è·Ÿ CPU æ‰§è¡ŒæŒ‡ä»¤çš„é€Ÿåº¦æ¯”èµ·æ¥è¦æ…¢çš„å¤šï¼Œå› æ­¤å¦‚æœä»»ä½•æ—¶å€™å¯¹æ•°æ®çš„æ“ä½œéƒ½è¦é€šè¿‡å’Œå†…å­˜çš„äº¤äº’æ¥è¿›è¡Œï¼Œä¼šå¤§å¤§é™ä½æŒ‡ä»¤æ‰§è¡Œçš„é€Ÿåº¦ã€‚å› æ­¤åœ¨ CPU é‡Œé¢å°±æœ‰äº†é«˜é€Ÿç¼“å­˜ã€‚ä¹Ÿå°±æ˜¯ï¼Œ<strong>å½“ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šå°†è¿ç®—éœ€è¦çš„æ•°æ®ä»ä¸»å­˜å¤åˆ¶ä¸€ä»½åˆ° CPU çš„é«˜é€Ÿç¼“å­˜å½“ä¸­</strong>ï¼Œé‚£ä¹ˆCPUè¿›è¡Œè®¡ç®—æ—¶å°±å¯ä»¥ç›´æ¥ä»å®ƒçš„é«˜é€Ÿç¼“å­˜è¯»å–æ•°æ®å’Œå‘å…¶ä¸­å†™å…¥æ•°æ®ï¼Œå½“è¿ç®—ç»“æŸä¹‹åï¼Œå†å°†é«˜é€Ÿç¼“å­˜ä¸­çš„æ•°æ®åˆ·æ–°åˆ°ä¸»å­˜å½“ä¸­ã€‚</p>
</blockquote>
<p>ã€€ã€€JMMå†³å®šä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™å…¥ä½•æ—¶å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ï¼ŒJMMå®šä¹‰äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„æŠ½è±¡å…³ç³»ï¼šå…±äº«å˜é‡å­˜å‚¨åœ¨ä¸»å†…å­˜(Main Memory)ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°å†…å­˜ï¼ˆLocal Memoryï¼‰ï¼Œæœ¬åœ°å†…å­˜ä¿å­˜äº†è¢«è¯¥çº¿ç¨‹ä½¿ç”¨åˆ°çš„ä¸»å†…å­˜çš„å‰¯æœ¬æ‹·è´ï¼Œçº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œè€Œä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜ä¸­çš„å˜é‡ã€‚è¿™ä¸‰è€…ä¹‹é—´çš„äº¤äº’å…³ç³»å¦‚ä¸‹</p>
<p><img src="https://gitee.com/fly_tom/use/raw/master/jc31.png"></p>
<p>ã€€éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒJMMæ˜¯ä¸ªæŠ½è±¡çš„å†…å­˜æ¨¡å‹ï¼Œæ‰€ä»¥æ‰€è°“çš„æœ¬åœ°å†…å­˜ï¼Œä¸»å†…å­˜éƒ½æ˜¯æŠ½è±¡æ¦‚å¿µï¼Œå¹¶ä¸ä¸€å®šå°±çœŸå®çš„å¯¹åº”cpuç¼“å­˜å’Œç‰©ç†å†…å­˜ã€‚å½“ç„¶å¦‚æœæ˜¯å‡ºäºç†è§£çš„ç›®çš„ï¼Œè¿™æ ·å¯¹åº”èµ·æ¥ä¹Ÿæ— ä¸å¯ã€‚</p>
<p>&amp;ensp;&amp;ensp;é‚£ä¹ˆè¿™ç§å…±äº«å˜é‡åœ¨å¤šçº¿ç¨‹æ¨¡å‹ä¸­çš„ä¸å¯è§æ€§å¦‚ä½•è§£å†³å‘¢ï¼Ÿæ¯”è¾ƒç²—æš´çš„æ–¹å¼è‡ªç„¶å°±æ˜¯åŠ é”ï¼Œä½†æ˜¯æ­¤å¤„ä½¿ç”¨synchronizedæˆ–è€…Lockè¿™äº›æ–¹å¼å¤ªé‡é‡çº§äº†ï¼Œæœ‰ç‚¹ç‚®æ‰“èšŠå­çš„æ„æ€ã€‚æ¯”è¾ƒåˆç†çš„æ–¹å¼å…¶å®å°±æ˜¯volatile</p>
<h4 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h4><p><a href="https://www.cnblogs.com/xzwblog/p/7227509.html">https://www.cnblogs.com/xzwblog/p/7227509.html</a></p>
<p><a href="https://www.jianshu.com/p/98b68c97df9b">https://www.jianshu.com/p/98b68c97df9b</a></p>
<p>å˜é‡å€¼çš„å…±äº«å¯ä»¥ä½¿ç”¨public staticçš„å½¢å¼ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½ä½¿ç”¨åŒä¸€ä¸ªå˜é‡ï¼Œå¦‚æœæƒ³å®ç°æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å…±äº«å˜é‡è¯¥å¦‚ä½•å®ç°å‘¢ï¼ŸJDKä¸­çš„ThreadLocalç±»æ­£æ˜¯ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚</p>
<p>ThreadLocalåº•å±‚ç›¸å½“äºä¸€ä¸ªmapæ•°ç»„ï¼Œkeyç”¨æ¥å­˜å‚¨å½“å‰çº¿ç¨‹ï¼Œvalueç”¨æ¥å­˜å‚¨å½“å‰çº¿ç¨‹ä¸‹å…±äº«çš„æ•°æ®ã€‚å®ƒé‡Œé¢æœ‰ä¸€äº›æ–¹æ³•éœ€è¦è¯´æ˜ä¸€ä¸‹ã€‚</p>
<ul>
<li>get()æ–¹æ³•ç”¨äºè·å–å½“å‰çº¿ç¨‹çš„å‰¯æœ¬å˜é‡å€¼ã€‚</li>
<li>set()æ–¹æ³•ç”¨äºä¿å­˜å½“å‰çº¿ç¨‹çš„å‰¯æœ¬å˜é‡å€¼ã€‚</li>
<li>initialValue()ä¸ºå½“å‰çº¿ç¨‹åˆå§‹å‰¯æœ¬å˜é‡å€¼ã€‚</li>
<li>remove()æ–¹æ³•ç§»é™¤å½“å‰å‰ç¨‹çš„å‰¯æœ¬å˜é‡å€¼ã€‚</li>
</ul>
<h5 id="ThreadLocalä»‹ç»-amp-è·³å‡ºè¯¯åŒº"><a href="#ThreadLocalä»‹ç»-amp-è·³å‡ºè¯¯åŒº" class="headerlink" title="ThreadLocalä»‹ç»&amp;è·³å‡ºè¯¯åŒº"></a>ThreadLocalä»‹ç»&amp;è·³å‡ºè¯¯åŒº</h5><p>ã€€ã€€ThreadLocalä¸€èˆ¬ç§°ä¸ºçº¿ç¨‹æœ¬åœ°å˜é‡ï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹ç»‘å®šæœºåˆ¶ï¼Œå°†å˜é‡ä¸çº¿ç¨‹ç»‘å®šåœ¨ä¸€èµ·ï¼Œä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ã€‚é€šè¿‡ThreadLocalå¯ä»¥å°†å¯¹è±¡çš„å¯è§èŒƒå›´é™åˆ¶åœ¨åŒä¸€ä¸ªçº¿ç¨‹å†…ã€‚</p>
<p><strong>è·³å‡ºè¯¯åŒº</strong></p>
<blockquote>
<p>éœ€è¦é‡ç‚¹å¼ºè°ƒçš„çš„æ˜¯ï¼Œä¸è¦æ‹¿ThreadLocalå’Œsynchronizedåšç±»æ¯”ï¼Œå› ä¸ºè¿™ç§æ¯”è¾ƒå‹æ ¹å°±æ˜¯æ— æ„ä¹‰çš„ï¼sysnchronizedæ˜¯ä¸€ç§äº’æ–¥åŒæ­¥æœºåˆ¶ï¼Œæ˜¯ä¸ºäº†ä¿è¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯¹äºå…±äº«èµ„æºçš„æ­£ç¡®è®¿é—®ã€‚è€ŒThreadLocalä»æœ¬è´¨ä¸Šè®²ï¼Œæ— éæ˜¯æä¾›äº†ä¸€ä¸ªâ€œçº¿ç¨‹çº§â€çš„å˜é‡ä½œç”¨åŸŸï¼Œå®ƒæ˜¯ä¸€ç§çº¿ç¨‹å°é—­ï¼ˆæ¯ä¸ªçº¿ç¨‹ç‹¬äº«å˜é‡ï¼‰æŠ€æœ¯ï¼Œæ›´ç›´ç™½ç‚¹è®²ï¼ŒThreadLocalå¯ä»¥ç†è§£ä¸ºå°†å¯¹è±¡çš„ä½œç”¨èŒƒå›´é™åˆ¶åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­ï¼Œä½¿å¾—å˜é‡çš„ä½œç”¨åŸŸä¸ºâ€œçº¿ç¨‹çº§â€ã€‚</p>
</blockquote>
<blockquote>
<p>æ²¡æœ‰ThreadLocalçš„æ—¶å€™ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨å…¶å£°æ˜å‘¨æœŸå†…ï¼Œå¯èƒ½ç©¿è¿‡å¤šä¸ªå±‚çº§ï¼Œå¤šä¸ªæ–¹æ³•ï¼Œå¦‚æœæœ‰ä¸ªå¯¹è±¡éœ€è¦åœ¨æ­¤çº¿ç¨‹å‘¨æœŸå†…å¤šæ¬¡è°ƒç”¨ï¼Œä¸”æ˜¯è·¨å±‚çº§çš„ï¼ˆçº¿ç¨‹å†…å…±äº«ï¼‰ï¼Œé€šå¸¸çš„åšæ³•æ˜¯é€šè¿‡å‚æ•°è¿›è¡Œä¼ é€’ï¼›è€ŒThreadLocalå°†å˜é‡ç»‘å®šåœ¨çº¿ç¨‹ä¸Šï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹å‘¨æœŸå†…ï¼Œæ— è®ºâ€œä½ èº«å¤„ä½•åœ°â€ï¼Œåªéœ€é€šè¿‡å…¶æä¾›çš„getæ–¹æ³•å°±å¯è½»æ¾è·å–åˆ°å¯¹è±¡ã€‚æå¤§åœ°æé«˜äº†å¯¹äºâ€œçº¿ç¨‹çº§å˜é‡â€çš„è®¿é—®ä¾¿åˆ©æ€§ã€‚</p>
</blockquote>
<h5 id="è§£å†³ç¬¬ä¸€ä¸ªget-è¿”å›null"><a href="#è§£å†³ç¬¬ä¸€ä¸ªget-è¿”å›null" class="headerlink" title="è§£å†³ç¬¬ä¸€ä¸ªget()è¿”å›null"></a>è§£å†³ç¬¬ä¸€ä¸ªget()è¿”å›null</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalTest</span> &#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;Integer&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">		</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="built_in">super</span>.run();</span><br><span class="line">			<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">				threadLocal.set(i);</span><br><span class="line">				System.out.println(getName() + <span class="string">&quot; threadLocal.get() = &quot;</span> + threadLocal.get());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="type">MyThread</span> <span class="variable">myThreadA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread</span>();</span><br><span class="line">		myThreadA.setName(<span class="string">&quot;ThreadA&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="type">MyThread</span> <span class="variable">myThreadB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread</span>();</span><br><span class="line">		myThreadB.setName(<span class="string">&quot;ThreadB&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		myThreadA.start();</span><br><span class="line">		myThreadB.start();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ThreadA threadLocal.get() = 0</span><br><span class="line">ThreadB threadLocal.get() = 0</span><br><span class="line">ThreadA threadLocal.get() = 1</span><br><span class="line">ThreadB threadLocal.get() = 1</span><br><span class="line">ThreadA threadLocal.get() = 2</span><br><span class="line">ThreadB threadLocal.get() = 2</span><br></pre></td></tr></table></figure>

<h5 id="ThreadLocalå†…å­˜æ³„éœ²"><a href="#ThreadLocalå†…å­˜æ³„éœ²" class="headerlink" title="ThreadLocalå†…å­˜æ³„éœ²"></a>ThreadLocalå†…å­˜æ³„éœ²</h5><p><strong>å†…å­˜æ³„æ¼memory leakï¼š</strong> æ˜¯æŒ‡ç¨‹åºåœ¨ç”³è¯·å†…å­˜åï¼Œæ— æ³•é‡Šæ”¾å·²ç”³è¯·çš„å†…å­˜ç©ºé—´ï¼Œä¸€æ¬¡å†…å­˜æ³„æ¼ä¼¼ä¹ä¸ä¼šæœ‰å¤§çš„å½±å“ï¼Œä½†å†…å­˜æ³„æ¼å †ç§¯åçš„åæœå°±æ˜¯å†…å­˜æº¢å‡ºã€‚</p>
<p><strong>å†…å­˜æº¢å‡º out of memoryï¼š</strong> æ²¡å†…å­˜å¯ä»¥åˆ†é…ç»™æ–°çš„å¯¹è±¡äº†ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œçº¿ç¨‹<code>Threadå¯¹è±¡</code>ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹è±¡å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªçš„<code>ThreadLocalMap</code>å¯¹è±¡ã€‚å¦‚æœè¿™ä¸ªå¯¹è±¡å­˜å‚¨äº†å¤šä¸ªå¤§å¯¹è±¡ï¼Œåˆ™å¯èƒ½æ—©å‡º<code>å†…å­˜æº¢å‡ºOOM</code>ã€‚ä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œåœ¨ThreadLocalçš„æºç ä¸­ï¼Œæœ‰å¯¹åº”çš„ç­–ç•¥ï¼Œå³è°ƒç”¨ getï¼ˆï¼‰ã€setï¼ˆï¼‰ã€removeï¼ˆï¼‰ æ–¹æ³•ï¼Œå‡ä¼šæ¸…é™¤ ThreadLocalå†…éƒ¨çš„ å†…å­˜ã€‚</p>
<p><strong>ThreadLocalçš„å†…éƒ¨æ˜¯ThreadLocalMap</strong>ã€‚<strong>ThreadLocalMapå†…éƒ¨æ˜¯ç”±ä¸€ä¸ªEntryæ•°ç»„ç»„æˆ</strong>ã€‚Entryç±»çš„æ„é€ å‡½æ•°ä¸º Entryï¼ˆå¼±å¼•ç”¨çš„ThreadLocalå¯¹è±¡ï¼Œ Object valueå¯¹è±¡ï¼‰ã€‚<strong>å› ä¸ºEntryçš„keyæ˜¯ä¸€ä¸ªå¼±å¼•ç”¨çš„ThreadLocalå¯¹è±¡</strong>ï¼Œ<strong>æ‰€ä»¥åœ¨ åƒåœ¾å›æ”¶ ä¹‹å‰ï¼Œå°†ä¼šæ¸…é™¤æ­¤Entryå¯¹è±¡çš„key</strong>ã€‚é‚£ä¹ˆï¼Œ ThreadLocalMap ä¸­å°±ä¼šå‡ºç° key ä¸º null çš„ Entryï¼Œå°±æ²¡æœ‰åŠæ³•è®¿é—®è¿™äº› key ä¸º null çš„ Entry çš„ valueã€‚è¿™äº› value è¢«Entryå¯¹è±¡å¼•ç”¨ï¼Œæ‰€ä»¥valueæ‰€å å†…å­˜ä¸ä¼šè¢«é‡Šæ”¾ã€‚<strong>è‹¥åœ¨æŒ‡å®šçš„çº¿ç¨‹ä»»åŠ¡é‡Œé¢ï¼Œè°ƒç”¨ThreadLocalå¯¹è±¡çš„getï¼ˆï¼‰ã€setï¼ˆï¼‰ã€removeï¼ˆï¼‰æ–¹æ³•ï¼Œå¯ä»¥é¿å…å‡ºç°å†…å­˜æ³„éœ²ã€‚</strong></p>
<h3 id="juc"><a href="#juc" class="headerlink" title="juc"></a>juc</h3><p><img src="https://gitee.com/fly_tom/use/raw/master/thread2.png"></p>
<h4 id="Java-JUCç®€ä»‹"><a href="#Java-JUCç®€ä»‹" class="headerlink" title="Java JUCç®€ä»‹"></a>Java JUCç®€ä»‹</h4><blockquote>
<p>åœ¨ Java 5.0 æä¾›äº† java.util.concurrent ï¼ˆç®€ç§°JUC ï¼‰åŒ…ï¼Œåœ¨æ­¤åŒ…ä¸­å¢åŠ äº†åœ¨å¹¶å‘ç¼–ç¨‹ä¸­å¾ˆå¸¸ç”¨çš„å®ç”¨å·¥å…·ç±»ï¼Œç”¨äºå®šä¹‰ç±»ä¼¼äºçº¿ç¨‹çš„è‡ªå®šä¹‰å­ç³»ç»Ÿï¼ŒåŒ…æ‹¬çº¿ç¨‹æ± ã€å¼‚æ­¥ IO å’Œè½»é‡çº§ä»»åŠ¡æ¡†æ¶ã€‚æä¾›å¯è°ƒçš„ã€çµæ´»çš„çº¿ç¨‹æ± ã€‚è¿˜æä¾›äº†è®¾è®¡ç”¨äºå¤šçº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­çš„ Collection å®ç°ç­‰ã€‚</p>
</blockquote>
<h4 id="Locké”"><a href="#Locké”" class="headerlink" title="Locké”"></a>Locké”</h4><p><a href="https://www.cnblogs.com/lucky_dai/p/5498295.html">https://www.cnblogs.com/lucky_dai/p/5498295.html</a></p>
<p>ä»Java 5ä¹‹åï¼Œåœ¨java.util.concurrent.locksåŒ…ä¸‹æä¾›äº†å¦å¤–ä¸€ç§æ–¹å¼æ¥å®ç°åŒæ­¥è®¿é—®ï¼Œé‚£å°±æ˜¯Lockã€‚</p>
<p>æ—¢ç„¶éƒ½å¯ä»¥é€šè¿‡synchronizedæ¥å®ç°åŒæ­¥è®¿é—®äº†ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜éœ€è¦æä¾›Lockï¼Ÿè¿™ä¸ªé—®é¢˜å°†åœ¨ä¸‹é¢è¿›è¡Œé˜è¿°ã€‚</p>
<h5 id="synchronizedçš„ç¼ºé™·"><a href="#synchronizedçš„ç¼ºé™·" class="headerlink" title="synchronizedçš„ç¼ºé™·"></a>synchronizedçš„ç¼ºé™·</h5><p>synchronizedæ˜¯javaä¸­çš„ä¸€ä¸ªå…³é”®å­—ï¼Œä¹Ÿå°±æ˜¯è¯´æ˜¯Javaè¯­è¨€å†…ç½®çš„ç‰¹æ€§ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šå‡ºç°Lockå‘¢ï¼Ÿ</p>
<p>å¦‚æœä¸€ä¸ªä»£ç å—è¢«synchronizedä¿®é¥°äº†ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å–äº†å¯¹åº”çš„é”ï¼Œå¹¶æ‰§è¡Œè¯¥ä»£ç å—æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¾¿åªèƒ½ä¸€ç›´ç­‰å¾…ï¼Œç­‰å¾…è·å–é”çš„çº¿ç¨‹é‡Šæ”¾é”ï¼Œè€Œè¿™é‡Œè·å–é”çš„çº¿ç¨‹é‡Šæ”¾é”åªä¼šæœ‰ä¸¤ç§æƒ…å†µï¼š</p>
<p>1ï¼‰è·å–é”çš„çº¿ç¨‹æ‰§è¡Œå®Œäº†è¯¥ä»£ç å—ï¼Œç„¶åçº¿ç¨‹é‡Šæ”¾å¯¹é”çš„å æœ‰ï¼›</p>
<p>2ï¼‰çº¿ç¨‹æ‰§è¡Œå‘ç”Ÿå¼‚å¸¸ï¼Œæ­¤æ—¶JVMä¼šè®©çº¿ç¨‹è‡ªåŠ¨é‡Šæ”¾é”ã€‚</p>
<p>é‚£ä¹ˆå¦‚æœè¿™ä¸ªè·å–é”çš„çº¿ç¨‹ç”±äºè¦ç­‰å¾…IOæˆ–è€…å…¶ä»–åŸå› ï¼ˆæ¯”å¦‚è°ƒç”¨sleepæ–¹æ³•ï¼‰è¢«é˜»å¡äº†ï¼Œä½†æ˜¯åˆæ²¡æœ‰é‡Šæ”¾é”ï¼Œå…¶ä»–çº¿ç¨‹ä¾¿åªèƒ½å¹²å·´å·´åœ°ç­‰å¾…ï¼Œè¯•æƒ³ä¸€ä¸‹ï¼Œè¿™å¤šä¹ˆå½±å“ç¨‹åºæ‰§è¡Œæ•ˆç‡ã€‚</p>
<p>å› æ­¤å°±éœ€è¦æœ‰ä¸€ç§æœºåˆ¶å¯ä»¥ä¸è®©ç­‰å¾…çš„çº¿ç¨‹ä¸€ç›´æ— æœŸé™åœ°ç­‰å¾…ä¸‹å»ï¼ˆæ¯”å¦‚åªç­‰å¾…ä¸€å®šçš„æ—¶é—´æˆ–è€…èƒ½å¤Ÿå“åº”ä¸­æ–­ï¼‰ï¼Œé€šè¿‡Lockå°±å¯ä»¥åŠåˆ°ã€‚</p>
<p>å†ä¸¾ä¸ªä¾‹å­ï¼šå½“æœ‰å¤šä¸ªçº¿ç¨‹è¯»å†™æ–‡ä»¶æ—¶ï¼Œè¯»æ“ä½œå’Œå†™æ“ä½œä¼šå‘ç”Ÿå†²çªç°è±¡ï¼Œå†™æ“ä½œå’Œå†™æ“ä½œä¼šå‘ç”Ÿå†²çªç°è±¡ï¼Œä½†æ˜¯è¯»æ“ä½œå’Œè¯»æ“ä½œä¸ä¼šå‘ç”Ÿå†²çªç°è±¡ã€‚</p>
<p>ä½†æ˜¯é‡‡ç”¨synchronizedå…³é”®å­—æ¥å®ç°åŒæ­¥çš„è¯ï¼Œå°±ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼š</p>
<p>å¦‚æœå¤šä¸ªçº¿ç¨‹éƒ½åªæ˜¯è¿›è¡Œè¯»æ“ä½œï¼Œæ‰€ä»¥å½“ä¸€ä¸ªçº¿ç¨‹åœ¨è¿›è¡Œè¯»æ“ä½œæ—¶ï¼Œå…¶ä»–çº¿ç¨‹åªèƒ½ç­‰å¾…æ— æ³•è¿›è¡Œè¯»æ“ä½œã€‚</p>
<p>å› æ­¤å°±éœ€è¦ä¸€ç§æœºåˆ¶æ¥ä½¿å¾—å¤šä¸ªçº¿ç¨‹éƒ½åªæ˜¯è¿›è¡Œè¯»æ“ä½œæ—¶ï¼Œçº¿ç¨‹ä¹‹é—´ä¸ä¼šå‘ç”Ÿå†²çªï¼Œé€šè¿‡Lockå°±å¯ä»¥åŠåˆ°ã€‚</p>
<p>å¦å¤–ï¼Œé€šè¿‡Lockå¯ä»¥çŸ¥é“çº¿ç¨‹æœ‰æ²¡æœ‰æˆåŠŸè·å–åˆ°é”ã€‚è¿™ä¸ªæ˜¯synchronizedæ— æ³•åŠåˆ°çš„ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼Œä¹Ÿå°±æ˜¯è¯´Lockæä¾›äº†æ¯”synchronizedæ›´å¤šçš„åŠŸèƒ½ã€‚ä½†æ˜¯è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<p>1ï¼‰Lockä¸æ˜¯Javaè¯­è¨€å†…ç½®çš„ï¼Œsynchronizedæ˜¯Javaè¯­è¨€çš„å…³é”®å­—ï¼Œå› æ­¤æ˜¯å†…ç½®ç‰¹æ€§ã€‚Lockæ˜¯ä¸€ä¸ªç±»ï¼Œé€šè¿‡è¿™ä¸ªç±»å¯ä»¥å®ç°åŒæ­¥è®¿é—®ï¼›</p>
<p>2ï¼‰Lockå’Œsynchronizedæœ‰ä¸€ç‚¹éå¸¸å¤§çš„ä¸åŒï¼Œé‡‡ç”¨synchronizedä¸éœ€è¦ç”¨æˆ·å»æ‰‹åŠ¨é‡Šæ”¾é”ï¼Œå½“synchronizedæ–¹æ³•æˆ–è€…synchronizedä»£ç å—æ‰§è¡Œå®Œä¹‹åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®©çº¿ç¨‹é‡Šæ”¾å¯¹é”çš„å ç”¨ï¼›è€ŒLockåˆ™å¿…é¡»è¦ç”¨æˆ·å»<strong>æ‰‹åŠ¨é‡Šæ”¾é”</strong>ï¼Œå¦‚æœæ²¡æœ‰ä¸»åŠ¨é‡Šæ”¾é”ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´å‡ºç°æ­»é”ç°è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">é€šè¿‡æŸ¥çœ‹Lockçš„æºç å¯çŸ¥ï¼ŒLockæ˜¯ä¸€ä¸ªæ¥å£, ä½äºï¼š<span class="keyword">package</span> java.util.concurrent.locks;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–é”ï¼Œè·å–ä¸åˆ°lockå°±ä¸ç½¢ä¼‘,ä¸å¯è¢«æ‰“æ–­,å³ä½¿å½“å‰çº¿ç¨‹è¢«ä¸­æ–­,çº¿ç¨‹ä¹Ÿä¸€ç›´é˜»å¡,ç›´åˆ°æ‹¿åˆ°é”, æ¯”è¾ƒæ— èµ–çš„åšæ³•</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*è·å–é”ï¼Œå¯ä¸­æ–­ï¼Œå¦‚æœè·å–é”ä¹‹å‰å½“å‰çº¿ç¨‹è¢«interruptäº†ï¼Œ</span></span><br><span class="line"><span class="comment">*è·å–é”ä¹‹åä¼šæŠ›å‡ºInterruptedExceptionï¼Œå¹¶ä¸”åœæ­¢å½“å‰çº¿ç¨‹ï¼›</span></span><br><span class="line"><span class="comment">*ä¼˜å…ˆå“åº”ä¸­æ–­</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç«‹å³è¿”å›ç»“æœï¼›å°è¯•è·å¾—é”,å¦‚æœè·å¾—é”ç«‹å³è¿”å›ture,å¤±è´¥ç«‹å³è¿”å›false</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°è¯•æ‹¿é”ï¼Œå¯è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶è¿”å›falseï¼Œå³è¿‡æ—¶ä¸å€™</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿”å›å½“å‰çº¿ç¨‹çš„Condition ï¼Œå¯å¤šæ¬¡è°ƒç”¨</span></span><br><span class="line">Condition <span class="title function_">newCondition</span><span class="params">()</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>é‡‡ç”¨Lockï¼Œå¿…é¡»ä¸»åŠ¨å»é‡Šæ”¾é”ï¼Œå¹¶ä¸”åœ¨å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä¸ä¼šè‡ªåŠ¨é‡Šæ”¾é”ã€‚å› æ­¤ä¸€èˆ¬æ¥è¯´ï¼Œ<strong>ä½¿ç”¨Lockå¿…é¡»åœ¨try{}catch{}å—</strong>ä¸­è¿›è¡Œï¼Œå¹¶ä¸”å°†<strong>é‡Šæ”¾é”</strong>çš„æ“ä½œæ”¾åœ¨<strong>finally</strong>å—ä¸­è¿›è¡Œï¼Œä»¥ä¿è¯é”ä¸€å®šè¢«è¢«é‡Šæ”¾ï¼Œé˜²æ­¢æ­»é”çš„å‘ç”Ÿã€‚é€šå¸¸ä½¿ç”¨Lockæ¥è¿›è¡ŒåŒæ­¥çš„è¯ï¼Œæ˜¯ä»¥ä¸‹é¢è¿™ç§å½¢å¼å»ä½¿ç”¨çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> ...;</span><br><span class="line">lock.lock();</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="comment">//å¤„ç†ä»»åŠ¡</span></span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line"> </span><br><span class="line">&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">    lock.unlock();   <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Synchronized-å’ŒLockçš„åŒºåˆ«"><a href="#Synchronized-å’ŒLockçš„åŒºåˆ«" class="headerlink" title="Synchronized å’ŒLockçš„åŒºåˆ«"></a>Synchronized å’ŒLockçš„åŒºåˆ«</h5><p><img src="https://gitee.com/fly_tom/use/raw/master/thread.png"></p>
<h5 id="Lockæ¥å£æ–¹æ³•"><a href="#Lockæ¥å£æ–¹æ³•" class="headerlink" title="Lockæ¥å£æ–¹æ³•"></a>Lockæ¥å£æ–¹æ³•</h5><h6 id="lock"><a href="#lock" class="headerlink" title="lock()"></a>lock()</h6><p>å…ˆlock()æ–¹æ³•æ˜¯å¹³å¸¸ä½¿ç”¨å¾—æœ€å¤šçš„ä¸€ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯ç”¨æ¥è·å–é”ã€‚å¦‚æœé”å·²è¢«å…¶ä»–çº¿ç¨‹è·å–ï¼Œåˆ™è¿›è¡Œç­‰å¾…ã€‚</p>
<h6 id="lockInterruptibly"><a href="#lockInterruptibly" class="headerlink" title="lockInterruptibly()"></a>lockInterruptibly()</h6><p>lockInterruptibly()æ–¹æ³•æ¯”è¾ƒç‰¹æ®Šï¼Œå½“é€šè¿‡è¿™ä¸ªæ–¹æ³•å»è·å–é”æ—¶ï¼Œå¦‚æœçº¿ç¨‹æ­£åœ¨ç­‰å¾…è·å–é”ï¼Œåˆ™è¿™ä¸ªçº¿ç¨‹èƒ½å¤Ÿå“åº”ä¸­æ–­ï¼Œå³ä¸­æ–­çº¿ç¨‹çš„ç­‰å¾…çŠ¶æ€ã€‚ä¹Ÿå°±ä½¿è¯´ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶é€šè¿‡lock.lockInterruptibly()æƒ³è·å–æŸä¸ªé”æ—¶ï¼Œå‡è‹¥æ­¤æ—¶çº¿ç¨‹Aè·å–åˆ°äº†é”ï¼Œè€Œçº¿ç¨‹Båªæœ‰åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå¯¹çº¿ç¨‹Bè°ƒç”¨threadB.interrupt()æ–¹æ³•èƒ½å¤Ÿä¸­æ–­çº¿ç¨‹Bçš„ç­‰å¾…è¿‡ç¨‹ã€‚</p>
<p>ç”±äºlockInterruptibly()çš„å£°æ˜ä¸­æŠ›å‡ºäº†å¼‚å¸¸ï¼Œæ‰€ä»¥lock.lockInterruptibly()å¿…é¡»æ”¾åœ¨tryå—ä¸­æˆ–è€…åœ¨è°ƒç”¨lockInterruptibly()çš„æ–¹æ³•å¤–å£°æ˜æŠ›å‡ºInterruptedExceptionã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    lock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">     <span class="comment">//.....</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è·å–äº†é”ä¹‹åï¼Œæ˜¯ä¸ä¼šè¢«interrupt()æ–¹æ³•ä¸­æ–­çš„ã€‚å› ä¸ºæœ¬èº«åœ¨å‰é¢çš„æ–‡ç« ä¸­è®²è¿‡å•ç‹¬è°ƒç”¨interrupt()æ–¹æ³•ä¸èƒ½ä¸­æ–­æ­£åœ¨è¿è¡Œè¿‡ç¨‹ä¸­çš„çº¿ç¨‹ï¼Œåªèƒ½ä¸­æ–­é˜»å¡è¿‡ç¨‹ä¸­çš„çº¿ç¨‹ã€‚</p>
<p>å› æ­¤å½“é€šè¿‡lockInterruptibly()æ–¹æ³•è·å–æŸä¸ªé”æ—¶ï¼Œå¦‚æœä¸èƒ½è·å–åˆ°ï¼Œåªæœ‰è¿›è¡Œç­‰å¾…çš„æƒ…å†µä¸‹ï¼Œæ˜¯å¯ä»¥å“åº”ä¸­æ–­çš„ã€‚</p>
<p>è€Œç”¨synchronizedä¿®é¥°çš„è¯ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å¤„äºç­‰å¾…æŸä¸ªé”çš„çŠ¶æ€ï¼Œæ˜¯æ— æ³•è¢«ä¸­æ–­çš„ï¼Œåªæœ‰ä¸€ç›´ç­‰å¾…ä¸‹å»ã€‚</p>
<h6 id="tryLock"><a href="#tryLock" class="headerlink" title="tryLock()"></a>tryLock()</h6><p>tryLock()æ–¹æ³•æ˜¯æœ‰è¿”å›å€¼çš„ï¼Œå®ƒè¡¨ç¤ºç”¨æ¥å°è¯•è·å–é”ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œåˆ™è¿”å›trueï¼Œå¦‚æœè·å–å¤±è´¥ï¼ˆå³é”å·²è¢«å…¶ä»–çº¿ç¨‹è·å–ï¼‰ï¼Œåˆ™è¿”å›falseï¼Œä¹Ÿå°±è¯´è¿™ä¸ªæ–¹æ³•æ— è®ºå¦‚ä½•éƒ½ä¼šç«‹å³è¿”å›ã€‚åœ¨æ‹¿ä¸åˆ°é”æ—¶ä¸ä¼šä¸€ç›´åœ¨é‚£ç­‰å¾…ã€‚</p>
<p>tryLock(long time, TimeUnit unit)æ–¹æ³•å’ŒtryLock()æ–¹æ³•æ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡åŒºåˆ«åœ¨äºè¿™ä¸ªæ–¹æ³•åœ¨æ‹¿ä¸åˆ°é”æ—¶ä¼šç­‰å¾…ä¸€å®šçš„æ—¶é—´ï¼Œåœ¨æ—¶é—´æœŸé™ä¹‹å†…å¦‚æœè¿˜æ‹¿ä¸åˆ°é”ï¼Œå°±è¿”å›falseã€‚å¦‚æœå¦‚æœä¸€å¼€å§‹æ‹¿åˆ°é”æˆ–è€…åœ¨ç­‰å¾…æœŸé—´å†…æ‹¿åˆ°äº†é”</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> ...;</span><br><span class="line"><span class="keyword">if</span>(lock.tryLock()) &#123;</span><br><span class="line">     <span class="keyword">try</span>&#123;</span><br><span class="line">         <span class="comment">//å¤„ç†ä»»åŠ¡</span></span><br><span class="line">     &#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line"> </span><br><span class="line">     &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">         lock.unlock();   <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">     &#125; </span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//å¦‚æœä¸èƒ½è·å–é”ï¼Œåˆ™ç›´æ¥åšå…¶ä»–äº‹æƒ…</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="unlock"><a href="#unlock" class="headerlink" title="unlock()"></a>unlock()</h6><p>è§£é” ä¸€æ—¦äº§ç”Ÿå¼‚å¸¸ï¼Œæ²¡æœ‰è§£é”å°±ä¼šé€ æˆå½“å‰æ— æ³•è§£é”ï¼Œå…¶ä»–çº¿ç¨‹ä¸€ç›´ç­‰å¾…è·å–é”ï¼Œ<br>æ‰€ä»¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"> <span class="comment">//å¤„ç†ä»»åŠ¡</span></span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">finally</span>&#123;</span><br><span class="line"> lock.unlock();   <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">&#125; <span class="comment">//å¦‚æœä¸èƒ½è·å–é”ï¼Œåˆ™ç›´æ¥åšå…¶ä»–äº‹æƒ…</span></span><br></pre></td></tr></table></figure>

<h6 id="newCondition"><a href="#newCondition" class="headerlink" title="newCondition()"></a>newCondition()</h6><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Condition <span class="title function_">newCondition</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<h5 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h5><p>ReentrantLockä¸­é™¤äº†å®ç°Lockä¸­å®šä¹‰çš„ä¸€äº›æ ‡å‡†å‡½æ•°å¤–ï¼ŒåŒæ—¶æä¾›å…¶ä»–çš„ç”¨äºç®¡ç†é”çš„publicæ–¹æ³•ï¼š</p>
<p><strong>é»˜è®¤æ˜¯éå…¬å¹³é”çš„</strong></p>
<p><strong>ReentrantLocké”æ˜¯å®Œå…¨æ’ä»–é”,åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œlock.lock()å’Œlock.unlock()ä¹‹é—´çš„ä»£ç .</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä¼ å…¥booleanå€¼,trueæ—¶createä¸€ä¸ªå…¬å¹³é”ï¼Œfalseä¸ºéå…¬å¹³é”</span></span><br><span class="line">ReentrantLock(<span class="type">boolean</span> fair) </span><br><span class="line"></span><br><span class="line"><span class="comment">//æŸ¥çœ‹æœ‰å¤šå°‘çº¿ç¨‹ç­‰å¾…é”</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">getQueueLength</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ˜¯å¦æœ‰çº¿ç¨‹ç­‰å¾…æŠ¢é”</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">hasQueuedThreads</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ˜¯å¦æœ‰æŒ‡å®šçº¿ç¨‹ç­‰å¾…æŠ¢é”</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">hasQueuedThread</span><span class="params">(Thread thread)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å½“å‰çº¿ç¨‹æ˜¯å¦æŠ¢åˆ°é”ã€‚è¿”å›0ä»£è¡¨æ²¡æœ‰</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">getHoldCount</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æŸ¥è¯¢æ­¤é”æ˜¯å¦ç”±ä»»ä½•çº¿ç¨‹æŒæœ‰</span></span><br><span class="line"> <span class="type">boolean</span> <span class="title function_">isLocked</span><span class="params">()</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">//æ˜¯å¦ä¸ºå…¬å¹³é”</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isFair</span><span class="params">()</span> </span><br></pre></td></tr></table></figure>

<h6 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h6><p>ReentrantLockä¸­å¦ä¸€ä¸ªé‡è¦çš„åº”ç”¨å°±æ˜¯Conditionï¼ŒConditionæ˜¯Lockä¸Šçš„ä¸€ä¸ªæ¡ä»¶ï¼Œå¯ä»¥å¤šæ¬¡newCondition()è·å¾—å¤šä¸ªæ¡ä»¶ï¼ŒConditionå¯ç”¨äºçº¿ç¨‹é—´é€šä¿¡ï¼Œé€šè¿‡Conditionèƒ½å¤Ÿæ›´åŠ ç²¾ç»†çš„æ§åˆ¶å¤šçº¿ç¨‹çš„ä¼‘çœ ä¸å”¤é†’ï¼Œè€Œä¸”åœ¨ç²’åº¦å’Œæ€§èƒ½ä¸Šéƒ½ä¼˜äºObjectçš„é€šä¿¡æ–¹æ³•ï¼ˆwaitã€notify å’Œ notifyAllï¼‰ï¼›</p>
<p>Condition æ¥å£çš„æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Condition</span> &#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	*Conditionçº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€,è°ƒç”¨signal()æˆ–è€…signalAll()å†æ¬¡å”¤é†’ï¼Œ</span></span><br><span class="line"><span class="comment">	*å…è®¸ä¸­æ–­å¦‚æœåœ¨é˜»å¡æ—¶é”æŒæœ‰çº¿ç¨‹ä¸­æ–­ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼›</span></span><br><span class="line"><span class="comment">	*é‡è¦ä¸€ç‚¹æ˜¯ï¼šåœ¨å½“å‰æŒæœ‰Lockçš„çº¿ç¨‹ä¸­ï¼Œå½“å¤–éƒ¨è°ƒç”¨ä¼šawait()åï¼Œ</span></span><br><span class="line"><span class="comment">	*ReentrantLockå°±å…è®¸å…¶ä»–çº¿ç¨‹æ¥æŠ¢å¤ºé”å½“å‰é”ï¼Œ</span></span><br><span class="line"><span class="comment">	*æ³¨æ„ï¼šé€šè¿‡åˆ›å»ºConditionå¯¹è±¡æ¥ä½¿çº¿ç¨‹waitï¼Œå¿…é¡»å…ˆæ‰§è¡Œlock.lockæ–¹æ³•è·å¾—é”</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Conditionçº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€,è°ƒç”¨signal()æˆ–è€…signalAll()å†æ¬¡å”¤é†’ï¼Œä¸å…è®¸ä¸­æ–­ï¼Œå¦‚æœåœ¨é˜»å¡æ—¶é”æŒæœ‰çº¿ç¨‹ä¸­æ–­ï¼Œç»§ç»­ç­‰å¾…å”¤é†’</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">awaitUninterruptibly</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®é˜»å¡æ—¶é—´ï¼Œè¶…æ—¶ç»§ç»­ï¼Œè¶…æ—¶æ—¶é—´å•ä½ä¸ºçº³ç§’ï¼Œå…¶ä»–åŒawait()ï¼›è¿”å›æ—¶é—´å¤§äºé›¶ï¼Œè¡¨ç¤ºæ˜¯è¢«å”¤é†’ï¼Œç­‰å¾…æ—¶é—´å¹¶ä¸”å¯ä»¥ä½œä¸ºç­‰å¾…æ—¶é—´æœŸæœ›å€¼ï¼Œå°äºé›¶è¡¨ç¤ºè¶…æ—¶</span></span><br><span class="line">    <span class="type">long</span> <span class="title function_">awaitNanos</span><span class="params">(<span class="type">long</span> nanosTimeout)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//ç±»ä¼¼awaitNanos(long nanosTimeout);è¿”å›å€¼ï¼šè¢«å”¤é†’trueï¼Œè¶…æ—¶false</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">await</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//ç±»ä¼¼await(long time, TimeUnit unit) </span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">awaitUntil</span><span class="params">(Date deadline)</span> <span class="keyword">throws</span> InterruptedException;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//å”¤é†’æŒ‡å®šçº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">signal</span><span class="params">()</span>;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//å”¤é†’å…¨éƒ¨çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">signalAll</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ¡ˆä¾‹</strong></p>
<blockquote>
<p>å®ç°çº¿ç¨‹é—´çš„é€šä¿¡ </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MyService</span> <span class="variable">myService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyService</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                    myService.get();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                    myService.set();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="comment">// è°ƒç”¨ReentrantLockä¸­çš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">condition</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">hasValue</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">while</span> (hasValue == <span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">// ç›¸å½“äºobjectçš„wait()æ–¹æ³•</span></span><br><span class="line">                condition.await();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">            hasValue = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// ç›¸å½“äºobjectçš„notify()æ–¹æ³•</span></span><br><span class="line">            condition.signal();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">while</span> (hasValue == <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="comment">// ç›¸å½“äºobjectçš„wait()æ–¹æ³•</span></span><br><span class="line">                condition.await();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">            hasValue = <span class="literal">false</span>;</span><br><span class="line">            condition.signal();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ReentrantLock.Conditionçš„çº¿ç¨‹é€šä¿¡ï¼š</strong><br>ReentrantLock.Conditionæ˜¯åœ¨ç²’åº¦å’Œæ€§èƒ½ä¸Šéƒ½ä¼˜äºObjectçš„notify()ã€wait()ã€notifyAll()çº¿ç¨‹é€šä¿¡çš„æ–¹å¼ã€‚</p>
<p>Conditionä¸­é€šä¿¡æ–¹æ³•ç›¸å¯¹Objectçš„é€šä¿¡åœ¨ç²’åº¦ä¸Šæ˜¯ç²’åº¦æ›´ç»†åŒ–ï¼Œè¡¨ç°åœ¨ä¸€ä¸ªLockå¯¹è±¡ä¸Šå¼•å…¥å¤šä¸ªConditionç›‘è§†å™¨ã€é€šä¿¡æ–¹æ³•ä¸­é™¤äº†å’ŒObjectå¯¹åº”çš„ä¸‰ä¸ªåŸºæœ¬å‡½æ•°å¤–ï¼Œæ›´æ˜¯æ–°å¢äº†çº¿ç¨‹ä¸­æ–­ã€é˜»å¡è¶…æ—¶çš„å‡½æ•°ï¼›<br>Conditionä¸­é€šä¿¡æ–¹æ³•ç›¸å¯¹Objectçš„é€šä¿¡åœ¨æ€§èƒ½ä¸Šæ›´é«˜æ•ˆï¼Œæ€§èƒ½çš„ä¼˜åŒ–è¡¨ç°åœ¨ReentrantLockæ¯”è¾ƒsynchronizedçš„ä¼˜åŒ– ï¼›</p>
<blockquote>
<p>ReentrantLock.Conditionçº¿ç¨‹é€šä¿¡æ³¨æ„ç‚¹ï¼š<br>1.ä½¿ç”¨<strong>ReentrantLock.Conditionçš„signal()ã€await()ã€signalAll()æ–¹æ³•ä½¿ç”¨ä¹‹å‰å¿…é¡»è¦å…ˆè¿›è¡Œlock()æ“ä½œ</strong>[è®°å¾—unlock()]ï¼Œç±»ä¼¼ä½¿ç”¨Objectçš„notify()ã€wait()ã€notifyAll()ä¹‹å‰å¿…é¡»è¦å¯¹Objectå¯¹è±¡è¿›è¡Œsynchronizedæ“ä½œï¼›å¦åˆ™å°±ä¼šæŠ›IllegalMonitorStateExceptionï¼›<br>2.æ³¨æ„åœ¨ä½¿ç”¨**ReentrantLock.Conditionä¸­ä½¿ç”¨signal()ã€await()ã€signalAll()æ–¹æ³•ï¼Œä¸èƒ½å’ŒObjectçš„notify()ã€wait()ã€notifyAll()æ–¹æ³•æ··ç”¨ï¼Œå¦åˆ™æŠ›å‡ºIllegalMonitorStateException&#96;;</p>
</blockquote>
<h5 id="ReentrantReadWriteLock"><a href="#ReentrantReadWriteLock" class="headerlink" title="ReentrantReadWriteLock"></a>ReentrantReadWriteLock</h5><p>æ¦‚è¿°</p>
<p>&amp;#160; &amp;#160; &amp;#160; &amp;#160;ReentrantReadWriteLockæ˜¯Lockçš„å¦ä¸€ç§å®ç°æ–¹å¼ï¼ŒReentrantLockæ˜¯ä¸€ä¸ªæ’ä»–é”ï¼ŒåŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼Œè€ŒReentrantReadWriteLockå…è®¸å¤šä¸ªè¯»çº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œä½†ä¸å…è®¸å†™çº¿ç¨‹å’Œè¯»çº¿ç¨‹ã€å†™çº¿ç¨‹å’Œå†™çº¿ç¨‹åŒæ—¶è®¿é—®ã€‚ç›¸å¯¹äºæ’ä»–é”ï¼Œæé«˜äº†å¹¶å‘æ€§ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯¹å…±äº«æ•°æ®ï¼ˆå¦‚ç¼“å­˜ï¼‰çš„è®¿é—®éƒ½æ˜¯è¯»æ“ä½œè¿œå¤šäºå†™æ“ä½œï¼Œè¿™æ—¶ReentrantReadWriteLockèƒ½å¤Ÿæä¾›æ¯”æ’ä»–é”æ›´å¥½çš„å¹¶å‘æ€§å’Œååé‡ã€‚</p>
<p>&amp;#160; &amp;#160; &amp;#160; &amp;#160;è¯»å†™é”å†…éƒ¨ç»´æŠ¤äº†ä¸¤ä¸ªé”ï¼Œä¸€ä¸ªç”¨äºè¯»æ“ä½œï¼Œä¸€ä¸ªç”¨äºå†™æ“ä½œã€‚æ‰€æœ‰ ReadWriteLockå®ç°éƒ½å¿…é¡»ä¿è¯ writeLockæ“ä½œçš„å†…å­˜åŒæ­¥æ•ˆæœä¹Ÿè¦ä¿æŒä¸ç›¸å…³ readLockçš„è”ç³»ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒæˆåŠŸè·å–è¯»é”çš„çº¿ç¨‹ä¼šçœ‹åˆ°å†™å…¥é”ä¹‹å‰ç‰ˆæœ¬æ‰€åšçš„æ‰€æœ‰æ›´æ–°ã€‚</p>
<p><strong>ReentrantReadWriteLockæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š</strong></p>
<p>ã€€ã€€ã€€ã€€1ï¼‰æ”¯æŒå…¬å¹³å’Œéå…¬å¹³çš„è·å–é”çš„æ–¹å¼ï¼›</p>
<p>ã€€ã€€ã€€ã€€2ï¼‰æ”¯æŒå¯é‡å…¥ã€‚è¯»çº¿ç¨‹åœ¨è·å–äº†è¯»é”åè¿˜å¯ä»¥è·å–è¯»é”ï¼›å†™çº¿ç¨‹åœ¨è·å–äº†å†™é”ä¹‹åæ—¢å¯ä»¥å†æ¬¡è·å–å†™é”åˆå¯ä»¥è·å–è¯»é”ï¼›</p>
<p>ã€€ã€€ã€€ã€€3ï¼‰è¿˜å…è®¸ä»å†™å…¥é”é™çº§ä¸ºè¯»å–é”ï¼Œå…¶å®ç°æ–¹å¼æ˜¯ï¼šå…ˆè·å–å†™å…¥é”ï¼Œç„¶åè·å–è¯»å–é”ï¼Œæœ€åé‡Šæ”¾å†™å…¥é”ã€‚ä½†æ˜¯ï¼Œä»è¯»å–é”å‡çº§åˆ°å†™å…¥é”æ˜¯ä¸å…è®¸çš„ï¼›</p>
<p>ã€€ã€€ã€€ã€€4ï¼‰è¯»å–é”å’Œå†™å…¥é”éƒ½æ”¯æŒé”è·å–æœŸé—´çš„ä¸­æ–­ï¼›</p>
<p>ã€€ã€€ã€€ã€€5ï¼‰Conditionæ”¯æŒã€‚ä»…å†™å…¥é”æä¾›äº†ä¸€ä¸ª Conditon å®ç°ï¼›è¯»å–é”ä¸æ”¯æŒ Conditon ï¼ŒreadLock().newCondition() ä¼šæŠ›å‡º UnsupportedOperationExceptionã€‚ </p>
<h5 id="ReentrantLockå®é™…å¼€å‘ä¸­çš„åº”ç”¨åœºæ™¯"><a href="#ReentrantLockå®é™…å¼€å‘ä¸­çš„åº”ç”¨åœºæ™¯" class="headerlink" title="ReentrantLockå®é™…å¼€å‘ä¸­çš„åº”ç”¨åœºæ™¯"></a>ReentrantLockå®é™…å¼€å‘ä¸­çš„åº”ç”¨åœºæ™¯</h5><ol>
<li><p>å…¬å¹³é”ï¼Œçº¿ç¨‹æ’åºæ‰§è¡Œï¼Œé˜²é¥¿æ­»åº”ç”¨åœºæ™¯ï¼›<br>å…¬å¹³é”åŸåˆ™å¿…é¡»æŒ‰ç…§é”ç”³è¯·æ—¶é—´ä¸Šå…ˆåˆ°å…ˆå¾—çš„åŸåˆ™åˆ†é…æœºåˆ¶åœºæ™¯ï¼›</p>
<p> 1ï¼‰. å®ç°é€»è¾‘ ä¸Š(åŒ…æ‹¬ï¼šè½¯ä»¶ä¸­å‡½æ•°è®¡ç®—ã€ä¸šåŠ¡å…ˆåæµç¨‹ï¼›ç¡¬ä»¶ä¸­æ“ä½œå®ç°ä¸­é¡ºåºé€»è¾‘)çš„é¡ºåºæ’é˜Ÿæœºåˆ¶çš„åœºæ™¯ï¼›<br> è½¯ä»¶åœºæ™¯ï¼šç”¨æˆ·äº¤äº’Viewä¸­å¯¹ç”¨æˆ·è¾“å…¥ç»“æœåˆ†æç±»ï¼Œåˆ†æè¿‡ç¨‹åé¢ç®—æ³•ä¾èµ–ä¸Šä¸€æ­¥ç»“æœçš„åœºæ™¯ï¼Œä¾‹å¦‚ï¼šæ¨èç®—æ³•å®ç°[æ ¹æ®æ€§åˆ«ã€å¹´é¾„ç­›é€‰]ã€é˜»å¡é˜Ÿåˆ—çš„å®ç°ï¼›<br> ç¡¬ä»¶åœºæ™¯ï¼šéœ€è¦å…ˆåˆ†æç¡®è®¤ç”¨æˆ·æ“ä½œç±»å‹ç¡¬ä»¶ç‰ˆæœ¬æˆ–è€…å‚å®¶ï¼Œç„¶åå‘å‡ºæ“ä½œæŒ‡ä»¤ï¼›ä¾‹å¦‚ï¼šè‡ªåŠ¨å”®è´§æœºï¼›</p>
<p> 2ï¼‰.ç°å® ç”Ÿæ´»ä¸­ æ—¶é—´æ’åºçš„ å…¬å¹³åŸåˆ™ï¼šä¾‹å¦‚ï¼šå®¢æœåˆ†é…ï¼Œå¿…é¡»æ˜¯å…ˆåˆ°å…ˆæœåŠ¡ï¼Œä¸èƒ½å‡ºç°é¥¿æ­»ç°è±¡ï¼›</p>
</li>
<li><p>éå…¬å¹³é”,æ•ˆç‡çš„ä½“ç°è€…ï¼›<br>å®é™…å¼€å‘ä¸­æœ€å¸¸ç”¨çš„çš„åœºæ™¯å°±æ˜¯éå…¬å¹³é”ï¼ŒReentrantLockæ— å‚æ„é€ é»˜è®¤å°±æ—¶å€™éå…¬å¹³é”ï¼›<br>é€‚åº”åœºæ™¯é™¤äº†ä¸Šé¢å…¬å¹³é”ä¸­æåˆ°çš„å…¶ä»–éƒ½æ˜¯éå…¬å¹³é”çš„ä½¿ç”¨åœºæ™¯ï¼›</p>
</li>
<li><p>ReentrantLock.Conditionçº¿ç¨‹é€šä¿¡<br>ReentrantLock.Conditionçº¿ç¨‹é€šä¿¡æ˜¯æœ€é•¿è§çš„é¢è¯•é¢˜ï¼Œè¿™é‡Œä»¥æœ€ç®€å•ä¾‹å­ï¼šä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´äº¤æ›¿æ‰“å° 26è‹±æ–‡å­—æ¯å’Œé˜¿æ‹‰ä¼¯æ•°å­—ä¸ºdemoï¼š</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">alternateTask</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="type">Condition</span> <span class="variable">condition1</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="type">Condition</span> <span class="variable">condition2</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">65</span>; i &lt; <span class="number">91</span>; i++) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;----------thread1------- &quot;</span> + (<span class="type">char</span>) i);</span><br><span class="line">                condition2.signal();</span><br><span class="line">                condition1.await();</span><br><span class="line">            &#125;</span><br><span class="line">            condition2.signal();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">26</span>; i++) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;----------thread2------- &quot;</span> + i);</span><br><span class="line">                condition1.signal();</span><br><span class="line">                condition2.await();</span><br><span class="line">            &#125;</span><br><span class="line">            condition1.signal();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    thread1.start();</span><br><span class="line">    thread2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.åŒæ­¥åŠŸèƒ½çš„ä½¿ç”¨<br>å®ç°çº¿ç¨‹åŒæ­¥é”synchronized åŠŸèƒ½ã€å•ä¾‹ä¸ºä¾‹ã€‘</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Singleton instance;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>6.ä¸­æ–­æ€å™¨åº”ç”¨<br>ReentrantLockä¸­lockInterruptibly()å’Œlock()æœ€å¤§çš„åŒºåˆ«å°±æ˜¯ä¸­æ–­ç›¸åº”é—®é¢˜ï¼š<br>lock()æ˜¯æ”¯æŒä¸­æ–­ç›¸åº”çš„é˜»å¡è¯•çš„è·å–æ–¹å¼ï¼Œå› æ­¤å³ä½¿ä¸»åŠ¨ä¸­æ–­äº†é”çš„æŒæœ‰è€…ï¼Œä½†æ˜¯å®ƒä¸èƒ½ç«‹å³unlock(),ä»ç„¶è¦æœºæ¢°ç‰ˆæ‰§è¡Œå®Œæ‰€æœ‰æ“ä½œæ‰ä¼šé‡Šæ”¾é”ã€‚<br>lockInterruptibly()æ˜¯ ä¼˜å…ˆå“åº”ä¸­æ–­çš„ï¼Œè¿™æ ·æœ‰ä¸ªä¼˜åŠ¿å°±æ˜¯å¯ä»¥é€šè¿‡tryLock()ã€tryLock(timeout, TimeUnit.SECONDS)æ–¹æ³•ï¼Œä¸­æ–­ä¼˜å…ˆçº§ä½çš„Taskï¼ŒåŠæ—¶é‡Šæ”¾èµ„æºç»™ä¼˜å…ˆçº§æ›´é«˜çš„Taskï¼Œç”šè‡³çœ‹åˆ°ç½‘ä¸Šæœ‰äººè¯´å¯ä»¥åšé˜²æ­¢æ­»é”çš„ä¼˜åŒ–ï¼›</p>
<p>å®ä¾‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        lock.lockInterruptibly();</span><br><span class="line">        <span class="keyword">if</span> (lock.tryLock(timeout, TimeUnit.SECONDS)) &#123;</span><br><span class="line">            <span class="comment">//TODO</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//è¶…æ—¶ç›´æ¥ä¸­æ–­ä¼˜å…ˆçº§ä½çš„Task</span></span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="comment">//TODO</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br></pre></td></tr></table></figure>

<p>7.éé‡è¦ä»»åŠ¡Lockä½¿ç”¨<br>ä¼˜å…ˆçº§è¾ƒä½çš„æ“ä½œè®©æ­¥ç»™ä¼˜å…ˆçº§æ›´é«˜çš„æ“ä½œï¼Œæç¤ºä»£ç æ•ˆç‡&#x2F;ç”¨æˆ·ä½“éªŒï¼›<br>å¿½ç•¥é‡å¤è§¦å‘<br>1ï¼‰.ç”¨åœ¨å®šæ—¶ä»»åŠ¡æ—¶ï¼Œå¦‚æœä»»åŠ¡æ‰§è¡Œæ—¶é—´å¯èƒ½è¶…è¿‡ä¸‹æ¬¡è®¡åˆ’æ‰§è¡Œæ—¶é—´ï¼Œç¡®ä¿è¯¥æœ‰çŠ¶æ€ä»»åŠ¡åªæœ‰ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œï¼Œå¿½ç•¥é‡å¤è§¦å‘ã€‚<br>2ï¼‰.ç”¨åœ¨ç•Œé¢äº¤äº’æ—¶ç‚¹å‡»æ‰§è¡Œè¾ƒé•¿æ—¶é—´è¯·æ±‚æ“ä½œæ—¶ï¼Œé˜²æ­¢å¤šæ¬¡ç‚¹å‡»å¯¼è‡´åå°é‡å¤æ‰§è¡Œï¼ˆå¿½ç•¥é‡å¤è§¦å‘ï¼‰ã€‚<br>ä»¥ä¸Šä¸¤ç§æƒ…å†µå¤šç”¨äºè¿›è¡Œéé‡è¦ä»»åŠ¡é˜²æ­¢é‡å¤æ‰§è¡Œï¼Œï¼ˆå¦‚ï¼šæ¸…é™¤æ— ç”¨ä¸´æ—¶æ–‡ä»¶ï¼Œæ£€æŸ¥æŸäº›èµ„æºçš„å¯ç”¨æ€§ï¼Œæ•°æ®å¤‡ä»½æ“ä½œç­‰ï¼‰<br>tryLock()åŠŸèƒ½ï¼šå¦‚æœå·²ç»è·å¾—é”ç«‹å³è¿”å›faleï¼Œèµ·åˆ°é˜²æ­¢é‡å¤è€Œå¿½ç•¥çš„æ•ˆæœ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ReentrantLock lock = new ReentrantLock();</span><br><span class="line">//é˜²æ­¢é‡å¤æ‰§è¡Œï¼Œæ‰§è¡Œè€—æ—¶æ“ä½œï¼Œä¾‹å¦‚ç”¨æˆ·é‡å¤ç‚¹å‡»</span><br><span class="line">if (lock.tryLock()) &#123;</span><br><span class="line">   try &#123;</span><br><span class="line">	//TO DO</span><br><span class="line">   &#125; finally &#123;</span><br><span class="line">     lock.unlock();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¶…æ—¶æ”¾å¼ƒ<br>å®šæ—¶æ“ä½œçš„ä¾‹å¦‚ï¼šé”™è¯¯æ—¥å¿—ã€å®šæ—¶è¿‡æœŸç¼“å­˜æ¸…ç†çš„æ“ä½œï¼Œé‡åˆ°ä¼˜å…ˆçº§æ›´é«˜çš„æ“ä½œå ç”¨èµ„æºæ—¶ï¼Œæš‚æ—¶æ”¾å¼ƒæœ¬æ¬¡æ“ä½œä¸‹æ¬¡å†å¤„ç†ï¼Œå¯ä»¥èµ·åˆ°è®©å‡ºCPUï¼Œæå‡ç”¨æˆ·ä½“éªŒï¼›</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (lock.tryLock(timeout, TimeUnit.SECONDS)) &#123;</span><br><span class="line">        <span class="comment">//TO DO</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Lockå’Œsynchronizedçš„é€‰æ‹©"><a href="#Lockå’Œsynchronizedçš„é€‰æ‹©" class="headerlink" title="Lockå’Œsynchronizedçš„é€‰æ‹©"></a>Lockå’Œsynchronizedçš„é€‰æ‹©</h4><p>æ€»ç»“æ¥è¯´ï¼ŒLockå’Œsynchronizedæœ‰ä»¥ä¸‹å‡ ç‚¹ä¸åŒï¼š</p>
<p>1ï¼‰Lockæ˜¯ä¸€ä¸ªæ¥å£ï¼Œè€Œsynchronizedæ˜¯Javaä¸­çš„å…³é”®å­—ï¼Œsynchronizedæ˜¯å†…ç½®çš„è¯­è¨€å®ç°ï¼›</p>
<p>2ï¼‰synchronizedåœ¨å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾çº¿ç¨‹å æœ‰çš„é”ï¼Œå› æ­¤ä¸ä¼šå¯¼è‡´æ­»é”ç°è±¡å‘ç”Ÿï¼›è€ŒLockåœ¨å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œå¦‚æœæ²¡æœ‰ä¸»åŠ¨é€šè¿‡unLock()å»é‡Šæ”¾é”ï¼Œåˆ™å¾ˆå¯èƒ½é€ æˆæ­»é”ç°è±¡ï¼Œå› æ­¤ä½¿ç”¨Lockæ—¶éœ€è¦åœ¨finallyå—ä¸­é‡Šæ”¾é”ï¼›</p>
<p>3ï¼‰Lockå¯ä»¥è®©ç­‰å¾…é”çš„çº¿ç¨‹å“åº”ä¸­æ–­ï¼Œè€Œsynchronizedå´ä¸è¡Œï¼Œä½¿ç”¨synchronizedæ—¶ï¼Œç­‰å¾…çš„çº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ï¼Œä¸èƒ½å¤Ÿå“åº”ä¸­æ–­ï¼›</p>
<p>1.å¯é‡å…¥æ€§<br>ReentrantLockå’Œsynchronizedéƒ½å…·æœ‰å¯é‡å…¥æ€§ï¼Œå†™ä»£ç synchronizedæ›´ç®€å•ï¼ŒReentrantLockéœ€è¦å°†lock()å’Œunlock()è¿›è¡Œä¸€ä¸€å¯¹åº”å¦åˆ™æœ‰æ­»é”çš„é£é™©ï¼›</p>
<p>2.é”çš„å®ç°æ–¹å¼<br>Synchronizedä½œä¸ºJavaå…³é”®å­—æ˜¯ä¾èµ–äºJVMå®ç°çš„ï¼Œè€ŒReenTrantLockæ˜¯JDKå®ç°çš„ï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œè¯´ç™½äº†å°±ç±»ä¼¼äºæ“ä½œç³»ç»Ÿæ¥æ§åˆ¶å®ç°å’Œç”¨æˆ·è‡ªå·±æ•²ä»£ç å®ç°çš„åŒºåˆ«ã€‚å‰è€…çš„å®ç°æ˜¯æ¯”è¾ƒéš¾è§åˆ°çš„ï¼Œåè€…æœ‰ç›´æ¥çš„æºç å¯ä¾›é˜…è¯»ã€‚</p>
<p>3.å…¬å¹³æ€§<br>ReentrantLockæä¾›äº†å…¬å¹³é”å’Œéå…¬å¹³é”ä¸¤ç§APIï¼Œå¼€å‘äººå‘˜å®Œå…¨å¯ä»¥æ ¹æ®åº”ç”¨åœºæ™¯é€‰æ‹©é”çš„å…¬å¹³æ€§ï¼›<br>synchronizedæ˜¯ä½œä¸ºJavaå…³é”®å­—æ˜¯ä¾èµ–äºJVMå®ç°ï¼ŒJavaå›¢é˜Ÿåº”è¯¥æ˜¯ä¼˜å…ˆè€ƒè™‘æ€§èƒ½é—®é¢˜ï¼Œå› æ­¤synchronizedæ˜¯éå…¬å¹³é”ã€‚</p>
<p>åœ¨æ€§èƒ½ä¸Šæ¥è¯´ï¼Œå¦‚æœç«äº‰èµ„æºä¸æ¿€çƒˆï¼Œä¸¤è€…çš„æ€§èƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œè€Œå½“ç«äº‰èµ„æºéå¸¸æ¿€çƒˆæ—¶ï¼ˆå³æœ‰å¤§é‡çº¿ç¨‹åŒæ—¶ç«äº‰ï¼‰ï¼Œæ­¤æ—¶Lockçš„æ€§èƒ½è¦è¿œè¿œä¼˜äºsynchronizedã€‚æ‰€ä»¥è¯´ï¼Œåœ¨å…·ä½“ä½¿ç”¨æ—¶è¦æ ¹æ®é€‚å½“æƒ…å†µé€‰æ‹©ã€‚</p>
<p><img src="https://gitee.com/fly_tom/use/raw/master/juc18.png"></p>
<h4 id="å…¬å¹³é”ä¸éå…¬å¹³é”"><a href="#å…¬å¹³é”ä¸éå…¬å¹³é”" class="headerlink" title="å…¬å¹³é”ä¸éå…¬å¹³é”"></a>å…¬å¹³é”ä¸éå…¬å¹³é”</h4><p><strong>å…¬å¹³é”ï¼š</strong> æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹ç«äº‰åŒä¸€èµ„æºæ—¶[ç­‰å¾…åŒä¸€ä¸ªé”æ—¶]ï¼Œè·å–èµ„æºçš„é¡ºåºæ˜¯æŒ‰ç…§ç”³è¯·é”çš„å…ˆåé¡ºåºçš„ï¼›å…¬å¹³é”ä¿éšœäº†å¤šçº¿ç¨‹ä¸‹å„çº¿ç¨‹è·å–é”çš„é¡ºåºï¼Œå…ˆåˆ°çš„çº¿ç¨‹ä¼˜å…ˆè·å–é”ï¼Œæœ‰ç‚¹åƒæ—©å¹´ä¹°ç«è½¦ç¥¨ä¸€æ ·æ’é˜Ÿæ—©çš„äººå…ˆä¹°åˆ°ç«è½¦ç¥¨ï¼›<br>åŸºæœ¬ç‰¹ç‚¹ï¼š çº¿ç¨‹æ‰§è¡Œä¼šä¸¥æ ¼æŒ‰ç…§é¡ºåºæ‰§è¡Œï¼Œç­‰å¾…é”çš„çº¿ç¨‹ä¸ä¼šé¥¿æ­»ï¼Œä½† æ•´ä½“æ•ˆç‡ç›¸å¯¹æ¯”è¾ƒä½ï¼›</p>
<p><strong>éå…¬å¹³é”ï¼š</strong> æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹ç«äº‰åŒä¸€èµ„æºæ—¶ï¼Œè·å–èµ„æºçš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼Œä¸€èˆ¬æ˜¯æŠ¢å å¼çš„ï¼›éå…¬å¹³é”ç›¸å¯¹å…¬å¹³é”æ˜¯å¢åŠ äº†è·å–èµ„æºçš„ä¸ç¡®å®šæ€§ï¼Œä½†æ˜¯æ•´ä½“æ•ˆç‡å¾—ä»¥æå‡ï¼›<br>åŸºæœ¬ç‰¹ç‚¹ï¼š æ•´ä½“æ•ˆç‡é«˜ï¼Œçº¿ç¨‹ç­‰å¾…æ—¶é—´ç‰‡å…·æœ‰ä¸ç¡®å®šæ€§ï¼›</p>
<p>å…¬å¹³é”ä¸éå…¬å¹³é”çš„æµ‹è¯•demoï¼š<br>é‡å…¥é”ReentrantLockå®ç°å…¬å¹³é”å’Œéå…¬å¹³é”å¾ˆç®€å•çš„ï¼Œå› ä¸ºReentrantLockæ„é€ å‡½æ•°ä¸­å¯ä»¥ç›´æ¥ä¼ å…¥ä¸€ä¸ªbooleanå€¼fairï¼Œå¯¹å…¬å¹³æ€§è¿›è¡Œè®¾ç½®ã€‚å½“fairä¸ºtrueæ—¶ï¼Œè¡¨ç¤ºæ­¤é”æ˜¯å…¬å¹³çš„ï¼Œå½“fairä¸ºfalseæ—¶ï¼Œè¡¨ç¤ºæ­¤é”æ˜¯éå…¬å¹³çš„é”ï¼›<br>æ¥ä¸ªç®€å•çš„demoï¼›</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">    <span class="type">ReentrantLock</span> <span class="variable">fairLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ReentrantLock</span> <span class="variable">unFairLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        threadPool.submit(<span class="keyword">new</span> <span class="title class_">TestThread</span>(fairLock,i,<span class="string">&quot; fairLock&quot;</span>));</span><br><span class="line">        threadPool.submit(<span class="keyword">new</span> <span class="title class_">TestThread</span>(unFairLock, i, <span class="string">&quot;unFairLock&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h3><p><a href="https://www.javazhiyin.com/22399.html">https://www.javazhiyin.com/22399.html</a></p>
<p><strong>ä»€ä¹ˆæ˜¯æ­»é”å‘¢ï¼Ÿ</strong></p>
<p>&amp;ensp;&amp;ensp;&amp;ensp;&amp;ensp;å®ƒçš„ä¸€ä¸ªæ¯”è¾ƒå®˜æ–¹çš„å®šä¹‰å°±æ˜¯ï¼šæ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±äº<strong>ç«äº‰èµ„æº</strong>æˆ–è€…ç”±äºå½¼æ­¤é€šä¿¡è€Œé€ æˆçš„ä¸€ç§é˜»å¡çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ã€‚æ­¤æ—¶ç§°ç³»ç»Ÿå¤„äºæ­»é”çŠ¶æ€æˆ–ç³»ç»Ÿäº§ç”Ÿäº†æ­»é”ï¼Œ<strong>è¿™äº›æ°¸è¿œåœ¨äº’ç›¸ç­‰å¾…çš„è¿›ç¨‹ç§°ä¸ºæ­»é”è¿›ç¨‹</strong></p>
<p><strong>æ­»é”æœ‰å“ªäº›å½¢æˆçš„åŸå› </strong></p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œäº§ç”Ÿæ­»é”é—®é¢˜æœ‰ä»¥ä¸‹æ¡ä»¶ï¼š</p>
<p>äº’æ–¥æ¡ä»¶ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ã€‚</p>
<p>è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šä¸€ä¸ªè¿›ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚</p>
<p>ä¸å‰¥å¤ºæ¡ä»¶ï¼šè¿›ç¨‹å·²è·å¾—çš„èµ„æºï¼Œåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½å¼ºè¡Œå‰¥å¤ºã€‚</p>
<p>å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»ã€‚</p>
<p>æ­»é”æ˜¯ç”±å››ä¸ªå¿…è¦æ¡ä»¶å¯¼è‡´çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬æ¥è¯´ï¼Œåªè¦ç ´åè¿™å››ä¸ªå¿…è¦æ¡ä»¶ä¸­çš„ä¸€ä¸ªæ¡ä»¶ï¼Œæ­»é”æƒ…å†µå°±åº”è¯¥ä¸ä¼šå‘ç”Ÿã€‚</p>
<p><strong>æ­»é”æ¡ˆä¾‹</strong></p>
<blockquote>
<p>å¯åŠ¨ä¹‹åï¼Œçº¿ç¨‹rè·å–â€Aâ€é”å¯¹è±¡ï¼Œçº¿ç¨‹r2è·å–â€Bâ€é”å¯¹è±¡ï¼ˆé¡ºåºä¸è®ºå‰åï¼‰ï¼Œæ­¤æ—¶çº¿ç¨‹â€Aâ€è¦è·å–çº¿ç¨‹â€Bâ€é”å¯¹è±¡ï¼Œä½†æ˜¯çº¿ç¨‹r2å¹¶æ²¡æœ‰é‡Šæ”¾ï¼Œçº¿ç¨‹r2è¦è·å–çº¿ç¨‹â€Aâ€é”å¯¹è±¡ï¼Œä½†æ˜¯çº¿ç¨‹ræ²¡æœ‰é‡Šæ”¾ï¼Œæ­¤æ—¶å°±ä¼šé€ æˆçº¿ç¨‹æ­»é”ï¼Œç¨‹åºå¹¶ä¸ä¼šåœæ­¢ï¼Œ</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">r</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="string">&quot;A&quot;</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Açº¿ç¨‹æŒæœ‰Aé”ï¼Œç­‰å¾…Bé”&quot;</span>);</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="string">&quot;B&quot;</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Açº¿ç¨‹åŒæ—¶æŒæœ‰ABé”&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">r2</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="string">&quot;B&quot;</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Bçº¿ç¨‹æŒæœ‰Bï¼Œç­‰å¾…Aé”&quot;</span>);</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="string">&quot;A&quot;</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Bçº¿ç¨‹åŒæ—¶æŒæœ‰ABé”&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(r).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(r2).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CountDownLatch-amp-Semaphore-amp-CyclicBarrier"><a href="#CountDownLatch-amp-Semaphore-amp-CyclicBarrier" class="headerlink" title="CountDownLatch &amp; Semaphore &amp; CyclicBarrier"></a>CountDownLatch &amp; Semaphore &amp; CyclicBarrier</h3><blockquote>
<p>CountDownLatchæ˜¯åœ¨java1.5è¢«å¼•å…¥çš„ï¼Œè·Ÿå®ƒä¸€èµ·è¢«å¼•å…¥çš„å¹¶å‘å·¥å…·ç±»è¿˜æœ‰CyclicBarrierã€Semaphoreã€ConcurrentHashMapå’ŒBlockingQueueï¼Œå®ƒä»¬éƒ½å­˜åœ¨äºjava.util.concurrentåŒ…ä¸‹ã€‚</p>
</blockquote>
<h4 id="CountDownLatch-é—­é”"><a href="#CountDownLatch-é—­é”" class="headerlink" title="CountDownLatch(é—­é”)"></a>CountDownLatch(é—­é”)</h4><p><a href="https://www.javazhiyin.com/18110.html">https://www.javazhiyin.com/18110.html</a></p>
<p>CountDownLatchè®¡æ•°å™¨é—­é”æ˜¯ä¸€ä¸ªèƒ½é˜»å¡ä¸»çº¿ç¨‹ï¼Œè®©å…¶ä»–çº¿ç¨‹æ»¡è¶³ç‰¹å®šæ¡ä»¶ä¸‹ä¸»çº¿ç¨‹å†ç»§ç»­æ‰§è¡Œçš„çº¿ç¨‹åŒæ­¥å·¥å…·ã€‚</p>
<p>Latché—­é”çš„æ„æ€ï¼Œæ˜¯ä¸€ç§åŒæ­¥çš„å·¥å…·ç±»ã€‚ç±»ä¼¼äºä¸€æ‰‡é—¨ï¼šåœ¨é—­é”åˆ°è¾¾ç»“æŸçŠ¶æ€ä¹‹å‰ï¼Œè¿™æ‰‡é—¨ä¸€ç›´æ˜¯å…³é—­ç€çš„ï¼Œä¸å…è®¸ä»»ä½•çº¿ç¨‹é€šè¿‡ï¼Œå½“åˆ°è¾¾ç»“æŸçŠ¶æ€æ—¶ï¼Œè¿™æ‰‡é—¨ä¼šæ‰“å¼€å¹¶å…è®¸æ‰€æœ‰çš„çº¿ç¨‹é€šè¿‡ã€‚ä¸”å½“é—¨æ‰“å¼€äº†ï¼Œå°±æ°¸è¿œä¿æŒæ‰“å¼€çŠ¶æ€ã€‚</p>
<p>CountDowmLatchæ˜¯ä¸€ç§çµæ´»çš„é—­é”å®ç°ï¼ŒåŒ…å«ä¸€ä¸ªè®¡æ•°å™¨ï¼Œè¯¥è®¡ç®—å™¨åˆå§‹åŒ–ä¸ºä¸€ä¸ªæ­£æ•°ï¼Œè¡¨ç¤ºéœ€è¦ç­‰å¾…äº‹ä»¶çš„æ•°é‡ã€‚countDownæ–¹æ³•é€’å‡è®¡æ•°å™¨ï¼Œè¡¨ç¤ºæœ‰ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿï¼Œè€Œawaitæ–¹æ³•ç­‰å¾…è®¡æ•°å™¨åˆ°è¾¾0ï¼Œè¡¨ç¤ºæ‰€æœ‰éœ€è¦ç­‰å¾…çš„äº‹æƒ…éƒ½å·²ç»å®Œæˆã€‚</p>
<p>è¿™å¥è¯çš„æ„æ€æ˜¯:åœ¨å•ç‹¬ä¸»çº¿ç¨‹çš„æƒ…å†µä¸‹,åˆ›å»ºå¤šä¸ªå­çº¿ç¨‹, åœ¨ä¿è¯ä¸»çº¿ç¨‹åŒæ­¥çš„æƒ…å†µä¸‹,åŒæ—¶åˆè®©å¤šä¸ªå­çº¿ç¨‹å¤„ç†,å¯ä»¥ä½¿ç”¨ CountDownLatchæ¥é˜»å¡ä¸»çº¿ç¨‹,ç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œå®Œæˆ,ä¸»çº¿ç¨‹æ‰æ‰§è¡Œåç»­æ“ä½œ.</p>
<blockquote>
<p>CountDownLatchå†…éƒ¨ä½¿ç”¨äº†å…±äº«é”ï¼Œç”¨ç»™å®šçš„è®¡æ•°ï¼Œåˆå§‹åŒ– CountDownLatchã€‚ç”±äºè°ƒç”¨äº† countDown() æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨å½“å‰è®¡æ•°åˆ°è¾¾é›¶ä¹‹å‰ï¼Œawait æ–¹æ³•ä¼šä¸€ç›´å—é˜»å¡ã€‚ä¹‹åï¼Œä¼šé‡Šæ”¾æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œawait çš„æ‰€æœ‰åç»­è°ƒç”¨éƒ½å°†ç«‹å³è¿”å›ã€‚è¿™ç§ç°è±¡åªå‡ºç°ä¸€æ¬¡â€”â€”è®¡æ•°æ— æ³•è¢«é‡ç½®ã€‚å¦‚æœéœ€è¦é‡ç½®è®¡æ•°ï¼Œè¯·è€ƒè™‘ä½¿ç”¨ CyclicBarrierã€‚</p>
</blockquote>
<p><strong>å¸¸è§æ¡ˆä¾‹:</strong></p>
<blockquote>
<p>ä½†æ˜¯æ›´å¥½çš„æ–¹å¼è¿˜æ˜¯ä½¿ç”¨CompletableFutureæ¥ç®¡ç†</p>
</blockquote>
<p>1:å¤šçº¿ç¨‹è¯»å–æ‰¹é‡æ–‡ä»¶, å¹¶ä¸”è¯»å–å®Œæˆä¹‹åæ±‡æ€»å¤„ç†</p>
<p>2:å¤šçº¿ç¨‹è¯»å–Excelå¤šä¸ªsheet,è¯»å–å®Œæˆä¹‹åè·å–æ±‡æ€»è·å–çš„ç»“æœ</p>
<p>3:å¤šä¸ªäººä¸€èµ·ä¸€èµ·æ¥åƒé¥­,ä¸»äººç­‰å¾…å®¢äººåˆ°æ¥,å®¢äººä¸€ä¸ªä¸ªä»ä¸åŒåœ°æ–¹æ¥åˆ°é¥­åº—,ä¸»äººéœ€è¦ç­‰åˆ°æ‰€æœ‰äººéƒ½åˆ°æ¥ä¹‹å,æ‰èƒ½å¼€é¥­</p>
<p>4:æ±½è½¦ç«™,æ‰€æœ‰ä¹˜å®¢éƒ½ä»ä¸åŒçš„åœ°æ–¹èµ¶åˆ°æ±½è½¦ç«™,å¿…é¡»ç­‰åˆ°æ‰€æœ‰ä¹˜å®¢éƒ½åˆ°äº†,æ±½è½¦æ‰ä¼šå‡ºå‘,å¦‚æœè®¾ç½®äº†è¶…æ—¶ç­‰å¾…,é‚£ä¹ˆå½“æŸä¸ªæ—¶é—´ç‚¹åˆ°äº†,æ±½è½¦ä¹Ÿå‡ºå‘</p>
<p><strong>æ³¨æ„äº‹é¡¹:</strong></p>
<p><strong>ä½¿ç”¨CountDownLatchå¿…é¡»ç¡®ä¿è®¡æ•°å™¨æ•°é‡ä¸å­çº¿ç¨‹æ•°é‡ä¸€è‡´,ä¸”countDownå¿…é¡»è¦æ‰§è¡Œ,å¦åˆ™å‡ºç°è®¡æ•°å™¨ä¸ä¸º0,å¯¼è‡´ä¸»çº¿ç¨‹ä¸€è‡´ç­‰å¾…çš„æƒ…å†µ</strong></p>
<p>ç„¶åä¸‹é¢è¿™3ä¸ªæ–¹æ³•æ˜¯CountDownLatchç±»ä¸­æœ€é‡è¦çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è°ƒç”¨await()æ–¹æ³•çš„çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œå®ƒä¼šç­‰å¾…ç›´åˆ°countå€¼ä¸º0æ‰ç»§ç»­æ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123; &#125;;   </span><br><span class="line"><span class="comment">//å’Œawait()ç±»ä¼¼ï¼Œåªä¸è¿‡ç­‰å¾…ä¸€å®šçš„æ—¶é—´åcountå€¼è¿˜æ²¡å˜ä¸º0çš„è¯å°±ä¼šç»§ç»­æ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">await</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123; &#125;;  </span><br><span class="line"><span class="comment">//å°†countå€¼å‡1</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">countDown</span><span class="params">()</span> &#123; &#125;;  </span><br></pre></td></tr></table></figure>

<p><strong>æ¡ˆä¾‹</strong></p>
<blockquote>
<p>æ•™ç»ƒç­‰å¾…æ‰€æœ‰è¿åŠ¨å‘˜åˆ°åœºåï¼Œå¼€å§‹è®­ç»ƒ</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Test</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                test.jl();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;æ•™ç»ƒ&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                test.ydy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;è¿åŠ¨å‘˜1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                test.ydy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;è¿åŠ¨å‘˜2&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                test.ydy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;è¿åŠ¨å‘˜3&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span>&#123;</span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  è¿åŠ¨å‘˜æ–¹æ³•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">ydy</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// è®¡æ•°å‡ä¸€</span></span><br><span class="line">        countDownLatch.countDown();</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> Thread.currentThread().getName();</span><br><span class="line">        System.out.println(name + <span class="string">&quot;å‡†å¤‡å®Œæ¯•ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ•™ç»ƒæ–¹æ³•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">jl</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ•™ç»ƒç­‰å¾….........&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// ç­‰äº0æ—¶ å”¤é†’</span></span><br><span class="line">            countDownLatch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> Thread.currentThread().getName();</span><br><span class="line">        System.out.println(name + <span class="string">&quot;å¼€å§‹è®­ç»ƒï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">æ•™ç»ƒç­‰å¾….........</span><br><span class="line">è¿åŠ¨å‘˜<span class="number">1</span>å‡†å¤‡å®Œæ¯•ï¼</span><br><span class="line">è¿åŠ¨å‘˜<span class="number">2</span>å‡†å¤‡å®Œæ¯•ï¼</span><br><span class="line">è¿åŠ¨å‘˜<span class="number">3</span>å‡†å¤‡å®Œæ¯•ï¼</span><br><span class="line">æ•™ç»ƒå¼€å§‹è®­ç»ƒï¼</span><br></pre></td></tr></table></figure>

<p><strong>æ€»ç»“</strong></p>
<p><code>CountDownLatch</code>å†…éƒ¨é€šè¿‡<strong>å…±äº«é”</strong>å®ç°ã€‚åœ¨åˆ›å»º<code>CountDownLatch</code>å®ä¾‹æ—¶ï¼Œéœ€è¦ä¼ é€’ä¸€ä¸ª<code>int</code>å‹çš„å‚æ•°ï¼š<code>count</code>ï¼Œè¯¥å‚æ•°ä¸ºè®¡æ•°å™¨çš„åˆå§‹å€¼ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºè¯¥å…±äº«é”å¯ä»¥è·å–çš„æ€»æ¬¡æ•°ã€‚å½“æŸä¸ªçº¿ç¨‹è°ƒç”¨<code>await()</code>æ–¹æ³•ï¼Œç¨‹åºé¦–å…ˆåˆ¤æ–­<code>count</code>çš„å€¼æ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸ä¼š0çš„è¯åˆ™ä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°ä¸º0ä¸ºæ­¢ã€‚å½“å…¶ä»–çº¿ç¨‹è°ƒç”¨<code>countDown()</code>æ–¹æ³•æ—¶ï¼Œåˆ™æ‰§è¡Œé‡Šæ”¾å…±äº«é”çŠ¶æ€ï¼Œä½¿<code>count</code>å€¼ - 1ã€‚å½“åœ¨åˆ›å»º<code>CountDownLatch</code>æ—¶åˆå§‹åŒ–çš„<code>count</code>å‚æ•°ï¼Œå¿…é¡»è¦æœ‰<code>count</code>çº¿ç¨‹è°ƒç”¨<code>countDown</code>æ–¹æ³•æ‰ä¼šä½¿è®¡æ•°å™¨countç­‰äº0ï¼Œé”æ‰ä¼šé‡Šæ”¾ï¼Œå‰é¢ç­‰å¾…çš„çº¿ç¨‹æ‰ä¼šç»§ç»­è¿è¡Œã€‚æ³¨æ„<code>CountDownLatch</code>ä¸èƒ½å›æ»šé‡ç½®ã€‚</p>
<h4 id="CyclicBarrier-å¾ªç¯æ …æ "><a href="#CyclicBarrier-å¾ªç¯æ …æ " class="headerlink" title="CyclicBarrier(å¾ªç¯æ …æ )"></a>CyclicBarrier(å¾ªç¯æ …æ )</h4><p><a href="https://www.javazhiyin.com/53302.html">https://www.javazhiyin.com/53302.html</a></p>
<blockquote>
<p>å­—é¢æ„æ€å›ç¯æ …æ ï¼Œé€šè¿‡å®ƒå¯ä»¥å®ç°è®©ä¸€ç»„çº¿ç¨‹ç­‰å¾…è‡³æŸä¸ªçŠ¶æ€ä¹‹åå†å…¨éƒ¨åŒæ—¶æ‰§è¡Œã€‚å«åšå›ç¯æ˜¯å› ä¸ºå½“æ‰€æœ‰ç­‰å¾…çº¿ç¨‹éƒ½è¢«é‡Šæ”¾ä»¥åï¼ŒCyclicBarrierå¯ä»¥è¢«é‡ç”¨ã€‚æˆ‘ä»¬æš‚ä¸”æŠŠè¿™ä¸ªçŠ¶æ€å°±å«åšbarrierï¼Œå½“è°ƒç”¨await()æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹å°±å¤„äºbarrieräº†ã€‚</p>
</blockquote>
<h4 id="CountDownLatch-å’Œ-CyclicBarrieråŒºåˆ«"><a href="#CountDownLatch-å’Œ-CyclicBarrieråŒºåˆ«" class="headerlink" title="CountDownLatch å’Œ CyclicBarrieråŒºåˆ«"></a>CountDownLatch å’Œ CyclicBarrieråŒºåˆ«</h4><table>
<thead>
<tr>
<th>CountDownLatch</th>
<th>CyclicBarrier</th>
</tr>
</thead>
<tbody><tr>
<td>å‡è®¡æ•°æ–¹å¼</td>
<td>åŠ è®¡æ•°æ–¹å¼</td>
</tr>
<tr>
<td>è®¡ç®—ä¸º 0 æ—¶é‡Šæ”¾æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹</td>
<td>è®¡æ•°è¾¾åˆ°æŒ‡å®šå€¼æ—¶é‡Šæ”¾æ‰€æœ‰ç­‰å¾…çº¿ç¨‹</td>
</tr>
<tr>
<td>è®¡æ•°ä¸º 0 æ—¶ï¼Œæ— æ³•é‡ç½®</td>
<td>è®¡æ•°è¾¾åˆ°æŒ‡å®šå€¼æ—¶ï¼Œè®¡æ•°ç½®ä¸º 0 é‡æ–°å¼€å§‹</td>
</tr>
<tr>
<td>è°ƒç”¨ <code>countDown()</code>æ–¹æ³•è®¡æ•°å‡ä¸€ï¼Œè°ƒç”¨ <code>await()</code> æ–¹æ³•åªè¿›è¡Œé˜»å¡ï¼Œå¯¹è®¡æ•°æ²¡ä»»ä½•å½±å“</td>
<td>è°ƒç”¨ <code>await()</code>æ–¹æ³•è®¡æ•°åŠ  1ï¼Œè‹¥åŠ  1 åçš„å€¼ ä¸ç­‰äºæ„é€ æ–¹æ³•çš„å€¼ï¼Œåˆ™çº¿ç¨‹é˜»å¡</td>
</tr>
<tr>
<td>ä¸å¯é‡å¤åˆ©ç”¨</td>
<td>å¯é‡å¤åˆ©ç”¨</td>
</tr>
</tbody></table>
<h4 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h4><blockquote>
<p>Semaphoreç¿»è¯‘æˆå­—é¢æ„æ€ä¸º ä¿¡å·é‡ï¼ŒSemaphoreå¯ä»¥æ§åˆ¶åŒæ—¶è®¿é—®çš„çº¿ç¨‹ä¸ªæ•°ï¼Œé€šè¿‡ <code>acquire()</code> è·å–ä¸€ä¸ªè®¸å¯ï¼Œå¦‚æœæ²¡æœ‰å°±ç­‰å¾…ï¼Œè€Œ release() é‡Šæ”¾ä¸€ä¸ªè®¸å¯ã€‚<br>Semaphoreå…¶å®å’Œé”æœ‰ç‚¹ç±»ä¼¼ï¼Œå®ƒä¸€èˆ¬ç”¨äºæ§åˆ¶å¯¹æŸç»„èµ„æºçš„è®¿é—®æƒé™ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å‚æ•°permitsè¡¨ç¤ºè®¸å¯æ•°ç›®ï¼Œå³åŒæ—¶å¯ä»¥å…è®¸å¤šå°‘çº¿ç¨‹è¿›è¡Œè®¿é—®</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Semaphore</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> &#123;          </span><br><span class="line">    sync = <span class="keyword">new</span> <span class="title class_">NonfairSync</span>(<span class="keyword">permits</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¿™ä¸ªå¤šäº†ä¸€ä¸ªå‚æ•°fairè¡¨ç¤ºæ˜¯å¦æ˜¯å…¬å¹³çš„ï¼Œå³ç­‰å¾…æ—¶é—´è¶Šä¹…çš„è¶Šå…ˆè·å–è®¸å¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Semaphore</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>, <span class="type">boolean</span> fair)</span> &#123;    </span><br><span class="line">    sync = (fair)? <span class="keyword">new</span> <span class="title class_">FairSync</span>(<span class="keyword">permits</span>) : <span class="keyword">new</span> <span class="title class_">NonfairSync</span>(<span class="keyword">permits</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Semaphoreç±»ä¸­æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªæ–¹æ³•ï¼Œé¦–å…ˆæ˜¯acquire()ã€release()æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è·å–ä¸€ä¸ªè®¸å¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;  &#125;     </span><br><span class="line"><span class="comment">//è·å–permitsä¸ªè®¸å¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> <span class="keyword">throws</span> InterruptedException &#123; &#125;</span><br><span class="line"><span class="comment">//é‡Šæ”¾ä¸€ä¸ªè®¸å¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">()</span> &#123; &#125;          </span><br><span class="line"><span class="comment">//é‡Šæ”¾permitsä¸ªè®¸å¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> &#123; &#125;    </span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢4ä¸ªæ–¹æ³•éƒ½ä¼šè¢«<strong>é˜»å¡</strong>ï¼Œå¦‚æœæƒ³ç«‹å³å¾—åˆ°æ‰§è¡Œç»“æœï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢å‡ ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å°è¯•è·å–ä¸€ä¸ªè®¸å¯ï¼Œè‹¥è·å–æˆåŠŸï¼Œåˆ™ç«‹å³è¿”å›trueï¼Œè‹¥è·å–å¤±è´¥ï¼Œåˆ™ç«‹å³è¿”å›false</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">()</span> &#123; &#125;; </span><br><span class="line"><span class="comment">//å°è¯•è·å–ä¸€ä¸ªè®¸å¯ï¼Œè‹¥åœ¨æŒ‡å®šçš„æ—¶é—´å†…è·å–æˆåŠŸï¼Œåˆ™ç«‹å³è¿”å›trueï¼Œå¦åˆ™åˆ™ç«‹å³è¿”å›false </span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123; &#125;;  </span><br><span class="line"><span class="comment">//å°è¯•è·å–permitsä¸ªè®¸å¯ï¼Œè‹¥è·å–æˆåŠŸï¼Œåˆ™ç«‹å³è¿”å›trueï¼Œè‹¥è·å–å¤±è´¥ï¼Œåˆ™ç«‹å³è¿”å›false</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>)</span> &#123; &#125;; </span><br><span class="line"><span class="comment">//å°è¯•è·å–permitsä¸ªè®¸å¯ï¼Œè‹¥åœ¨æŒ‡å®šçš„æ—¶é—´å†…è·å–æˆåŠŸï¼Œåˆ™ç«‹å³è¿”å›trueï¼Œå¦åˆ™åˆ™ç«‹å³è¿”å›false</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> <span class="keyword">permits</span>, <span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123; &#125;; </span><br></pre></td></tr></table></figure>

<h3 id="CompletableFuture"><a href="#CompletableFuture" class="headerlink" title="CompletableFuture"></a>CompletableFuture</h3><p><a href="https://juejin.cn/post/6970558076642394142">https://juejin.cn/post/6970558076642394142</a></p>
<p><strong>Futureæ¥å£çš„å±€é™æ€§</strong></p>
<p>å½“æˆ‘ä»¬å¾—åˆ°åŒ…å«ç»“æœçš„Futureæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨getæ–¹æ³•<strong>ç­‰å¾…çº¿ç¨‹å®Œæˆ</strong>å¹¶è·å–è¿”å›å€¼ï¼Œæ³¨æ„æˆ‘åŠ ç²—çš„åœ°æ–¹ï¼ŒFutureçš„<strong>get()</strong> æ–¹æ³•ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚ Futureæ–‡æ¡£åŸæ–‡å¦‚ä¸‹</p>
<blockquote>
<p>A {@code Future} represents the result of an asynchronous computation. Methods are provided to check if the computation is complete, to wait for its completion, and to retrieve the result of the computation.</p>
</blockquote>
<p>è°·æ­Œç¿»è¯‘ï¼š</p>
<blockquote>
<p>{@code Future}ä»£è¡¨å¼‚æ­¥*è®¡ç®—çš„ç»“æœã€‚æä¾›äº†ä¸€äº›æ–¹æ³•æ¥æ£€æŸ¥è®¡ç®—æ˜¯å¦å®Œæˆï¼Œç­‰å¾…å…¶å®Œæˆå¹¶æ£€ç´¢è®¡ç®—ç»“æœã€‚</p>
</blockquote>
<p>ç”±æ­¤æˆ‘ä»¬å¾—çŸ¥ï¼ŒFutureè·å–å¾—çº¿ç¨‹æ‰§è¡Œç»“æœå‰ï¼Œæˆ‘ä»¬çš„ä¸»çº¿ç¨‹get()å¾—åˆ°ç»“æœéœ€è¦ä¸€ç›´é˜»å¡ç­‰å¾…ï¼Œå³ä½¿æˆ‘ä»¬ä½¿ç”¨isDone()æ–¹æ³•è½®è¯¢å»æŸ¥çœ‹çº¿ç¨‹æ‰§è¡ŒçŠ¶æ€ï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿéå¸¸æµªè´¹cpuèµ„æºã€‚</p>
<p><img src="https://gitee.com/fly_tom/use/raw/master/xc3.png"></p>
<h4 id="å®ä¾‹åŒ–CompletableFuture"><a href="#å®ä¾‹åŒ–CompletableFuture" class="headerlink" title="å®ä¾‹åŒ–CompletableFuture"></a>å®ä¾‹åŒ–CompletableFuture</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier, Executor executor)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable, Executor executor)</span>;</span><br></pre></td></tr></table></figure>

<p>æœ‰ä¸¤ç§æ ¼å¼ï¼Œä¸€ç§æ˜¯supplyå¼€å¤´çš„æ–¹æ³•ï¼Œä¸€ç§æ˜¯runå¼€å¤´çš„æ–¹æ³•</p>
<ul>
<li>supplyå¼€å¤´ï¼šè¿™ç§æ–¹æ³•ï¼Œå¯ä»¥è¿”å›å¼‚æ­¥çº¿ç¨‹æ‰§è¡Œä¹‹åçš„ç»“æœ</li>
<li>runå¼€å¤´ï¼šè¿™ç§ä¸ä¼šè¿”å›ç»“æœï¼Œå°±åªæ˜¯æ‰§è¡Œçº¿ç¨‹ä»»åŠ¡</li>
</ul>
<p><strong>supplyAsyncæ–¹æ³•</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä½¿ç”¨é»˜è®¤å†…ç½®çº¿ç¨‹æ± ForkJoinPool.commonPool()ï¼Œæ ¹æ®supplieræ„å»ºæ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier)</span></span><br><span class="line"><span class="comment">//è‡ªå®šä¹‰çº¿ç¨‹ï¼Œæ ¹æ®supplieræ„å»ºæ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier, Executor executor)</span></span><br><span class="line">å¤åˆ¶ä»£ç </span><br></pre></td></tr></table></figure>

<p><strong>runAsyncæ–¹æ³•</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä½¿ç”¨é»˜è®¤å†…ç½®çº¿ç¨‹æ± ForkJoinPool.commonPool()ï¼Œæ ¹æ®runnableæ„å»ºæ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable)</span> </span><br><span class="line"><span class="comment">//è‡ªå®šä¹‰çº¿ç¨‹ï¼Œæ ¹æ®runnableæ„å»ºæ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable,  Executor executor)</span></span><br></pre></td></tr></table></figure>

<p>è‡ªå®šä¹‰çº¿ç¨‹æ± æ–¹å¼</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FutureTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//å¯ä»¥è‡ªå®šä¹‰çº¿ç¨‹æ± </span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newCachedThreadPool();</span><br><span class="line">        <span class="comment">//runAsyncçš„ä½¿ç”¨</span></span><br><span class="line">        CompletableFuture&lt;Void&gt; runFuture = CompletableFuture.runAsync(() -&gt; System.out.println(<span class="string">&quot;çº¿ç¨‹æ± æ–¹å¼&quot;</span>), executor);</span><br><span class="line">        <span class="comment">//supplyAsyncçš„ä½¿ç”¨</span></span><br><span class="line">        CompletableFuture&lt;String&gt; supplyFuture = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;supplyçº¿ç¨‹æ± æ–¹å¼&quot;</span>; &#125;, executor);</span><br><span class="line">        <span class="comment">//runAsyncçš„futureæ²¡æœ‰è¿”å›å€¼ï¼Œè¾“å‡ºnull</span></span><br><span class="line">        System.out.println(runFuture.join());</span><br><span class="line">        <span class="comment">//supplyAsyncçš„futureï¼Œæœ‰è¿”å›å€¼</span></span><br><span class="line">        System.out.println(supplyFuture.join());</span><br><span class="line">        executor.shutdown(); <span class="comment">// çº¿ç¨‹æ± éœ€è¦å…³é—­</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><strong>å°è´´å£«</strong>ï¼šæˆ‘ä»¬æ³¨æ„åˆ°ï¼Œåœ¨å®ä¾‹åŒ–æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥æŒ‡å®šExecutorå‚æ•°çš„ï¼Œå½“æˆ‘ä»¬ä¸æŒ‡å®šçš„è¯•è¯ï¼Œæˆ‘ä»¬æ‰€å¼€çš„å¹¶è¡Œçº¿ç¨‹ä½¿ç”¨çš„æ˜¯é»˜è®¤ç³»ç»ŸåŠå…¬å…±çº¿ç¨‹æ± <code>ForkJoinPool</code>ï¼Œè€Œä¸”è¿™äº›çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ã€‚æˆ‘ä»¬åœ¨ç¼–ç¨‹çš„æ—¶å€™éœ€è¦è°¨æ…ä½¿ç”¨å®ˆæŠ¤çº¿ç¨‹ï¼Œå¦‚æœå°†æˆ‘ä»¬æ™®é€šçš„ç”¨æˆ·çº¿ç¨‹è®¾ç½®æˆå®ˆæŠ¤çº¿ç¨‹ï¼Œå½“æˆ‘ä»¬çš„ç¨‹åºä¸»çº¿ç¨‹ç»“æŸï¼Œ<code>JVM</code>ä¸­ä¸å­˜åœ¨å…¶ä½™ç”¨æˆ·çº¿ç¨‹ï¼Œé‚£ä¹ˆ<code>CompletableFuture</code>çš„å®ˆæŠ¤çº¿ç¨‹ä¼šç›´æ¥é€€å‡ºï¼Œé€ æˆä»»åŠ¡æ— æ³•å®Œæˆçš„é—®é¢˜ï¼Œå…¶ä½™çš„åŒ…æ‹¬å®ˆæŠ¤çº¿ç¨‹é˜»å¡é—®é¢˜æˆ‘å°±ä¸åœ¨æœ¬ç¯‡èµ˜è¿°ã€‚</p>
<h3 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h3><p>Compare And Swapï¼Œæ¯”è¾ƒäº¤æ¢ã€‚å¯ä»¥çœ‹åˆ° <code>synchronized</code> å¯ä»¥ä¿è¯ä»£ç å—åŸå­æ€§ï¼Œå¾ˆå¤šæ—¶å€™ä¼šå¼•èµ·æ€§èƒ½é—®é¢˜ï¼Œvolatileä¹Ÿæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œä½†æ˜¯<code>volatile</code> ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œåªèƒ½åœ¨æŸäº›åœºåˆä¸‹ä½¿ç”¨ã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡ <code>CAS </code>æ¥è¿›è¡ŒåŒæ­¥ï¼Œä¿è¯åŸå­æ€§ã€‚</p>
<h4 id="ä»€ä¹ˆæ˜¯CASæœºåˆ¶"><a href="#ä»€ä¹ˆæ˜¯CASæœºåˆ¶" class="headerlink" title="ä»€ä¹ˆæ˜¯CASæœºåˆ¶"></a>ä»€ä¹ˆæ˜¯CASæœºåˆ¶</h4><p>CASæ˜¯è‹±æ–‡å•è¯Compare And Swapçš„ç¼©å†™ï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯æ¯”è¾ƒå¹¶æ›¿æ¢ã€‚</p>
<p>CASæœºåˆ¶å½“ä¸­ä½¿ç”¨äº†3ä¸ªåŸºæœ¬æ“ä½œæ•°ï¼šå†…å­˜åœ°å€Vï¼Œæ—§çš„é¢„æœŸå€¼Aï¼Œè¦ä¿®æ”¹çš„æ–°å€¼Bã€‚</p>
<p>æ›´æ–°ä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œåªæœ‰å½“å˜é‡çš„é¢„æœŸå€¼Aå’Œå†…å­˜åœ°å€Vå½“ä¸­çš„å®é™…å€¼ç›¸åŒæ—¶ï¼Œæ‰ä¼šå°†å†…å­˜åœ°å€Vå¯¹åº”çš„å€¼ä¿®æ”¹ä¸ºBã€‚</p>
<p>CASæ˜¯è‹±æ–‡å•è¯Compare And Swapçš„ç¼©å†™ï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯æ¯”è¾ƒå¹¶æ›¿æ¢ã€‚</p>
<p>CASæœºåˆ¶å½“ä¸­ä½¿ç”¨äº†3ä¸ªåŸºæœ¬æ“ä½œæ•°ï¼šå†…å­˜åœ°å€Vï¼Œæ—§çš„é¢„æœŸå€¼Aï¼Œè¦ä¿®æ”¹çš„æ–°å€¼Bã€‚</p>
<p>æ›´æ–°ä¸€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œåªæœ‰å½“å˜é‡çš„é¢„æœŸå€¼Aå’Œå†…å­˜åœ°å€Vå½“ä¸­çš„å®é™…å€¼ç›¸åŒæ—¶ï¼Œæ‰ä¼šå°†å†…å­˜åœ°å€Vå¯¹åº”çš„å€¼ä¿®æ”¹ä¸ºBã€‚</p>
<p>ä»æ€æƒ³ä¸Šæ¥è¯´ï¼Œ<strong>Synchronizedå±äºæ‚²è§‚é”</strong>ï¼Œæ‚²è§‚åœ°è®¤ä¸ºç¨‹åºä¸­çš„å¹¶å‘æƒ…å†µä¸¥é‡ï¼Œæ‰€ä»¥ä¸¥é˜²æ­»å®ˆã€‚<strong>CASå±äºä¹è§‚é”</strong>ï¼Œä¹è§‚åœ°è®¤ä¸ºç¨‹åºä¸­çš„å¹¶å‘æƒ…å†µä¸é‚£ä¹ˆä¸¥é‡ï¼Œæ‰€ä»¥è®©çº¿ç¨‹ä¸æ–­å»å°è¯•æ›´æ–°ã€‚</p>
<h4 id="ABAé—®é¢˜ä»¥åŠè§£å†³æ–¹æ¡ˆ"><a href="#ABAé—®é¢˜ä»¥åŠè§£å†³æ–¹æ¡ˆ" class="headerlink" title="ABAé—®é¢˜ä»¥åŠè§£å†³æ–¹æ¡ˆ"></a>ABAé—®é¢˜ä»¥åŠè§£å†³æ–¹æ¡ˆ</h4><p>å› ä¸ºCASéœ€è¦åœ¨æ“ä½œå€¼çš„æ—¶å€™æ£€æŸ¥ä¸‹å€¼æœ‰æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿå˜åŒ–åˆ™æ›´æ–°ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªå€¼åŸæ¥æ˜¯Aï¼Œå˜æˆäº†Bï¼Œåˆå˜æˆäº†Aï¼Œé‚£ä¹ˆä½¿ç”¨CASè¿›è¡Œæ£€æŸ¥æ—¶ä¼šå‘ç°å®ƒçš„å€¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯å®é™…ä¸Šå´å˜åŒ–äº†ã€‚ABAé—®é¢˜çš„è§£å†³æ€è·¯å°±æ˜¯ä½¿ç”¨ç‰ˆæœ¬å·ã€‚åœ¨å˜é‡å‰é¢è¿½åŠ ä¸Šç‰ˆæœ¬å·ï¼Œæ¯æ¬¡å˜é‡æ›´æ–°çš„æ—¶å€™æŠŠç‰ˆæœ¬å·åŠ ä¸€ï¼Œé‚£ä¹ˆAï¼Bï¼A å°±ä¼šå˜æˆ1A-2Bï¼3Aã€‚ ä»Java1.5å¼€å§‹JDKçš„atomicåŒ…é‡Œæä¾›äº†ä¸€ä¸ªç±»AtomicStampedReferenceæ¥è§£å†³ABAé—®é¢˜ã€‚è¿™ä¸ªç±»çš„compareAndSetæ–¹æ³•ä½œç”¨æ˜¯é¦–å…ˆæ£€æŸ¥å½“å‰å¼•ç”¨æ˜¯å¦ç­‰äºé¢„æœŸå¼•ç”¨ï¼Œå¹¶ä¸”å½“å‰æ ‡å¿—æ˜¯å¦ç­‰äºé¢„æœŸæ ‡å¿—ï¼Œå¦‚æœå…¨éƒ¨ç›¸ç­‰ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å¼•ç”¨å’Œè¯¥æ ‡å¿—çš„å€¼è®¾ç½®ä¸ºç»™å®šçš„æ›´æ–°å€¼ã€‚</p>
<h4 id="CASçš„ç¼ºç‚¹ï¼š"><a href="#CASçš„ç¼ºç‚¹ï¼š" class="headerlink" title="CASçš„ç¼ºç‚¹ï¼š"></a>CASçš„ç¼ºç‚¹ï¼š</h4><ol>
<li>CPUå¼€é”€è¾ƒå¤§<br>åœ¨å¹¶å‘é‡æ¯”è¾ƒé«˜çš„æƒ…å†µä¸‹ï¼Œå¦‚æœè®¸å¤šçº¿ç¨‹åå¤å°è¯•æ›´æ–°æŸä¸€ä¸ªå˜é‡ï¼Œå´åˆä¸€ç›´æ›´æ–°ä¸æˆåŠŸï¼Œå¾ªç¯å¾€å¤ï¼Œä¼šç»™CPUå¸¦æ¥å¾ˆå¤§çš„å‹åŠ›ã€‚</li>
<li>ä¸èƒ½ä¿è¯ä»£ç å—çš„åŸå­æ€§<br><strong>åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ</strong>ï¼Œè€Œä¸èƒ½ä¿è¯æ•´ä¸ªä»£ç å—çš„åŸå­æ€§ã€‚æ¯”å¦‚éœ€è¦ä¿è¯3ä¸ªå˜é‡å…±åŒè¿›è¡ŒåŸå­æ€§çš„æ›´æ–°ï¼Œå°±ä¸å¾—ä¸ä½¿ç”¨Synchronizedäº†ã€‚</li>
</ol>
<h3 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h3><p><a href="https://tech.meituan.com/2019/12/05/aqs-theory-and-apply.html">https://tech.meituan.com/2019/12/05/aqs-theory-and-apply.html</a></p>
<blockquote>
<p>Javaä¸­çš„å¤§éƒ¨åˆ†åŒæ­¥ç±»ï¼ˆLockã€Semaphoreã€ReentrantLockç­‰ï¼‰éƒ½æ˜¯åŸºäºAbstractQueuedSynchronizerï¼ˆç®€ç§°ä¸ºAQSï¼‰å®ç°çš„ã€‚AQSæ˜¯ä¸€ç§æä¾›äº†åŸå­å¼ç®¡ç†åŒæ­¥çŠ¶æ€ã€é˜»å¡å’Œå”¤é†’çº¿ç¨‹åŠŸèƒ½ä»¥åŠé˜Ÿåˆ—æ¨¡å‹çš„ç®€å•æ¡†æ¶</p>
</blockquote>
<h2 id="é«˜æ€§èƒ½æ— é”å¹¶å‘æ¡†æ¶Disruptor"><a href="#é«˜æ€§èƒ½æ— é”å¹¶å‘æ¡†æ¶Disruptor" class="headerlink" title="é«˜æ€§èƒ½æ— é”å¹¶å‘æ¡†æ¶Disruptor"></a>é«˜æ€§èƒ½æ— é”å¹¶å‘æ¡†æ¶Disruptor</h2><blockquote>
<p>Disruptoræ˜¯ä¸€ä¸ªå¼€æºæ¡†æ¶ï¼Œç ”å‘çš„åˆè¡·æ˜¯ä¸ºäº†è§£å†³é«˜å¹¶å‘ä¸‹é˜Ÿåˆ—é”çš„é—®é¢˜ï¼Œæœ€æ—©ç”±LMAXæå‡ºå¹¶ä½¿ç”¨ï¼Œèƒ½å¤Ÿåœ¨æ— é”çš„æƒ…å†µä¸‹å®ç°é˜Ÿåˆ—çš„å¹¶å‘æ“ä½œï¼Œå¹¶å·ç§°èƒ½å¤Ÿåœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œæ¯ç§’å¤„ç†6ç™¾ä¸‡ç¬”è®¢å•</p>
<p>å®˜ç½‘ï¼š<a href="https://link.juejin.cn/?target=http://lmax-exchange.github.io/disruptor/">lmax-exchange.github.io&#x2F;disruptor&#x2F;</a></p>
<p>ç›®å‰ï¼ŒåŒ…æ‹¬Apache Stormã€Camelã€Log4j2åœ¨å†…çš„å¾ˆå¤šçŸ¥åé¡¹ç›®éƒ½åº”ç”¨äº†Disruptorä»¥è·å–é«˜æ€§èƒ½</p>
</blockquote>
<h3 id="Disruptorçš„è®¾è®¡æ–¹æ¡ˆ"><a href="#Disruptorçš„è®¾è®¡æ–¹æ¡ˆ" class="headerlink" title="Disruptorçš„è®¾è®¡æ–¹æ¡ˆ"></a>Disruptorçš„è®¾è®¡æ–¹æ¡ˆ</h3><p>Disruptoré€šè¿‡ä»¥ä¸‹è®¾è®¡æ¥è§£å†³é˜Ÿåˆ—é€Ÿåº¦æ…¢çš„é—®é¢˜ï¼š</p>
<ul>
<li>ç¯å½¢æ•°ç»„ç»“æ„</li>
</ul>
<p>ä¸ºäº†é¿å…åƒåœ¾å›æ”¶ï¼Œé‡‡ç”¨æ•°ç»„è€Œéé“¾è¡¨ã€‚åŒæ—¶ï¼Œæ•°ç»„å¯¹å¤„ç†å™¨çš„ç¼“å­˜æœºåˆ¶æ›´åŠ å‹å¥½ã€‚</p>
<ul>
<li>å…ƒç´ ä½ç½®å®šä½</li>
</ul>
<p>æ•°ç»„é•¿åº¦2^nï¼Œé€šè¿‡ä½è¿ç®—ï¼ŒåŠ å¿«å®šä½çš„é€Ÿåº¦ã€‚ä¸‹æ ‡é‡‡å–é€’å¢çš„å½¢å¼ã€‚ä¸ç”¨æ‹…å¿ƒindexæº¢å‡ºçš„é—®é¢˜ã€‚indexæ˜¯longç±»å‹ï¼Œå³ä½¿100ä¸‡QPSçš„å¤„ç†é€Ÿåº¦ï¼Œä¹Ÿéœ€è¦30ä¸‡å¹´æ‰èƒ½ç”¨å®Œã€‚</p>
<ul>
<li>æ— é”è®¾è®¡</li>
</ul>
<p>æ¯ä¸ªç”Ÿäº§è€…æˆ–è€…æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œä¼šå…ˆç”³è¯·å¯ä»¥æ“ä½œçš„å…ƒç´ åœ¨æ•°ç»„ä¸­çš„ä½ç½®ï¼Œç”³è¯·åˆ°ä¹‹åï¼Œç›´æ¥åœ¨è¯¥ä½ç½®å†™å…¥æˆ–è€…è¯»å–æ•°æ®ã€‚</p>
<p>ä¸‹é¢å¿½ç•¥æ•°ç»„çš„ç¯å½¢ç»“æ„ï¼Œä»‹ç»ä¸€ä¸‹å¦‚ä½•å®ç°æ— é”è®¾è®¡ã€‚æ•´ä¸ªè¿‡ç¨‹é€šè¿‡åŸå­å˜é‡CASï¼Œä¿è¯æ“ä½œçš„çº¿ç¨‹å®‰å…¨ã€‚</p>
<h2 id="æ³¨æ„ç‚¹"><a href="#æ³¨æ„ç‚¹" class="headerlink" title="æ³¨æ„ç‚¹"></a>æ³¨æ„ç‚¹</h2><h4 id="å¤šçº¿ç¨‹ä¸­çš„è™šå‡å”¤é†’"><a href="#å¤šçº¿ç¨‹ä¸­çš„è™šå‡å”¤é†’" class="headerlink" title="å¤šçº¿ç¨‹ä¸­çš„è™šå‡å”¤é†’"></a>å¤šçº¿ç¨‹ä¸­çš„è™šå‡å”¤é†’</h4><p><strong>è™šå‡å”¤é†’</strong>ï¼š ä¸¤ä¸ªçº¿ç¨‹ä»¥ä¸Šä¼šé€ æˆè™šå‡å”¤é†’çš„æƒ…å†µã€‚è™šå‡å”¤é†’ï¼ˆspurious wakeupï¼‰æ˜¯ä¸€ä¸ªè¡¨è±¡ï¼Œå³åœ¨å¤šå¤„ç†å™¨çš„ç³»ç»Ÿä¸‹å‘å‡ºwaitçš„ç¨‹åºæœ‰å¯èƒ½åœ¨æ²¡æœ‰notifyå”¤é†’çš„æƒ…å½¢ä¸‹è‹é†’ç»§ç»­æ‰§è¡Œã€‚ä»¥è¿è¡Œåœ¨linuxçš„hotspotè™šæ‹Ÿæœºä¸Šçš„javaç¨‹åºä¸ºä¾‹ï¼Œwaitæ–¹æ³•åœ¨jvmæ‰§è¡Œæ—¶å®è´¨æ˜¯è°ƒç”¨äº†åº•å±‚pthread_cond_wait&#x2F;pthread_cond_timedwaitå‡½æ•°ï¼ŒæŒ‚èµ·ç­‰å¾…æ¡ä»¶å˜é‡æ¥è¾¾åˆ°çº¿ç¨‹é—´åŒæ­¥é€šä¿¡çš„æ•ˆæœï¼Œè€Œåº•å±‚waitå‡½æ•°åœ¨è®¾è®¡ä¹‹åˆä¸ºäº†ä¸å‡æ…¢æ¡ä»¶å˜é‡æ“ä½œçš„æ•ˆç‡å¹¶æ²¡æœ‰å»ä¿è¯æ¯æ¬¡å”¤é†’éƒ½æ˜¯ç”±notifyè§¦å‘ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªä»»åŠ¡äº¤ç”±ä¸Šå±‚åº”ç”¨å»å®ç°ï¼Œå³ä½¿ç”¨è€…éœ€è¦å®šä¹‰ä¸€ä¸ªå¾ªç¯å»åˆ¤æ–­æ˜¯å¦æ¡ä»¶çœŸèƒ½æ»¡è¶³ç¨‹åºç»§ç»­è¿è¡Œçš„éœ€æ±‚ï¼Œå½“ç„¶è¿™æ ·çš„å®ç°ä¹Ÿå¯ä»¥é¿å…å› ä¸ºè®¾è®¡ç¼ºé™·å¯¼è‡´ç¨‹åºå¼‚å¸¸å”¤é†’çš„é—®é¢˜ã€‚</p>
<p><strong>è§£å†³</strong>ï¼š æ‰€ä»¥ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œåªå¥½ç”¨whileå¾ªç¯é¿å…è™šå‡å”¤é†’ã€‚ï¼ˆå› ä¸ºifåªåˆ¤æ–­ä¸€æ¬¡ï¼Œä¸èƒ½é¿å…è™šå‡å”¤é†’ï¼‰</p>
<p>ä¸‹é¢æ˜¯ä½¿ç”¨Locké”å®Œæˆæ¶ˆè´¹è€…å’Œç”Ÿäº§è€…æ¡ˆä¾‹ï¼Œé‡Œé¢ä½¿ç”¨äº†whileå¾ªç¯é¿å…äº†è™šå‡å”¤é†’ã€‚</p>
<p>æ€è·¯æ˜¯ï¼šå®šä¹‰ä¸€ä¸ªèµ„æºç±»ï¼Œé‡Œé¢å…ˆåˆ¤æ–­ï¼Œå†å†™ä»£ç ï¼Œåœ¨é€šçŸ¥ï¼Œä¸»çº¿ç¨‹é€šè¿‡å­çº¿ç¨‹è¿›è¡Œè°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bestqiang.thread.Queue;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> BestQiang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é¢˜ç›®ï¼šä¸€ä¸ªåˆå§‹å€¼ä¸ºé›¶çš„å˜é‡ï¼Œä¸¤ä¸ªçº¿ç¨‹å¯¹å…¶äº¤æ›¿æ“ä½œï¼Œä¸€ä¸ªåŠ 1ï¼Œä¸€ä¸ªå‡1ï¼Œæ¥5è½®</span></span><br><span class="line"><span class="comment"> * 1. çº¿ç¨‹    æ“ä½œ  èµ„æºç±»</span></span><br><span class="line"><span class="comment"> * 2. åˆ¤æ–­    å¹²æ´»  é€šçŸ¥</span></span><br><span class="line"><span class="comment"> * 3. é˜²æ­¢è™šå‡å”¤é†’æœºåˆ¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProdConsumer_TraditionDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ShareData</span> <span class="variable">shareData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShareData</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    shareData.increment();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;A&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    shareData.decrement();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;B&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ShareData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">condition</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decrement</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.åˆ¤æ–­ ä½¿ç”¨whileå¾ªç¯ï¼Œé¿å…è™šå‡å”¤é†’</span></span><br><span class="line">            <span class="keyword">while</span> (number == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// ç­‰å¾…ï¼Œä¸èƒ½ç”Ÿäº§</span></span><br><span class="line">                condition.await();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.å¹²æ´»</span></span><br><span class="line">            number --;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t&quot;</span> + number);</span><br><span class="line">            <span class="comment">// 3.é€šçŸ¥å”¤é†’</span></span><br><span class="line">            condition.signalAll();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.åˆ¤æ–­</span></span><br><span class="line">            <span class="keyword">while</span> (number != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// ç­‰å¾…ï¼Œä¸èƒ½ç”Ÿäº§</span></span><br><span class="line">                condition.await();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 2.å¹²æ´»</span></span><br><span class="line">            number ++;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t&quot;</span> + number);</span><br><span class="line">            <span class="comment">// 3.é€šçŸ¥å”¤é†’</span></span><br><span class="line">            condition.signalAll();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>javaåŸºç¡€</category>
      </categories>
      <tags>
        <tag>å¤šçº¿ç¨‹</tag>
      </tags>
  </entry>
</search>
